<html>
<head>
<title>no-restricted-globals.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #067d17;}
.s4 { color: #0033b3;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
no-restricted-globals.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@fileoverview </span><span class="s0">Restrict usage of specified globals.</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Beno√Æt Zugmeyer</span>
 <span class="s0">*/</span>
<span class="s3">&quot;use strict&quot;</span><span class="s2">;</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Requirements</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s4">const </span><span class="s2">astUtils = require(</span><span class="s3">&quot;./utils/ast-utils&quot;</span><span class="s2">);</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Helpers</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s4">const </span><span class="s2">TYPE_NODES = </span><span class="s4">new </span><span class="s2">Set([</span>
	<span class="s3">&quot;TSTypeReference&quot;</span><span class="s2">,</span>
	<span class="s3">&quot;TSInterfaceHeritage&quot;</span><span class="s2">,</span>
	<span class="s3">&quot;TSClassImplements&quot;</span><span class="s2">,</span>
	<span class="s3">&quot;TSTypeQuery&quot;</span><span class="s2">,</span>
	<span class="s3">&quot;TSQualifiedName&quot;</span><span class="s2">,</span>
<span class="s2">]);</span>

<span class="s4">const </span><span class="s2">GLOBAL_OBJECTS = </span><span class="s4">new </span><span class="s2">Set([</span><span class="s3">&quot;globalThis&quot;</span><span class="s2">, </span><span class="s3">&quot;self&quot;</span><span class="s2">, </span><span class="s3">&quot;window&quot;</span><span class="s2">]);</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Rule Definition</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s4">const </span><span class="s2">arrayOfGlobals = {</span>
	<span class="s2">type: </span><span class="s3">&quot;array&quot;</span><span class="s2">,</span>
	<span class="s2">items: {</span>
		<span class="s2">oneOf: [</span>
			<span class="s2">{</span>
				<span class="s2">type: </span><span class="s3">&quot;string&quot;</span><span class="s2">,</span>
			<span class="s2">},</span>
			<span class="s2">{</span>
				<span class="s2">type: </span><span class="s3">&quot;object&quot;</span><span class="s2">,</span>
				<span class="s2">properties: {</span>
					<span class="s2">name: { type: </span><span class="s3">&quot;string&quot; </span><span class="s2">},</span>
					<span class="s2">message: { type: </span><span class="s3">&quot;string&quot; </span><span class="s2">},</span>
				<span class="s2">},</span>
				<span class="s2">required: [</span><span class="s3">&quot;name&quot;</span><span class="s2">],</span>
				<span class="s2">additionalProperties: </span><span class="s4">false</span><span class="s2">,</span>
			<span class="s2">},</span>
		<span class="s2">],</span>
	<span class="s2">},</span>
	<span class="s2">uniqueItems: </span><span class="s4">true</span><span class="s2">,</span>
	<span class="s2">minItems: </span><span class="s5">0</span><span class="s2">,</span>
<span class="s2">};</span>

<span class="s0">/** </span><span class="s1">@type </span><span class="s0">{import('../types').Rule.RuleModule} */</span>
<span class="s2">module.exports = {</span>
	<span class="s2">meta: {</span>
		<span class="s2">dialects: [</span><span class="s3">&quot;javascript&quot;</span><span class="s2">, </span><span class="s3">&quot;typescript&quot;</span><span class="s2">],</span>
		<span class="s2">language: </span><span class="s3">&quot;javascript&quot;</span><span class="s2">,</span>
		<span class="s2">type: </span><span class="s3">&quot;suggestion&quot;</span><span class="s2">,</span>

		<span class="s2">docs: {</span>
			<span class="s2">description: </span><span class="s3">&quot;Disallow specified global variables&quot;</span><span class="s2">,</span>
			<span class="s2">recommended: </span><span class="s4">false</span><span class="s2">,</span>
			<span class="s2">url: </span><span class="s3">&quot;https://eslint.org/docs/latest/rules/no-restricted-globals&quot;</span><span class="s2">,</span>
		<span class="s2">},</span>

		<span class="s2">schema: {</span>
			<span class="s2">anyOf: [</span>
				<span class="s2">arrayOfGlobals,</span>
				<span class="s2">{</span>
					<span class="s2">type: </span><span class="s3">&quot;array&quot;</span><span class="s2">,</span>
					<span class="s2">items: [</span>
						<span class="s2">{</span>
							<span class="s2">type: </span><span class="s3">&quot;object&quot;</span><span class="s2">,</span>
							<span class="s2">properties: {</span>
								<span class="s2">globals: arrayOfGlobals,</span>
								<span class="s2">checkGlobalObject: {</span>
									<span class="s2">type: </span><span class="s3">&quot;boolean&quot;</span><span class="s2">,</span>
								<span class="s2">},</span>
								<span class="s2">globalObjects: {</span>
									<span class="s2">type: </span><span class="s3">&quot;array&quot;</span><span class="s2">,</span>
									<span class="s2">items: {</span>
										<span class="s2">type: </span><span class="s3">&quot;string&quot;</span><span class="s2">,</span>
									<span class="s2">},</span>
									<span class="s2">uniqueItems: </span><span class="s4">true</span><span class="s2">,</span>
								<span class="s2">},</span>
							<span class="s2">},</span>
							<span class="s2">required: [</span><span class="s3">&quot;globals&quot;</span><span class="s2">],</span>
							<span class="s2">additionalProperties: </span><span class="s4">false</span><span class="s2">,</span>
						<span class="s2">},</span>
					<span class="s2">],</span>
					<span class="s2">additionalItems: </span><span class="s4">false</span><span class="s2">,</span>
				<span class="s2">},</span>
			<span class="s2">],</span>
		<span class="s2">},</span>

		<span class="s2">messages: {</span>
			<span class="s2">defaultMessage: </span><span class="s3">&quot;Unexpected use of '{{name}}'.&quot;</span><span class="s2">,</span>
			<span class="s0">// eslint-disable-next-line eslint-plugin/report-message-format -- Custom message might not end in a period</span>
			<span class="s2">customMessage: </span><span class="s3">&quot;Unexpected use of '{{name}}'. {{customMessage}}&quot;</span><span class="s2">,</span>
		<span class="s2">},</span>
	<span class="s2">},</span>

	<span class="s2">create(context) {</span>
		<span class="s4">const </span><span class="s2">{ sourceCode, options } = context;</span>

		<span class="s4">const </span><span class="s2">isGlobalsObject =</span>
			<span class="s4">typeof </span><span class="s2">options[</span><span class="s5">0</span><span class="s2">] === </span><span class="s3">&quot;object&quot; </span><span class="s2">&amp;&amp;</span>
			<span class="s2">Object.hasOwn(options[</span><span class="s5">0</span><span class="s2">], </span><span class="s3">&quot;globals&quot;</span><span class="s2">);</span>

		<span class="s4">const </span><span class="s2">restrictedGlobals = isGlobalsObject</span>
			<span class="s2">? options[</span><span class="s5">0</span><span class="s2">].globals</span>
			<span class="s2">: options;</span>
		<span class="s4">const </span><span class="s2">checkGlobalObject = isGlobalsObject</span>
			<span class="s2">? options[</span><span class="s5">0</span><span class="s2">].checkGlobalObject</span>
			<span class="s2">: </span><span class="s4">false</span><span class="s2">;</span>
		<span class="s4">const </span><span class="s2">userGlobalObjects = isGlobalsObject</span>
			<span class="s2">? options[</span><span class="s5">0</span><span class="s2">].globalObjects || []</span>
			<span class="s2">: [];</span>

		<span class="s4">const </span><span class="s2">globalObjects = </span><span class="s4">new </span><span class="s2">Set([</span>
			<span class="s2">...GLOBAL_OBJECTS,</span>
			<span class="s2">...userGlobalObjects,</span>
		<span class="s2">]);</span>

		<span class="s0">// If no globals are restricted, we don't need to do anything</span>
		<span class="s4">if </span><span class="s2">(restrictedGlobals.length === </span><span class="s5">0</span><span class="s2">) {</span>
			<span class="s4">return </span><span class="s2">{};</span>
		<span class="s2">}</span>

		<span class="s4">const </span><span class="s2">restrictedGlobalMessages = restrictedGlobals.reduce(</span>
			<span class="s2">(memo, option) =&gt; {</span>
				<span class="s4">if </span><span class="s2">(</span><span class="s4">typeof </span><span class="s2">option === </span><span class="s3">&quot;string&quot;</span><span class="s2">) {</span>
					<span class="s2">memo[option] = </span><span class="s4">null</span><span class="s2">;</span>
				<span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
					<span class="s2">memo[option.name] = option.message;</span>
				<span class="s2">}</span>

				<span class="s4">return </span><span class="s2">memo;</span>
			<span class="s2">},</span>
			<span class="s2">{},</span>
		<span class="s2">);</span>

		<span class="s0">/**</span>
		 <span class="s0">* Report a variable to be used as a restricted global.</span>
		 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{Reference} reference the variable reference</span>
		 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{void}</span>
		 <span class="s0">* </span><span class="s1">@private</span>
		 <span class="s0">*/</span>
		<span class="s4">function </span><span class="s2">reportReference(reference) {</span>
			<span class="s4">const </span><span class="s2">name = reference.identifier.name,</span>
				<span class="s2">customMessage = restrictedGlobalMessages[name],</span>
				<span class="s2">messageId = customMessage ? </span><span class="s3">&quot;customMessage&quot; </span><span class="s2">: </span><span class="s3">&quot;defaultMessage&quot;</span><span class="s2">;</span>

			<span class="s2">context.report({</span>
				<span class="s2">node: reference.identifier,</span>
				<span class="s2">messageId,</span>
				<span class="s2">data: {</span>
					<span class="s2">name,</span>
					<span class="s2">customMessage,</span>
				<span class="s2">},</span>
			<span class="s2">});</span>
		<span class="s2">}</span>

		<span class="s0">/**</span>
		 <span class="s0">* Check if the given name is a restricted global name.</span>
		 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} name name of a variable</span>
		 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{boolean} whether the variable is a restricted global or not</span>
		 <span class="s0">* </span><span class="s1">@private</span>
		 <span class="s0">*/</span>
		<span class="s4">function </span><span class="s2">isRestricted(name) {</span>
			<span class="s4">return </span><span class="s2">Object.hasOwn(restrictedGlobalMessages, name);</span>
		<span class="s2">}</span>

		<span class="s0">/**</span>
		 <span class="s0">* Check if the given reference occurs within a TypeScript type context.</span>
		 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{Reference} reference The variable reference to check.</span>
		 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{boolean} Whether the reference is in a type context.</span>
		 <span class="s0">* </span><span class="s1">@private</span>
		 <span class="s0">*/</span>
		<span class="s4">function </span><span class="s2">isInTypeContext(reference) {</span>
			<span class="s4">const </span><span class="s2">parent = reference.identifier.parent;</span>

			<span class="s4">return </span><span class="s2">TYPE_NODES.has(parent.type);</span>
		<span class="s2">}</span>

		<span class="s4">return </span><span class="s2">{</span>
			<span class="s2">Program(node) {</span>
				<span class="s4">const </span><span class="s2">scope = sourceCode.getScope(node);</span>

				<span class="s0">// Report variables declared elsewhere (ex: variables defined as &quot;global&quot; by eslint)</span>
				<span class="s2">scope.variables.forEach(variable =&gt; {</span>
					<span class="s4">if </span><span class="s2">(!variable.defs.length &amp;&amp; isRestricted(variable.name)) {</span>
						<span class="s2">variable.references.forEach(reference =&gt; {</span>
							<span class="s4">if </span><span class="s2">(!isInTypeContext(reference)) {</span>
								<span class="s2">reportReference(reference);</span>
							<span class="s2">}</span>
						<span class="s2">});</span>
					<span class="s2">}</span>
				<span class="s2">});</span>

				<span class="s0">// Report variables not declared at all</span>
				<span class="s2">scope.through.forEach(reference =&gt; {</span>
					<span class="s4">if </span><span class="s2">(</span>
						<span class="s2">isRestricted(reference.identifier.name) &amp;&amp;</span>
						<span class="s2">!isInTypeContext(reference)</span>
					<span class="s2">) {</span>
						<span class="s2">reportReference(reference);</span>
					<span class="s2">}</span>
				<span class="s2">});</span>
			<span class="s2">},</span>

			<span class="s3">&quot;Program:exit&quot;</span><span class="s2">(node) {</span>
				<span class="s4">if </span><span class="s2">(!checkGlobalObject) {</span>
					<span class="s4">return</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s4">const </span><span class="s2">globalScope = sourceCode.getScope(node);</span>
				<span class="s2">globalObjects.forEach(globalObjectName =&gt; {</span>
					<span class="s4">const </span><span class="s2">variable = astUtils.getVariableByName(</span>
						<span class="s2">globalScope,</span>
						<span class="s2">globalObjectName,</span>
					<span class="s2">);</span>

					<span class="s4">if </span><span class="s2">(!variable) {</span>
						<span class="s4">return</span><span class="s2">;</span>
					<span class="s2">}</span>

					<span class="s2">variable.references.forEach(reference =&gt; {</span>
						<span class="s4">const </span><span class="s2">identifier = reference.identifier;</span>
						<span class="s4">let </span><span class="s2">parent = identifier.parent;</span>

						<span class="s0">// To detect code like `window.window.Promise`.</span>
						<span class="s4">while </span><span class="s2">(</span>
							<span class="s2">astUtils.isSpecificMemberAccess(</span>
								<span class="s2">parent,</span>
								<span class="s4">null</span><span class="s2">,</span>
								<span class="s2">globalObjectName,</span>
							<span class="s2">)</span>
						<span class="s2">) {</span>
							<span class="s2">parent = parent.parent;</span>
						<span class="s2">}</span>

						<span class="s4">const </span><span class="s2">propertyName =</span>
							<span class="s2">astUtils.getStaticPropertyName(parent);</span>
						<span class="s4">if </span><span class="s2">(propertyName &amp;&amp; isRestricted(propertyName)) {</span>
							<span class="s4">const </span><span class="s2">customMessage =</span>
								<span class="s2">restrictedGlobalMessages[propertyName];</span>
							<span class="s4">const </span><span class="s2">messageId = customMessage</span>
								<span class="s2">? </span><span class="s3">&quot;customMessage&quot;</span>
								<span class="s2">: </span><span class="s3">&quot;defaultMessage&quot;</span><span class="s2">;</span>

							<span class="s2">context.report({</span>
								<span class="s2">node: parent.property,</span>
								<span class="s2">messageId,</span>
								<span class="s2">data: {</span>
									<span class="s2">name: propertyName,</span>
									<span class="s2">customMessage,</span>
								<span class="s2">},</span>
							<span class="s2">});</span>
						<span class="s2">}</span>
					<span class="s2">});</span>
				<span class="s2">});</span>
			<span class="s2">},</span>
		<span class="s2">};</span>
	<span class="s2">},</span>
<span class="s2">};</span>
</pre>
</body>
</html>