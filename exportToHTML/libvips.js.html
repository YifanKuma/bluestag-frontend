<html>
<head>
<title>libvips.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #0033b3;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
libvips.js</font>
</center></td></tr></table>
<pre><span class="s0">// Copyright 2013 Lovell Fuller and others.</span>
<span class="s0">// SPDX-License-Identifier: Apache-2.0</span>

<span class="s2">'use strict'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">{ spawnSync } = require(</span><span class="s2">'node:child_process'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">{ createHash } = require(</span><span class="s2">'node:crypto'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">semverCoerce = require(</span><span class="s2">'semver/functions/coerce'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">semverGreaterThanOrEqualTo = require(</span><span class="s2">'semver/functions/gte'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">semverSatisfies = require(</span><span class="s2">'semver/functions/satisfies'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">detectLibc = require(</span><span class="s2">'detect-libc'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s1">{ config, engines, optionalDependencies } = require(</span><span class="s2">'../package.json'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s1">minimumLibvipsVersionLabelled = process.env.npm_package_config_libvips || </span><span class="s0">/* istanbul ignore next */</span>
  <span class="s1">config.libvips;</span>
<span class="s3">const </span><span class="s1">minimumLibvipsVersion = semverCoerce(minimumLibvipsVersionLabelled).version;</span>

<span class="s3">const </span><span class="s1">prebuiltPlatforms = [</span>
  <span class="s2">'darwin-arm64'</span><span class="s1">, </span><span class="s2">'darwin-x64'</span><span class="s1">,</span>
  <span class="s2">'linux-arm'</span><span class="s1">, </span><span class="s2">'linux-arm64'</span><span class="s1">, </span><span class="s2">'linux-ppc64'</span><span class="s1">, </span><span class="s2">'linux-s390x'</span><span class="s1">, </span><span class="s2">'linux-x64'</span><span class="s1">,</span>
  <span class="s2">'linuxmusl-arm64'</span><span class="s1">, </span><span class="s2">'linuxmusl-x64'</span><span class="s1">,</span>
  <span class="s2">'win32-arm64'</span><span class="s1">, </span><span class="s2">'win32-ia32'</span><span class="s1">, </span><span class="s2">'win32-x64'</span>
<span class="s1">];</span>

<span class="s3">const </span><span class="s1">spawnSyncOptions = {</span>
  <span class="s1">encoding: </span><span class="s2">'utf8'</span><span class="s1">,</span>
  <span class="s1">shell: </span><span class="s3">true</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">log = (item) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(item </span><span class="s3">instanceof </span><span class="s1">Error) {</span>
    <span class="s1">console.error(</span><span class="s2">`sharp: Installation error: </span><span class="s1">${item.message}</span><span class="s2">`</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s1">console.log(</span><span class="s2">`sharp: </span><span class="s1">${item}</span><span class="s2">`</span><span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">const </span><span class="s1">runtimeLibc = () =&gt; detectLibc.isNonGlibcLinuxSync() ? detectLibc.familySync() : </span><span class="s2">''</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">runtimePlatformArch = () =&gt; </span><span class="s2">`</span><span class="s1">${process.platform}${runtimeLibc()}</span><span class="s2">-</span><span class="s1">${process.arch}</span><span class="s2">`</span><span class="s1">;</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">const </span><span class="s1">buildPlatformArch = () =&gt; {</span>
  <span class="s3">if </span><span class="s1">(isEmscripten()) {</span>
    <span class="s3">return </span><span class="s2">'wasm32'</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">/* eslint camelcase: [&quot;error&quot;, { allow: [&quot;^npm_config_&quot;] }] */</span>
  <span class="s3">const </span><span class="s1">{ npm_config_arch, npm_config_platform, npm_config_libc } = process.env;</span>
  <span class="s3">const </span><span class="s1">libc = </span><span class="s3">typeof </span><span class="s1">npm_config_libc === </span><span class="s2">'string' </span><span class="s1">? npm_config_libc : runtimeLibc();</span>
  <span class="s3">return </span><span class="s2">`</span><span class="s1">${npm_config_platform || process.platform}${libc}</span><span class="s2">-</span><span class="s1">${npm_config_arch || process.arch}</span><span class="s2">`</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">buildSharpLibvipsIncludeDir = () =&gt; {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">return </span><span class="s1">require(</span><span class="s2">`@img/sharp-libvips-dev-</span><span class="s1">${buildPlatformArch()}</span><span class="s2">/include`</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">return </span><span class="s1">require(</span><span class="s2">'@img/sharp-libvips-dev/include'</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>
  <span class="s1">}</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">buildSharpLibvipsCPlusPlusDir = () =&gt; {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">return </span><span class="s1">require(</span><span class="s2">'@img/sharp-libvips-dev/cplusplus'</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">buildSharpLibvipsLibDir = () =&gt; {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">return </span><span class="s1">require(</span><span class="s2">`@img/sharp-libvips-dev-</span><span class="s1">${buildPlatformArch()}</span><span class="s2">/lib`</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">return </span><span class="s1">require(</span><span class="s2">`@img/sharp-libvips-</span><span class="s1">${buildPlatformArch()}</span><span class="s2">/lib`</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>
  <span class="s1">}</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">isUnsupportedNodeRuntime = () =&gt; {</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">if </span><span class="s1">(process.release?.name === </span><span class="s2">'node' </span><span class="s1">&amp;&amp; process.versions) {</span>
    <span class="s3">if </span><span class="s1">(!semverSatisfies(process.versions.node, engines.node)) {</span>
      <span class="s3">return </span><span class="s1">{ found: process.versions.node, expected: engines.node };</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">const </span><span class="s1">isEmscripten = () =&gt; {</span>
  <span class="s3">const </span><span class="s1">{ CC } = process.env;</span>
  <span class="s3">return </span><span class="s1">Boolean(CC &amp;&amp; CC.endsWith(</span><span class="s2">'/emcc'</span><span class="s1">));</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">isRosetta = () =&gt; {</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">if </span><span class="s1">(process.platform === </span><span class="s2">'darwin' </span><span class="s1">&amp;&amp; process.arch === </span><span class="s2">'x64'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">translated = spawnSync(</span><span class="s2">'sysctl sysctl.proc_translated'</span><span class="s1">, spawnSyncOptions).stdout;</span>
    <span class="s3">return </span><span class="s1">(translated || </span><span class="s2">''</span><span class="s1">).trim() === </span><span class="s2">'sysctl.proc_translated: 1'</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">return false</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">sha512 = (s) =&gt; createHash(</span><span class="s2">'sha512'</span><span class="s1">).update(s).digest(</span><span class="s2">'hex'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s1">yarnLocator = () =&gt; {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s3">const </span><span class="s1">identHash = sha512(</span><span class="s2">`imgsharp-libvips-</span><span class="s1">${buildPlatformArch()}</span><span class="s2">`</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s1">npmVersion = semverCoerce(optionalDependencies[</span><span class="s2">`@img/sharp-libvips-</span><span class="s1">${buildPlatformArch()}</span><span class="s2">`</span><span class="s1">], {</span>
      <span class="s1">includePrerelease: </span><span class="s3">true</span>
    <span class="s1">}).version;</span>
    <span class="s3">return </span><span class="s1">sha512(</span><span class="s2">`</span><span class="s1">${identHash}</span><span class="s2">npm:</span><span class="s1">${npmVersion}</span><span class="s2">`</span><span class="s1">).slice(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">10</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">{}</span>
  <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">const </span><span class="s1">spawnRebuild = () =&gt;</span>
  <span class="s1">spawnSync(</span><span class="s2">`node-gyp rebuild --directory=src </span><span class="s1">${isEmscripten() ? </span><span class="s2">'--nodedir=emscripten' </span><span class="s1">: </span><span class="s2">''</span><span class="s1">}</span><span class="s2">`</span><span class="s1">, {</span>
    <span class="s1">...spawnSyncOptions,</span>
    <span class="s1">stdio: </span><span class="s2">'inherit'</span>
  <span class="s1">}).status;</span>

<span class="s3">const </span><span class="s1">globalLibvipsVersion = () =&gt; {</span>
  <span class="s3">if </span><span class="s1">(process.platform !== </span><span class="s2">'win32'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">globalLibvipsVersion = spawnSync(</span><span class="s2">'pkg-config --modversion vips-cpp'</span><span class="s1">, {</span>
      <span class="s1">...spawnSyncOptions,</span>
      <span class="s1">env: {</span>
        <span class="s1">...process.env,</span>
        <span class="s1">PKG_CONFIG_PATH: pkgConfigPath()</span>
      <span class="s1">}</span>
    <span class="s1">}).stdout;</span>
    <span class="s0">/* istanbul ignore next */</span>
    <span class="s3">return </span><span class="s1">(globalLibvipsVersion || </span><span class="s2">''</span><span class="s1">).trim();</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">const </span><span class="s1">pkgConfigPath = () =&gt; {</span>
  <span class="s3">if </span><span class="s1">(process.platform !== </span><span class="s2">'win32'</span><span class="s1">) {</span>
    <span class="s3">const </span><span class="s1">brewPkgConfigPath = spawnSync(</span>
      <span class="s2">'which brew &gt;/dev/null 2&gt;&amp;1 &amp;&amp; brew environment --plain | grep PKG_CONFIG_LIBDIR | cut -d&quot; &quot; -f2'</span><span class="s1">,</span>
      <span class="s1">spawnSyncOptions</span>
    <span class="s1">).stdout || </span><span class="s2">''</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">[</span>
      <span class="s1">brewPkgConfigPath.trim(),</span>
      <span class="s1">process.env.PKG_CONFIG_PATH,</span>
      <span class="s2">'/usr/local/lib/pkgconfig'</span><span class="s1">,</span>
      <span class="s2">'/usr/lib/pkgconfig'</span><span class="s1">,</span>
      <span class="s2">'/usr/local/libdata/pkgconfig'</span><span class="s1">,</span>
      <span class="s2">'/usr/libdata/pkgconfig'</span>
    <span class="s1">].filter(Boolean).join(</span><span class="s2">':'</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">return </span><span class="s2">''</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">skipSearch = (status, reason, logger) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(logger) {</span>
    <span class="s1">logger(</span><span class="s2">`Detected </span><span class="s1">${reason}</span><span class="s2">, skipping search for globally-installed libvips`</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s1">status;</span>
<span class="s1">};</span>

<span class="s3">const </span><span class="s1">useGlobalLibvips = (logger) =&gt; {</span>
  <span class="s3">if </span><span class="s1">(Boolean(process.env.SHARP_IGNORE_GLOBAL_LIBVIPS) === </span><span class="s3">true</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">skipSearch(</span><span class="s3">false</span><span class="s1">, </span><span class="s2">'SHARP_IGNORE_GLOBAL_LIBVIPS'</span><span class="s1">, logger);</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(Boolean(process.env.SHARP_FORCE_GLOBAL_LIBVIPS) === </span><span class="s3">true</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">skipSearch(</span><span class="s3">true</span><span class="s1">, </span><span class="s2">'SHARP_FORCE_GLOBAL_LIBVIPS'</span><span class="s1">, logger);</span>
  <span class="s1">}</span>
  <span class="s0">/* istanbul ignore next */</span>
  <span class="s3">if </span><span class="s1">(isRosetta()) {</span>
    <span class="s3">return </span><span class="s1">skipSearch(</span><span class="s3">false</span><span class="s1">, </span><span class="s2">'Rosetta'</span><span class="s1">, logger);</span>
  <span class="s1">}</span>
  <span class="s3">const </span><span class="s1">globalVipsVersion = globalLibvipsVersion();</span>
  <span class="s3">return </span><span class="s1">!!globalVipsVersion &amp;&amp; </span><span class="s0">/* istanbul ignore next */</span>
    <span class="s1">semverGreaterThanOrEqualTo(globalVipsVersion, minimumLibvipsVersion);</span>
<span class="s1">};</span>

<span class="s1">module.exports = {</span>
  <span class="s1">minimumLibvipsVersion,</span>
  <span class="s1">prebuiltPlatforms,</span>
  <span class="s1">buildPlatformArch,</span>
  <span class="s1">buildSharpLibvipsIncludeDir,</span>
  <span class="s1">buildSharpLibvipsCPlusPlusDir,</span>
  <span class="s1">buildSharpLibvipsLibDir,</span>
  <span class="s1">isUnsupportedNodeRuntime,</span>
  <span class="s1">runtimePlatformArch,</span>
  <span class="s1">log,</span>
  <span class="s1">yarnLocator,</span>
  <span class="s1">spawnRebuild,</span>
  <span class="s1">globalLibvipsVersion,</span>
  <span class="s1">pkgConfigPath,</span>
  <span class="s1">useGlobalLibvips</span>
<span class="s1">};</span>
</pre>
</body>
</html>