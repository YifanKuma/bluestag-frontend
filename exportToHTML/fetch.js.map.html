<html>
<head>
<title>fetch.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
fetch.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../src/experimental/testmode/fetch.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import type {</span><span class="s3">\n  </span><span class="s1">ProxyFetchRequest,</span><span class="s3">\n  </span><span class="s1">ProxyFetchResponse,</span><span class="s3">\n  </span><span class="s1">ProxyResponse,</span><span class="s3">\n</span><span class="s1">} from './proxy'</span><span class="s3">\n</span><span class="s1">import { getTestReqInfo, type TestRequestReader } from './context'</span><span class="s3">\n\n</span><span class="s1">type Fetch = typeof fetch</span><span class="s3">\n</span><span class="s1">type FetchInputArg = Parameters&lt;Fetch&gt;[0]</span><span class="s3">\n</span><span class="s1">type FetchInitArg = Parameters&lt;Fetch&gt;[1]</span><span class="s3">\n\n</span><span class="s1">export const reader: TestRequestReader&lt;Request&gt; = {</span><span class="s3">\n  </span><span class="s1">url(req) {</span><span class="s3">\n    </span><span class="s1">return req.url</span><span class="s3">\n  </span><span class="s1">},</span><span class="s3">\n  </span><span class="s1">header(req, name) {</span><span class="s3">\n    </span><span class="s1">return req.headers.get(name)</span><span class="s3">\n  </span><span class="s1">},</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">function getTestStack(): string {</span><span class="s3">\n  </span><span class="s1">let stack = (new Error().stack ?? '').split('</span><span class="s3">\\</span><span class="s1">n')</span><span class="s3">\n  </span><span class="s1">// Skip the first line and find first non-empty line.</span><span class="s3">\n  </span><span class="s1">for (let i = 1; i &lt; stack.length; i++) {</span><span class="s3">\n    </span><span class="s1">if (stack[i].length &gt; 0) {</span><span class="s3">\n      </span><span class="s1">stack = stack.slice(i)</span><span class="s3">\n      </span><span class="s1">break</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">// Filter out franmework lines.</span><span class="s3">\n  </span><span class="s1">stack = stack.filter((f) =&gt; !f.includes('/next/dist/'))</span><span class="s3">\n  </span><span class="s1">// At most 5 lines.</span><span class="s3">\n  </span><span class="s1">stack = stack.slice(0, 5)</span><span class="s3">\n  </span><span class="s1">// Cleanup some internal info and trim.</span><span class="s3">\n  </span><span class="s1">stack = stack.map((s) =&gt; s.replace('webpack-internal:///(rsc)/', '').trim())</span><span class="s3">\n  </span><span class="s1">return stack.join('    ')</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">async function buildProxyRequest(</span><span class="s3">\n  </span><span class="s1">testData: string,</span><span class="s3">\n  </span><span class="s1">request: Request</span><span class="s3">\n</span><span class="s1">): Promise&lt;ProxyFetchRequest&gt; {</span><span class="s3">\n  </span><span class="s1">const {</span><span class="s3">\n    </span><span class="s1">url,</span><span class="s3">\n    </span><span class="s1">method,</span><span class="s3">\n    </span><span class="s1">headers,</span><span class="s3">\n    </span><span class="s1">body,</span><span class="s3">\n    </span><span class="s1">cache,</span><span class="s3">\n    </span><span class="s1">credentials,</span><span class="s3">\n    </span><span class="s1">integrity,</span><span class="s3">\n    </span><span class="s1">mode,</span><span class="s3">\n    </span><span class="s1">redirect,</span><span class="s3">\n    </span><span class="s1">referrer,</span><span class="s3">\n    </span><span class="s1">referrerPolicy,</span><span class="s3">\n  </span><span class="s1">} = request</span><span class="s3">\n  </span><span class="s1">return {</span><span class="s3">\n    </span><span class="s1">testData,</span><span class="s3">\n    </span><span class="s1">api: 'fetch',</span><span class="s3">\n    </span><span class="s1">request: {</span><span class="s3">\n      </span><span class="s1">url,</span><span class="s3">\n      </span><span class="s1">method,</span><span class="s3">\n      </span><span class="s1">headers: [...Array.from(headers), ['next-test-stack', getTestStack()]],</span><span class="s3">\n      </span><span class="s1">body: body</span><span class="s3">\n        </span><span class="s1">? Buffer.from(await request.arrayBuffer()).toString('base64')</span><span class="s3">\n        </span><span class="s1">: null,</span><span class="s3">\n      </span><span class="s1">cache,</span><span class="s3">\n      </span><span class="s1">credentials,</span><span class="s3">\n      </span><span class="s1">integrity,</span><span class="s3">\n      </span><span class="s1">mode,</span><span class="s3">\n      </span><span class="s1">redirect,</span><span class="s3">\n      </span><span class="s1">referrer,</span><span class="s3">\n      </span><span class="s1">referrerPolicy,</span><span class="s3">\n    </span><span class="s1">},</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">function buildResponse(proxyResponse: ProxyFetchResponse): Response {</span><span class="s3">\n  </span><span class="s1">const { status, headers, body } = proxyResponse.response</span><span class="s3">\n  </span><span class="s1">return new Response(body ? Buffer.from(body, 'base64') : null, {</span><span class="s3">\n    </span><span class="s1">status,</span><span class="s3">\n    </span><span class="s1">headers: new Headers(headers),</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">export async function handleFetch(</span><span class="s3">\n  </span><span class="s1">originalFetch: Fetch,</span><span class="s3">\n  </span><span class="s1">request: Request</span><span class="s3">\n</span><span class="s1">): Promise&lt;Response&gt; {</span><span class="s3">\n  </span><span class="s1">const testInfo = getTestReqInfo(request, reader)</span><span class="s3">\n  </span><span class="s1">if (!testInfo) {</span><span class="s3">\n    </span><span class="s1">// Passthrough non-test requests.</span><span class="s3">\n    </span><span class="s1">return originalFetch(request)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const { testData, proxyPort } = testInfo</span><span class="s3">\n  </span><span class="s1">const proxyRequest = await buildProxyRequest(testData, request)</span><span class="s3">\n\n  </span><span class="s1">const resp = await originalFetch(`http://localhost:${proxyPort}`, {</span><span class="s3">\n    </span><span class="s1">method: 'POST',</span><span class="s3">\n    </span><span class="s1">body: JSON.stringify(proxyRequest),</span><span class="s3">\n    </span><span class="s1">next: {</span><span class="s3">\n      </span><span class="s1">// @ts-ignore</span><span class="s3">\n      </span><span class="s1">internal: true,</span><span class="s3">\n    </span><span class="s1">},</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n  </span><span class="s1">if (!resp.ok) {</span><span class="s3">\n    </span><span class="s1">throw new Error(`Proxy request failed: ${resp.status}`)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const proxyResponse = (await resp.json()) as ProxyResponse</span><span class="s3">\n  </span><span class="s1">const { api } = proxyResponse</span><span class="s3">\n  </span><span class="s1">switch (api) {</span><span class="s3">\n    </span><span class="s1">case 'continue':</span><span class="s3">\n      </span><span class="s1">return originalFetch(request)</span><span class="s3">\n    </span><span class="s1">case 'abort':</span><span class="s3">\n    </span><span class="s1">case 'unhandled':</span><span class="s3">\n      </span><span class="s1">throw new Error(</span><span class="s3">\n        </span><span class="s1">`Proxy request aborted [${request.method} ${request.url}]`</span><span class="s3">\n      </span><span class="s1">)</span><span class="s3">\n    </span><span class="s1">case 'fetch':</span><span class="s3">\n      </span><span class="s1">return buildResponse(proxyResponse)</span><span class="s3">\n    </span><span class="s1">default:</span><span class="s3">\n      </span><span class="s1">return api satisfies never</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">export function interceptFetch(originalFetch: Fetch) {</span><span class="s3">\n  </span><span class="s1">global.fetch = function testFetch(</span><span class="s3">\n    </span><span class="s1">input: FetchInputArg,</span><span class="s3">\n    </span><span class="s1">init?: FetchInitArg</span><span class="s3">\n  </span><span class="s1">): Promise&lt;Response&gt; {</span><span class="s3">\n    </span><span class="s1">// Passthrough internal requests.</span><span class="s3">\n    </span><span class="s1">// @ts-ignore</span><span class="s3">\n    </span><span class="s1">if (init?.next?.internal) {</span><span class="s3">\n      </span><span class="s1">return originalFetch(input, init)</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">return handleFetch(originalFetch, new Request(input, init))</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">return () =&gt; {</span><span class="s3">\n    </span><span class="s1">global.fetch = originalFetch</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;handleFetch&quot;</span><span class="s0">,</span><span class="s1">&quot;interceptFetch&quot;</span><span class="s0">,</span><span class="s1">&quot;reader&quot;</span><span class="s0">,</span><span class="s1">&quot;url&quot;</span><span class="s0">,</span><span class="s1">&quot;req&quot;</span><span class="s0">,</span><span class="s1">&quot;header&quot;</span><span class="s0">,</span><span class="s1">&quot;name&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;get&quot;</span><span class="s0">,</span><span class="s1">&quot;getTestStack&quot;</span><span class="s0">,</span><span class="s1">&quot;stack&quot;</span><span class="s0">,</span><span class="s1">&quot;Error&quot;</span><span class="s0">,</span><span class="s1">&quot;split&quot;</span><span class="s0">,</span><span class="s1">&quot;i&quot;</span><span class="s0">,</span><span class="s1">&quot;length&quot;</span><span class="s0">,</span><span class="s1">&quot;slice&quot;</span><span class="s0">,</span><span class="s1">&quot;filter&quot;</span><span class="s0">,</span><span class="s1">&quot;f&quot;</span><span class="s0">,</span><span class="s1">&quot;includes&quot;</span><span class="s0">,</span><span class="s1">&quot;map&quot;</span><span class="s0">,</span><span class="s1">&quot;s&quot;</span><span class="s0">,</span><span class="s1">&quot;replace&quot;</span><span class="s0">,</span><span class="s1">&quot;trim&quot;</span><span class="s0">,</span><span class="s1">&quot;join&quot;</span><span class="s0">,</span><span class="s1">&quot;buildProxyRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;testData&quot;</span><span class="s0">,</span><span class="s1">&quot;request&quot;</span><span class="s0">,</span><span class="s1">&quot;method&quot;</span><span class="s0">,</span><span class="s1">&quot;body&quot;</span><span class="s0">,</span><span class="s1">&quot;cache&quot;</span><span class="s0">,</span><span class="s1">&quot;credentials&quot;</span><span class="s0">,</span><span class="s1">&quot;integrity&quot;</span><span class="s0">,</span><span class="s1">&quot;mode&quot;</span><span class="s0">,</span><span class="s1">&quot;redirect&quot;</span><span class="s0">,</span><span class="s1">&quot;referrer&quot;</span><span class="s0">,</span><span class="s1">&quot;referrerPolicy&quot;</span><span class="s0">,</span><span class="s1">&quot;api&quot;</span><span class="s0">,</span><span class="s1">&quot;Array&quot;</span><span class="s0">,</span><span class="s1">&quot;from&quot;</span><span class="s0">,</span><span class="s1">&quot;Buffer&quot;</span><span class="s0">,</span><span class="s1">&quot;arrayBuffer&quot;</span><span class="s0">,</span><span class="s1">&quot;toString&quot;</span><span class="s0">,</span><span class="s1">&quot;buildResponse&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyResponse&quot;</span><span class="s0">,</span><span class="s1">&quot;status&quot;</span><span class="s0">,</span><span class="s1">&quot;response&quot;</span><span class="s0">,</span><span class="s1">&quot;Response&quot;</span><span class="s0">,</span><span class="s1">&quot;Headers&quot;</span><span class="s0">,</span><span class="s1">&quot;originalFetch&quot;</span><span class="s0">,</span><span class="s1">&quot;testInfo&quot;</span><span class="s0">,</span><span class="s1">&quot;getTestReqInfo&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyPort&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;resp&quot;</span><span class="s0">,</span><span class="s1">&quot;JSON&quot;</span><span class="s0">,</span><span class="s1">&quot;stringify&quot;</span><span class="s0">,</span><span class="s1">&quot;next&quot;</span><span class="s0">,</span><span class="s1">&quot;internal&quot;</span><span class="s0">,</span><span class="s1">&quot;ok&quot;</span><span class="s0">,</span><span class="s1">&quot;json&quot;</span><span class="s0">,</span><span class="s1">&quot;global&quot;</span><span class="s0">,</span><span class="s1">&quot;fetch&quot;</span><span class="s0">,</span><span class="s1">&quot;testFetch&quot;</span><span class="s0">,</span><span class="s1">&quot;input&quot;</span><span class="s0">,</span><span class="s1">&quot;init&quot;</span><span class="s0">,</span><span class="s1">&quot;Request&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;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&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>