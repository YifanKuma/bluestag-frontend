<html>
<head>
<title>get-amp-html-validator.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
get-amp-html-validator.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../src/export/helpers/get-amp-html-validator.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import AmpHtmlValidator, {</span><span class="s3">\n  </span><span class="s1">type Validator,</span><span class="s3">\n</span><span class="s1">} from 'next/dist/compiled/amphtml-validator'</span><span class="s3">\n\n</span><span class="s1">const instancePromises = new Map&lt;string | undefined, Promise&lt;Validator&gt;&gt;()</span><span class="s3">\n\n</span><span class="s1">/**</span><span class="s3">\n </span><span class="s1">* `AmpHtmlValidator.getInstance` is buggy when multiple calls to getInstance occur in parallel.</span><span class="s3">\n </span><span class="s1">* This wrapper is a workaround for that.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* `AmpHtmlValidator.getInstance(validatorPath)` attempts to re-use the instances across multiple calls</span><span class="s3">\n </span><span class="s1">* by stashing existing instances in `instanceByValidatorJs`.</span><span class="s3">\n </span><span class="s1">* However, when creating a fresh instance, it is added to `instanceByValidatorJs` before `instance.init()` is finished:</span><span class="s3">\n </span><span class="s1">* https://github.com/ampproject/amphtml/blob/0c8eaba73ca8f5c462a642fa91901a29e6304f6e/validator/js/nodejs/index.js#L309-L313</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* which means that, if a concurrent call to `AmpHtmlValidator.getInstance(validatorPath)` happens before the original `init()` is done,</span><span class="s3">\n </span><span class="s1">* then we'll get back an uninitialized or partially initialized instance:</span><span class="s3">\n </span><span class="s1">* https://github.com/ampproject/amphtml/blob/0c8eaba73ca8f5c462a642fa91901a29e6304f6e/validator/js/nodejs/index.js#L292-L294</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* And, since `instance.init()` is the part that handles loading the webassembly code, this race results in</span><span class="s3">\n </span><span class="s1">* the dreaded </span><span class="s3">\&quot;</span><span class="s1">AssertionError: Assertion failed: WebAssembly is uninitialized</span><span class="s3">\&quot; </span><span class="s1">error.</span><span class="s3">\n </span><span class="s1">* As a workaround, we properly dedupe instance creation on our own.</span><span class="s3">\n </span><span class="s1">* */</span><span class="s3">\n</span><span class="s1">export function getAmpValidatorInstance(</span><span class="s3">\n  </span><span class="s1">validatorPath: string | undefined</span><span class="s3">\n</span><span class="s1">): Promise&lt;Validator&gt; {</span><span class="s3">\n  </span><span class="s1">let promise = instancePromises.get(validatorPath)</span><span class="s3">\n  </span><span class="s1">if (!promise) {</span><span class="s3">\n    </span><span class="s1">// NOTE: if `validatorPath` is undefined, `AmpHtmlValidator` will load the code from its default URL</span><span class="s3">\n    </span><span class="s1">promise = AmpHtmlValidator.getInstance(validatorPath)</span><span class="s3">\n    </span><span class="s1">instancePromises.set(validatorPath, promise)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">return promise</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">export function getBundledAmpValidatorFilepath() {</span><span class="s3">\n  </span><span class="s1">return require.resolve(</span><span class="s3">\n    </span><span class="s1">'next/dist/compiled/amphtml-validator/validator_wasm.js'</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;getAmpValidatorInstance&quot;</span><span class="s0">,</span><span class="s1">&quot;getBundledAmpValidatorFilepath&quot;</span><span class="s0">,</span><span class="s1">&quot;instancePromises&quot;</span><span class="s0">,</span><span class="s1">&quot;Map&quot;</span><span class="s0">,</span><span class="s1">&quot;validatorPath&quot;</span><span class="s0">,</span><span class="s1">&quot;promise&quot;</span><span class="s0">,</span><span class="s1">&quot;get&quot;</span><span class="s0">,</span><span class="s1">&quot;AmpHtmlValidator&quot;</span><span class="s0">,</span><span class="s1">&quot;getInstance&quot;</span><span class="s0">,</span><span class="s1">&quot;set&quot;</span><span class="s0">,</span><span class="s1">&quot;require&quot;</span><span class="s0">,</span><span class="s1">&quot;resolve&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;;;;;;;;;;;;IAuBgBA,uBAAuB;eAAvBA;;IAYAC,8BAA8B;eAA9BA;;;yEAjCT;;;;;;AAEP,MAAMC,mBAAmB,IAAIC;AAmBtB,SAASH,wBACdI,aAAiC;IAEjC,IAAIC,UAAUH,iBAAiBI,GAAG,CAACF;IACnC,IAAI,CAACC,SAAS;QACZ,oGAAoG;QACpGA,UAAUE,yBAAgB,CAACC,WAAW,CAACJ;QACvCF,iBAAiBO,GAAG,CAACL,eAAeC;IACtC;IACA,OAAOA;AACT;AAEO,SAASJ;IACd,OAAOS,QAAQC,OAAO,CACpB;AAEJ&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>