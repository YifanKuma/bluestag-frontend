<html>
<head>
<title>PanSession.mjs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
PanSession.mjs</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">{ frame, isPrimaryPointer, cancelFrame, frameData } from </span><span class="s2">'motion-dom'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ pipe, secondsToMilliseconds, millisecondsToSeconds } from </span><span class="s2">'motion-utils'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ addPointerEvent } from </span><span class="s2">'../../events/add-pointer-event.mjs'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ extractEventInfo } from </span><span class="s2">'../../events/event-info.mjs'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ distance2D } from </span><span class="s2">'../../utils/distance.mjs'</span><span class="s1">;</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@internal</span>
 <span class="s3">*/</span>
<span class="s0">class </span><span class="s1">PanSession {</span>
    <span class="s1">constructor(event, handlers, { transformPagePoint, contextWindow = window, dragSnapToOrigin = </span><span class="s0">false</span><span class="s1">, distanceThreshold = </span><span class="s5">3</span><span class="s1">, } = {}) {</span>
        <span class="s3">/**</span>
         <span class="s3">* </span><span class="s4">@internal</span>
         <span class="s3">*/</span>
        <span class="s0">this</span><span class="s1">.startEvent = </span><span class="s0">null</span><span class="s1">;</span>
        <span class="s3">/**</span>
         <span class="s3">* </span><span class="s4">@internal</span>
         <span class="s3">*/</span>
        <span class="s0">this</span><span class="s1">.lastMoveEvent = </span><span class="s0">null</span><span class="s1">;</span>
        <span class="s3">/**</span>
         <span class="s3">* </span><span class="s4">@internal</span>
         <span class="s3">*/</span>
        <span class="s0">this</span><span class="s1">.lastMoveEventInfo = </span><span class="s0">null</span><span class="s1">;</span>
        <span class="s3">/**</span>
         <span class="s3">* </span><span class="s4">@internal</span>
         <span class="s3">*/</span>
        <span class="s0">this</span><span class="s1">.handlers = {};</span>
        <span class="s3">/**</span>
         <span class="s3">* </span><span class="s4">@internal</span>
         <span class="s3">*/</span>
        <span class="s0">this</span><span class="s1">.contextWindow = window;</span>
        <span class="s0">this</span><span class="s1">.updatePoint = () =&gt; {</span>
            <span class="s0">if </span><span class="s1">(!(</span><span class="s0">this</span><span class="s1">.lastMoveEvent &amp;&amp; </span><span class="s0">this</span><span class="s1">.lastMoveEventInfo))</span>
                <span class="s0">return</span><span class="s1">;</span>
            <span class="s0">const </span><span class="s1">info = getPanInfo(</span><span class="s0">this</span><span class="s1">.lastMoveEventInfo, </span><span class="s0">this</span><span class="s1">.history);</span>
            <span class="s0">const </span><span class="s1">isPanStarted = </span><span class="s0">this</span><span class="s1">.startEvent !== </span><span class="s0">null</span><span class="s1">;</span>
            <span class="s3">// Only start panning if the offset is larger than 3 pixels. If we make it</span>
            <span class="s3">// any larger than this we'll want to reset the pointer history</span>
            <span class="s3">// on the first update to avoid visual snapping to the cursor.</span>
            <span class="s0">const </span><span class="s1">isDistancePastThreshold = distance2D(info.offset, { x: </span><span class="s5">0</span><span class="s1">, y: </span><span class="s5">0 </span><span class="s1">}) &gt;= </span><span class="s0">this</span><span class="s1">.distanceThreshold;</span>
            <span class="s0">if </span><span class="s1">(!isPanStarted &amp;&amp; !isDistancePastThreshold)</span>
                <span class="s0">return</span><span class="s1">;</span>
            <span class="s0">const </span><span class="s1">{ point } = info;</span>
            <span class="s0">const </span><span class="s1">{ timestamp } = frameData;</span>
            <span class="s0">this</span><span class="s1">.history.push({ ...point, timestamp });</span>
            <span class="s0">const </span><span class="s1">{ onStart, onMove } = </span><span class="s0">this</span><span class="s1">.handlers;</span>
            <span class="s0">if </span><span class="s1">(!isPanStarted) {</span>
                <span class="s1">onStart &amp;&amp; onStart(</span><span class="s0">this</span><span class="s1">.lastMoveEvent, info);</span>
                <span class="s0">this</span><span class="s1">.startEvent = </span><span class="s0">this</span><span class="s1">.lastMoveEvent;</span>
            <span class="s1">}</span>
            <span class="s1">onMove &amp;&amp; onMove(</span><span class="s0">this</span><span class="s1">.lastMoveEvent, info);</span>
        <span class="s1">};</span>
        <span class="s0">this</span><span class="s1">.handlePointerMove = (event, info) =&gt; {</span>
            <span class="s0">this</span><span class="s1">.lastMoveEvent = event;</span>
            <span class="s0">this</span><span class="s1">.lastMoveEventInfo = transformPoint(info, </span><span class="s0">this</span><span class="s1">.transformPagePoint);</span>
            <span class="s3">// Throttle mouse move event to once per frame</span>
            <span class="s1">frame.update(</span><span class="s0">this</span><span class="s1">.updatePoint, </span><span class="s0">true</span><span class="s1">);</span>
        <span class="s1">};</span>
        <span class="s0">this</span><span class="s1">.handlePointerUp = (event, info) =&gt; {</span>
            <span class="s0">this</span><span class="s1">.end();</span>
            <span class="s0">const </span><span class="s1">{ onEnd, onSessionEnd, resumeAnimation } = </span><span class="s0">this</span><span class="s1">.handlers;</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.dragSnapToOrigin)</span>
                <span class="s1">resumeAnimation &amp;&amp; resumeAnimation();</span>
            <span class="s0">if </span><span class="s1">(!(</span><span class="s0">this</span><span class="s1">.lastMoveEvent &amp;&amp; </span><span class="s0">this</span><span class="s1">.lastMoveEventInfo))</span>
                <span class="s0">return</span><span class="s1">;</span>
            <span class="s0">const </span><span class="s1">panInfo = getPanInfo(event.type === </span><span class="s2">&quot;pointercancel&quot;</span>
                <span class="s1">? </span><span class="s0">this</span><span class="s1">.lastMoveEventInfo</span>
                <span class="s1">: transformPoint(info, </span><span class="s0">this</span><span class="s1">.transformPagePoint), </span><span class="s0">this</span><span class="s1">.history);</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.startEvent &amp;&amp; onEnd) {</span>
                <span class="s1">onEnd(event, panInfo);</span>
            <span class="s1">}</span>
            <span class="s1">onSessionEnd &amp;&amp; onSessionEnd(event, panInfo);</span>
        <span class="s1">};</span>
        <span class="s3">// If we have more than one touch, don't start detecting this gesture</span>
        <span class="s0">if </span><span class="s1">(!isPrimaryPointer(event))</span>
            <span class="s0">return</span><span class="s1">;</span>
        <span class="s0">this</span><span class="s1">.dragSnapToOrigin = dragSnapToOrigin;</span>
        <span class="s0">this</span><span class="s1">.handlers = handlers;</span>
        <span class="s0">this</span><span class="s1">.transformPagePoint = transformPagePoint;</span>
        <span class="s0">this</span><span class="s1">.distanceThreshold = distanceThreshold;</span>
        <span class="s0">this</span><span class="s1">.contextWindow = contextWindow || window;</span>
        <span class="s0">const </span><span class="s1">info = extractEventInfo(event);</span>
        <span class="s0">const </span><span class="s1">initialInfo = transformPoint(info, </span><span class="s0">this</span><span class="s1">.transformPagePoint);</span>
        <span class="s0">const </span><span class="s1">{ point } = initialInfo;</span>
        <span class="s0">const </span><span class="s1">{ timestamp } = frameData;</span>
        <span class="s0">this</span><span class="s1">.history = [{ ...point, timestamp }];</span>
        <span class="s0">const </span><span class="s1">{ onSessionStart } = handlers;</span>
        <span class="s1">onSessionStart &amp;&amp;</span>
            <span class="s1">onSessionStart(event, getPanInfo(initialInfo, </span><span class="s0">this</span><span class="s1">.history));</span>
        <span class="s0">this</span><span class="s1">.removeListeners = pipe(addPointerEvent(</span><span class="s0">this</span><span class="s1">.contextWindow, </span><span class="s2">&quot;pointermove&quot;</span><span class="s1">, </span><span class="s0">this</span><span class="s1">.handlePointerMove), addPointerEvent(</span><span class="s0">this</span><span class="s1">.contextWindow, </span><span class="s2">&quot;pointerup&quot;</span><span class="s1">, </span><span class="s0">this</span><span class="s1">.handlePointerUp), addPointerEvent(</span><span class="s0">this</span><span class="s1">.contextWindow, </span><span class="s2">&quot;pointercancel&quot;</span><span class="s1">, </span><span class="s0">this</span><span class="s1">.handlePointerUp));</span>
    <span class="s1">}</span>
    <span class="s1">updateHandlers(handlers) {</span>
        <span class="s0">this</span><span class="s1">.handlers = handlers;</span>
    <span class="s1">}</span>
    <span class="s1">end() {</span>
        <span class="s0">this</span><span class="s1">.removeListeners &amp;&amp; </span><span class="s0">this</span><span class="s1">.removeListeners();</span>
        <span class="s1">cancelFrame(</span><span class="s0">this</span><span class="s1">.updatePoint);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">transformPoint(info, transformPagePoint) {</span>
    <span class="s0">return </span><span class="s1">transformPagePoint ? { point: transformPagePoint(info.point) } : info;</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">subtractPoint(a, b) {</span>
    <span class="s0">return </span><span class="s1">{ x: a.x - b.x, y: a.y - b.y };</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">getPanInfo({ point }, history) {</span>
    <span class="s0">return </span><span class="s1">{</span>
        <span class="s1">point,</span>
        <span class="s1">delta: subtractPoint(point, lastDevicePoint(history)),</span>
        <span class="s1">offset: subtractPoint(point, startDevicePoint(history)),</span>
        <span class="s1">velocity: getVelocity(history, </span><span class="s5">0.1</span><span class="s1">),</span>
    <span class="s1">};</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">startDevicePoint(history) {</span>
    <span class="s0">return </span><span class="s1">history[</span><span class="s5">0</span><span class="s1">];</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">lastDevicePoint(history) {</span>
    <span class="s0">return </span><span class="s1">history[history.length - </span><span class="s5">1</span><span class="s1">];</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">getVelocity(history, timeDelta) {</span>
    <span class="s0">if </span><span class="s1">(history.length &lt; </span><span class="s5">2</span><span class="s1">) {</span>
        <span class="s0">return </span><span class="s1">{ x: </span><span class="s5">0</span><span class="s1">, y: </span><span class="s5">0 </span><span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s0">let </span><span class="s1">i = history.length - </span><span class="s5">1</span><span class="s1">;</span>
    <span class="s0">let </span><span class="s1">timestampedPoint = </span><span class="s0">null</span><span class="s1">;</span>
    <span class="s0">const </span><span class="s1">lastPoint = lastDevicePoint(history);</span>
    <span class="s0">while </span><span class="s1">(i &gt;= </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s1">timestampedPoint = history[i];</span>
        <span class="s0">if </span><span class="s1">(lastPoint.timestamp - timestampedPoint.timestamp &gt;</span>
            <span class="s1">secondsToMilliseconds(timeDelta)) {</span>
            <span class="s0">break</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s1">i--;</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">(!timestampedPoint) {</span>
        <span class="s0">return </span><span class="s1">{ x: </span><span class="s5">0</span><span class="s1">, y: </span><span class="s5">0 </span><span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s0">const </span><span class="s1">time = millisecondsToSeconds(lastPoint.timestamp - timestampedPoint.timestamp);</span>
    <span class="s0">if </span><span class="s1">(time === </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s0">return </span><span class="s1">{ x: </span><span class="s5">0</span><span class="s1">, y: </span><span class="s5">0 </span><span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s0">const </span><span class="s1">currentVelocity = {</span>
        <span class="s1">x: (lastPoint.x - timestampedPoint.x) / time,</span>
        <span class="s1">y: (lastPoint.y - timestampedPoint.y) / time,</span>
    <span class="s1">};</span>
    <span class="s0">if </span><span class="s1">(currentVelocity.x === Infinity) {</span>
        <span class="s1">currentVelocity.x = </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">(currentVelocity.y === Infinity) {</span>
        <span class="s1">currentVelocity.y = </span><span class="s5">0</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">currentVelocity;</span>
<span class="s1">}</span>

<span class="s0">export </span><span class="s1">{ PanSession };</span>
</pre>
</body>
</html>