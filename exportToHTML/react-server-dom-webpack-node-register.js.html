<html>
<head>
<title>react-server-dom-webpack-node-register.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #067d17;}
.s4 { color: #0033b3;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
react-server-dom-webpack-node-register.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@license </span><span class="s0">React</span>
 <span class="s0">* react-server-dom-webpack-node-register.js</span>
 <span class="s0">*</span>
 <span class="s0">* Copyright (c) Meta Platforms, Inc. and affiliates.</span>
 <span class="s0">*</span>
 <span class="s0">* This source code is licensed under the MIT license found in the</span>
 <span class="s0">* LICENSE file in the root directory of this source tree.</span>
 <span class="s0">*/</span>

<span class="s3">&quot;use strict&quot;</span><span class="s2">;</span>
<span class="s4">const </span><span class="s2">acorn = require(</span><span class="s3">&quot;acorn-loose&quot;</span><span class="s2">),</span>
  <span class="s2">url = require(</span><span class="s3">&quot;url&quot;</span><span class="s2">),</span>
  <span class="s2">Module = require(</span><span class="s3">&quot;module&quot;</span><span class="s2">);</span>
<span class="s2">module.exports = </span><span class="s4">function </span><span class="s2">() {</span>
  <span class="s4">const </span><span class="s2">Server = require(</span><span class="s3">&quot;react-server-dom-webpack/server&quot;</span><span class="s2">),</span>
    <span class="s2">registerServerReference = Server.registerServerReference,</span>
    <span class="s2">createClientModuleProxy = Server.createClientModuleProxy,</span>
    <span class="s2">originalCompile = Module.prototype._compile;</span>
  <span class="s2">Module.prototype._compile = </span><span class="s4">function </span><span class="s2">(content, filename) {</span>
    <span class="s4">if </span><span class="s2">(</span>
      <span class="s2">-</span><span class="s5">1 </span><span class="s2">=== content.indexOf(</span><span class="s3">&quot;use client&quot;</span><span class="s2">) &amp;&amp;</span>
      <span class="s2">-</span><span class="s5">1 </span><span class="s2">=== content.indexOf(</span><span class="s3">&quot;use server&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
      <span class="s4">return </span><span class="s2">originalCompile.apply(</span><span class="s4">this</span><span class="s2">, arguments);</span>
    <span class="s4">try </span><span class="s2">{</span>
      <span class="s4">var </span><span class="s2">body = acorn.parse(content, {</span>
        <span class="s2">ecmaVersion: </span><span class="s3">&quot;2024&quot;</span><span class="s2">,</span>
        <span class="s2">sourceType: </span><span class="s3">&quot;source&quot;</span>
      <span class="s2">}).body;</span>
    <span class="s2">} </span><span class="s4">catch </span><span class="s2">(x) {</span>
      <span class="s4">return </span><span class="s2">(</span>
        <span class="s2">console.error(</span><span class="s3">&quot;Error parsing %s %s&quot;</span><span class="s2">, url, x.message),</span>
        <span class="s2">originalCompile.apply(</span><span class="s4">this</span><span class="s2">, arguments)</span>
      <span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s4">var </span><span class="s2">useClient = !</span><span class="s5">1</span><span class="s2">,</span>
      <span class="s2">useServer = !</span><span class="s5">1</span><span class="s2">;</span>
    <span class="s4">for </span><span class="s2">(</span><span class="s4">var </span><span class="s2">i = </span><span class="s5">0</span><span class="s2">; i &lt; body.length; i++) {</span>
      <span class="s4">var </span><span class="s2">node = body[i];</span>
      <span class="s4">if </span><span class="s2">(</span><span class="s3">&quot;ExpressionStatement&quot; </span><span class="s2">!== node.type || !node.directive) </span><span class="s4">break</span><span class="s2">;</span>
      <span class="s3">&quot;use client&quot; </span><span class="s2">=== node.directive &amp;&amp; (useClient = !</span><span class="s5">0</span><span class="s2">);</span>
      <span class="s3">&quot;use server&quot; </span><span class="s2">=== node.directive &amp;&amp; (useServer = !</span><span class="s5">0</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s4">if </span><span class="s2">(!useClient &amp;&amp; !useServer) </span><span class="s4">return </span><span class="s2">originalCompile.apply(</span><span class="s4">this</span><span class="s2">, arguments);</span>
    <span class="s4">if </span><span class="s2">(useClient &amp;&amp; useServer)</span>
      <span class="s4">throw </span><span class="s2">Error(</span>
        <span class="s3">'Cannot have both &quot;use client&quot; and &quot;use server&quot; directives in the same file.'</span>
      <span class="s2">);</span>
    <span class="s2">useClient &amp;&amp;</span>
      <span class="s2">((body = url.pathToFileURL(filename).href),</span>
      <span class="s2">(</span><span class="s4">this</span><span class="s2">.exports = createClientModuleProxy(body)));</span>
    <span class="s4">if </span><span class="s2">(useServer)</span>
      <span class="s4">if </span><span class="s2">(</span>
        <span class="s2">(originalCompile.apply(</span><span class="s4">this</span><span class="s2">, arguments),</span>
        <span class="s2">(useServer = url.pathToFileURL(filename).href),</span>
        <span class="s2">(body = </span><span class="s4">this</span><span class="s2">.exports),</span>
        <span class="s3">&quot;function&quot; </span><span class="s2">=== </span><span class="s4">typeof </span><span class="s2">body)</span>
      <span class="s2">)</span>
        <span class="s2">registerServerReference(body, useServer, </span><span class="s4">null</span><span class="s2">);</span>
      <span class="s4">else</span>
        <span class="s4">for </span><span class="s2">(useClient = Object.keys(body), i = </span><span class="s5">0</span><span class="s2">; i &lt; useClient.length; i++) {</span>
          <span class="s2">node = useClient[i];</span>
          <span class="s4">const </span><span class="s2">value = body[useClient[i]];</span>
          <span class="s3">&quot;function&quot; </span><span class="s2">=== </span><span class="s4">typeof </span><span class="s2">value &amp;&amp;</span>
            <span class="s2">registerServerReference(value, useServer, node);</span>
        <span class="s2">}</span>
  <span class="s2">};</span>
<span class="s2">};</span>
</pre>
</body>
</html>