<html>
<head>
<title>update-metadata-from-google-metadata.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #264eff;}
.s5 { color: #1750eb;}
.s6 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
update-metadata-from-google-metadata.js</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">fs from </span><span class="s2">'fs'</span>
<span class="s0">import </span><span class="s1">semver from </span><span class="s2">'semver'</span>

<span class="s0">import </span><span class="s1">exec from </span><span class="s2">'./exec.js'</span>

<span class="s3">// Checks if Google's metadata XML file has changes, and, if it has,</span>
<span class="s3">// generates JSON metadata files from it, runs the tests and updates `CHANGELOG.md`.</span>
<span class="s0">export default function</span><span class="s1">(googleMetadataFilePath, metadataInfoFilePath)</span>
<span class="s1">{</span>
	<span class="s0">let </span><span class="s1">metadata_changed = exec(</span><span class="s2">`git ls-files --modified </span><span class="s1">${googleMetadataFilePath}</span><span class="s2">`</span><span class="s1">)</span>

	<span class="s0">if </span><span class="s1">(!metadata_changed)</span>
	<span class="s1">{</span>
		<span class="s1">console.log()</span>
		<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
		<span class="s1">console.log(</span><span class="s2">'=   Metadata is up-to-date. Exiting.   ='</span><span class="s1">)</span>
		<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
		<span class="s1">console.log()</span>

		<span class="s0">return</span>
	<span class="s1">}</span>

	<span class="s1">console.log()</span>
	<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
	<span class="s1">console.log(</span><span class="s2">'= Metadata has changed, updating files ='</span><span class="s1">)</span>
	<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
	<span class="s1">console.log()</span>

	<span class="s1">console.log(exec(</span><span class="s2">'npm run metadata:generate'</span><span class="s1">))</span>

	<span class="s1">console.log()</span>
	<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
	<span class="s1">console.log(</span><span class="s2">'=             Running tests            ='</span><span class="s1">)</span>
	<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
	<span class="s1">console.log()</span>

	<span class="s3">// console.log('* Actually not running tests because if they fail then it won\'t be reported in any way, and if instead tests fail for the Pull Request on github then the repo owner will be notified by Travis CI about that.')</span>
	<span class="s1">console.log(exec(</span><span class="s2">'npm run build'</span><span class="s1">))</span>
	<span class="s1">console.log(exec(</span><span class="s2">'npm test'</span><span class="s1">))</span>

	<span class="s0">let </span><span class="s1">modified_files = exec(</span><span class="s2">'git ls-files --modified'</span><span class="s1">).split(</span><span class="s4">/\s/</span><span class="s1">)</span>

	<span class="s0">let </span><span class="s1">unexpected_modified_files = modified_files.filter(</span><span class="s0">function</span><span class="s1">(file)</span>
	<span class="s1">{</span>
		<span class="s0">return </span><span class="s1">file !== googleMetadataFilePath &amp;&amp;</span>
			<span class="s1">!</span><span class="s4">/^metadata\.[a-z]+\.json$/</span><span class="s1">.test(file) &amp;&amp;</span>
			<span class="s1">!</span><span class="s4">/^examples\.[a-z]+\.json$/</span><span class="s1">.test(file)</span>
	<span class="s1">})</span>

	<span class="s3">// Turned off this &quot;modified files&quot; check</span>
	<span class="s3">// because on Windows random files constantly got &quot;modified&quot;</span>
	<span class="s3">// without actually being modified.</span>
	<span class="s3">// (perhaps something related to line endings)</span>
	<span class="s0">if </span><span class="s1">(</span><span class="s0">false </span><span class="s1">&amp;&amp; unexpected_modified_files.length &gt; </span><span class="s5">0</span><span class="s1">)</span>
	<span class="s1">{</span>
		<span class="s0">let </span><span class="s1">error</span>

		<span class="s1">error += </span><span class="s2">'Only `' </span><span class="s1">+ googleMetadataFilePath + </span><span class="s2">'`, `metadata.*.json` and `examples.*.json` files should be modified. Unexpected modified files:'</span>
		<span class="s1">error += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
		<span class="s1">error += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
		<span class="s1">error += unexpected_modified_files.join(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s1">)</span>

		<span class="s1">console.log()</span>
		<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
		<span class="s1">console.log(</span><span class="s2">'=                 Error                ='</span><span class="s1">)</span>
		<span class="s1">console.log(</span><span class="s2">'========================================'</span><span class="s1">)</span>
		<span class="s1">console.log()</span>
		<span class="s1">console.log(error)</span>

		<span class="s0">throw new </span><span class="s1">Error(error)</span>
	<span class="s1">}</span>

	<span class="s3">// Doesn't work</span>
	<span class="s3">//</span>
	<span class="s3">// // http://stackoverflow.com/questions/33610682/git-list-of-staged-files</span>
	<span class="s3">// let staged_files = exec('git diff --name-only --cached').split(/\s/)</span>
	<span class="s3">//</span>
	<span class="s3">// if (staged_files.length &gt; 0)</span>
	<span class="s3">// {</span>
	<span class="s3">//  console.log()</span>
	<span class="s3">//  console.log('========================================')</span>
	<span class="s3">//  console.log('=                 Error                =')</span>
	<span class="s3">//  console.log('========================================')</span>
	<span class="s3">//  console.log()</span>
	<span class="s3">//  console.log('There are some staged files already. Aborting metadata update process.')</span>
	<span class="s3">//  console.log()</span>
	<span class="s3">//  console.log(staged_files.join('\n'))</span>
	<span class="s3">//</span>
	<span class="s3">//  process.exit(1)</span>
	<span class="s3">// }</span>

	<span class="s3">// Add an entry in `CHANGELOG.md`.</span>
	<span class="s1">addMetadataUpdateChangelogEntry(metadataInfoFilePath)</span>

	<span class="s0">return true</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">addMetadataUpdateChangelogEntry(metadataInfoFilePath) {</span>
	<span class="s0">const </span><span class="s1">{</span>
		<span class="s1">version: metadataVersion,</span>
		<span class="s1">changes: metadataChanges</span>
	<span class="s1">} = JSON.parse(fs.readFileSync(metadataInfoFilePath, </span><span class="s2">'utf8'</span><span class="s1">))</span>

	<span class="s0">const </span><span class="s1">packageVersion = JSON.parse(fs.readFileSync(</span><span class="s2">'./package.json'</span><span class="s1">, </span><span class="s2">'utf8'</span><span class="s1">)).version</span>
	<span class="s0">const </span><span class="s1">nextPackageVersion = semver.inc(packageVersion, </span><span class="s2">'patch'</span><span class="s1">)</span>

	<span class="s0">const </span><span class="s1">now = </span><span class="s0">new </span><span class="s1">Date()</span>

	<span class="s0">let </span><span class="s1">changesLog = </span><span class="s2">''</span>
	<span class="s1">changesLog += </span><span class="s2">`</span><span class="s1">${nextPackageVersion} </span><span class="s2">/ </span><span class="s1">${now.getDate()}</span><span class="s2">.</span><span class="s1">${now.getMonth() + </span><span class="s5">1</span><span class="s1">}</span><span class="s2">.</span><span class="s1">${now.getFullYear()}</span><span class="s2">`</span>
	<span class="s1">changesLog += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
	<span class="s1">changesLog += </span><span class="s2">'==================='</span>
	<span class="s1">changesLog += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
	<span class="s1">changesLog += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
	<span class="s1">changesLog += </span><span class="s2">`* Updated metadata to version </span><span class="s1">${metadataVersion}</span><span class="s2">`</span>
	<span class="s0">if </span><span class="s1">(metadataChanges.length &gt; </span><span class="s5">0</span><span class="s1">) {</span>
		<span class="s1">changesLog += </span><span class="s2">':'</span>
		<span class="s1">changesLog += </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span>
		<span class="s1">changesLog += metadataChanges.map(change =&gt; </span><span class="s2">`  - </span><span class="s1">${change.replace(</span><span class="s4">/\n/g</span><span class="s1">, </span><span class="s2">'</span><span class="s6">\n</span><span class="s2">' </span><span class="s1">+ </span><span class="s2">'    '</span><span class="s1">)}</span><span class="s2">`</span><span class="s1">).join(</span><span class="s2">'</span><span class="s6">\n</span><span class="s2">'</span><span class="s1">)</span>
	<span class="s1">}</span>

	<span class="s0">const </span><span class="s1">changelog = fs.readFileSync(</span><span class="s2">'./CHANGELOG.md'</span><span class="s1">, </span><span class="s2">'utf8'</span><span class="s1">)</span>

	<span class="s0">const </span><span class="s1">changesLogStartMarker = </span><span class="s2">'&lt;!-- CHANGELOG START --&gt;'</span>
	<span class="s0">const </span><span class="s1">changesLogStartMarkerStartsAt = changelog.indexOf(changesLogStartMarker)</span>
	<span class="s0">if </span><span class="s1">(changesLogStartMarkerStartsAt &lt; </span><span class="s5">0</span><span class="s1">) {</span>
		<span class="s0">throw new </span><span class="s1">Error(</span><span class="s2">'Changelog start marker not found in CHANGELOG.md'</span><span class="s1">)</span>
	<span class="s1">}</span>
	<span class="s0">const </span><span class="s1">changesLogStartsAt = changesLogStartMarkerStartsAt + changesLogStartMarker.length</span>
	<span class="s0">const </span><span class="s1">changelogPre = changelog.slice(</span><span class="s5">0</span><span class="s1">, changesLogStartsAt)</span>
	<span class="s0">const </span><span class="s1">previousChangesLog = changelog.slice(changesLogStartsAt).trim()</span>

	<span class="s1">fs.writeFileSync(</span><span class="s2">'./CHANGELOG.md'</span><span class="s1">, changelogPre + </span><span class="s2">'</span><span class="s6">\n\n</span><span class="s2">' </span><span class="s1">+ changesLog + </span><span class="s2">'</span><span class="s6">\n\n</span><span class="s2">' </span><span class="s1">+ previousChangesLog)</span>
<span class="s1">}</span></pre>
</body>
</html>