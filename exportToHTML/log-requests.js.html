<html>
<head>
<title>log-requests.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
log-requests.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s3">0 </span><span class="s1">&amp;&amp; (module.exports = {</span>
    <span class="s1">ignoreLoggingIncomingRequests: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">logRequests: </span><span class="s2">null</span>
<span class="s1">});</span>
<span class="s2">function </span><span class="s1">_export(target, all) {</span>
    <span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s1">name </span><span class="s2">in </span><span class="s1">all)Object.defineProperty(target, name, {</span>
        <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
        <span class="s1">get: all[name]</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s1">_export(exports, {</span>
    <span class="s1">ignoreLoggingIncomingRequests: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">ignoreLoggingIncomingRequests;</span>
    <span class="s1">},</span>
    <span class="s1">logRequests: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">logRequests;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_picocolors = require(</span><span class="s0">&quot;../../lib/picocolors&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_url = require(</span><span class="s0">&quot;../../lib/url&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_requestmeta = require(</span><span class="s0">&quot;../request-meta&quot;</span><span class="s1">);</span>
<span class="s2">function </span><span class="s1">ignoreLoggingIncomingRequests(request, loggingConfig) {</span>
    <span class="s2">var </span><span class="s1">_loggingConfig_incomingRequests;</span>
    <span class="s4">// If it's boolean use the boolean value</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">(loggingConfig == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: loggingConfig.incomingRequests) === </span><span class="s0">'boolean'</span><span class="s1">) {</span>
        <span class="s2">return </span><span class="s1">!loggingConfig.incomingRequests;</span>
    <span class="s1">}</span>
    <span class="s4">// Any of the value on the chain is falsy, will not ignore the request.</span>
    <span class="s2">const </span><span class="s1">ignore = loggingConfig == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: (_loggingConfig_incomingRequests = loggingConfig.incomingRequests) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _loggingConfig_incomingRequests.ignore;</span>
    <span class="s4">// If ignore is not set, don't ignore anything</span>
    <span class="s2">if </span><span class="s1">(!ignore) {</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">// If array of RegExp, ignore if any pattern matches</span>
    <span class="s2">return </span><span class="s1">ignore.some((pattern)=&gt;pattern.test(request.url));</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">logRequests(options) {</span>
    <span class="s2">const </span><span class="s1">{ request, response, loggingConfig, requestDurationInMs } = options;</span>
    <span class="s2">if </span><span class="s1">(!ignoreLoggingIncomingRequests(request, loggingConfig)) {</span>
        <span class="s1">logIncomingRequests({</span>
            <span class="s1">request,</span>
            <span class="s1">requestDurationInMs,</span>
            <span class="s1">statusCode: response.statusCode</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(request.fetchMetrics) {</span>
        <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">fetchMetric of request.fetchMetrics){</span>
            <span class="s1">logFetchMetric(fetchMetric, loggingConfig);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">logIncomingRequests(options) {</span>
    <span class="s2">const </span><span class="s1">{ request, requestDurationInMs, statusCode } = options;</span>
    <span class="s2">const </span><span class="s1">isRSC = (</span><span class="s3">0</span><span class="s1">, _requestmeta.getRequestMeta)(request, </span><span class="s0">'isRSCRequest'</span><span class="s1">);</span>
    <span class="s2">const </span><span class="s1">url = isRSC ? (</span><span class="s3">0</span><span class="s1">, _url.stripNextRscUnionQuery)(request.url) : request.url;</span>
    <span class="s2">const </span><span class="s1">statusCodeColor = statusCode &lt; </span><span class="s3">200 </span><span class="s1">? _picocolors.white : statusCode &lt; </span><span class="s3">300 </span><span class="s1">? _picocolors.green : statusCode &lt; </span><span class="s3">400 </span><span class="s1">? _picocolors.blue : statusCode &lt; </span><span class="s3">500 </span><span class="s1">? _picocolors.yellow : _picocolors.red;</span>
    <span class="s2">const </span><span class="s1">coloredStatus = statusCodeColor(statusCode.toString());</span>
    <span class="s2">return </span><span class="s1">writeLine(</span><span class="s0">`</span><span class="s1">${request.method} ${url} ${coloredStatus} </span><span class="s0">in </span><span class="s1">${requestDurationInMs}</span><span class="s0">ms`</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">logFetchMetric(fetchMetric, loggingConfig) {</span>
    <span class="s2">var </span><span class="s1">_loggingConfig_fetches;</span>
    <span class="s2">let </span><span class="s1">{ cacheReason, cacheStatus, cacheWarning, end, method, start, status, url } = fetchMetric;</span>
    <span class="s2">if </span><span class="s1">(cacheStatus === </span><span class="s0">'hmr' </span><span class="s1">&amp;&amp; !(loggingConfig == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: (_loggingConfig_fetches = loggingConfig.fetches) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _loggingConfig_fetches.hmrRefreshes)) {</span>
        <span class="s4">// Cache hits during HMR refreshes are intentionally not logged, unless</span>
        <span class="s4">// explicitly enabled in the logging config.</span>
        <span class="s2">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(loggingConfig == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: loggingConfig.fetches) {</span>
        <span class="s2">if </span><span class="s1">(url.length &gt; </span><span class="s3">48 </span><span class="s1">&amp;&amp; !loggingConfig.fetches.fullUrl) {</span>
            <span class="s1">url = truncateUrl(url);</span>
        <span class="s1">}</span>
        <span class="s1">writeLine((</span><span class="s3">0</span><span class="s1">, _picocolors.white)(</span><span class="s0">`</span><span class="s1">${method} ${url} ${status} </span><span class="s0">in </span><span class="s1">${Math.round(end - start)}</span><span class="s0">ms </span><span class="s1">${formatCacheStatus(cacheStatus)}</span><span class="s0">`</span><span class="s1">), </span><span class="s3">1</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(cacheStatus === </span><span class="s0">'skip' </span><span class="s1">|| cacheStatus === </span><span class="s0">'miss'</span><span class="s1">) {</span>
            <span class="s1">writeLine((</span><span class="s3">0</span><span class="s1">, _picocolors.gray)(</span><span class="s0">`Cache </span><span class="s1">${cacheStatus === </span><span class="s0">'skip' </span><span class="s1">? </span><span class="s0">'skipped' </span><span class="s1">: </span><span class="s0">'missed'</span><span class="s1">} </span><span class="s0">reason: (</span><span class="s1">${(</span><span class="s3">0</span><span class="s1">, _picocolors.white)(cacheReason)}</span><span class="s0">)`</span><span class="s1">), </span><span class="s3">2</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(cacheWarning) {</span>
        <span class="s4">// When logging for fetches is not enabled, we still want to print any</span>
        <span class="s4">// associated warnings, so we print the request first to provide context.</span>
        <span class="s1">writeLine((</span><span class="s3">0</span><span class="s1">, _picocolors.white)(</span><span class="s0">`</span><span class="s1">${method} ${url}</span><span class="s0">`</span><span class="s1">), </span><span class="s3">1</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(cacheWarning) {</span>
        <span class="s1">writeLine(</span><span class="s0">`</span><span class="s1">${(</span><span class="s3">0</span><span class="s1">, _picocolors.yellow)((</span><span class="s3">0</span><span class="s1">, _picocolors.bold)(</span><span class="s0">'⚠'</span><span class="s1">))} ${(</span><span class="s3">0</span><span class="s1">, _picocolors.white)(cacheWarning)}</span><span class="s0">`</span><span class="s1">, </span><span class="s3">2</span><span class="s1">);</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">writeLine(text, indentationLevel = </span><span class="s3">0</span><span class="s1">) {</span>
    <span class="s1">process.stdout.write(</span><span class="s0">` </span><span class="s1">${</span><span class="s0">'│ '</span><span class="s1">.repeat(indentationLevel)}${text}</span><span class="s5">\n</span><span class="s0">`</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">truncate(text, maxLength) {</span>
    <span class="s2">return </span><span class="s1">maxLength !== undefined &amp;&amp; text.length &gt; maxLength ? text.substring(</span><span class="s3">0</span><span class="s1">, maxLength) + </span><span class="s0">'..' </span><span class="s1">: text;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">truncateUrl(url) {</span>
    <span class="s2">const </span><span class="s1">{ protocol, host, pathname, search } = </span><span class="s2">new </span><span class="s1">URL(url);</span>
    <span class="s2">return </span><span class="s1">protocol + </span><span class="s0">'//' </span><span class="s1">+ truncate(host, </span><span class="s3">16</span><span class="s1">) + truncate(pathname, </span><span class="s3">24</span><span class="s1">) + truncate(search, </span><span class="s3">16</span><span class="s1">);</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">formatCacheStatus(cacheStatus) {</span>
    <span class="s2">switch</span><span class="s1">(cacheStatus){</span>
        <span class="s2">case </span><span class="s0">'hmr'</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _picocolors.green)(</span><span class="s0">'(HMR cache)'</span><span class="s1">);</span>
        <span class="s2">case </span><span class="s0">'hit'</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _picocolors.green)(</span><span class="s0">'(cache hit)'</span><span class="s1">);</span>
        <span class="s2">case </span><span class="s0">'miss'</span><span class="s1">:</span>
        <span class="s2">case </span><span class="s0">'skip'</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _picocolors.yellow)(</span><span class="s0">`(cache </span><span class="s1">${cacheStatus}</span><span class="s0">)`</span><span class="s1">);</span>
        <span class="s2">default</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">cacheStatus;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">//# sourceMappingURL=log-requests.js.map</span></pre>
</body>
</html>