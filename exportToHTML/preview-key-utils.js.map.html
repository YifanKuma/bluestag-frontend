<html>
<head>
<title>preview-key-utils.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
preview-key-utils.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../src/build/preview-key-utils.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import path from 'path'</span><span class="s3">\n</span><span class="s1">import fs from 'fs'</span><span class="s3">\n</span><span class="s1">import crypto from 'crypto'</span><span class="s3">\n</span><span class="s1">import type { __ApiPreviewProps } from '../server/api-utils'</span><span class="s3">\n</span><span class="s1">import { getStorageDirectory } from '../server/cache-dir'</span><span class="s3">\n\n</span><span class="s1">const CONFIG_FILE = '.previewinfo'</span><span class="s3">\n</span><span class="s1">const PREVIEW_ID = 'previewModeId'</span><span class="s3">\n</span><span class="s1">const PREVIEW_SIGNING_KEY = 'previewModeSigningKey'</span><span class="s3">\n</span><span class="s1">const PREVIEW_ENCRYPTION_KEY = 'previewModeEncryptionKey'</span><span class="s3">\n</span><span class="s1">const PREVIEW_EXPIRE_AT = 'expireAt'</span><span class="s3">\n</span><span class="s1">const EXPIRATION = 1000 * 60 * 60 * 24 * 14 // 14 days</span><span class="s3">\n\n</span><span class="s1">async function writeCache(distDir: string, config: __ApiPreviewProps) {</span><span class="s3">\n  </span><span class="s1">const cacheBaseDir = getStorageDirectory(distDir)</span><span class="s3">\n  </span><span class="s1">if (!cacheBaseDir) return</span><span class="s3">\n\n  </span><span class="s1">const configPath = path.join(cacheBaseDir, CONFIG_FILE)</span><span class="s3">\n  </span><span class="s1">if (!fs.existsSync(cacheBaseDir)) {</span><span class="s3">\n    </span><span class="s1">await fs.promises.mkdir(cacheBaseDir, { recursive: true })</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">await fs.promises.writeFile(</span><span class="s3">\n    </span><span class="s1">configPath,</span><span class="s3">\n    </span><span class="s1">JSON.stringify({</span><span class="s3">\n      </span><span class="s1">[PREVIEW_ID]: config.previewModeId,</span><span class="s3">\n      </span><span class="s1">[PREVIEW_SIGNING_KEY]: config.previewModeSigningKey,</span><span class="s3">\n      </span><span class="s1">[PREVIEW_ENCRYPTION_KEY]: config.previewModeEncryptionKey,</span><span class="s3">\n      </span><span class="s1">[PREVIEW_EXPIRE_AT]: Date.now() + EXPIRATION,</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">function generateConfig() {</span><span class="s3">\n  </span><span class="s1">return {</span><span class="s3">\n    </span><span class="s1">previewModeId: crypto.randomBytes(16).toString('hex'),</span><span class="s3">\n    </span><span class="s1">previewModeSigningKey: crypto.randomBytes(32).toString('hex'),</span><span class="s3">\n    </span><span class="s1">previewModeEncryptionKey: crypto.randomBytes(32).toString('hex'),</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">// This utility is used to get a key for the cache directory. If the</span><span class="s3">\n</span><span class="s1">// key is not present, it will generate a new one and store it in the</span><span class="s3">\n</span><span class="s1">// cache directory inside dist.</span><span class="s3">\n</span><span class="s1">// The key will also expire after a certain amount of time. Once it</span><span class="s3">\n</span><span class="s1">// expires, a new one will be generated.</span><span class="s3">\n</span><span class="s1">export async function generatePreviewKeys({</span><span class="s3">\n  </span><span class="s1">distDir,</span><span class="s3">\n  </span><span class="s1">isBuild,</span><span class="s3">\n</span><span class="s1">}: {</span><span class="s3">\n  </span><span class="s1">distDir: string</span><span class="s3">\n  </span><span class="s1">isBuild: boolean</span><span class="s3">\n</span><span class="s1">}): Promise&lt;__ApiPreviewProps&gt; {</span><span class="s3">\n  </span><span class="s1">const cacheBaseDir = getStorageDirectory(distDir)</span><span class="s3">\n\n  </span><span class="s1">if (!cacheBaseDir) {</span><span class="s3">\n    </span><span class="s1">// There's no persistent storage available. We generate a new config.</span><span class="s3">\n    </span><span class="s1">// This also covers development time.</span><span class="s3">\n    </span><span class="s1">return generateConfig()</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const configPath = path.join(cacheBaseDir, CONFIG_FILE)</span><span class="s3">\n  </span><span class="s1">async function tryReadCachedConfig(): Promise&lt;false | __ApiPreviewProps&gt; {</span><span class="s3">\n    </span><span class="s1">if (!fs.existsSync(configPath)) return false</span><span class="s3">\n    </span><span class="s1">try {</span><span class="s3">\n      </span><span class="s1">const config = JSON.parse(await fs.promises.readFile(configPath, 'utf8'))</span><span class="s3">\n      </span><span class="s1">if (!config) return false</span><span class="s3">\n      </span><span class="s1">if (</span><span class="s3">\n        </span><span class="s1">typeof config[PREVIEW_ID] !== 'string' ||</span><span class="s3">\n        </span><span class="s1">typeof config[PREVIEW_ENCRYPTION_KEY] !== 'string' ||</span><span class="s3">\n        </span><span class="s1">typeof config[PREVIEW_SIGNING_KEY] !== 'string' ||</span><span class="s3">\n        </span><span class="s1">typeof config[PREVIEW_EXPIRE_AT] !== 'number'</span><span class="s3">\n      </span><span class="s1">) {</span><span class="s3">\n        </span><span class="s1">return false</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n      </span><span class="s1">// For build time, we need to rotate the key if it's expired. Otherwise</span><span class="s3">\n      </span><span class="s1">// (next start) we have to keep the key as it is so the runtime key matches</span><span class="s3">\n      </span><span class="s1">// the build time key.</span><span class="s3">\n      </span><span class="s1">if (isBuild &amp;&amp; config[PREVIEW_EXPIRE_AT] &lt; Date.now()) {</span><span class="s3">\n        </span><span class="s1">return false</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n\n      </span><span class="s1">return {</span><span class="s3">\n        </span><span class="s1">previewModeId: config[PREVIEW_ID],</span><span class="s3">\n        </span><span class="s1">previewModeSigningKey: config[PREVIEW_SIGNING_KEY],</span><span class="s3">\n        </span><span class="s1">previewModeEncryptionKey: config[PREVIEW_ENCRYPTION_KEY],</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">} catch (e) {</span><span class="s3">\n      </span><span class="s1">// Broken config file. We should generate a new key and overwrite it.</span><span class="s3">\n      </span><span class="s1">return false</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">const maybeValidConfig = await tryReadCachedConfig()</span><span class="s3">\n  </span><span class="s1">if (maybeValidConfig !== false) {</span><span class="s3">\n    </span><span class="s1">return maybeValidConfig</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">const config = generateConfig()</span><span class="s3">\n  </span><span class="s1">await writeCache(distDir, config)</span><span class="s3">\n\n  </span><span class="s1">return config</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;generatePreviewKeys&quot;</span><span class="s0">,</span><span class="s1">&quot;CONFIG_FILE&quot;</span><span class="s0">,</span><span class="s1">&quot;PREVIEW_ID&quot;</span><span class="s0">,</span><span class="s1">&quot;PREVIEW_SIGNING_KEY&quot;</span><span class="s0">,</span><span class="s1">&quot;PREVIEW_ENCRYPTION_KEY&quot;</span><span class="s0">,</span><span class="s1">&quot;PREVIEW_EXPIRE_AT&quot;</span><span class="s0">,</span><span class="s1">&quot;EXPIRATION&quot;</span><span class="s0">,</span><span class="s1">&quot;writeCache&quot;</span><span class="s0">,</span><span class="s1">&quot;distDir&quot;</span><span class="s0">,</span><span class="s1">&quot;config&quot;</span><span class="s0">,</span><span class="s1">&quot;cacheBaseDir&quot;</span><span class="s0">,</span><span class="s1">&quot;getStorageDirectory&quot;</span><span class="s0">,</span><span class="s1">&quot;configPath&quot;</span><span class="s0">,</span><span class="s1">&quot;path&quot;</span><span class="s0">,</span><span class="s1">&quot;join&quot;</span><span class="s0">,</span><span class="s1">&quot;fs&quot;</span><span class="s0">,</span><span class="s1">&quot;existsSync&quot;</span><span class="s0">,</span><span class="s1">&quot;promises&quot;</span><span class="s0">,</span><span class="s1">&quot;mkdir&quot;</span><span class="s0">,</span><span class="s1">&quot;recursive&quot;</span><span class="s0">,</span><span class="s1">&quot;writeFile&quot;</span><span class="s0">,</span><span class="s1">&quot;JSON&quot;</span><span class="s0">,</span><span class="s1">&quot;stringify&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeId&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeSigningKey&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeEncryptionKey&quot;</span><span class="s0">,</span><span class="s1">&quot;Date&quot;</span><span class="s0">,</span><span class="s1">&quot;now&quot;</span><span class="s0">,</span><span class="s1">&quot;generateConfig&quot;</span><span class="s0">,</span><span class="s1">&quot;crypto&quot;</span><span class="s0">,</span><span class="s1">&quot;randomBytes&quot;</span><span class="s0">,</span><span class="s1">&quot;toString&quot;</span><span class="s0">,</span><span class="s1">&quot;isBuild&quot;</span><span class="s0">,</span><span class="s1">&quot;tryReadCachedConfig&quot;</span><span class="s0">,</span><span class="s1">&quot;parse&quot;</span><span class="s0">,</span><span class="s1">&quot;readFile&quot;</span><span class="s0">,</span><span class="s1">&quot;e&quot;</span><span class="s0">,</span><span class="s1">&quot;maybeValidConfig&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;+BA6CsBA;;;eAAAA;;;6DA7CL;2DACF;+DACI;0BAEiB;;;;;;AAEpC,MAAMC,cAAc;AACpB,MAAMC,aAAa;AACnB,MAAMC,sBAAsB;AAC5B,MAAMC,yBAAyB;AAC/B,MAAMC,oBAAoB;AAC1B,MAAMC,aAAa,OAAO,KAAK,KAAK,KAAK,GAAG,UAAU;;AAEtD,eAAeC,WAAWC,OAAe,EAAEC,MAAyB;IAClE,MAAMC,eAAeC,IAAAA,6BAAmB,EAACH;IACzC,IAAI,CAACE,cAAc;IAEnB,MAAME,aAAaC,aAAI,CAACC,IAAI,CAACJ,cAAcT;IAC3C,IAAI,CAACc,WAAE,CAACC,UAAU,CAACN,eAAe;QAChC,MAAMK,WAAE,CAACE,QAAQ,CAACC,KAAK,CAACR,cAAc;YAAES,WAAW;QAAK;IAC1D;IACA,MAAMJ,WAAE,CAACE,QAAQ,CAACG,SAAS,CACzBR,YACAS,KAAKC,SAAS,CAAC;QACb,CAACpB,WAAW,EAAEO,OAAOc,aAAa;QAClC,CAACpB,oBAAoB,EAAEM,OAAOe,qBAAqB;QACnD,CAACpB,uBAAuB,EAAEK,OAAOgB,wBAAwB;QACzD,CAACpB,kBAAkB,EAAEqB,KAAKC,GAAG,KAAKrB;IACpC;AAEJ;AAEA,SAASsB;IACP,OAAO;QACLL,eAAeM,eAAM,CAACC,WAAW,CAAC,IAAIC,QAAQ,CAAC;QAC/CP,uBAAuBK,eAAM,CAACC,WAAW,CAAC,IAAIC,QAAQ,CAAC;QACvDN,0BAA0BI,eAAM,CAACC,WAAW,CAAC,IAAIC,QAAQ,CAAC;IAC5D;AACF;AAOO,eAAe/B,oBAAoB,EACxCQ,OAAO,EACPwB,OAAO,EAIR;IACC,MAAMtB,eAAeC,IAAAA,6BAAmB,EAACH;IAEzC,IAAI,CAACE,cAAc;QACjB,qEAAqE;QACrE,qCAAqC;QACrC,OAAOkB;IACT;IAEA,MAAMhB,aAAaC,aAAI,CAACC,IAAI,CAACJ,cAAcT;IAC3C,eAAegC;QACb,IAAI,CAAClB,WAAE,CAACC,UAAU,CAACJ,aAAa,OAAO;QACvC,IAAI;YACF,MAAMH,SAASY,KAAKa,KAAK,CAAC,MAAMnB,WAAE,CAACE,QAAQ,CAACkB,QAAQ,CAACvB,YAAY;YACjE,IAAI,CAACH,QAAQ,OAAO;YACpB,IACE,OAAOA,MAAM,CAACP,WAAW,KAAK,YAC9B,OAAOO,MAAM,CAACL,uBAAuB,KAAK,YAC1C,OAAOK,MAAM,CAACN,oBAAoB,KAAK,YACvC,OAAOM,MAAM,CAACJ,kBAAkB,KAAK,UACrC;gBACA,OAAO;YACT;YACA,uEAAuE;YACvE,2EAA2E;YAC3E,sBAAsB;YACtB,IAAI2B,WAAWvB,MAAM,CAACJ,kBAAkB,GAAGqB,KAAKC,GAAG,IAAI;gBACrD,OAAO;YACT;YAEA,OAAO;gBACLJ,eAAed,MAAM,CAACP,WAAW;gBACjCsB,uBAAuBf,MAAM,CAACN,oBAAoB;gBAClDsB,0BAA0BhB,MAAM,CAACL,uBAAuB;YAC1D;QACF,EAAE,OAAOgC,GAAG;YACV,qEAAqE;YACrE,OAAO;QACT;IACF;IACA,MAAMC,mBAAmB,MAAMJ;IAC/B,IAAII,qBAAqB,OAAO;QAC9B,OAAOA;IACT;IACA,MAAM5B,SAASmB;IACf,MAAMrB,WAAWC,SAASC;IAE1B,OAAOA;AACT&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>