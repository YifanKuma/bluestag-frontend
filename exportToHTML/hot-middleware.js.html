<html>
<head>
<title>hot-middleware.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #0033b3;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
hot-middleware.js</font>
</center></td></tr></table>
<pre><span class="s0">// Based on https://github.com/webpack-contrib/webpack-hot-middleware/blob/9708d781ae0e46179cf8ea1a94719de4679aaf53/middleware.js</span>
<span class="s0">// Included License below</span>
<span class="s0">// Copyright JS Foundation and other contributors</span>
<span class="s0">// Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="s0">// a copy of this software and associated documentation files (the</span>
<span class="s0">// 'Software'), to deal in the Software without restriction, including</span>
<span class="s0">// without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="s0">// distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="s0">// permit persons to whom the Software is furnished to do so, subject to</span>
<span class="s0">// the following conditions:</span>
<span class="s0">// The above copyright notice and this permission notice shall be</span>
<span class="s0">// included in all copies or substantial portions of the Software.</span>
<span class="s0">// THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,</span>
<span class="s0">// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="s0">// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.</span>
<span class="s0">// IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY</span>
<span class="s0">// CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,</span>
<span class="s0">// TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE</span>
<span class="s0">// SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="s2">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s2">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s3">true</span>
<span class="s1">});</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s2">&quot;WebpackHotMiddleware&quot;</span><span class="s1">, {</span>
    <span class="s1">enumerable: </span><span class="s3">true</span><span class="s1">,</span>
    <span class="s1">get: </span><span class="s3">function</span><span class="s1">() {</span>
        <span class="s3">return </span><span class="s1">WebpackHotMiddleware;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s3">const </span><span class="s1">_utils = require(</span><span class="s2">&quot;../../build/utils&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">_hotreloadertypes = require(</span><span class="s2">&quot;./hot-reloader-types&quot;</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">_devindicatorserverstate = require(</span><span class="s2">&quot;./dev-indicator-server-state&quot;</span><span class="s1">);</span>
<span class="s3">function </span><span class="s1">isMiddlewareStats(stats) {</span>
    <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">key of stats.compilation.entrypoints.keys()){</span>
        <span class="s3">if </span><span class="s1">((</span><span class="s4">0</span><span class="s1">, _utils.isMiddlewareFilename)(key)) {</span>
            <span class="s3">return true</span><span class="s1">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return false</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s1">statsToJson(stats) {</span>
    <span class="s3">if </span><span class="s1">(!stats) </span><span class="s3">return </span><span class="s1">{};</span>
    <span class="s3">return </span><span class="s1">stats.toJson({</span>
        <span class="s1">all: </span><span class="s3">false</span><span class="s1">,</span>
        <span class="s1">errors: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s1">hash: </span><span class="s3">true</span><span class="s1">,</span>
        <span class="s1">warnings: </span><span class="s3">true</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s3">function </span><span class="s1">getStatsForSyncEvent(clientStats, serverStats) {</span>
    <span class="s3">if </span><span class="s1">(!clientStats) </span><span class="s3">return </span><span class="s1">serverStats == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: serverStats.stats;</span>
    <span class="s3">if </span><span class="s1">(!serverStats) </span><span class="s3">return </span><span class="s1">clientStats == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: clientStats.stats;</span>
    <span class="s0">// Prefer the server compiler stats if it has errors.</span>
    <span class="s0">// Otherwise we may end up in a state where the client compilation is the latest but without errors.</span>
    <span class="s0">// This causes the error overlay to not display the build error.</span>
    <span class="s3">if </span><span class="s1">(serverStats.stats.hasErrors()) {</span>
        <span class="s3">return </span><span class="s1">serverStats.stats;</span>
    <span class="s1">}</span>
    <span class="s0">// Return the latest stats</span>
    <span class="s3">return </span><span class="s1">serverStats.ts &gt; clientStats.ts ? serverStats.stats : clientStats.stats;</span>
<span class="s1">}</span>
<span class="s3">class </span><span class="s1">EventStream {</span>
    <span class="s1">constructor(){</span>
        <span class="s3">this</span><span class="s1">.clients = </span><span class="s3">new </span><span class="s1">Set();</span>
    <span class="s1">}</span>
    <span class="s1">close() {</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">wsClient of </span><span class="s3">this</span><span class="s1">.clients){</span>
            <span class="s0">// it's okay to not cleanly close these websocket connections, this is dev</span>
            <span class="s1">wsClient.terminate();</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.clients.clear();</span>
    <span class="s1">}</span>
    <span class="s1">handler(client) {</span>
        <span class="s3">this</span><span class="s1">.clients.add(client);</span>
        <span class="s1">client.addEventListener(</span><span class="s2">'close'</span><span class="s1">, ()=&gt;{</span>
            <span class="s3">this</span><span class="s1">.clients.delete(client);</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s1">publish(payload) {</span>
        <span class="s3">for </span><span class="s1">(</span><span class="s3">const </span><span class="s1">wsClient of </span><span class="s3">this</span><span class="s1">.clients){</span>
            <span class="s1">wsClient.send(JSON.stringify(payload));</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">class </span><span class="s1">WebpackHotMiddleware {</span>
    <span class="s1">constructor(compilers, versionInfo, devtoolsFrontendUrl, devToolsConfig){</span>
        <span class="s3">this</span><span class="s1">.onClientInvalid = ()=&gt;{</span>
            <span class="s3">var </span><span class="s1">_this_serverLatestStats;</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed || ((_this_serverLatestStats = </span><span class="s3">this</span><span class="s1">.serverLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_serverLatestStats.stats.hasErrors())) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.publish({</span>
                <span class="s1">action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILDING</span>
            <span class="s1">});</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.onClientDone = (statsResult)=&gt;{</span>
            <span class="s3">var </span><span class="s1">_this_serverLatestStats;</span>
            <span class="s3">this</span><span class="s1">.clientLatestStats = {</span>
                <span class="s1">ts: Date.now(),</span>
                <span class="s1">stats: statsResult</span>
            <span class="s1">};</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed || ((_this_serverLatestStats = </span><span class="s3">this</span><span class="s1">.serverLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_serverLatestStats.stats.hasErrors())) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.publishStats(statsResult);</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.onServerInvalid = ()=&gt;{</span>
            <span class="s3">var </span><span class="s1">_this_serverLatestStats, _this_clientLatestStats;</span>
            <span class="s3">if </span><span class="s1">(!((_this_serverLatestStats = </span><span class="s3">this</span><span class="s1">.serverLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_serverLatestStats.stats.hasErrors())) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.serverLatestStats = </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">((_this_clientLatestStats = </span><span class="s3">this</span><span class="s1">.clientLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_clientLatestStats.stats) {</span>
                <span class="s3">this</span><span class="s1">.publishStats(</span><span class="s3">this</span><span class="s1">.clientLatestStats.stats);</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.onServerDone = (statsResult)=&gt;{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(statsResult.hasErrors()) {</span>
                <span class="s3">this</span><span class="s1">.serverLatestStats = {</span>
                    <span class="s1">ts: Date.now(),</span>
                    <span class="s1">stats: statsResult</span>
                <span class="s1">};</span>
                <span class="s3">this</span><span class="s1">.publishStats(statsResult);</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.onEdgeServerInvalid = ()=&gt;{</span>
            <span class="s3">var </span><span class="s1">_this_middlewareLatestStats, _this_clientLatestStats;</span>
            <span class="s3">if </span><span class="s1">(!((_this_middlewareLatestStats = </span><span class="s3">this</span><span class="s1">.middlewareLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_middlewareLatestStats.stats.hasErrors())) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.middlewareLatestStats = </span><span class="s3">null</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">((_this_clientLatestStats = </span><span class="s3">this</span><span class="s1">.clientLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_clientLatestStats.stats) {</span>
                <span class="s3">this</span><span class="s1">.publishStats(</span><span class="s3">this</span><span class="s1">.clientLatestStats.stats);</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.onEdgeServerDone = (statsResult)=&gt;{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">if </span><span class="s1">(!isMiddlewareStats(statsResult)) {</span>
                <span class="s3">this</span><span class="s1">.onServerInvalid();</span>
                <span class="s3">this</span><span class="s1">.onServerDone(statsResult);</span>
            <span class="s1">}</span>
            <span class="s3">if </span><span class="s1">(statsResult.hasErrors()) {</span>
                <span class="s3">this</span><span class="s1">.middlewareLatestStats = {</span>
                    <span class="s1">ts: Date.now(),</span>
                    <span class="s1">stats: statsResult</span>
                <span class="s1">};</span>
                <span class="s3">this</span><span class="s1">.publishStats(statsResult);</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s0">/**</span>
   <span class="s0">* To sync we use the most recent stats but also we append middleware</span>
   <span class="s0">* errors. This is because it is possible that middleware fails to compile</span>
   <span class="s0">* and we still want to show the client overlay with the error while</span>
   <span class="s0">* the error page should be rendered just fine.</span>
   <span class="s0">*/ </span><span class="s3">this</span><span class="s1">.onHMR = (client)=&gt;{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.eventStream.handler(client);</span>
            <span class="s3">const </span><span class="s1">syncStats = getStatsForSyncEvent(</span><span class="s3">this</span><span class="s1">.clientLatestStats, </span><span class="s3">this</span><span class="s1">.serverLatestStats);</span>
            <span class="s3">if </span><span class="s1">(syncStats) {</span>
                <span class="s3">var </span><span class="s1">_this_middlewareLatestStats;</span>
                <span class="s3">const </span><span class="s1">stats = statsToJson(syncStats);</span>
                <span class="s3">const </span><span class="s1">middlewareStats = statsToJson((_this_middlewareLatestStats = </span><span class="s3">this</span><span class="s1">.middlewareLatestStats) == </span><span class="s3">null </span><span class="s1">? </span><span class="s3">void </span><span class="s4">0 </span><span class="s1">: _this_middlewareLatestStats.stats);</span>
                <span class="s3">if </span><span class="s1">(_devindicatorserverstate.devIndicatorServerState.disabledUntil &lt; Date.now()) {</span>
                    <span class="s1">_devindicatorserverstate.devIndicatorServerState.disabledUntil = </span><span class="s4">0</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">this</span><span class="s1">.publish({</span>
                    <span class="s1">action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.SYNC,</span>
                    <span class="s1">hash: stats.hash,</span>
                    <span class="s1">errors: [</span>
                        <span class="s1">...stats.errors || [],</span>
                        <span class="s1">...middlewareStats.errors || []</span>
                    <span class="s1">],</span>
                    <span class="s1">warnings: [</span>
                        <span class="s1">...stats.warnings || [],</span>
                        <span class="s1">...middlewareStats.warnings || []</span>
                    <span class="s1">],</span>
                    <span class="s1">versionInfo: </span><span class="s3">this</span><span class="s1">.versionInfo,</span>
                    <span class="s1">debug: {</span>
                        <span class="s1">devtoolsFrontendUrl: </span><span class="s3">this</span><span class="s1">.devtoolsFrontendUrl</span>
                    <span class="s1">},</span>
                    <span class="s1">devIndicator: _devindicatorserverstate.devIndicatorServerState,</span>
                    <span class="s1">devToolsConfig: </span><span class="s3">this</span><span class="s1">.devToolsConfig</span>
                <span class="s1">});</span>
            <span class="s1">}</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.publishStats = (statsResult)=&gt;{</span>
            <span class="s3">const </span><span class="s1">stats = statsResult.toJson({</span>
                <span class="s1">all: </span><span class="s3">false</span><span class="s1">,</span>
                <span class="s1">hash: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s1">warnings: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s1">errors: </span><span class="s3">true</span><span class="s1">,</span>
                <span class="s1">moduleTrace: </span><span class="s3">true</span>
            <span class="s1">});</span>
            <span class="s3">this</span><span class="s1">.publish({</span>
                <span class="s1">action: _hotreloadertypes.HMR_ACTIONS_SENT_TO_BROWSER.BUILT,</span>
                <span class="s1">hash: stats.hash,</span>
                <span class="s1">warnings: stats.warnings || [],</span>
                <span class="s1">errors: stats.errors || []</span>
            <span class="s1">});</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.publish = (payload)=&gt;{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.eventStream.publish(payload);</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.close = ()=&gt;{</span>
            <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.closed) </span><span class="s3">return</span><span class="s1">;</span>
            <span class="s0">// Can't remove compiler plugins, so we just set a flag and noop if closed</span>
            <span class="s0">// https://github.com/webpack/tapable/issues/32#issuecomment-350644466</span>
            <span class="s3">this</span><span class="s1">.closed = </span><span class="s3">true</span><span class="s1">;</span>
            <span class="s3">this</span><span class="s1">.eventStream.close();</span>
        <span class="s1">};</span>
        <span class="s3">this</span><span class="s1">.eventStream = </span><span class="s3">new </span><span class="s1">EventStream();</span>
        <span class="s3">this</span><span class="s1">.clientLatestStats = </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.middlewareLatestStats = </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.serverLatestStats = </span><span class="s3">null</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.closed = </span><span class="s3">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.versionInfo = versionInfo;</span>
        <span class="s3">this</span><span class="s1">.devtoolsFrontendUrl = devtoolsFrontendUrl;</span>
        <span class="s3">this</span><span class="s1">.devToolsConfig = devToolsConfig || {};</span>
        <span class="s1">compilers[</span><span class="s4">0</span><span class="s1">].hooks.invalid.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onClientInvalid);</span>
        <span class="s1">compilers[</span><span class="s4">0</span><span class="s1">].hooks.done.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onClientDone);</span>
        <span class="s1">compilers[</span><span class="s4">1</span><span class="s1">].hooks.invalid.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onServerInvalid);</span>
        <span class="s1">compilers[</span><span class="s4">1</span><span class="s1">].hooks.done.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onServerDone);</span>
        <span class="s1">compilers[</span><span class="s4">2</span><span class="s1">].hooks.done.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onEdgeServerDone);</span>
        <span class="s1">compilers[</span><span class="s4">2</span><span class="s1">].hooks.invalid.tap(</span><span class="s2">'webpack-hot-middleware'</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.onEdgeServerInvalid);</span>
    <span class="s1">}</span>
    <span class="s1">updateDevToolsConfig(newConfig) {</span>
        <span class="s3">this</span><span class="s1">.devToolsConfig = newConfig;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">//# sourceMappingURL=hot-middleware.js.map</span></pre>
</body>
</html>