<html>
<head>
<title>suppressions-service.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #067d17;}
.s4 { color: #0033b3;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
suppressions-service.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@fileoverview </span><span class="s0">Manages the suppressed violations.</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Iacovos Constantinou</span>
 <span class="s0">*/</span>

<span class="s3">&quot;use strict&quot;</span><span class="s2">;</span>

<span class="s0">//-----------------------------------------------------------------------------</span>
<span class="s0">// Requirements</span>
<span class="s0">//-----------------------------------------------------------------------------</span>

<span class="s4">const </span><span class="s2">fs = require(</span><span class="s3">&quot;node:fs&quot;</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">path = require(</span><span class="s3">&quot;node:path&quot;</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">{ calculateStatsPerFile } = require(</span><span class="s3">&quot;../eslint/eslint-helpers&quot;</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">stringify = require(</span><span class="s3">&quot;json-stable-stringify-without-jsonify&quot;</span><span class="s2">);</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Typedefs</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s0">// For VSCode IntelliSense</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;../types&quot;).Linter.LintMessage} LintMessage */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;../types&quot;).ESLint.LintResult} LintResult */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{Record&lt;string, Record&lt;string, { count: number; }&gt;&gt;} SuppressedViolations */</span>

<span class="s0">//-----------------------------------------------------------------------------</span>
<span class="s0">// Exports</span>
<span class="s0">//-----------------------------------------------------------------------------</span>

<span class="s0">/**</span>
 <span class="s0">* Manages the suppressed violations.</span>
 <span class="s0">*/</span>
<span class="s4">class </span><span class="s2">SuppressionsService {</span>
	<span class="s2">filePath = </span><span class="s3">&quot;&quot;</span><span class="s2">;</span>
	<span class="s2">cwd = </span><span class="s3">&quot;&quot;</span><span class="s2">;</span>

	<span class="s0">/**</span>
	 <span class="s0">* Creates a new instance of SuppressionsService.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{Object} options The options.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} [options.filePath] The location of the suppressions file.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} [options.cwd] The current working directory.</span>
	 <span class="s0">*/</span>
	<span class="s2">constructor({ filePath, cwd }) {</span>
		<span class="s4">this</span><span class="s2">.filePath = filePath;</span>
		<span class="s4">this</span><span class="s2">.cwd = cwd;</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Updates the suppressions file based on the current violations and the provided rules.</span>
	 <span class="s0">* If no rules are provided, all violations are suppressed.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{LintResult[]|undefined} results The lint results.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string[]|undefined} rules The rules to suppress.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{Promise&lt;void&gt;}</span>
	 <span class="s0">*/</span>
	<span class="s2">async suppress(results, rules) {</span>
		<span class="s4">const </span><span class="s2">suppressions = </span><span class="s4">await this</span><span class="s2">.load();</span>

		<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">result of results) {</span>
			<span class="s4">const </span><span class="s2">relativeFilePath = </span><span class="s4">this</span><span class="s2">.getRelativeFilePath(result.filePath);</span>
			<span class="s4">const </span><span class="s2">violationsByRule = SuppressionsService.countViolationsByRule(</span>
				<span class="s2">result.messages,</span>
			<span class="s2">);</span>

			<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">ruleId </span><span class="s4">in </span><span class="s2">violationsByRule) {</span>
				<span class="s4">if </span><span class="s2">(rules &amp;&amp; !rules.includes(ruleId)) {</span>
					<span class="s4">continue</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s2">suppressions[relativeFilePath] ??= {};</span>
				<span class="s2">suppressions[relativeFilePath][ruleId] =</span>
					<span class="s2">violationsByRule[ruleId];</span>
			<span class="s2">}</span>
		<span class="s2">}</span>

		<span class="s4">return this</span><span class="s2">.save(suppressions);</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Removes old, unused suppressions for violations that do not occur anymore.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{LintResult[]} results The lint results.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{Promise&lt;void&gt;} No return value.</span>
	 <span class="s0">*/</span>
	<span class="s2">async prune(results) {</span>
		<span class="s4">const </span><span class="s2">suppressions = </span><span class="s4">await this</span><span class="s2">.load();</span>
		<span class="s4">const </span><span class="s2">{ unused } = </span><span class="s4">this</span><span class="s2">.applySuppressions(results, suppressions);</span>

		<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">file </span><span class="s4">in </span><span class="s2">unused) {</span>
			<span class="s4">if </span><span class="s2">(!suppressions[file]) {</span>
				<span class="s4">continue</span><span class="s2">;</span>
			<span class="s2">}</span>

			<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">rule </span><span class="s4">in </span><span class="s2">unused[file]) {</span>
				<span class="s4">if </span><span class="s2">(!suppressions[file][rule]) {</span>
					<span class="s4">continue</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s4">const </span><span class="s2">suppressionsCount = suppressions[file][rule].count;</span>
				<span class="s4">const </span><span class="s2">violationsCount = unused[file][rule].count;</span>

				<span class="s4">if </span><span class="s2">(suppressionsCount === violationsCount) {</span>
					<span class="s0">// Remove unused rules</span>
					<span class="s4">delete </span><span class="s2">suppressions[file][rule];</span>
				<span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
					<span class="s0">// Update the count to match the new number of violations</span>
					<span class="s2">suppressions[file][rule].count -= violationsCount;</span>
				<span class="s2">}</span>
			<span class="s2">}</span>

			<span class="s0">// Cleanup files with no rules</span>
			<span class="s4">if </span><span class="s2">(Object.keys(suppressions[file]).length === </span><span class="s5">0</span><span class="s2">) {</span>
				<span class="s4">delete </span><span class="s2">suppressions[file];</span>
			<span class="s2">}</span>
		<span class="s2">}</span>

		<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">file of Object.keys(suppressions)) {</span>
			<span class="s4">const </span><span class="s2">absolutePath = path.resolve(</span><span class="s4">this</span><span class="s2">.cwd, file);</span>

			<span class="s4">if </span><span class="s2">(!fs.existsSync(absolutePath)) {</span>
				<span class="s4">delete </span><span class="s2">suppressions[file];</span>
			<span class="s2">}</span>
		<span class="s2">}</span>

		<span class="s4">return this</span><span class="s2">.save(suppressions);</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Checks the provided suppressions against the lint results.</span>
	 <span class="s0">*</span>
	 <span class="s0">* For each file, counts the number of violations per rule.</span>
	 <span class="s0">* For each rule in each file, compares the number of violations against the counter from the suppressions file.</span>
	 <span class="s0">* If the number of violations is less or equal to the counter, messages are moved to `LintResult#suppressedMessages` and ignored.</span>
	 <span class="s0">* Otherwise, all violations are reported as usual.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{LintResult[]} results The lint results.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{SuppressedViolations} suppressions The suppressions.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{{</span>
	 <span class="s0">*   results: LintResult[],</span>
	 <span class="s0">*   unused: SuppressedViolations</span>
	 <span class="s0">* }} The updated results and the unused suppressions.</span>
	 <span class="s0">*/</span>
	<span class="s2">applySuppressions(results, suppressions) {</span>
		<span class="s0">/**</span>
		 <span class="s0">* We copy the results to avoid modifying the original objects</span>
		 <span class="s0">* We remove only result messages that are matched and hence suppressed</span>
		 <span class="s0">* We leave the rest untouched to minimize the risk of losing parts of the original data</span>
		 <span class="s0">*/</span>
		<span class="s4">const </span><span class="s2">filtered = structuredClone(results);</span>
		<span class="s4">const </span><span class="s2">unused = {};</span>

		<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">result of filtered) {</span>
			<span class="s4">const </span><span class="s2">relativeFilePath = </span><span class="s4">this</span><span class="s2">.getRelativeFilePath(result.filePath);</span>

			<span class="s4">if </span><span class="s2">(!suppressions[relativeFilePath]) {</span>
				<span class="s4">continue</span><span class="s2">;</span>
			<span class="s2">}</span>

			<span class="s4">const </span><span class="s2">violationsByRule = SuppressionsService.countViolationsByRule(</span>
				<span class="s2">result.messages,</span>
			<span class="s2">);</span>
			<span class="s4">let </span><span class="s2">wasSuppressed = </span><span class="s4">false</span><span class="s2">;</span>

			<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">ruleId </span><span class="s4">in </span><span class="s2">violationsByRule) {</span>
				<span class="s4">if </span><span class="s2">(!suppressions[relativeFilePath][ruleId]) {</span>
					<span class="s4">continue</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s4">const </span><span class="s2">suppressionsCount =</span>
					<span class="s2">suppressions[relativeFilePath][ruleId].count;</span>
				<span class="s4">const </span><span class="s2">violationsCount = violationsByRule[ruleId].count;</span>

				<span class="s0">// Suppress messages if the number of violations is less or equal to the suppressions count</span>
				<span class="s4">if </span><span class="s2">(violationsCount &lt;= suppressionsCount) {</span>
					<span class="s2">SuppressionsService.suppressMessagesByRule(result, ruleId);</span>
					<span class="s2">wasSuppressed = </span><span class="s4">true</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s0">// Update the count to match the new number of violations, otherwise remove the rule entirely</span>
				<span class="s4">if </span><span class="s2">(violationsCount &lt; suppressionsCount) {</span>
					<span class="s2">unused[relativeFilePath] ??= {};</span>
					<span class="s2">unused[relativeFilePath][ruleId] ??= {};</span>
					<span class="s2">unused[relativeFilePath][ruleId].count =</span>
						<span class="s2">suppressionsCount - violationsCount;</span>
				<span class="s2">}</span>
			<span class="s2">}</span>

			<span class="s0">// Mark as unused all the suppressions that were not matched against a rule</span>
			<span class="s4">for </span><span class="s2">(</span><span class="s4">const </span><span class="s2">ruleId </span><span class="s4">in </span><span class="s2">suppressions[relativeFilePath]) {</span>
				<span class="s4">if </span><span class="s2">(violationsByRule[ruleId]) {</span>
					<span class="s4">continue</span><span class="s2">;</span>
				<span class="s2">}</span>

				<span class="s2">unused[relativeFilePath] ??= {};</span>
				<span class="s2">unused[relativeFilePath][ruleId] =</span>
					<span class="s2">suppressions[relativeFilePath][ruleId];</span>
			<span class="s2">}</span>

			<span class="s0">// Recalculate stats if messages were suppressed</span>
			<span class="s4">if </span><span class="s2">(wasSuppressed) {</span>
				<span class="s2">Object.assign(result, calculateStatsPerFile(result.messages));</span>
			<span class="s2">}</span>
		<span class="s2">}</span>

		<span class="s4">return </span><span class="s2">{</span>
			<span class="s2">results: filtered,</span>
			<span class="s2">unused,</span>
		<span class="s2">};</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Loads the suppressions file.</span>
	 <span class="s0">* </span><span class="s1">@throws </span><span class="s0">{Error} If the suppressions file cannot be parsed.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{Promise&lt;SuppressedViolations&gt;} The suppressions.</span>
	 <span class="s0">*/</span>
	<span class="s2">async load() {</span>
		<span class="s4">try </span><span class="s2">{</span>
			<span class="s4">const </span><span class="s2">data = </span><span class="s4">await </span><span class="s2">fs.promises.readFile(</span><span class="s4">this</span><span class="s2">.filePath, </span><span class="s3">&quot;utf8&quot;</span><span class="s2">);</span>

			<span class="s4">return </span><span class="s2">JSON.parse(data);</span>
		<span class="s2">} </span><span class="s4">catch </span><span class="s2">(err) {</span>
			<span class="s4">if </span><span class="s2">(err.code === </span><span class="s3">&quot;ENOENT&quot;</span><span class="s2">) {</span>
				<span class="s4">return </span><span class="s2">{};</span>
			<span class="s2">}</span>
			<span class="s4">throw new </span><span class="s2">Error(</span>
				<span class="s3">`Failed to parse suppressions file at </span><span class="s2">${</span><span class="s4">this</span><span class="s2">.filePath}</span><span class="s3">`</span><span class="s2">,</span>
				<span class="s2">{</span>
					<span class="s2">cause: err,</span>
				<span class="s2">},</span>
			<span class="s2">);</span>
		<span class="s2">}</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Updates the suppressions file.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{SuppressedViolations} suppressions The suppressions to save.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{Promise&lt;void&gt;}</span>
	 <span class="s0">* </span><span class="s1">@private</span>
	 <span class="s0">*/</span>
	<span class="s2">save(suppressions) {</span>
		<span class="s4">return </span><span class="s2">fs.promises.writeFile(</span>
			<span class="s4">this</span><span class="s2">.filePath,</span>
			<span class="s2">stringify(suppressions, { space: </span><span class="s5">2 </span><span class="s2">}),</span>
		<span class="s2">);</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Counts the violations by rule, ignoring warnings.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{LintMessage[]} messages The messages to count.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{Record&lt;string, number&gt;} The number of violations by rule.</span>
	 <span class="s0">*/</span>
	<span class="s4">static </span><span class="s2">countViolationsByRule(messages) {</span>
		<span class="s4">return </span><span class="s2">messages.reduce((totals, message) =&gt; {</span>
			<span class="s4">if </span><span class="s2">(message.severity === </span><span class="s5">2 </span><span class="s2">&amp;&amp; message.ruleId) {</span>
				<span class="s2">totals[message.ruleId] ??= { count: </span><span class="s5">0 </span><span class="s2">};</span>
				<span class="s2">totals[message.ruleId].count++;</span>
			<span class="s2">}</span>
			<span class="s4">return </span><span class="s2">totals;</span>
		<span class="s2">}, {});</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Returns the relative path of a file to the current working directory.</span>
	 <span class="s0">* Always in POSIX format for consistency and interoperability.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} filePath The file path.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{string} The relative file path.</span>
	 <span class="s0">*/</span>
	<span class="s2">getRelativeFilePath(filePath) {</span>
		<span class="s4">return </span><span class="s2">path</span>
			<span class="s2">.relative(</span><span class="s4">this</span><span class="s2">.cwd, filePath)</span>
			<span class="s2">.split(path.sep)</span>
			<span class="s2">.join(path.posix.sep);</span>
	<span class="s2">}</span>

	<span class="s0">/**</span>
	 <span class="s0">* Moves the messages matching the rule to `LintResult#suppressedMessages` and updates the stats.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{LintResult} result The result to update.</span>
	 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} ruleId The rule to suppress.</span>
	 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{void}</span>
	 <span class="s0">*/</span>
	<span class="s4">static </span><span class="s2">suppressMessagesByRule(result, ruleId) {</span>
		<span class="s4">const </span><span class="s2">suppressedMessages = result.messages.filter(</span>
			<span class="s2">message =&gt; message.ruleId === ruleId,</span>
		<span class="s2">);</span>

		<span class="s2">result.suppressedMessages = result.suppressedMessages.concat(</span>
			<span class="s2">suppressedMessages.map(message =&gt; {</span>
				<span class="s2">message.suppressions = [</span>
					<span class="s2">{</span>
						<span class="s2">kind: </span><span class="s3">&quot;file&quot;</span><span class="s2">,</span>
						<span class="s2">justification: </span><span class="s3">&quot;&quot;</span><span class="s2">,</span>
					<span class="s2">},</span>
				<span class="s2">];</span>

				<span class="s4">return </span><span class="s2">message;</span>
			<span class="s2">}),</span>
		<span class="s2">);</span>

		<span class="s2">result.messages = result.messages.filter(</span>
			<span class="s2">message =&gt; message.ruleId !== ruleId,</span>
		<span class="s2">);</span>
	<span class="s2">}</span>
<span class="s2">}</span>

<span class="s2">module.exports = { SuppressionsService };</span>
</pre>
</body>
</html>