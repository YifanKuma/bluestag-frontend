<html>
<head>
<title>try-get-preview-data.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
try-get-preview-data.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;tryGetPreviewData&quot;</span><span class="s1">, {</span>
    <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
    <span class="s1">get: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">tryGetPreviewData;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_ = require(</span><span class="s0">&quot;../.&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_index = require(</span><span class="s0">&quot;../index&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_cookies = require(</span><span class="s0">&quot;../../web/spec-extension/cookies&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_headers = require(</span><span class="s0">&quot;../../web/spec-extension/adapters/headers&quot;</span><span class="s1">);</span>
<span class="s2">function </span><span class="s1">tryGetPreviewData(req, res, options, multiZoneDraftMode) {</span>
    <span class="s2">var </span><span class="s1">_cookies_get, _cookies_get1;</span>
    <span class="s3">// if an On-Demand revalidation is being done preview mode</span>
    <span class="s3">// is disabled</span>
    <span class="s2">if </span><span class="s1">(options &amp;&amp; (</span><span class="s4">0</span><span class="s1">, _.checkIsOnDemandRevalidate)(req, options).isOnDemandRevalidate) {</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">// Read cached preview data if present</span>
    <span class="s3">// TODO: use request metadata instead of a symbol</span>
    <span class="s2">if </span><span class="s1">(_index.SYMBOL_PREVIEW_DATA </span><span class="s2">in </span><span class="s1">req) {</span>
        <span class="s2">return </span><span class="s1">req[_index.SYMBOL_PREVIEW_DATA];</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">headers = _headers.HeadersAdapter.from(req.headers);</span>
    <span class="s2">const </span><span class="s1">cookies = </span><span class="s2">new </span><span class="s1">_cookies.RequestCookies(headers);</span>
    <span class="s2">const </span><span class="s1">previewModeId = (_cookies_get = cookies.get(_index.COOKIE_NAME_PRERENDER_BYPASS)) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _cookies_get.value;</span>
    <span class="s2">const </span><span class="s1">tokenPreviewData = (_cookies_get1 = cookies.get(_index.COOKIE_NAME_PRERENDER_DATA)) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _cookies_get1.value;</span>
    <span class="s3">// Case: preview mode cookie set but data cookie is not set</span>
    <span class="s2">if </span><span class="s1">(previewModeId &amp;&amp; !tokenPreviewData &amp;&amp; previewModeId === options.previewModeId) {</span>
        <span class="s3">// This is &quot;Draft Mode&quot; which doesn't use</span>
        <span class="s3">// previewData, so we return an empty object</span>
        <span class="s3">// for backwards compat with &quot;Preview Mode&quot;.</span>
        <span class="s2">const </span><span class="s1">data = {};</span>
        <span class="s1">Object.defineProperty(req, _index.SYMBOL_PREVIEW_DATA, {</span>
            <span class="s1">value: data,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span>
        <span class="s1">});</span>
        <span class="s2">return </span><span class="s1">data;</span>
    <span class="s1">}</span>
    <span class="s3">// Case: neither cookie is set.</span>
    <span class="s2">if </span><span class="s1">(!previewModeId &amp;&amp; !tokenPreviewData) {</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">// Case: one cookie is set, but not the other.</span>
    <span class="s2">if </span><span class="s1">(!previewModeId || !tokenPreviewData) {</span>
        <span class="s2">if </span><span class="s1">(!multiZoneDraftMode) {</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, _index.clearPreviewData)(res);</span>
        <span class="s1">}</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">// Case: preview session is for an old build.</span>
    <span class="s2">if </span><span class="s1">(previewModeId !== options.previewModeId) {</span>
        <span class="s2">if </span><span class="s1">(!multiZoneDraftMode) {</span>
            <span class="s1">(</span><span class="s4">0</span><span class="s1">, _index.clearPreviewData)(res);</span>
        <span class="s1">}</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">let </span><span class="s1">encryptedPreviewData;</span>
    <span class="s2">try </span><span class="s1">{</span>
        <span class="s2">const </span><span class="s1">jsonwebtoken = require(</span><span class="s0">'next/dist/compiled/jsonwebtoken'</span><span class="s1">);</span>
        <span class="s1">encryptedPreviewData = jsonwebtoken.verify(tokenPreviewData, options.previewModeSigningKey);</span>
    <span class="s1">} </span><span class="s2">catch  </span><span class="s1">{</span>
        <span class="s3">// TODO: warn</span>
        <span class="s1">(</span><span class="s4">0</span><span class="s1">, _index.clearPreviewData)(res);</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">{ decryptWithSecret } = require(</span><span class="s0">'../../crypto-utils'</span><span class="s1">);</span>
    <span class="s2">const </span><span class="s1">decryptedPreviewData = decryptWithSecret(Buffer.from(options.previewModeEncryptionKey), encryptedPreviewData.data);</span>
    <span class="s2">try </span><span class="s1">{</span>
        <span class="s3">// TODO: strict runtime type checking</span>
        <span class="s2">const </span><span class="s1">data = JSON.parse(decryptedPreviewData);</span>
        <span class="s3">// Cache lookup</span>
        <span class="s1">Object.defineProperty(req, _index.SYMBOL_PREVIEW_DATA, {</span>
            <span class="s1">value: data,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span>
        <span class="s1">});</span>
        <span class="s2">return </span><span class="s1">data;</span>
    <span class="s1">} </span><span class="s2">catch  </span><span class="s1">{</span>
        <span class="s2">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s3">//# sourceMappingURL=try-get-preview-data.js.map</span></pre>
</body>
</html>