<html>
<head>
<title>block-cross-site.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
block-cross-site.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../../src/server/lib/router-utils/block-cross-site.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import type { Duplex } from 'stream'</span><span class="s3">\n</span><span class="s1">import type { IncomingMessage, ServerResponse } from 'node:http'</span><span class="s3">\n</span><span class="s1">import { parseUrl } from '../../../lib/url'</span><span class="s3">\n</span><span class="s1">import { warnOnce } from '../../../build/output/log'</span><span class="s3">\n</span><span class="s1">import { isCsrfOriginAllowed } from '../../app-render/csrf-protection'</span><span class="s3">\n\n</span><span class="s1">function warnOrBlockRequest(</span><span class="s3">\n  </span><span class="s1">res: ServerResponse | Duplex,</span><span class="s3">\n  </span><span class="s1">origin: string | undefined,</span><span class="s3">\n  </span><span class="s1">mode: 'warn' | 'block'</span><span class="s3">\n</span><span class="s1">): boolean {</span><span class="s3">\n  </span><span class="s1">const originString = origin ? `from ${origin}` : ''</span><span class="s3">\n  </span><span class="s1">if (mode === 'warn') {</span><span class="s3">\n    </span><span class="s1">warnOnce(</span><span class="s3">\n      </span><span class="s1">`Cross origin request detected ${originString} to /_next/* resource. In a future major version of Next.js, you will need to explicitly configure </span><span class="s3">\&quot;</span><span class="s1">allowedDevOrigins</span><span class="s3">\&quot; </span><span class="s1">in next.config to allow this.</span><span class="s3">\\</span><span class="s1">nRead more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins`</span><span class="s3">\n    </span><span class="s1">)</span><span class="s3">\n\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">warnOnce(</span><span class="s3">\n    </span><span class="s1">`Blocked cross-origin request ${originString} to /_next/* resource. To allow this, configure </span><span class="s3">\&quot;</span><span class="s1">allowedDevOrigins</span><span class="s3">\&quot; </span><span class="s1">in next.config</span><span class="s3">\\</span><span class="s1">nRead more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins`</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n\n  </span><span class="s1">if ('statusCode' in res) {</span><span class="s3">\n    </span><span class="s1">res.statusCode = 403</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">res.end('Unauthorized')</span><span class="s3">\n\n  </span><span class="s1">return true</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">function isInternalDevEndpoint(req: IncomingMessage): boolean {</span><span class="s3">\n  </span><span class="s1">if (!req.url) return false</span><span class="s3">\n\n  </span><span class="s1">try {</span><span class="s3">\n    </span><span class="s1">// TODO: We should standardize on a single prefix for this</span><span class="s3">\n    </span><span class="s1">const isMiddlewareRequest = req.url.includes('/__nextjs')</span><span class="s3">\n    </span><span class="s1">const isInternalAsset = req.url.includes('/_next')</span><span class="s3">\n    </span><span class="s1">// Static media requests are excluded, as they might be loaded via CSS and would fail</span><span class="s3">\n    </span><span class="s1">// CORS checks.</span><span class="s3">\n    </span><span class="s1">const isIgnoredRequest =</span><span class="s3">\n      </span><span class="s1">req.url.includes('/_next/image') ||</span><span class="s3">\n      </span><span class="s1">req.url.includes('/_next/static/media')</span><span class="s3">\n\n    </span><span class="s1">return !isIgnoredRequest &amp;&amp; (isInternalAsset || isMiddlewareRequest)</span><span class="s3">\n  </span><span class="s1">} catch (err) {</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">export const blockCrossSite = (</span><span class="s3">\n  </span><span class="s1">req: IncomingMessage,</span><span class="s3">\n  </span><span class="s1">res: ServerResponse | Duplex,</span><span class="s3">\n  </span><span class="s1">allowedDevOrigins: string[] | undefined,</span><span class="s3">\n  </span><span class="s1">hostname: string | undefined</span><span class="s3">\n</span><span class="s1">): boolean =&gt; {</span><span class="s3">\n  </span><span class="s1">// in the future, these will be blocked by default when allowed origins aren't configured.</span><span class="s3">\n  </span><span class="s1">// for now, we warn when allowed origins aren't configured</span><span class="s3">\n  </span><span class="s1">const mode = typeof allowedDevOrigins === 'undefined' ? 'warn' : 'block'</span><span class="s3">\n\n  </span><span class="s1">const allowedOrigins = [</span><span class="s3">\n    </span><span class="s1">'*.localhost',</span><span class="s3">\n    </span><span class="s1">'localhost',</span><span class="s3">\n    </span><span class="s1">...(allowedDevOrigins || []),</span><span class="s3">\n  </span><span class="s1">]</span><span class="s3">\n  </span><span class="s1">if (hostname) {</span><span class="s3">\n    </span><span class="s1">allowedOrigins.push(hostname)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// only process internal URLs/middleware</span><span class="s3">\n  </span><span class="s1">if (!isInternalDevEndpoint(req)) {</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">// block non-cors request from cross-site e.g. script tag on</span><span class="s3">\n  </span><span class="s1">// different host</span><span class="s3">\n  </span><span class="s1">if (</span><span class="s3">\n    </span><span class="s1">req.headers['sec-fetch-mode'] === 'no-cors' &amp;&amp;</span><span class="s3">\n    </span><span class="s1">req.headers['sec-fetch-site'] === 'cross-site'</span><span class="s3">\n  </span><span class="s1">) {</span><span class="s3">\n    </span><span class="s1">return warnOrBlockRequest(res, undefined, mode)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// ensure websocket requests from allowed origin</span><span class="s3">\n  </span><span class="s1">const rawOrigin = req.headers['origin']</span><span class="s3">\n\n  </span><span class="s1">if (rawOrigin) {</span><span class="s3">\n    </span><span class="s1">const parsedOrigin = parseUrl(rawOrigin)</span><span class="s3">\n\n    </span><span class="s1">if (parsedOrigin) {</span><span class="s3">\n      </span><span class="s1">const originLowerCase = parsedOrigin.hostname.toLowerCase()</span><span class="s3">\n\n      </span><span class="s1">if (!isCsrfOriginAllowed(originLowerCase, allowedOrigins)) {</span><span class="s3">\n        </span><span class="s1">return warnOrBlockRequest(res, originLowerCase, mode)</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">return false</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;blockCrossSite&quot;</span><span class="s0">,</span><span class="s1">&quot;warnOrBlockRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;res&quot;</span><span class="s0">,</span><span class="s1">&quot;origin&quot;</span><span class="s0">,</span><span class="s1">&quot;mode&quot;</span><span class="s0">,</span><span class="s1">&quot;originString&quot;</span><span class="s0">,</span><span class="s1">&quot;warnOnce&quot;</span><span class="s0">,</span><span class="s1">&quot;statusCode&quot;</span><span class="s0">,</span><span class="s1">&quot;end&quot;</span><span class="s0">,</span><span class="s1">&quot;isInternalDevEndpoint&quot;</span><span class="s0">,</span><span class="s1">&quot;req&quot;</span><span class="s0">,</span><span class="s1">&quot;url&quot;</span><span class="s0">,</span><span class="s1">&quot;isMiddlewareRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;includes&quot;</span><span class="s0">,</span><span class="s1">&quot;isInternalAsset&quot;</span><span class="s0">,</span><span class="s1">&quot;isIgnoredRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;err&quot;</span><span class="s0">,</span><span class="s1">&quot;allowedDevOrigins&quot;</span><span class="s0">,</span><span class="s1">&quot;hostname&quot;</span><span class="s0">,</span><span class="s1">&quot;allowedOrigins&quot;</span><span class="s0">,</span><span class="s1">&quot;push&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;undefined&quot;</span><span class="s0">,</span><span class="s1">&quot;rawOrigin&quot;</span><span class="s0">,</span><span class="s1">&quot;parsedOrigin&quot;</span><span class="s0">,</span><span class="s1">&quot;parseUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;originLowerCase&quot;</span><span class="s0">,</span><span class="s1">&quot;toLowerCase&quot;</span><span class="s0">,</span><span class="s1">&quot;isCsrfOriginAllowed&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;+BAoDaA;;;eAAAA;;;qBAlDY;qBACA;gCACW;AAEpC,SAASC,mBACPC,GAA4B,EAC5BC,MAA0B,EAC1BC,IAAsB;IAEtB,MAAMC,eAAeF,SAAS,CAAC,KAAK,EAAEA,QAAQ,GAAG;IACjD,IAAIC,SAAS,QAAQ;QACnBE,IAAAA,aAAQ,EACN,CAAC,8BAA8B,EAAED,aAAa,kPAAkP,CAAC;QAGnS,OAAO;IACT;IAEAC,IAAAA,aAAQ,EACN,CAAC,6BAA6B,EAAED,aAAa,gLAAgL,CAAC;IAGhO,IAAI,gBAAgBH,KAAK;QACvBA,IAAIK,UAAU,GAAG;IACnB;IAEAL,IAAIM,GAAG,CAAC;IAER,OAAO;AACT;AAEA,SAASC,sBAAsBC,GAAoB;IACjD,IAAI,CAACA,IAAIC,GAAG,EAAE,OAAO;IAErB,IAAI;QACF,0DAA0D;QAC1D,MAAMC,sBAAsBF,IAAIC,GAAG,CAACE,QAAQ,CAAC;QAC7C,MAAMC,kBAAkBJ,IAAIC,GAAG,CAACE,QAAQ,CAAC;QACzC,qFAAqF;QACrF,eAAe;QACf,MAAME,mBACJL,IAAIC,GAAG,CAACE,QAAQ,CAAC,mBACjBH,IAAIC,GAAG,CAACE,QAAQ,CAAC;QAEnB,OAAO,CAACE,oBAAqBD,CAAAA,mBAAmBF,mBAAkB;IACpE,EAAE,OAAOI,KAAK;QACZ,OAAO;IACT;AACF;AAEO,MAAMhB,iBAAiB,CAC5BU,KACAR,KACAe,mBACAC;IAEA,0FAA0F;IAC1F,0DAA0D;IAC1D,MAAMd,OAAO,OAAOa,sBAAsB,cAAc,SAAS;IAEjE,MAAME,iBAAiB;QACrB;QACA;WACIF,qBAAqB,EAAE;KAC5B;IACD,IAAIC,UAAU;QACZC,eAAeC,IAAI,CAACF;IACtB;IAEA,wCAAwC;IACxC,IAAI,CAACT,sBAAsBC,MAAM;QAC/B,OAAO;IACT;IACA,4DAA4D;IAC5D,iBAAiB;IACjB,IACEA,IAAIW,OAAO,CAAC,iBAAiB,KAAK,aAClCX,IAAIW,OAAO,CAAC,iBAAiB,KAAK,cAClC;QACA,OAAOpB,mBAAmBC,KAAKoB,WAAWlB;IAC5C;IAEA,gDAAgD;IAChD,MAAMmB,YAAYb,IAAIW,OAAO,CAAC,SAAS;IAEvC,IAAIE,WAAW;QACb,MAAMC,eAAeC,IAAAA,aAAQ,EAACF;QAE9B,IAAIC,cAAc;YAChB,MAAME,kBAAkBF,aAAaN,QAAQ,CAACS,WAAW;YAEzD,IAAI,CAACC,IAAAA,mCAAmB,EAACF,iBAAiBP,iBAAiB;gBACzD,OAAOlB,mBAAmBC,KAAKwB,iBAAiBtB;YAClD;QACF;IACF;IAEA,OAAO;AACT&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>