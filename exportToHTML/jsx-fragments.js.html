<html>
<head>
<title>jsx-fragments.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #067d17;}
.s4 { color: #0033b3;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
jsx-fragments.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@fileoverview </span><span class="s0">Enforce shorthand or standard form for React fragments.</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Alex Zherdev</span>
 <span class="s0">*/</span>

<span class="s3">'use strict'</span><span class="s2">;</span>

<span class="s4">const </span><span class="s2">elementType = require(</span><span class="s3">'jsx-ast-utils/elementType'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">pragmaUtil = require(</span><span class="s3">'../util/pragma'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">variableUtil = require(</span><span class="s3">'../util/variable'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">testReactVersion = require(</span><span class="s3">'../util/version'</span><span class="s2">).testReactVersion;</span>
<span class="s4">const </span><span class="s2">docsUrl = require(</span><span class="s3">'../util/docsUrl'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">report = require(</span><span class="s3">'../util/report'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">getText = require(</span><span class="s3">'../util/eslint'</span><span class="s2">).getText;</span>

<span class="s0">// ------------------------------------------------------------------------------</span>
<span class="s0">// Rule Definition</span>
<span class="s0">// ------------------------------------------------------------------------------</span>

<span class="s4">function </span><span class="s2">replaceNode(source, node, text) {</span>
  <span class="s4">return </span><span class="s3">`</span><span class="s2">${source.slice(</span><span class="s5">0</span><span class="s2">, node.range[</span><span class="s5">0</span><span class="s2">])}${text}${source.slice(node.range[</span><span class="s5">1</span><span class="s2">])}</span><span class="s3">`</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s4">const </span><span class="s2">messages = {</span>
  <span class="s2">fragmentsNotSupported: </span><span class="s3">'Fragments are only supported starting from React v16.2. Please disable the `react/jsx-fragments` rule in `eslint` settings or upgrade your version of React.'</span><span class="s2">,</span>
  <span class="s2">preferPragma: </span><span class="s3">'Prefer {{react}}.{{fragment}} over fragment shorthand'</span><span class="s2">,</span>
  <span class="s2">preferFragment: </span><span class="s3">'Prefer fragment shorthand over {{react}}.{{fragment}}'</span><span class="s2">,</span>
<span class="s2">};</span>

<span class="s0">/** </span><span class="s1">@type </span><span class="s0">{import('eslint').Rule.RuleModule} */</span>
<span class="s2">module.exports = {</span>
  <span class="s2">meta: {</span>
    <span class="s2">docs: {</span>
      <span class="s2">description: </span><span class="s3">'Enforce shorthand or standard form for React fragments'</span><span class="s2">,</span>
      <span class="s2">category: </span><span class="s3">'Stylistic Issues'</span><span class="s2">,</span>
      <span class="s2">recommended: </span><span class="s4">false</span><span class="s2">,</span>
      <span class="s2">url: docsUrl(</span><span class="s3">'jsx-fragments'</span><span class="s2">),</span>
    <span class="s2">},</span>
    <span class="s2">fixable: </span><span class="s3">'code'</span><span class="s2">,</span>

    <span class="s2">messages,</span>

    <span class="s2">schema: [{</span>
      <span class="s4">enum</span><span class="s2">: [</span><span class="s3">'syntax'</span><span class="s2">, </span><span class="s3">'element'</span><span class="s2">],</span>
    <span class="s2">}],</span>
  <span class="s2">},</span>

  <span class="s2">create(context) {</span>
    <span class="s4">const </span><span class="s2">configuration = context.options[</span><span class="s5">0</span><span class="s2">] || </span><span class="s3">'syntax'</span><span class="s2">;</span>
    <span class="s4">const </span><span class="s2">reactPragma = pragmaUtil.getFromContext(context);</span>
    <span class="s4">const </span><span class="s2">fragmentPragma = pragmaUtil.getFragmentFromContext(context);</span>
    <span class="s4">const </span><span class="s2">openFragShort = </span><span class="s3">'&lt;&gt;'</span><span class="s2">;</span>
    <span class="s4">const </span><span class="s2">closeFragShort = </span><span class="s3">'&lt;/&gt;'</span><span class="s2">;</span>
    <span class="s4">const </span><span class="s2">openFragLong = </span><span class="s3">`&lt;</span><span class="s2">${reactPragma}</span><span class="s3">.</span><span class="s2">${fragmentPragma}</span><span class="s3">&gt;`</span><span class="s2">;</span>
    <span class="s4">const </span><span class="s2">closeFragLong = </span><span class="s3">`&lt;/</span><span class="s2">${reactPragma}</span><span class="s3">.</span><span class="s2">${fragmentPragma}</span><span class="s3">&gt;`</span><span class="s2">;</span>

    <span class="s4">function </span><span class="s2">reportOnReactVersion(node) {</span>
      <span class="s4">if </span><span class="s2">(!testReactVersion(context, </span><span class="s3">'&gt;= 16.2.0'</span><span class="s2">)) {</span>
        <span class="s2">report(context, messages.fragmentsNotSupported, </span><span class="s3">'fragmentsNotSupported'</span><span class="s2">, {</span>
          <span class="s2">node,</span>
        <span class="s2">});</span>
        <span class="s4">return true</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">return false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">function </span><span class="s2">getFixerToLong(jsxFragment) {</span>
      <span class="s4">if </span><span class="s2">(!jsxFragment.closingFragment || !jsxFragment.openingFragment) {</span>
        <span class="s0">// the old TS parser crashes here</span>
        <span class="s0">// TODO: FIXME: can we fake these two descriptors?</span>
        <span class="s4">return null</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s4">return function </span><span class="s2">fix(fixer) {</span>
        <span class="s4">let </span><span class="s2">source = getText(context);</span>
        <span class="s2">source = replaceNode(source, jsxFragment.closingFragment, closeFragLong);</span>
        <span class="s2">source = replaceNode(source, jsxFragment.openingFragment, openFragLong);</span>
        <span class="s4">const </span><span class="s2">lengthDiff = openFragLong.length - getText(context, jsxFragment.openingFragment).length</span>
          <span class="s2">+ closeFragLong.length - getText(context, jsxFragment.closingFragment).length;</span>
        <span class="s4">const </span><span class="s2">range = jsxFragment.range;</span>
        <span class="s4">return </span><span class="s2">fixer.replaceTextRange(range, source.slice(range[</span><span class="s5">0</span><span class="s2">], range[</span><span class="s5">1</span><span class="s2">] + lengthDiff));</span>
      <span class="s2">};</span>
    <span class="s2">}</span>

    <span class="s4">function </span><span class="s2">getFixerToShort(jsxElement) {</span>
      <span class="s4">return function </span><span class="s2">fix(fixer) {</span>
        <span class="s4">let </span><span class="s2">source = getText(context);</span>
        <span class="s4">let </span><span class="s2">lengthDiff;</span>
        <span class="s4">if </span><span class="s2">(jsxElement.closingElement) {</span>
          <span class="s2">source = replaceNode(source, jsxElement.closingElement, closeFragShort);</span>
          <span class="s2">source = replaceNode(source, jsxElement.openingElement, openFragShort);</span>
          <span class="s2">lengthDiff = getText(context, jsxElement.openingElement).length - openFragShort.length</span>
            <span class="s2">+ getText(context, jsxElement.closingElement).length - closeFragShort.length;</span>
        <span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
          <span class="s2">source = replaceNode(source, jsxElement.openingElement, </span><span class="s3">`</span><span class="s2">${openFragShort}${closeFragShort}</span><span class="s3">`</span><span class="s2">);</span>
          <span class="s2">lengthDiff = getText(context, jsxElement.openingElement).length - openFragShort.length</span>
            <span class="s2">- closeFragShort.length;</span>
        <span class="s2">}</span>

        <span class="s4">const </span><span class="s2">range = jsxElement.range;</span>
        <span class="s4">return </span><span class="s2">fixer.replaceTextRange(range, source.slice(range[</span><span class="s5">0</span><span class="s2">], range[</span><span class="s5">1</span><span class="s2">] - lengthDiff));</span>
      <span class="s2">};</span>
    <span class="s2">}</span>

    <span class="s4">function </span><span class="s2">refersToReactFragment(node, name) {</span>
      <span class="s4">const </span><span class="s2">variableInit = variableUtil.findVariableByName(context, node, name);</span>
      <span class="s4">if </span><span class="s2">(!variableInit) {</span>
        <span class="s4">return false</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">// const { Fragment } = React;</span>
      <span class="s4">if </span><span class="s2">(variableInit.type === </span><span class="s3">'Identifier' </span><span class="s2">&amp;&amp; variableInit.name === reactPragma) {</span>
        <span class="s4">return true</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">// const Fragment = React.Fragment;</span>
      <span class="s4">if </span><span class="s2">(</span>
        <span class="s2">variableInit.type === </span><span class="s3">'MemberExpression'</span>
        <span class="s2">&amp;&amp; variableInit.object.type === </span><span class="s3">'Identifier'</span>
        <span class="s2">&amp;&amp; variableInit.object.name === reactPragma</span>
        <span class="s2">&amp;&amp; variableInit.property.type === </span><span class="s3">'Identifier'</span>
        <span class="s2">&amp;&amp; variableInit.property.name === fragmentPragma</span>
      <span class="s2">) {</span>
        <span class="s4">return true</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s0">// const { Fragment } = require('react');</span>
      <span class="s4">if </span><span class="s2">(</span>
        <span class="s2">variableInit.callee</span>
        <span class="s2">&amp;&amp; variableInit.callee.name === </span><span class="s3">'require'</span>
        <span class="s2">&amp;&amp; variableInit.arguments</span>
        <span class="s2">&amp;&amp; variableInit.arguments[</span><span class="s5">0</span><span class="s2">]</span>
        <span class="s2">&amp;&amp; variableInit.arguments[</span><span class="s5">0</span><span class="s2">].value === </span><span class="s3">'react'</span>
      <span class="s2">) {</span>
        <span class="s4">return true</span><span class="s2">;</span>
      <span class="s2">}</span>

      <span class="s4">return false</span><span class="s2">;</span>
    <span class="s2">}</span>

    <span class="s4">const </span><span class="s2">jsxElements = [];</span>
    <span class="s4">const </span><span class="s2">fragmentNames = </span><span class="s4">new </span><span class="s2">Set([</span><span class="s3">`</span><span class="s2">${reactPragma}</span><span class="s3">.</span><span class="s2">${fragmentPragma}</span><span class="s3">`</span><span class="s2">]);</span>

    <span class="s0">// --------------------------------------------------------------------------</span>
    <span class="s0">// Public</span>
    <span class="s0">// --------------------------------------------------------------------------</span>

    <span class="s4">return </span><span class="s2">{</span>
      <span class="s2">JSXElement(node) {</span>
        <span class="s2">jsxElements.push(node);</span>
      <span class="s2">},</span>

      <span class="s2">JSXFragment(node) {</span>
        <span class="s4">if </span><span class="s2">(reportOnReactVersion(node)) {</span>
          <span class="s4">return</span><span class="s2">;</span>
        <span class="s2">}</span>

        <span class="s4">if </span><span class="s2">(configuration === </span><span class="s3">'element'</span><span class="s2">) {</span>
          <span class="s2">report(context, messages.preferPragma, </span><span class="s3">'preferPragma'</span><span class="s2">, {</span>
            <span class="s2">node,</span>
            <span class="s2">data: {</span>
              <span class="s2">react: reactPragma,</span>
              <span class="s2">fragment: fragmentPragma,</span>
            <span class="s2">},</span>
            <span class="s2">fix: getFixerToLong(node),</span>
          <span class="s2">});</span>
        <span class="s2">}</span>
      <span class="s2">},</span>

      <span class="s2">ImportDeclaration(node) {</span>
        <span class="s4">if </span><span class="s2">(node.source &amp;&amp; node.source.value === </span><span class="s3">'react'</span><span class="s2">) {</span>
          <span class="s2">node.specifiers.forEach((spec) =&gt; {</span>
            <span class="s4">if </span><span class="s2">(</span>
              <span class="s3">'imported' </span><span class="s4">in </span><span class="s2">spec</span>
              <span class="s2">&amp;&amp; spec.imported</span>
              <span class="s2">&amp;&amp; </span><span class="s3">'name' </span><span class="s4">in </span><span class="s2">spec.imported</span>
              <span class="s2">&amp;&amp; spec.imported.name === fragmentPragma</span>
            <span class="s2">) {</span>
              <span class="s4">if </span><span class="s2">(spec.local) {</span>
                <span class="s2">fragmentNames.add(spec.local.name);</span>
              <span class="s2">}</span>
            <span class="s2">}</span>
          <span class="s2">});</span>
        <span class="s2">}</span>
      <span class="s2">},</span>

      <span class="s3">'Program:exit'</span><span class="s2">() {</span>
        <span class="s2">jsxElements.forEach((node) =&gt; {</span>
          <span class="s4">const </span><span class="s2">openingEl = node.openingElement;</span>
          <span class="s4">const </span><span class="s2">elName = elementType(openingEl);</span>

          <span class="s4">if </span><span class="s2">(fragmentNames.has(elName) || refersToReactFragment(node, elName)) {</span>
            <span class="s4">if </span><span class="s2">(reportOnReactVersion(node)) {</span>
              <span class="s4">return</span><span class="s2">;</span>
            <span class="s2">}</span>

            <span class="s4">const </span><span class="s2">attrs = openingEl.attributes;</span>
            <span class="s4">if </span><span class="s2">(configuration === </span><span class="s3">'syntax' </span><span class="s2">&amp;&amp; !(attrs &amp;&amp; attrs.length &gt; </span><span class="s5">0</span><span class="s2">)) {</span>
              <span class="s2">report(context, messages.preferFragment, </span><span class="s3">'preferFragment'</span><span class="s2">, {</span>
                <span class="s2">node,</span>
                <span class="s2">data: {</span>
                  <span class="s2">react: reactPragma,</span>
                  <span class="s2">fragment: fragmentPragma,</span>
                <span class="s2">},</span>
                <span class="s2">fix: getFixerToShort(node),</span>
              <span class="s2">});</span>
            <span class="s2">}</span>
          <span class="s2">}</span>
        <span class="s2">});</span>
      <span class="s2">},</span>
    <span class="s2">};</span>
  <span class="s2">},</span>
<span class="s2">};</span>
</pre>
</body>
</html>