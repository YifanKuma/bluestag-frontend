<html>
<head>
<title>try-get-preview-data.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
try-get-preview-data.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../../src/server/api-utils/node/try-get-preview-data.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import type { IncomingMessage, ServerResponse } from 'http'</span><span class="s3">\n</span><span class="s1">import type { NextApiResponse } from '../../../shared/lib/utils'</span><span class="s3">\n</span><span class="s1">import { checkIsOnDemandRevalidate } from '../.'</span><span class="s3">\n</span><span class="s1">import type { __ApiPreviewProps } from '../.'</span><span class="s3">\n</span><span class="s1">import type { BaseNextRequest, BaseNextResponse } from '../../base-http'</span><span class="s3">\n</span><span class="s1">import type { PreviewData } from '../../../types'</span><span class="s3">\n\n</span><span class="s1">import {</span><span class="s3">\n  </span><span class="s1">clearPreviewData,</span><span class="s3">\n  </span><span class="s1">COOKIE_NAME_PRERENDER_BYPASS,</span><span class="s3">\n  </span><span class="s1">COOKIE_NAME_PRERENDER_DATA,</span><span class="s3">\n  </span><span class="s1">SYMBOL_PREVIEW_DATA,</span><span class="s3">\n</span><span class="s1">} from '../index'</span><span class="s3">\n</span><span class="s1">import { RequestCookies } from '../../web/spec-extension/cookies'</span><span class="s3">\n</span><span class="s1">import { HeadersAdapter } from '../../web/spec-extension/adapters/headers'</span><span class="s3">\n\n</span><span class="s1">export function tryGetPreviewData(</span><span class="s3">\n  </span><span class="s1">req: IncomingMessage | BaseNextRequest | Request,</span><span class="s3">\n  </span><span class="s1">res: ServerResponse | BaseNextResponse,</span><span class="s3">\n  </span><span class="s1">options: __ApiPreviewProps,</span><span class="s3">\n  </span><span class="s1">multiZoneDraftMode: boolean</span><span class="s3">\n</span><span class="s1">): PreviewData {</span><span class="s3">\n  </span><span class="s1">// if an On-Demand revalidation is being done preview mode</span><span class="s3">\n  </span><span class="s1">// is disabled</span><span class="s3">\n  </span><span class="s1">if (options &amp;&amp; checkIsOnDemandRevalidate(req, options).isOnDemandRevalidate) {</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// Read cached preview data if present</span><span class="s3">\n  </span><span class="s1">// TODO: use request metadata instead of a symbol</span><span class="s3">\n  </span><span class="s1">if (SYMBOL_PREVIEW_DATA in req) {</span><span class="s3">\n    </span><span class="s1">return (req as any)[SYMBOL_PREVIEW_DATA] as any</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const headers = HeadersAdapter.from(req.headers)</span><span class="s3">\n  </span><span class="s1">const cookies = new RequestCookies(headers)</span><span class="s3">\n\n  </span><span class="s1">const previewModeId = cookies.get(COOKIE_NAME_PRERENDER_BYPASS)?.value</span><span class="s3">\n  </span><span class="s1">const tokenPreviewData = cookies.get(COOKIE_NAME_PRERENDER_DATA)?.value</span><span class="s3">\n\n  </span><span class="s1">// Case: preview mode cookie set but data cookie is not set</span><span class="s3">\n  </span><span class="s1">if (</span><span class="s3">\n    </span><span class="s1">previewModeId &amp;&amp;</span><span class="s3">\n    </span><span class="s1">!tokenPreviewData &amp;&amp;</span><span class="s3">\n    </span><span class="s1">previewModeId === options.previewModeId</span><span class="s3">\n  </span><span class="s1">) {</span><span class="s3">\n    </span><span class="s1">// This is </span><span class="s3">\&quot;</span><span class="s1">Draft Mode</span><span class="s3">\&quot; </span><span class="s1">which doesn't use</span><span class="s3">\n    </span><span class="s1">// previewData, so we return an empty object</span><span class="s3">\n    </span><span class="s1">// for backwards compat with </span><span class="s3">\&quot;</span><span class="s1">Preview Mode</span><span class="s3">\&quot;</span><span class="s1">.</span><span class="s3">\n    </span><span class="s1">const data = {}</span><span class="s3">\n    </span><span class="s1">Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {</span><span class="s3">\n      </span><span class="s1">value: data,</span><span class="s3">\n      </span><span class="s1">enumerable: false,</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">return data</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// Case: neither cookie is set.</span><span class="s3">\n  </span><span class="s1">if (!previewModeId &amp;&amp; !tokenPreviewData) {</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// Case: one cookie is set, but not the other.</span><span class="s3">\n  </span><span class="s1">if (!previewModeId || !tokenPreviewData) {</span><span class="s3">\n    </span><span class="s1">if (!multiZoneDraftMode) {</span><span class="s3">\n      </span><span class="s1">clearPreviewData(res as NextApiResponse)</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// Case: preview session is for an old build.</span><span class="s3">\n  </span><span class="s1">if (previewModeId !== options.previewModeId) {</span><span class="s3">\n    </span><span class="s1">if (!multiZoneDraftMode) {</span><span class="s3">\n      </span><span class="s1">clearPreviewData(res as NextApiResponse)</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">let encryptedPreviewData: {</span><span class="s3">\n    </span><span class="s1">data: string</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">try {</span><span class="s3">\n    </span><span class="s1">const jsonwebtoken =</span><span class="s3">\n      </span><span class="s1">require('next/dist/compiled/jsonwebtoken') as typeof import('next/dist/compiled/jsonwebtoken')</span><span class="s3">\n    </span><span class="s1">encryptedPreviewData = jsonwebtoken.verify(</span><span class="s3">\n      </span><span class="s1">tokenPreviewData,</span><span class="s3">\n      </span><span class="s1">options.previewModeSigningKey</span><span class="s3">\n    </span><span class="s1">) as typeof encryptedPreviewData</span><span class="s3">\n  </span><span class="s1">} catch {</span><span class="s3">\n    </span><span class="s1">// TODO: warn</span><span class="s3">\n    </span><span class="s1">clearPreviewData(res as NextApiResponse)</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const { decryptWithSecret } =</span><span class="s3">\n    </span><span class="s1">require('../../crypto-utils') as typeof import('../../crypto-utils')</span><span class="s3">\n  </span><span class="s1">const decryptedPreviewData = decryptWithSecret(</span><span class="s3">\n    </span><span class="s1">Buffer.from(options.previewModeEncryptionKey),</span><span class="s3">\n    </span><span class="s1">encryptedPreviewData.data</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n\n  </span><span class="s1">try {</span><span class="s3">\n    </span><span class="s1">// TODO: strict runtime type checking</span><span class="s3">\n    </span><span class="s1">const data = JSON.parse(decryptedPreviewData)</span><span class="s3">\n    </span><span class="s1">// Cache lookup</span><span class="s3">\n    </span><span class="s1">Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {</span><span class="s3">\n      </span><span class="s1">value: data,</span><span class="s3">\n      </span><span class="s1">enumerable: false,</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">return data</span><span class="s3">\n  </span><span class="s1">} catch {</span><span class="s3">\n    </span><span class="s1">return false</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;tryGetPreviewData&quot;</span><span class="s0">,</span><span class="s1">&quot;req&quot;</span><span class="s0">,</span><span class="s1">&quot;res&quot;</span><span class="s0">,</span><span class="s1">&quot;options&quot;</span><span class="s0">,</span><span class="s1">&quot;multiZoneDraftMode&quot;</span><span class="s0">,</span><span class="s1">&quot;cookies&quot;</span><span class="s0">,</span><span class="s1">&quot;checkIsOnDemandRevalidate&quot;</span><span class="s0">,</span><span class="s1">&quot;isOnDemandRevalidate&quot;</span><span class="s0">,</span><span class="s1">&quot;SYMBOL_PREVIEW_DATA&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;HeadersAdapter&quot;</span><span class="s0">,</span><span class="s1">&quot;from&quot;</span><span class="s0">,</span><span class="s1">&quot;RequestCookies&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeId&quot;</span><span class="s0">,</span><span class="s1">&quot;get&quot;</span><span class="s0">,</span><span class="s1">&quot;COOKIE_NAME_PRERENDER_BYPASS&quot;</span><span class="s0">,</span><span class="s1">&quot;value&quot;</span><span class="s0">,</span><span class="s1">&quot;tokenPreviewData&quot;</span><span class="s0">,</span><span class="s1">&quot;COOKIE_NAME_PRERENDER_DATA&quot;</span><span class="s0">,</span><span class="s1">&quot;data&quot;</span><span class="s0">,</span><span class="s1">&quot;Object&quot;</span><span class="s0">,</span><span class="s1">&quot;defineProperty&quot;</span><span class="s0">,</span><span class="s1">&quot;enumerable&quot;</span><span class="s0">,</span><span class="s1">&quot;clearPreviewData&quot;</span><span class="s0">,</span><span class="s1">&quot;encryptedPreviewData&quot;</span><span class="s0">,</span><span class="s1">&quot;jsonwebtoken&quot;</span><span class="s0">,</span><span class="s1">&quot;require&quot;</span><span class="s0">,</span><span class="s1">&quot;verify&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeSigningKey&quot;</span><span class="s0">,</span><span class="s1">&quot;decryptWithSecret&quot;</span><span class="s0">,</span><span class="s1">&quot;decryptedPreviewData&quot;</span><span class="s0">,</span><span class="s1">&quot;Buffer&quot;</span><span class="s0">,</span><span class="s1">&quot;previewModeEncryptionKey&quot;</span><span class="s0">,</span><span class="s1">&quot;JSON&quot;</span><span class="s0">,</span><span class="s1">&quot;parse&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;+BAgBgBA;;;eAAAA;;;kBAd0B;uBAUnC;yBACwB;yBACA;AAExB,SAASA,kBACdC,GAAgD,EAChDC,GAAsC,EACtCC,OAA0B,EAC1BC,kBAA2B;QAiBLC,cACGA;IAhBzB,0DAA0D;IAC1D,cAAc;IACd,IAAIF,WAAWG,IAAAA,2BAAyB,EAACL,KAAKE,SAASI,oBAAoB,EAAE;QAC3E,OAAO;IACT;IAEA,sCAAsC;IACtC,iDAAiD;IACjD,IAAIC,0BAAmB,IAAIP,KAAK;QAC9B,OAAO,AAACA,GAAW,CAACO,0BAAmB,CAAC;IAC1C;IAEA,MAAMC,UAAUC,uBAAc,CAACC,IAAI,CAACV,IAAIQ,OAAO;IAC/C,MAAMJ,UAAU,IAAIO,uBAAc,CAACH;IAEnC,MAAMI,iBAAgBR,eAAAA,QAAQS,GAAG,CAACC,mCAA4B,sBAAxCV,aAA2CW,KAAK;IACtE,MAAMC,oBAAmBZ,gBAAAA,QAAQS,GAAG,CAACI,iCAA0B,sBAAtCb,cAAyCW,KAAK;IAEvE,2DAA2D;IAC3D,IACEH,iBACA,CAACI,oBACDJ,kBAAkBV,QAAQU,aAAa,EACvC;QACA,yCAAyC;QACzC,4CAA4C;QAC5C,4CAA4C;QAC5C,MAAMM,OAAO,CAAC;QACdC,OAAOC,cAAc,CAACpB,KAAKO,0BAAmB,EAAE;YAC9CQ,OAAOG;YACPG,YAAY;QACd;QACA,OAAOH;IACT;IAEA,+BAA+B;IAC/B,IAAI,CAACN,iBAAiB,CAACI,kBAAkB;QACvC,OAAO;IACT;IAEA,8CAA8C;IAC9C,IAAI,CAACJ,iBAAiB,CAACI,kBAAkB;QACvC,IAAI,CAACb,oBAAoB;YACvBmB,IAAAA,uBAAgB,EAACrB;QACnB;QACA,OAAO;IACT;IAEA,6CAA6C;IAC7C,IAAIW,kBAAkBV,QAAQU,aAAa,EAAE;QAC3C,IAAI,CAACT,oBAAoB;YACvBmB,IAAAA,uBAAgB,EAACrB;QACnB;QACA,OAAO;IACT;IAEA,IAAIsB;IAGJ,IAAI;QACF,MAAMC,eACJC,QAAQ;QACVF,uBAAuBC,aAAaE,MAAM,CACxCV,kBACAd,QAAQyB,qBAAqB;IAEjC,EAAE,OAAM;QACN,aAAa;QACbL,IAAAA,uBAAgB,EAACrB;QACjB,OAAO;IACT;IAEA,MAAM,EAAE2B,iBAAiB,EAAE,GACzBH,QAAQ;IACV,MAAMI,uBAAuBD,kBAC3BE,OAAOpB,IAAI,CAACR,QAAQ6B,wBAAwB,GAC5CR,qBAAqBL,IAAI;IAG3B,IAAI;QACF,qCAAqC;QACrC,MAAMA,OAAOc,KAAKC,KAAK,CAACJ;QACxB,eAAe;QACfV,OAAOC,cAAc,CAACpB,KAAKO,0BAAmB,EAAE;YAC9CQ,OAAOG;YACPG,YAAY;QACd;QACA,OAAOH;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>