<html>
<head>
<title>metadata.test.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
metadata.test.js</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">metadata from </span><span class="s2">'../metadata.min.json' </span><span class="s0">with </span><span class="s1">{ type: </span><span class="s2">'json' </span><span class="s1">}</span>
<span class="s0">import </span><span class="s1">metadataV1 from </span><span class="s2">'../test/metadata/1.0.0/metadata.min.json' </span><span class="s0">with </span><span class="s1">{ type: </span><span class="s2">'json' </span><span class="s1">}</span>
<span class="s0">import </span><span class="s1">metadataV2 from </span><span class="s2">'../test/metadata/1.1.11/metadata.min.json' </span><span class="s0">with </span><span class="s1">{ type: </span><span class="s2">'json' </span><span class="s1">}</span>
<span class="s0">import </span><span class="s1">metadataV3 from </span><span class="s2">'../test/metadata/1.7.34/metadata.min.json' </span><span class="s0">with </span><span class="s1">{ type: </span><span class="s2">'json' </span><span class="s1">}</span>
<span class="s0">import </span><span class="s1">metadataV4 from </span><span class="s2">'../test/metadata/1.7.37/metadata.min.json' </span><span class="s0">with </span><span class="s1">{ type: </span><span class="s2">'json' </span><span class="s1">}</span>

<span class="s0">import </span><span class="s1">Metadata, { validateMetadata, getExtPrefix, isSupportedCountry } from </span><span class="s2">'./metadata.js'</span>

<span class="s1">describe(</span><span class="s2">'metadata'</span><span class="s1">, () =&gt; {</span>
	<span class="s1">it(</span><span class="s2">'should return undefined for non-defined types'</span><span class="s1">, () =&gt; {</span>
		<span class="s0">const </span><span class="s1">FR = </span><span class="s0">new </span><span class="s1">Metadata(metadata).country(</span><span class="s2">'FR'</span><span class="s1">)</span>
		<span class="s1">expect(type(FR.type(</span><span class="s2">'FIXED_LINE'</span><span class="s1">))).to.equal(</span><span class="s2">'undefined'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should validate country'</span><span class="s1">, () =&gt; {</span>
		<span class="s0">const </span><span class="s1">thrower = () =&gt; </span><span class="s0">new </span><span class="s1">Metadata(metadata).country(</span><span class="s2">'RUS'</span><span class="s1">)</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Unknown country'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should tell if a country is supported'</span><span class="s1">, () =&gt; {</span>
		<span class="s1">expect(isSupportedCountry(</span><span class="s2">'RU'</span><span class="s1">, metadata)).to.equal(</span><span class="s0">true</span><span class="s1">)</span>
		<span class="s1">expect(isSupportedCountry(</span><span class="s2">'XX'</span><span class="s1">, metadata)).to.equal(</span><span class="s0">false</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should return ext prefix for a country'</span><span class="s1">, () =&gt; {</span>
		<span class="s1">expect(getExtPrefix(</span><span class="s2">'US'</span><span class="s1">, metadata)).to.equal(</span><span class="s2">' ext. '</span><span class="s1">)</span>
		<span class="s1">expect(getExtPrefix(</span><span class="s2">'CA'</span><span class="s1">, metadata)).to.equal(</span><span class="s2">' ext. '</span><span class="s1">)</span>
		<span class="s1">expect(getExtPrefix(</span><span class="s2">'GB'</span><span class="s1">, metadata)).to.equal(</span><span class="s2">' x'</span><span class="s1">)</span>
		<span class="s3">// expect(getExtPrefix('XX', metadata)).to.equal(undefined)</span>
		<span class="s1">expect(getExtPrefix(</span><span class="s2">'XX'</span><span class="s1">, metadata)).to.equal(</span><span class="s2">' ext. '</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should cover non-occuring edge cases'</span><span class="s1">, () =&gt; {</span>
		<span class="s0">new </span><span class="s1">Metadata(metadata).getNumberingPlanMetadata(</span><span class="s2">'999'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should support deprecated methods'</span><span class="s1">, () =&gt; {</span>
		<span class="s1">expect(</span><span class="s0">new </span><span class="s1">Metadata(metadata).country(</span><span class="s2">'US'</span><span class="s1">).nationalPrefixForParsing()).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s0">new </span><span class="s1">Metadata(metadata).chooseCountryByCountryCallingCode(</span><span class="s2">'1'</span><span class="s1">).nationalPrefixForParsing()</span>
        <span class="s1">).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should tell if a national prefix is mandatory when formatting a national number'</span><span class="s1">, () =&gt; {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadata)</span>
		<span class="s3">// No &quot;national_prefix_formatting_rule&quot;.</span>
		<span class="s3">// &quot;national_prefix_is_optional_when_formatting&quot;: true</span>
		<span class="s1">meta.country(</span><span class="s2">'US'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s1">meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixIsMandatoryWhenFormattingInNationalFormat()</span>
        <span class="s1">).to.equal(</span><span class="s0">false</span><span class="s1">)</span>
		<span class="s3">// &quot;national_prefix_formatting_rule&quot;: &quot;8 ($1)&quot;</span>
		<span class="s3">// &quot;national_prefix_is_optional_when_formatting&quot;: true</span>
		<span class="s1">meta.country(</span><span class="s2">'RU'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s1">meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixIsMandatoryWhenFormattingInNationalFormat()</span>
        <span class="s1">).to.equal(</span><span class="s0">false</span><span class="s1">)</span>
		<span class="s3">// &quot;national_prefix&quot;: &quot;0&quot;</span>
		<span class="s3">// &quot;national_prefix_formatting_rule&quot;: &quot;0 $1&quot;</span>
		<span class="s1">meta.country(</span><span class="s2">'FR'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s1">meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixIsMandatoryWhenFormattingInNationalFormat()</span>
        <span class="s1">).to.equal(</span><span class="s0">true</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should validate metadata'</span><span class="s1">, () =&gt; {</span>
		<span class="s0">let </span><span class="s1">thrower = () =&gt; validateMetadata()</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'`metadata` argument not passed'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata(</span><span class="s4">123</span><span class="s1">)</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got a number: 123.'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata(</span><span class="s2">'abc'</span><span class="s1">)</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got a string: abc.'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata({ a: </span><span class="s0">true</span><span class="s1">, b: </span><span class="s4">2 </span><span class="s1">})</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got an object of shape: { a, b }.'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata({ a: </span><span class="s0">true</span><span class="s1">, countries: </span><span class="s4">2 </span><span class="s1">})</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got an object of shape: { a, countries }.'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata({ country_calling_codes: </span><span class="s0">true</span><span class="s1">, countries: </span><span class="s4">2 </span><span class="s1">})</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got an object of shape'</span><span class="s1">)</span>

		<span class="s1">thrower = () =&gt; validateMetadata({ country_calling_codes: {}, countries: </span><span class="s4">2 </span><span class="s1">})</span>
		<span class="s1">expect(thrower).to.throw(</span><span class="s2">'Got an object of shape'</span><span class="s1">)</span>

		<span class="s1">validateMetadata({ country_calling_codes: {}, countries: {}, b: </span><span class="s4">3 </span><span class="s1">})</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work around `nonGeographical` typo in metadata generated from `1.7.35` to `1.7.37`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV4)</span>
		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'888'</span><span class="s1">)</span>
		<span class="s1">expect(type(meta.nonGeographic())).to.equal(</span><span class="s2">'object'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work around `nonGeographic` metadata not existing before `1.7.35`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV3)</span>
		<span class="s1">expect(type(meta.getNumberingPlanMetadata(</span><span class="s2">'800'</span><span class="s1">))).to.equal(</span><span class="s2">'object'</span><span class="s1">)</span>
		<span class="s1">expect(type(meta.getNumberingPlanMetadata(</span><span class="s2">'000'</span><span class="s1">))).to.equal(</span><span class="s2">'undefined'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work with metadata from version `1.1.11`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV2)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'US'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.possibleLengths()).to.deep.equal([</span><span class="s4">10</span><span class="s1">])</span>
		<span class="s1">expect(meta.numberingPlan.formats().length).to.equal(</span><span class="s4">1</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefix()).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefixForParsing()).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.type(</span><span class="s2">'MOBILE'</span><span class="s1">).pattern()).to.equal(</span><span class="s2">''</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'AG'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.leadingDigits()).to.equal(</span><span class="s2">'268'</span><span class="s1">)</span>
		<span class="s3">// Should've been &quot;268$1&quot; but apparently there was a bug in metadata generator</span>
		<span class="s3">// and no national prefix transform rules were written.</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefixTransformRule()).to.equal(</span><span class="s0">null</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'AF'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixFormattingRule()).to.equal(</span><span class="s2">'0$1'</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'RU'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s1">meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixIsOptionalWhenFormattingInNationalFormat()</span>
        <span class="s1">).to.equal(</span><span class="s0">true</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work with metadata from version `1.0.0`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV1)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'US'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.formats().length).to.equal(</span><span class="s4">1</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefix()).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefixForParsing()).to.equal(</span><span class="s2">'1'</span><span class="s1">)</span>
		<span class="s1">expect(type(meta.numberingPlan.type(</span><span class="s2">'MOBILE'</span><span class="s1">))).to.equal(</span><span class="s2">'undefined'</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'AG'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.leadingDigits()).to.equal(</span><span class="s2">'268'</span><span class="s1">)</span>
		<span class="s3">// Should've been &quot;268$1&quot; but apparently there was a bug in metadata generator</span>
		<span class="s3">// and no national prefix transform rules were written.</span>
		<span class="s1">expect(meta.numberingPlan.nationalPrefixTransformRule()).to.equal(</span><span class="s0">null</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'AF'</span><span class="s1">)</span>
		<span class="s1">expect(meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixFormattingRule()).to.equal(</span><span class="s2">'0$1'</span><span class="s1">)</span>

		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'RU'</span><span class="s1">)</span>
		<span class="s1">expect(</span>
            <span class="s1">meta.numberingPlan.formats()[</span><span class="s4">0</span><span class="s1">].nationalPrefixIsOptionalWhenFormattingInNationalFormat()</span>
        <span class="s1">).to.equal(</span><span class="s0">true</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work around &quot;ext&quot; data not present in metadata from version `1.0.0`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV1)</span>
		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'GB'</span><span class="s1">)</span>
		<span class="s1">expect(meta.ext()).to.equal(</span><span class="s2">' ext. '</span><span class="s1">)</span>

		<span class="s0">const </span><span class="s1">metaNew = </span><span class="s0">new </span><span class="s1">Metadata(metadata)</span>
		<span class="s1">metaNew.selectNumberingPlan(</span><span class="s2">'GB'</span><span class="s1">)</span>
		<span class="s1">expect(metaNew.ext()).to.equal(</span><span class="s2">' x'</span><span class="s1">)</span>
	<span class="s1">})</span>

	<span class="s1">it(</span><span class="s2">'should work around &quot;default IDD prefix&quot; data not present in metadata from version `1.0.0`'</span><span class="s1">, </span><span class="s0">function</span><span class="s1">() {</span>
		<span class="s0">const </span><span class="s1">meta = </span><span class="s0">new </span><span class="s1">Metadata(metadataV1)</span>
		<span class="s1">meta.selectNumberingPlan(</span><span class="s2">'AU'</span><span class="s1">)</span>
		<span class="s1">expect(type(meta.defaultIDDPrefix())).to.equal(</span><span class="s2">'undefined'</span><span class="s1">)</span>

		<span class="s0">const </span><span class="s1">metaNew = </span><span class="s0">new </span><span class="s1">Metadata(metadata)</span>
		<span class="s1">metaNew.selectNumberingPlan(</span><span class="s2">'AU'</span><span class="s1">)</span>
		<span class="s1">expect(metaNew.defaultIDDPrefix()).to.equal(</span><span class="s2">'0011'</span><span class="s1">)</span>
	<span class="s1">})</span>
<span class="s1">})</span>

<span class="s0">function </span><span class="s1">type(something) {</span>
	<span class="s0">return typeof </span><span class="s1">something</span>
<span class="s1">}</span></pre>
</body>
</html>