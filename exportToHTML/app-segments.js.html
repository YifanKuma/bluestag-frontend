<html>
<head>
<title>app-segments.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
.s5 { color: #8c8c8c; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
app-segments.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;collectSegments&quot;</span><span class="s1">, {</span>
    <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
    <span class="s1">get: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">collectSegments;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_appsegmentconfig = require(</span><span class="s0">&quot;./app-segment-config&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_invarianterror = require(</span><span class="s0">&quot;../../../shared/lib/invariant-error&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_checks = require(</span><span class="s0">&quot;../../../server/route-modules/checks&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_clientandserverreferences = require(</span><span class="s0">&quot;../../../lib/client-and-server-references&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_getsegmentparam = require(</span><span class="s0">&quot;../../../server/app-render/get-segment-param&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_appdirmodule = require(</span><span class="s0">&quot;../../../server/lib/app-dir-module&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_segment = require(</span><span class="s0">&quot;../../../shared/lib/segment&quot;</span><span class="s1">);</span>
<span class="s3">/**</span>
 <span class="s3">* Parses the app config and attaches it to the segment.</span>
 <span class="s3">*/ </span><span class="s2">function </span><span class="s1">attach(segment, userland, route) {</span>
    <span class="s3">// If the userland is not an object, then we can't do anything with it.</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">userland !== </span><span class="s0">'object' </span><span class="s1">|| userland === </span><span class="s2">null</span><span class="s1">) {</span>
        <span class="s2">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">// Try to parse the application configuration.</span>
    <span class="s2">const </span><span class="s1">config = (</span><span class="s4">0</span><span class="s1">, _appsegmentconfig.parseAppSegmentConfig)(userland, route);</span>
    <span class="s3">// If there was any keys on the config, then attach it to the segment.</span>
    <span class="s2">if </span><span class="s1">(Object.keys(config).length &gt; </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s1">segment.config = config;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s0">'generateStaticParams' </span><span class="s2">in </span><span class="s1">userland &amp;&amp; </span><span class="s2">typeof </span><span class="s1">userland.generateStaticParams === </span><span class="s0">'function'</span><span class="s1">) {</span>
        <span class="s2">var </span><span class="s1">_segment_config;</span>
        <span class="s1">segment.generateStaticParams = userland.generateStaticParams;</span>
        <span class="s3">// Validate that `generateStaticParams` makes sense in this context.</span>
        <span class="s2">if </span><span class="s1">(((_segment_config = segment.config) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _segment_config.runtime) === </span><span class="s0">'edge'</span><span class="s1">) {</span>
            <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">Error(</span><span class="s0">'Edge runtime is not supported with `generateStaticParams`.'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
                <span class="s1">value: </span><span class="s0">&quot;E502&quot;</span><span class="s1">,</span>
                <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
                <span class="s1">configurable: </span><span class="s2">true</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s3">/**</span>
 <span class="s3">* Walks the loader tree and collects the generate parameters for each segment.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s5">@param </span><span class="s3">routeModule the app page route module</span>
 <span class="s3">* </span><span class="s5">@returns </span><span class="s3">the segments for the app page route module</span>
 <span class="s3">*/ </span><span class="s1">async </span><span class="s2">function </span><span class="s1">collectAppPageSegments(routeModule) {</span>
    <span class="s3">// We keep track of unique segments, since with parallel routes, it's possible</span>
    <span class="s3">// to see the same segment multiple times.</span>
    <span class="s2">const </span><span class="s1">uniqueSegments = </span><span class="s2">new </span><span class="s1">Map();</span>
    <span class="s2">const </span><span class="s1">queue = [</span>
        <span class="s1">[</span>
            <span class="s1">routeModule.userland.loaderTree,</span>
            <span class="s1">[]</span>
        <span class="s1">]</span>
    <span class="s1">];</span>
    <span class="s2">while</span><span class="s1">(queue.length &gt; </span><span class="s4">0</span><span class="s1">){</span>
        <span class="s2">var </span><span class="s1">_getSegmentParam;</span>
        <span class="s2">const </span><span class="s1">[loaderTree, currentSegments] = queue.shift();</span>
        <span class="s2">const </span><span class="s1">[name, parallelRoutes] = loaderTree;</span>
        <span class="s3">// Process current node</span>
        <span class="s2">const </span><span class="s1">{ mod: userland, filePath } = </span><span class="s2">await </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, _appdirmodule.getLayoutOrPageModule)(loaderTree);</span>
        <span class="s2">const </span><span class="s1">isClientComponent = userland &amp;&amp; (</span><span class="s4">0</span><span class="s1">, _clientandserverreferences.isClientReference)(userland);</span>
        <span class="s2">const </span><span class="s1">param = (_getSegmentParam = (</span><span class="s4">0</span><span class="s1">, _getsegmentparam.getSegmentParam)(name)) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _getSegmentParam.param;</span>
        <span class="s2">const </span><span class="s1">segment = {</span>
            <span class="s1">name,</span>
            <span class="s1">param,</span>
            <span class="s1">filePath,</span>
            <span class="s1">config: undefined,</span>
            <span class="s1">isDynamicSegment: !!param,</span>
            <span class="s1">generateStaticParams: undefined</span>
        <span class="s1">};</span>
        <span class="s3">// Only server components can have app segment configurations</span>
        <span class="s2">if </span><span class="s1">(!isClientComponent) {</span>
            <span class="s1">attach(segment, userland, routeModule.definition.pathname);</span>
        <span class="s1">}</span>
        <span class="s3">// Create a unique key for the segment</span>
        <span class="s2">const </span><span class="s1">segmentKey = getSegmentKey(segment);</span>
        <span class="s2">if </span><span class="s1">(!uniqueSegments.has(segmentKey)) {</span>
            <span class="s1">uniqueSegments.set(segmentKey, segment);</span>
        <span class="s1">}</span>
        <span class="s2">const </span><span class="s1">updatedSegments = [</span>
            <span class="s1">...currentSegments,</span>
            <span class="s1">segment</span>
        <span class="s1">];</span>
        <span class="s3">// If this is a page segment, we've reached a leaf node</span>
        <span class="s2">if </span><span class="s1">(name === _segment.PAGE_SEGMENT_KEY) {</span>
            <span class="s3">// Add all segments in the current path</span>
            <span class="s1">updatedSegments.forEach((seg)=&gt;{</span>
                <span class="s2">const </span><span class="s1">key = getSegmentKey(seg);</span>
                <span class="s1">uniqueSegments.set(key, seg);</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s3">// Add all parallel routes to the queue</span>
        <span class="s2">for</span><span class="s1">(</span><span class="s2">const </span><span class="s1">parallelRouteKey </span><span class="s2">in </span><span class="s1">parallelRoutes){</span>
            <span class="s2">const </span><span class="s1">parallelRoute = parallelRoutes[parallelRouteKey];</span>
            <span class="s1">queue.push([</span>
                <span class="s1">parallelRoute,</span>
                <span class="s1">updatedSegments</span>
            <span class="s1">]);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">Array.from(uniqueSegments.values());</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">getSegmentKey(segment) {</span>
    <span class="s2">return </span><span class="s0">`</span><span class="s1">${segment.name}</span><span class="s0">-</span><span class="s1">${segment.filePath ?? </span><span class="s0">''</span><span class="s1">}</span><span class="s0">-</span><span class="s1">${segment.param ?? </span><span class="s0">''</span><span class="s1">}</span><span class="s0">`</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s3">/**</span>
 <span class="s3">* Collects the segments for a given app route module.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s5">@param </span><span class="s3">routeModule the app route module</span>
 <span class="s3">* </span><span class="s5">@returns </span><span class="s3">the segments for the app route module</span>
 <span class="s3">*/ </span><span class="s2">function </span><span class="s1">collectAppRouteSegments(routeModule) {</span>
    <span class="s3">// Get the pathname parts, slice off the first element (which is empty).</span>
    <span class="s2">const </span><span class="s1">parts = routeModule.definition.pathname.split(</span><span class="s0">'/'</span><span class="s1">).slice(</span><span class="s4">1</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(parts.length === </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Expected at least one segment'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E580&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s3">// Generate all the segments.</span>
    <span class="s2">const </span><span class="s1">segments = parts.map((name)=&gt;{</span>
        <span class="s2">var </span><span class="s1">_getSegmentParam;</span>
        <span class="s2">const </span><span class="s1">param = (_getSegmentParam = (</span><span class="s4">0</span><span class="s1">, _getsegmentparam.getSegmentParam)(name)) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _getSegmentParam.param;</span>
        <span class="s2">return </span><span class="s1">{</span>
            <span class="s1">name,</span>
            <span class="s1">param,</span>
            <span class="s1">filePath: undefined,</span>
            <span class="s1">isDynamicSegment: !!param,</span>
            <span class="s1">config: undefined,</span>
            <span class="s1">generateStaticParams: undefined</span>
        <span class="s1">};</span>
    <span class="s1">});</span>
    <span class="s3">// We know we have at least one, we verified this above. We should get the</span>
    <span class="s3">// last segment which represents the root route module.</span>
    <span class="s2">const </span><span class="s1">segment = segments[segments.length - </span><span class="s4">1</span><span class="s1">];</span>
    <span class="s1">segment.filePath = routeModule.definition.filename;</span>
    <span class="s3">// Extract the segment config from the userland module.</span>
    <span class="s1">attach(segment, routeModule.userland, routeModule.definition.pathname);</span>
    <span class="s2">return </span><span class="s1">segments;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">collectSegments({ routeModule }) {</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s4">0</span><span class="s1">, _checks.isAppRouteRouteModule)(routeModule)) {</span>
        <span class="s2">return </span><span class="s1">collectAppRouteSegments(routeModule);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s4">0</span><span class="s1">, _checks.isAppPageRouteModule)(routeModule)) {</span>
        <span class="s2">return </span><span class="s1">collectAppPageSegments(routeModule);</span>
    <span class="s1">}</span>
    <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Expected a route module to be one of app route or page'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
        <span class="s1">value: </span><span class="s0">&quot;E568&quot;</span><span class="s1">,</span>
        <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
        <span class="s1">configurable: </span><span class="s2">true</span>
    <span class="s1">});</span>
<span class="s1">}</span>

<span class="s3">//# sourceMappingURL=app-segments.js.map</span></pre>
</body>
</html>