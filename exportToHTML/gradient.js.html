<html>
<head>
<title>gradient.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #264eff;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #1750eb;}
.s6 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
gradient.js</font>
</center></td></tr></table>
<pre><span class="s0">let </span><span class="s1">range = require(</span><span class="s2">'normalize-range'</span><span class="s1">)</span>
<span class="s0">let </span><span class="s1">parser = require(</span><span class="s2">'postcss-value-parser'</span><span class="s1">)</span>

<span class="s0">let </span><span class="s1">OldValue = require(</span><span class="s2">'../old-value'</span><span class="s1">)</span>
<span class="s0">let </span><span class="s1">utils = require(</span><span class="s2">'../utils'</span><span class="s1">)</span>
<span class="s0">let </span><span class="s1">Value = require(</span><span class="s2">'../value'</span><span class="s1">)</span>

<span class="s0">let </span><span class="s1">IS_DIRECTION = </span><span class="s3">/top|left|right|bottom/gi</span>

<span class="s0">class </span><span class="s1">Gradient </span><span class="s0">extends </span><span class="s1">Value {</span>
  <span class="s4">/**</span>
   <span class="s4">* Do not add non-webkit prefixes for list-style and object</span>
   <span class="s4">*/</span>
  <span class="s1">add(decl, prefix) {</span>
    <span class="s0">let </span><span class="s1">p = decl.prop</span>
    <span class="s0">if </span><span class="s1">(p.includes(</span><span class="s2">'mask'</span><span class="s1">)) {</span>
      <span class="s0">if </span><span class="s1">(prefix === </span><span class="s2">'-webkit-' </span><span class="s1">|| prefix === </span><span class="s2">'-webkit- old'</span><span class="s1">) {</span>
        <span class="s0">return super</span><span class="s1">.add(decl, prefix)</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
      <span class="s1">p === </span><span class="s2">'list-style' </span><span class="s1">||</span>
      <span class="s1">p === </span><span class="s2">'list-style-image' </span><span class="s1">||</span>
      <span class="s1">p === </span><span class="s2">'content'</span>
    <span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(prefix === </span><span class="s2">'-webkit-' </span><span class="s1">|| prefix === </span><span class="s2">'-webkit- old'</span><span class="s1">) {</span>
        <span class="s0">return super</span><span class="s1">.add(decl, prefix)</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s0">return super</span><span class="s1">.add(decl, prefix)</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">undefined</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Get div token from exists parameters</span>
   <span class="s4">*/</span>
  <span class="s1">cloneDiv(params) {</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i of params) {</span>
      <span class="s0">if </span><span class="s1">(i.type === </span><span class="s2">'div' </span><span class="s1">&amp;&amp; i.value === </span><span class="s2">','</span><span class="s1">) {</span>
        <span class="s0">return </span><span class="s1">i</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">{ after: </span><span class="s2">' '</span><span class="s1">, type: </span><span class="s2">'div'</span><span class="s1">, value: </span><span class="s2">',' </span><span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Change colors syntax to old webkit</span>
   <span class="s4">*/</span>
  <span class="s1">colorStops(params) {</span>
    <span class="s0">let </span><span class="s1">result = []</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i = </span><span class="s5">0</span><span class="s1">; i &lt; params.length; i++) {</span>
      <span class="s0">let </span><span class="s1">pos</span>
      <span class="s0">let </span><span class="s1">param = params[i]</span>
      <span class="s0">let </span><span class="s1">item</span>
      <span class="s0">if </span><span class="s1">(i === </span><span class="s5">0</span><span class="s1">) {</span>
        <span class="s0">continue</span>
      <span class="s1">}</span>

      <span class="s0">let </span><span class="s1">color = parser.stringify(param[</span><span class="s5">0</span><span class="s1">])</span>
      <span class="s0">if </span><span class="s1">(param[</span><span class="s5">1</span><span class="s1">] &amp;&amp; param[</span><span class="s5">1</span><span class="s1">].type === </span><span class="s2">'word'</span><span class="s1">) {</span>
        <span class="s1">pos = param[</span><span class="s5">1</span><span class="s1">].value</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(param[</span><span class="s5">2</span><span class="s1">] &amp;&amp; param[</span><span class="s5">2</span><span class="s1">].type === </span><span class="s2">'word'</span><span class="s1">) {</span>
        <span class="s1">pos = param[</span><span class="s5">2</span><span class="s1">].value</span>
      <span class="s1">}</span>

      <span class="s0">let </span><span class="s1">stop</span>
      <span class="s0">if </span><span class="s1">(i === </span><span class="s5">1 </span><span class="s1">&amp;&amp; (!pos || pos === </span><span class="s2">'0%'</span><span class="s1">)) {</span>
        <span class="s1">stop = </span><span class="s2">`from(</span><span class="s1">${color}</span><span class="s2">)`</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(i === params.length - </span><span class="s5">1 </span><span class="s1">&amp;&amp; (!pos || pos === </span><span class="s2">'100%'</span><span class="s1">)) {</span>
        <span class="s1">stop = </span><span class="s2">`to(</span><span class="s1">${color}</span><span class="s2">)`</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(pos) {</span>
        <span class="s1">stop = </span><span class="s2">`color-stop(</span><span class="s1">${pos}</span><span class="s2">, </span><span class="s1">${color}</span><span class="s2">)`</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">stop = </span><span class="s2">`color-stop(</span><span class="s1">${color}</span><span class="s2">)`</span>
      <span class="s1">}</span>

      <span class="s0">let </span><span class="s1">div = param[param.length - </span><span class="s5">1</span><span class="s1">]</span>
      <span class="s1">params[i] = [{ type: </span><span class="s2">'word'</span><span class="s1">, value: stop }]</span>
      <span class="s0">if </span><span class="s1">(div.type === </span><span class="s2">'div' </span><span class="s1">&amp;&amp; div.value === </span><span class="s2">','</span><span class="s1">) {</span>
        <span class="s1">item = params[i].push(div)</span>
      <span class="s1">}</span>
      <span class="s1">result.push(item)</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">result</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Change new direction to old</span>
   <span class="s4">*/</span>
  <span class="s1">convertDirection(params) {</span>
    <span class="s0">if </span><span class="s1">(params.length &gt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(params[</span><span class="s5">0</span><span class="s1">].value === </span><span class="s2">'to'</span><span class="s1">) {</span>
        <span class="s0">this</span><span class="s1">.fixDirection(params)</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(params[</span><span class="s5">0</span><span class="s1">].value.includes(</span><span class="s2">'deg'</span><span class="s1">)) {</span>
        <span class="s0">this</span><span class="s1">.fixAngle(params)</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.isRadial(params)) {</span>
        <span class="s0">this</span><span class="s1">.fixRadial(params)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">params</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Add 90 degrees</span>
   <span class="s4">*/</span>
  <span class="s1">fixAngle(params) {</span>
    <span class="s0">let </span><span class="s1">first = params[</span><span class="s5">0</span><span class="s1">].value</span>
    <span class="s1">first = parseFloat(first)</span>
    <span class="s1">first = Math.abs(</span><span class="s5">450 </span><span class="s1">- first) % </span><span class="s5">360</span>
    <span class="s1">first = </span><span class="s0">this</span><span class="s1">.roundFloat(first, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">params[</span><span class="s5">0</span><span class="s1">].value = </span><span class="s2">`</span><span class="s1">${first}</span><span class="s2">deg`</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Replace `to top left` to `bottom right`</span>
   <span class="s4">*/</span>
  <span class="s1">fixDirection(params) {</span>
    <span class="s1">params.splice(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">param of params) {</span>
      <span class="s0">if </span><span class="s1">(param.type === </span><span class="s2">'div'</span><span class="s1">) {</span>
        <span class="s0">break</span>
      <span class="s1">}</span>
      <span class="s0">if </span><span class="s1">(param.type === </span><span class="s2">'word'</span><span class="s1">) {</span>
        <span class="s1">param.value = </span><span class="s0">this</span><span class="s1">.revertDirection(param.value)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Fix radial direction syntax</span>
   <span class="s4">*/</span>
  <span class="s1">fixRadial(params) {</span>
    <span class="s0">let </span><span class="s1">first = []</span>
    <span class="s0">let </span><span class="s1">second = []</span>
    <span class="s0">let </span><span class="s1">a, b, c, i, next</span>

    <span class="s0">for </span><span class="s1">(i = </span><span class="s5">0</span><span class="s1">; i &lt; params.length - </span><span class="s5">2</span><span class="s1">; i++) {</span>
      <span class="s1">a = params[i]</span>
      <span class="s1">b = params[i + </span><span class="s5">1</span><span class="s1">]</span>
      <span class="s1">c = params[i + </span><span class="s5">2</span><span class="s1">]</span>
      <span class="s0">if </span><span class="s1">(a.type === </span><span class="s2">'space' </span><span class="s1">&amp;&amp; b.value === </span><span class="s2">'at' </span><span class="s1">&amp;&amp; c.type === </span><span class="s2">'space'</span><span class="s1">) {</span>
        <span class="s1">next = i + </span><span class="s5">3</span>
        <span class="s0">break</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">first.push(a)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">let </span><span class="s1">div</span>
    <span class="s0">for </span><span class="s1">(i = next; i &lt; params.length; i++) {</span>
      <span class="s0">if </span><span class="s1">(params[i].type === </span><span class="s2">'div'</span><span class="s1">) {</span>
        <span class="s1">div = params[i]</span>
        <span class="s0">break</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">second.push(params[i])</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">params.splice(</span><span class="s5">0</span><span class="s1">, i, ...second, div, ...first)</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Look for at word</span>
   <span class="s4">*/</span>
  <span class="s1">isRadial(params) {</span>
    <span class="s0">let </span><span class="s1">state = </span><span class="s2">'before'</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">param of params) {</span>
      <span class="s0">if </span><span class="s1">(state === </span><span class="s2">'before' </span><span class="s1">&amp;&amp; param.type === </span><span class="s2">'space'</span><span class="s1">) {</span>
        <span class="s1">state = </span><span class="s2">'at'</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(state === </span><span class="s2">'at' </span><span class="s1">&amp;&amp; param.value === </span><span class="s2">'at'</span><span class="s1">) {</span>
        <span class="s1">state = </span><span class="s2">'after'</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(state === </span><span class="s2">'after' </span><span class="s1">&amp;&amp; param.type === </span><span class="s2">'space'</span><span class="s1">) {</span>
        <span class="s0">return true</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(param.type === </span><span class="s2">'div'</span><span class="s1">) {</span>
        <span class="s0">break</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">state = </span><span class="s2">'before'</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">return false</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Replace old direction to new</span>
   <span class="s4">*/</span>
  <span class="s1">newDirection(params) {</span>
    <span class="s0">if </span><span class="s1">(params[</span><span class="s5">0</span><span class="s1">].value === </span><span class="s2">'to'</span><span class="s1">) {</span>
      <span class="s0">return </span><span class="s1">params</span>
    <span class="s1">}</span>
    <span class="s1">IS_DIRECTION.lastIndex = </span><span class="s5">0 </span><span class="s4">// reset search index of global regexp</span>
    <span class="s0">if </span><span class="s1">(!IS_DIRECTION.test(params[</span><span class="s5">0</span><span class="s1">].value)) {</span>
      <span class="s0">return </span><span class="s1">params</span>
    <span class="s1">}</span>

    <span class="s1">params.unshift(</span>
      <span class="s1">{</span>
        <span class="s1">type: </span><span class="s2">'word'</span><span class="s1">,</span>
        <span class="s1">value: </span><span class="s2">'to'</span>
      <span class="s1">},</span>
      <span class="s1">{</span>
        <span class="s1">type: </span><span class="s2">'space'</span><span class="s1">,</span>
        <span class="s1">value: </span><span class="s2">' '</span>
      <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i = </span><span class="s5">2</span><span class="s1">; i &lt; params.length; i++) {</span>
      <span class="s0">if </span><span class="s1">(params[i].type === </span><span class="s2">'div'</span><span class="s1">) {</span>
        <span class="s0">break</span>
      <span class="s1">}</span>
      <span class="s0">if </span><span class="s1">(params[i].type === </span><span class="s2">'word'</span><span class="s1">) {</span>
        <span class="s1">params[i].value = </span><span class="s0">this</span><span class="s1">.revertDirection(params[i].value)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s1">params</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Normalize angle</span>
   <span class="s4">*/</span>
  <span class="s1">normalize(nodes, gradientName) {</span>
    <span class="s0">if </span><span class="s1">(!nodes[</span><span class="s5">0</span><span class="s1">]) </span><span class="s0">return </span><span class="s1">nodes</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s3">/-?\d+(.\d+)?grad/</span><span class="s1">.test(nodes[</span><span class="s5">0</span><span class="s1">].value)) {</span>
      <span class="s1">nodes[</span><span class="s5">0</span><span class="s1">].value = </span><span class="s0">this</span><span class="s1">.normalizeUnit(nodes[</span><span class="s5">0</span><span class="s1">].value, </span><span class="s5">400</span><span class="s1">)</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s3">/-?\d+(.\d+)?rad/</span><span class="s1">.test(nodes[</span><span class="s5">0</span><span class="s1">].value)) {</span>
      <span class="s1">nodes[</span><span class="s5">0</span><span class="s1">].value = </span><span class="s0">this</span><span class="s1">.normalizeUnit(nodes[</span><span class="s5">0</span><span class="s1">].value, </span><span class="s5">2 </span><span class="s1">* Math.PI)</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s3">/-?\d+(.\d+)?turn/</span><span class="s1">.test(nodes[</span><span class="s5">0</span><span class="s1">].value)) {</span>
      <span class="s1">nodes[</span><span class="s5">0</span><span class="s1">].value = </span><span class="s0">this</span><span class="s1">.normalizeUnit(nodes[</span><span class="s5">0</span><span class="s1">].value, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(nodes[</span><span class="s5">0</span><span class="s1">].value.includes(</span><span class="s2">'deg'</span><span class="s1">)) {</span>
      <span class="s0">let </span><span class="s1">num = parseFloat(nodes[</span><span class="s5">0</span><span class="s1">].value)</span>
      <span class="s1">num = range.wrap(</span><span class="s5">0</span><span class="s1">, </span><span class="s5">360</span><span class="s1">, num)</span>
      <span class="s1">nodes[</span><span class="s5">0</span><span class="s1">].value = </span><span class="s2">`</span><span class="s1">${num}</span><span class="s2">deg`</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span>
      <span class="s1">gradientName === </span><span class="s2">'linear-gradient' </span><span class="s1">||</span>
      <span class="s1">gradientName === </span><span class="s2">'repeating-linear-gradient'</span>
    <span class="s1">) {</span>
      <span class="s0">let </span><span class="s1">direction = nodes[</span><span class="s5">0</span><span class="s1">].value</span>

      <span class="s4">// Unitless zero for `&lt;angle&gt;` values are allowed in CSS gradients and transforms.</span>
      <span class="s4">// Spec: https://github.com/w3c/csswg-drafts/commit/602789171429b2231223ab1e5acf8f7f11652eb3</span>
      <span class="s0">if </span><span class="s1">(direction === </span><span class="s2">'0deg' </span><span class="s1">|| direction === </span><span class="s2">'0'</span><span class="s1">) {</span>
        <span class="s1">nodes = </span><span class="s0">this</span><span class="s1">.replaceFirst(nodes, </span><span class="s2">'to'</span><span class="s1">, </span><span class="s2">' '</span><span class="s1">, </span><span class="s2">'top'</span><span class="s1">)</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(direction === </span><span class="s2">'90deg'</span><span class="s1">) {</span>
        <span class="s1">nodes = </span><span class="s0">this</span><span class="s1">.replaceFirst(nodes, </span><span class="s2">'to'</span><span class="s1">, </span><span class="s2">' '</span><span class="s1">, </span><span class="s2">'right'</span><span class="s1">)</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(direction === </span><span class="s2">'180deg'</span><span class="s1">) {</span>
        <span class="s1">nodes = </span><span class="s0">this</span><span class="s1">.replaceFirst(nodes, </span><span class="s2">'to'</span><span class="s1">, </span><span class="s2">' '</span><span class="s1">, </span><span class="s2">'bottom'</span><span class="s1">) </span><span class="s4">// default value</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(direction === </span><span class="s2">'270deg'</span><span class="s1">) {</span>
        <span class="s1">nodes = </span><span class="s0">this</span><span class="s1">.replaceFirst(nodes, </span><span class="s2">'to'</span><span class="s1">, </span><span class="s2">' '</span><span class="s1">, </span><span class="s2">'left'</span><span class="s1">)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s1">nodes</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Convert angle unit to deg</span>
   <span class="s4">*/</span>
  <span class="s1">normalizeUnit(str, full) {</span>
    <span class="s0">let </span><span class="s1">num = parseFloat(str)</span>
    <span class="s0">let </span><span class="s1">deg = (num / full) * </span><span class="s5">360</span>
    <span class="s0">return </span><span class="s2">`</span><span class="s1">${deg}</span><span class="s2">deg`</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Remove old WebKit gradient too</span>
   <span class="s4">*/</span>
  <span class="s1">old(prefix) {</span>
    <span class="s0">if </span><span class="s1">(prefix === </span><span class="s2">'-webkit-'</span><span class="s1">) {</span>
      <span class="s0">let </span><span class="s1">type</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.name === </span><span class="s2">'linear-gradient'</span><span class="s1">) {</span>
        <span class="s1">type = </span><span class="s2">'linear'</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.name === </span><span class="s2">'repeating-linear-gradient'</span><span class="s1">) {</span>
        <span class="s1">type = </span><span class="s2">'repeating-linear'</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.name === </span><span class="s2">'repeating-radial-gradient'</span><span class="s1">) {</span>
        <span class="s1">type = </span><span class="s2">'repeating-radial'</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s1">type = </span><span class="s2">'radial'</span>
      <span class="s1">}</span>
      <span class="s0">let </span><span class="s1">string = </span><span class="s2">'-gradient'</span>
      <span class="s0">let </span><span class="s1">regexp = utils.regexp(</span>
        <span class="s2">`-webkit-(</span><span class="s1">${type}</span><span class="s2">-gradient|gradient</span><span class="s6">\\</span><span class="s2">(</span><span class="s6">\\</span><span class="s2">s*</span><span class="s1">${type}</span><span class="s2">)`</span><span class="s1">,</span>
        <span class="s0">false</span>
      <span class="s1">)</span>

      <span class="s0">return new </span><span class="s1">OldValue(</span><span class="s0">this</span><span class="s1">.name, prefix + </span><span class="s0">this</span><span class="s1">.name, string, regexp)</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s0">return super</span><span class="s1">.old(prefix)</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Change direction syntax to old webkit</span>
   <span class="s4">*/</span>
  <span class="s1">oldDirection(params) {</span>
    <span class="s0">let </span><span class="s1">div = </span><span class="s0">this</span><span class="s1">.cloneDiv(params[</span><span class="s5">0</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">(params[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">].value !== </span><span class="s2">'to'</span><span class="s1">) {</span>
      <span class="s0">return </span><span class="s1">params.unshift([</span>
        <span class="s1">{ type: </span><span class="s2">'word'</span><span class="s1">, value: Gradient.oldDirections.bottom },</span>
        <span class="s1">div</span>
      <span class="s1">])</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s0">let </span><span class="s1">words = []</span>
      <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">node of params[</span><span class="s5">0</span><span class="s1">].slice(</span><span class="s5">2</span><span class="s1">)) {</span>
        <span class="s0">if </span><span class="s1">(node.type === </span><span class="s2">'word'</span><span class="s1">) {</span>
          <span class="s1">words.push(node.value.toLowerCase())</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s1">words = words.join(</span><span class="s2">' '</span><span class="s1">)</span>
      <span class="s0">let </span><span class="s1">old = Gradient.oldDirections[words] || words</span>

      <span class="s1">params[</span><span class="s5">0</span><span class="s1">] = [{ type: </span><span class="s2">'word'</span><span class="s1">, value: old }, div]</span>
      <span class="s0">return </span><span class="s1">params[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Convert to old webkit syntax</span>
   <span class="s4">*/</span>
  <span class="s1">oldWebkit(node) {</span>
    <span class="s0">let </span><span class="s1">{ nodes } = node</span>
    <span class="s0">let </span><span class="s1">string = parser.stringify(node.nodes)</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.name !== </span><span class="s2">'linear-gradient'</span><span class="s1">) {</span>
      <span class="s0">return false</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">(nodes[</span><span class="s5">0</span><span class="s1">] &amp;&amp; nodes[</span><span class="s5">0</span><span class="s1">].value.includes(</span><span class="s2">'deg'</span><span class="s1">)) {</span>
      <span class="s0">return false</span>
    <span class="s1">}</span>
    <span class="s0">if </span><span class="s1">(</span>
      <span class="s1">string.includes(</span><span class="s2">'px'</span><span class="s1">) ||</span>
      <span class="s1">string.includes(</span><span class="s2">'-corner'</span><span class="s1">) ||</span>
      <span class="s1">string.includes(</span><span class="s2">'-side'</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s0">return false</span>
    <span class="s1">}</span>

    <span class="s0">let </span><span class="s1">params = [[]]</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i of nodes) {</span>
      <span class="s1">params[params.length - </span><span class="s5">1</span><span class="s1">].push(i)</span>
      <span class="s0">if </span><span class="s1">(i.type === </span><span class="s2">'div' </span><span class="s1">&amp;&amp; i.value === </span><span class="s2">','</span><span class="s1">) {</span>
        <span class="s1">params.push([])</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">this</span><span class="s1">.oldDirection(params)</span>
    <span class="s0">this</span><span class="s1">.colorStops(params)</span>

    <span class="s1">node.nodes = []</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">param of params) {</span>
      <span class="s1">node.nodes = node.nodes.concat(param)</span>
    <span class="s1">}</span>

    <span class="s1">node.nodes.unshift(</span>
      <span class="s1">{ type: </span><span class="s2">'word'</span><span class="s1">, value: </span><span class="s2">'linear' </span><span class="s1">},</span>
      <span class="s0">this</span><span class="s1">.cloneDiv(node.nodes)</span>
    <span class="s1">)</span>
    <span class="s1">node.value = </span><span class="s2">'-webkit-gradient'</span>

    <span class="s0">return true</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Change degrees for webkit prefix</span>
   <span class="s4">*/</span>
  <span class="s1">replace(string, prefix) {</span>
    <span class="s0">let </span><span class="s1">ast = parser(string)</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">node of ast.nodes) {</span>
      <span class="s0">let </span><span class="s1">gradientName = </span><span class="s0">this</span><span class="s1">.name </span><span class="s4">// gradient name</span>
      <span class="s0">if </span><span class="s1">(node.type === </span><span class="s2">'function' </span><span class="s1">&amp;&amp; node.value === gradientName) {</span>
        <span class="s1">node.nodes = </span><span class="s0">this</span><span class="s1">.newDirection(node.nodes)</span>
        <span class="s1">node.nodes = </span><span class="s0">this</span><span class="s1">.normalize(node.nodes, gradientName)</span>
        <span class="s0">if </span><span class="s1">(prefix === </span><span class="s2">'-webkit- old'</span><span class="s1">) {</span>
          <span class="s0">let </span><span class="s1">changes = </span><span class="s0">this</span><span class="s1">.oldWebkit(node)</span>
          <span class="s0">if </span><span class="s1">(!changes) {</span>
            <span class="s0">return false</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
          <span class="s1">node.nodes = </span><span class="s0">this</span><span class="s1">.convertDirection(node.nodes)</span>
          <span class="s1">node.value = prefix + node.value</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">ast.toString()</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Replace first token</span>
   <span class="s4">*/</span>
  <span class="s1">replaceFirst(params, ...words) {</span>
    <span class="s0">let </span><span class="s1">prefix = words.map(i =&gt; {</span>
      <span class="s0">if </span><span class="s1">(i === </span><span class="s2">' '</span><span class="s1">) {</span>
        <span class="s0">return </span><span class="s1">{ type: </span><span class="s2">'space'</span><span class="s1">, value: i }</span>
      <span class="s1">}</span>
      <span class="s0">return </span><span class="s1">{ type: </span><span class="s2">'word'</span><span class="s1">, value: i }</span>
    <span class="s1">})</span>
    <span class="s0">return </span><span class="s1">prefix.concat(params.slice(</span><span class="s5">1</span><span class="s1">))</span>
  <span class="s1">}</span>

  <span class="s1">revertDirection(word) {</span>
    <span class="s0">return </span><span class="s1">Gradient.directions[word.toLowerCase()] || word</span>
  <span class="s1">}</span>

  <span class="s4">/**</span>
   <span class="s4">* Round float and save digits under dot</span>
   <span class="s4">*/</span>
  <span class="s1">roundFloat(float, digits) {</span>
    <span class="s0">return </span><span class="s1">parseFloat(float.toFixed(digits))</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">Gradient.names = [</span>
  <span class="s2">'linear-gradient'</span><span class="s1">,</span>
  <span class="s2">'repeating-linear-gradient'</span><span class="s1">,</span>
  <span class="s2">'radial-gradient'</span><span class="s1">,</span>
  <span class="s2">'repeating-radial-gradient'</span>
<span class="s1">]</span>

<span class="s1">Gradient.directions = {</span>
  <span class="s1">bottom: </span><span class="s2">'top'</span><span class="s1">,</span>
  <span class="s1">left: </span><span class="s2">'right'</span><span class="s1">,</span>
  <span class="s1">right: </span><span class="s2">'left'</span><span class="s1">,</span>
  <span class="s1">top: </span><span class="s2">'bottom' </span><span class="s4">// default value</span>
<span class="s1">}</span>

<span class="s4">// Direction to replace</span>
<span class="s1">Gradient.oldDirections = {</span>
  <span class="s2">'bottom'</span><span class="s1">: </span><span class="s2">'left top, left bottom'</span><span class="s1">,</span>
  <span class="s2">'bottom left'</span><span class="s1">: </span><span class="s2">'right top, left bottom'</span><span class="s1">,</span>
  <span class="s2">'bottom right'</span><span class="s1">: </span><span class="s2">'left top, right bottom'</span><span class="s1">,</span>
  <span class="s2">'left'</span><span class="s1">: </span><span class="s2">'right top, left top'</span><span class="s1">,</span>

  <span class="s2">'left bottom'</span><span class="s1">: </span><span class="s2">'right top, left bottom'</span><span class="s1">,</span>
  <span class="s2">'left top'</span><span class="s1">: </span><span class="s2">'right bottom, left top'</span><span class="s1">,</span>
  <span class="s2">'right'</span><span class="s1">: </span><span class="s2">'left top, right top'</span><span class="s1">,</span>
  <span class="s2">'right bottom'</span><span class="s1">: </span><span class="s2">'left top, right bottom'</span><span class="s1">,</span>
  <span class="s2">'right top'</span><span class="s1">: </span><span class="s2">'left bottom, right top'</span><span class="s1">,</span>
  <span class="s2">'top'</span><span class="s1">: </span><span class="s2">'left bottom, left top'</span><span class="s1">,</span>
  <span class="s2">'top left'</span><span class="s1">: </span><span class="s2">'right bottom, left top'</span><span class="s1">,</span>
  <span class="s2">'top right'</span><span class="s1">: </span><span class="s2">'left bottom, right top'</span>
<span class="s1">}</span>

<span class="s1">module.exports = Gradient</span>
</pre>
</body>
</html>