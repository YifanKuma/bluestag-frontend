<html>
<head>
<title>cascading-config-array-factory.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #0033b3;}
.s4 { color: #067d17;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
cascading-config-array-factory.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@fileoverview </span><span class="s0">`CascadingConfigArrayFactory` class.</span>
 <span class="s0">*</span>
 <span class="s0">* `CascadingConfigArrayFactory` class has a responsibility:</span>
 <span class="s0">*</span>
 <span class="s0">* 1. Handles cascading of config files.</span>
 <span class="s0">*</span>
 <span class="s0">* It provides two methods:</span>
 <span class="s0">*</span>
 <span class="s0">* - `getConfigArrayForFile(filePath)`</span>
 <span class="s0">*     Get the corresponded configuration of a given file. This method doesn't</span>
 <span class="s0">*     throw even if the given file didn't exist.</span>
 <span class="s0">* - `clearCache()`</span>
 <span class="s0">*     Clear the internal cache. You have to call this method when</span>
 <span class="s0">*     `additionalPluginPool` was updated if `baseConfig` or `cliConfig` depends</span>
 <span class="s0">*     on the additional plugins. (`CLIEngine#addPlugin()` method calls this.)</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Toru Nagashima &lt;https://github.com/mysticatea&gt;</span>
 <span class="s0">*/</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Requirements</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s3">import </span><span class="s2">debugOrig from </span><span class="s4">&quot;debug&quot;</span><span class="s2">;</span>
<span class="s3">import </span><span class="s2">os from </span><span class="s4">&quot;node:os&quot;</span><span class="s2">;</span>
<span class="s3">import </span><span class="s2">path from </span><span class="s4">&quot;node:path&quot;</span><span class="s2">;</span>

<span class="s3">import </span><span class="s2">{ ConfigArrayFactory } from </span><span class="s4">&quot;./config-array-factory.js&quot;</span><span class="s2">;</span>
<span class="s3">import </span><span class="s2">{</span>
    <span class="s2">ConfigArray,</span>
    <span class="s2">ConfigDependency,</span>
    <span class="s2">IgnorePattern</span>
<span class="s2">} from </span><span class="s4">&quot;./config-array/index.js&quot;</span><span class="s2">;</span>
<span class="s3">import </span><span class="s2">ConfigValidator from </span><span class="s4">&quot;./shared/config-validator.js&quot;</span><span class="s2">;</span>
<span class="s3">import </span><span class="s2">{ emitDeprecationWarning } from </span><span class="s4">&quot;./shared/deprecation-warnings.js&quot;</span><span class="s2">;</span>

<span class="s3">const </span><span class="s2">debug = debugOrig(</span><span class="s4">&quot;eslintrc:cascading-config-array-factory&quot;</span><span class="s2">);</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Helpers</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s0">// Define types for VSCode IntelliSense.</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;./shared/types&quot;).ConfigData} ConfigData */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;./shared/types&quot;).Parser} Parser */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;./shared/types&quot;).Plugin} Plugin */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{import(&quot;./shared/types&quot;).Rule} Rule */</span>
<span class="s0">/** </span><span class="s1">@typedef </span><span class="s0">{ReturnType&lt;ConfigArrayFactory[&quot;create&quot;]&gt;} ConfigArray */</span>

<span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@typedef </span><span class="s0">{Object} CascadingConfigArrayFactoryOptions</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Map&lt;string,Plugin&gt;} [additionalPluginPool] The map for additional plugins.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigData} [baseConfig] The config by `baseConfig` option.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigData} [cliConfig] The config by CLI options (`--env`, `--global`, `--ignore-pattern`, `--parser`, `--parser-options`, `--plugin`, and `--rule`). CLI options overwrite the setting in config files.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} [cwd] The base directory to start lookup.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} [ignorePath] The path to the alternative file of `.eslintignore`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string[]} [rulePaths] The value of `--rulesdir` option.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} [specificConfigPath] The value of `--config` option.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{boolean} [useEslintrc] if `false` then it doesn't load config files.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} loadRules The function to use to load rules.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Map&lt;string,Rule&gt;} builtInRules The rules that are built in to ESLint.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Object} [resolver=ModuleResolver] The module resolver object.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} eslintAllPath The path to the definitions for eslint:all.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} getEslintAllConfig Returns the config data for eslint:all.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} eslintRecommendedPath The path to the definitions for eslint:recommended.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} getEslintRecommendedConfig Returns the config data for eslint:recommended.</span>
 <span class="s0">*/</span>

<span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@typedef </span><span class="s0">{Object} CascadingConfigArrayFactoryInternalSlots</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigArray} baseConfigArray The config array of `baseConfig` option.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigData} baseConfigData The config data of `baseConfig` option. This is used to reset `baseConfigArray`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigArray} cliConfigArray The config array of CLI options.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigData} cliConfigData The config data of CLI options. This is used to reset `cliConfigArray`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{ConfigArrayFactory} configArrayFactory The factory for config arrays.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Map&lt;string, ConfigArray&gt;} configCache The cache from directory paths to config arrays.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} cwd The base directory to start lookup.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{WeakMap&lt;ConfigArray, ConfigArray&gt;} finalizeCache The cache from config arrays to finalized config arrays.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} [ignorePath] The path to the alternative file of `.eslintignore`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string[]|null} rulePaths The value of `--rulesdir` option. This is used to reset `baseConfigArray`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string|null} specificConfigPath The value of `--config` option. This is used to reset `cliConfigArray`.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{boolean} useEslintrc if `false` then it doesn't load config files.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} loadRules The function to use to load rules.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Map&lt;string,Rule&gt;} builtInRules The rules that are built in to ESLint.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Object} [resolver=ModuleResolver] The module resolver object.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} eslintAllPath The path to the definitions for eslint:all.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} getEslintAllConfig Returns the config data for eslint:all.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{string} eslintRecommendedPath The path to the definitions for eslint:recommended.</span>
 <span class="s0">* </span><span class="s1">@property </span><span class="s0">{Function} getEslintRecommendedConfig Returns the config data for eslint:recommended.</span>
 <span class="s0">*/</span>

<span class="s0">/** </span><span class="s1">@type </span><span class="s0">{WeakMap&lt;CascadingConfigArrayFactory, CascadingConfigArrayFactoryInternalSlots&gt;} */</span>
<span class="s3">const </span><span class="s2">internalSlotsMap = </span><span class="s3">new </span><span class="s2">WeakMap();</span>

<span class="s0">/**</span>
 <span class="s0">* Create the config array from `baseConfig` and `rulePaths`.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{CascadingConfigArrayFactoryInternalSlots} slots The slots.</span>
 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The config array of the base configs.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">createBaseConfigArray({</span>
    <span class="s2">configArrayFactory,</span>
    <span class="s2">baseConfigData,</span>
    <span class="s2">rulePaths,</span>
    <span class="s2">cwd,</span>
    <span class="s2">loadRules</span>
<span class="s2">}) {</span>
    <span class="s3">const </span><span class="s2">baseConfigArray = configArrayFactory.create(</span>
        <span class="s2">baseConfigData,</span>
        <span class="s2">{ name: </span><span class="s4">&quot;BaseConfig&quot; </span><span class="s2">}</span>
    <span class="s2">);</span>

    <span class="s0">/* 
     * Create the config array element for the default ignore patterns. 
     * This element has `ignorePattern` property that ignores the default 
     * patterns in the current working directory. 
     */</span>
    <span class="s2">baseConfigArray.unshift(configArrayFactory.create(</span>
        <span class="s2">{ ignorePatterns: IgnorePattern.DefaultPatterns },</span>
        <span class="s2">{ name: </span><span class="s4">&quot;DefaultIgnorePattern&quot; </span><span class="s2">}</span>
    <span class="s2">)[</span><span class="s5">0</span><span class="s2">]);</span>

    <span class="s0">/* 
     * Load rules `--rulesdir` option as a pseudo plugin. 
     * Use a pseudo plugin to define rules of `--rulesdir`, so we can validate 
     * the rule's options with only information in the config array. 
     */</span>
    <span class="s3">if </span><span class="s2">(rulePaths &amp;&amp; rulePaths.length &gt; </span><span class="s5">0</span><span class="s2">) {</span>
        <span class="s2">baseConfigArray.push({</span>
            <span class="s2">type: </span><span class="s4">&quot;config&quot;</span><span class="s2">,</span>
            <span class="s2">name: </span><span class="s4">&quot;--rulesdir&quot;</span><span class="s2">,</span>
            <span class="s2">filePath: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
            <span class="s2">plugins: {</span>
                <span class="s4">&quot;&quot;</span><span class="s2">: </span><span class="s3">new </span><span class="s2">ConfigDependency({</span>
                    <span class="s2">definition: {</span>
                        <span class="s2">rules: rulePaths.reduce(</span>
                            <span class="s2">(map, rulesPath) =&gt; Object.assign(</span>
                                <span class="s2">map,</span>
                                <span class="s2">loadRules(rulesPath, cwd)</span>
                            <span class="s2">),</span>
                            <span class="s2">{}</span>
                        <span class="s2">)</span>
                    <span class="s2">},</span>
                    <span class="s2">filePath: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s2">id: </span><span class="s4">&quot;&quot;</span><span class="s2">,</span>
                    <span class="s2">importerName: </span><span class="s4">&quot;--rulesdir&quot;</span><span class="s2">,</span>
                    <span class="s2">importerPath: </span><span class="s4">&quot;&quot;</span>
                <span class="s2">})</span>
            <span class="s2">}</span>
        <span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s3">return </span><span class="s2">baseConfigArray;</span>
<span class="s2">}</span>

<span class="s0">/**</span>
 <span class="s0">* Create the config array from CLI options.</span>
 <span class="s0">* </span><span class="s1">@param </span><span class="s0">{CascadingConfigArrayFactoryInternalSlots} slots The slots.</span>
 <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The config array of the base configs.</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s2">createCLIConfigArray({</span>
    <span class="s2">cliConfigData,</span>
    <span class="s2">configArrayFactory,</span>
    <span class="s2">cwd,</span>
    <span class="s2">ignorePath,</span>
    <span class="s2">specificConfigPath</span>
<span class="s2">}) {</span>
    <span class="s3">const </span><span class="s2">cliConfigArray = configArrayFactory.create(</span>
        <span class="s2">cliConfigData,</span>
        <span class="s2">{ name: </span><span class="s4">&quot;CLIOptions&quot; </span><span class="s2">}</span>
    <span class="s2">);</span>

    <span class="s2">cliConfigArray.unshift(</span>
        <span class="s2">...(ignorePath</span>
            <span class="s2">? configArrayFactory.loadESLintIgnore(ignorePath)</span>
            <span class="s2">: configArrayFactory.loadDefaultESLintIgnore())</span>
    <span class="s2">);</span>

    <span class="s3">if </span><span class="s2">(specificConfigPath) {</span>
        <span class="s2">cliConfigArray.unshift(</span>
            <span class="s2">...configArrayFactory.loadFile(</span>
                <span class="s2">specificConfigPath,</span>
                <span class="s2">{ name: </span><span class="s4">&quot;--config&quot;</span><span class="s2">, basePath: cwd }</span>
            <span class="s2">)</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s3">return </span><span class="s2">cliConfigArray;</span>
<span class="s2">}</span>

<span class="s0">/**</span>
 <span class="s0">* The error type when there are files matched by a glob, but all of them have been ignored.</span>
 <span class="s0">*/</span>
<span class="s3">class </span><span class="s2">ConfigurationNotFoundError </span><span class="s3">extends </span><span class="s2">Error {</span>


    <span class="s0">/**</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} directoryPath The directory path.</span>
     <span class="s0">*/</span>
    <span class="s2">constructor(directoryPath) {</span>
        <span class="s3">super</span><span class="s2">(</span><span class="s4">`No ESLint configuration found in </span><span class="s2">${directoryPath}</span><span class="s4">.`</span><span class="s2">);</span>
        <span class="s3">this</span><span class="s2">.messageTemplate = </span><span class="s4">&quot;no-config-found&quot;</span><span class="s2">;</span>
        <span class="s3">this</span><span class="s2">.messageData = { directoryPath };</span>
    <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">/**</span>
 <span class="s0">* This class provides the functionality that enumerates every file which is</span>
 <span class="s0">* matched by given glob patterns and that configuration.</span>
 <span class="s0">*/</span>
<span class="s3">class </span><span class="s2">CascadingConfigArrayFactory {</span>

    <span class="s0">/**</span>
     <span class="s0">* Initialize this enumerator.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{CascadingConfigArrayFactoryOptions} options The options.</span>
     <span class="s0">*/</span>
    <span class="s2">constructor({</span>
        <span class="s2">additionalPluginPool = </span><span class="s3">new </span><span class="s2">Map(),</span>
        <span class="s2">baseConfig: baseConfigData = </span><span class="s3">null</span><span class="s2">,</span>
        <span class="s2">cliConfig: cliConfigData = </span><span class="s3">null</span><span class="s2">,</span>
        <span class="s2">cwd = process.cwd(),</span>
        <span class="s2">ignorePath,</span>
        <span class="s2">resolvePluginsRelativeTo,</span>
        <span class="s2">rulePaths = [],</span>
        <span class="s2">specificConfigPath = </span><span class="s3">null</span><span class="s2">,</span>
        <span class="s2">useEslintrc = </span><span class="s3">true</span><span class="s2">,</span>
        <span class="s2">builtInRules = </span><span class="s3">new </span><span class="s2">Map(),</span>
        <span class="s2">loadRules,</span>
        <span class="s2">resolver,</span>
        <span class="s2">eslintRecommendedPath,</span>
        <span class="s2">getEslintRecommendedConfig,</span>
        <span class="s2">eslintAllPath,</span>
        <span class="s2">getEslintAllConfig</span>
    <span class="s2">} = {}) {</span>
        <span class="s3">const </span><span class="s2">configArrayFactory = </span><span class="s3">new </span><span class="s2">ConfigArrayFactory({</span>
            <span class="s2">additionalPluginPool,</span>
            <span class="s2">cwd,</span>
            <span class="s2">resolvePluginsRelativeTo,</span>
            <span class="s2">builtInRules,</span>
            <span class="s2">resolver,</span>
            <span class="s2">eslintRecommendedPath,</span>
            <span class="s2">getEslintRecommendedConfig,</span>
            <span class="s2">eslintAllPath,</span>
            <span class="s2">getEslintAllConfig</span>
        <span class="s2">});</span>

        <span class="s2">internalSlotsMap.set(</span><span class="s3">this</span><span class="s2">, {</span>
            <span class="s2">baseConfigArray: createBaseConfigArray({</span>
                <span class="s2">baseConfigData,</span>
                <span class="s2">configArrayFactory,</span>
                <span class="s2">cwd,</span>
                <span class="s2">rulePaths,</span>
                <span class="s2">loadRules</span>
            <span class="s2">}),</span>
            <span class="s2">baseConfigData,</span>
            <span class="s2">cliConfigArray: createCLIConfigArray({</span>
                <span class="s2">cliConfigData,</span>
                <span class="s2">configArrayFactory,</span>
                <span class="s2">cwd,</span>
                <span class="s2">ignorePath,</span>
                <span class="s2">specificConfigPath</span>
            <span class="s2">}),</span>
            <span class="s2">cliConfigData,</span>
            <span class="s2">configArrayFactory,</span>
            <span class="s2">configCache: </span><span class="s3">new </span><span class="s2">Map(),</span>
            <span class="s2">cwd,</span>
            <span class="s2">finalizeCache: </span><span class="s3">new </span><span class="s2">WeakMap(),</span>
            <span class="s2">ignorePath,</span>
            <span class="s2">rulePaths,</span>
            <span class="s2">specificConfigPath,</span>
            <span class="s2">useEslintrc,</span>
            <span class="s2">builtInRules,</span>
            <span class="s2">loadRules</span>
        <span class="s2">});</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* The path to the current working directory.</span>
     <span class="s0">* This is used by tests.</span>
     <span class="s0">* </span><span class="s1">@type </span><span class="s0">{string}</span>
     <span class="s0">*/</span>
    <span class="s2">get cwd() {</span>
        <span class="s3">const </span><span class="s2">{ cwd } = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s3">return </span><span class="s2">cwd;</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Get the config array of a given file.</span>
     <span class="s0">* If `filePath` was not given, it returns the config which contains only</span>
     <span class="s0">* `baseConfigData` and `cliConfigData`.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} [filePath] The file path to a file.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{Object} [options] The options.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{boolean} [options.ignoreNotFoundError] If `true` then it doesn't throw `ConfigurationNotFoundError`.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The config array of the file.</span>
     <span class="s0">*/</span>
    <span class="s2">getConfigArrayForFile(filePath, { ignoreNotFoundError = </span><span class="s3">false </span><span class="s2">} = {}) {</span>
        <span class="s3">const </span><span class="s2">{</span>
            <span class="s2">baseConfigArray,</span>
            <span class="s2">cliConfigArray,</span>
            <span class="s2">cwd</span>
        <span class="s2">} = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s3">if </span><span class="s2">(!filePath) {</span>
            <span class="s3">return new </span><span class="s2">ConfigArray(...baseConfigArray, ...cliConfigArray);</span>
        <span class="s2">}</span>

        <span class="s3">const </span><span class="s2">directoryPath = path.dirname(path.resolve(cwd, filePath));</span>

        <span class="s2">debug(</span><span class="s4">`Load config files for </span><span class="s2">${directoryPath}</span><span class="s4">.`</span><span class="s2">);</span>

        <span class="s3">return this</span><span class="s2">._finalizeConfigArray(</span>
            <span class="s3">this</span><span class="s2">._loadConfigInAncestors(directoryPath),</span>
            <span class="s2">directoryPath,</span>
            <span class="s2">ignoreNotFoundError</span>
        <span class="s2">);</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Set the config data to override all configs.</span>
     <span class="s0">* Require to call `clearCache()` method after this method is called.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{ConfigData} configData The config data to override all configs.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{void}</span>
     <span class="s0">*/</span>
    <span class="s2">setOverrideConfig(configData) {</span>
        <span class="s3">const </span><span class="s2">slots = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s2">slots.cliConfigData = configData;</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Clear config cache.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{void}</span>
     <span class="s0">*/</span>
    <span class="s2">clearCache() {</span>
        <span class="s3">const </span><span class="s2">slots = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s2">slots.baseConfigArray = createBaseConfigArray(slots);</span>
        <span class="s2">slots.cliConfigArray = createCLIConfigArray(slots);</span>
        <span class="s2">slots.configCache.clear();</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Load and normalize config files from the ancestor directories.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} directoryPath The path to a leaf directory.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{boolean} configsExistInSubdirs `true` if configurations exist in subdirectories.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The loaded config.</span>
     <span class="s0">* </span><span class="s1">@throws </span><span class="s0">{Error} If a config file is invalid.</span>
     <span class="s0">* </span><span class="s1">@private</span>
     <span class="s0">*/</span>
    <span class="s2">_loadConfigInAncestors(directoryPath, configsExistInSubdirs = </span><span class="s3">false</span><span class="s2">) {</span>
        <span class="s3">const </span><span class="s2">{</span>
            <span class="s2">baseConfigArray,</span>
            <span class="s2">configArrayFactory,</span>
            <span class="s2">configCache,</span>
            <span class="s2">cwd,</span>
            <span class="s2">useEslintrc</span>
        <span class="s2">} = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s3">if </span><span class="s2">(!useEslintrc) {</span>
            <span class="s3">return </span><span class="s2">baseConfigArray;</span>
        <span class="s2">}</span>

        <span class="s3">let </span><span class="s2">configArray = configCache.get(directoryPath);</span>

        <span class="s0">// Hit cache.</span>
        <span class="s3">if </span><span class="s2">(configArray) {</span>
            <span class="s2">debug(</span><span class="s4">`Cache hit: </span><span class="s2">${directoryPath}</span><span class="s4">.`</span><span class="s2">);</span>
            <span class="s3">return </span><span class="s2">configArray;</span>
        <span class="s2">}</span>
        <span class="s2">debug(</span><span class="s4">`No cache found: </span><span class="s2">${directoryPath}</span><span class="s4">.`</span><span class="s2">);</span>

        <span class="s3">const </span><span class="s2">homePath = os.homedir();</span>

        <span class="s0">// Consider this is root.</span>
        <span class="s3">if </span><span class="s2">(directoryPath === homePath &amp;&amp; cwd !== homePath) {</span>
            <span class="s2">debug(</span><span class="s4">&quot;Stop traversing because of considered root.&quot;</span><span class="s2">);</span>
            <span class="s3">if </span><span class="s2">(configsExistInSubdirs) {</span>
                <span class="s3">const </span><span class="s2">filePath = ConfigArrayFactory.getPathToConfigFileInDirectory(directoryPath);</span>

                <span class="s3">if </span><span class="s2">(filePath) {</span>
                    <span class="s2">emitDeprecationWarning(</span>
                        <span class="s2">filePath,</span>
                        <span class="s4">&quot;ESLINT_PERSONAL_CONFIG_SUPPRESS&quot;</span>
                    <span class="s2">);</span>
                <span class="s2">}</span>
            <span class="s2">}</span>
            <span class="s3">return this</span><span class="s2">._cacheConfig(directoryPath, baseConfigArray);</span>
        <span class="s2">}</span>

        <span class="s0">// Load the config on this directory.</span>
        <span class="s3">try </span><span class="s2">{</span>
            <span class="s2">configArray = configArrayFactory.loadInDirectory(directoryPath);</span>
        <span class="s2">} </span><span class="s3">catch </span><span class="s2">(error) {</span>
            <span class="s0">/* istanbul ignore next */</span>
            <span class="s3">if </span><span class="s2">(error.code === </span><span class="s4">&quot;EACCES&quot;</span><span class="s2">) {</span>
                <span class="s2">debug(</span><span class="s4">&quot;Stop traversing because of 'EACCES' error.&quot;</span><span class="s2">);</span>
                <span class="s3">return this</span><span class="s2">._cacheConfig(directoryPath, baseConfigArray);</span>
            <span class="s2">}</span>
            <span class="s3">throw </span><span class="s2">error;</span>
        <span class="s2">}</span>

        <span class="s3">if </span><span class="s2">(configArray.length &gt; </span><span class="s5">0 </span><span class="s2">&amp;&amp; configArray.isRoot()) {</span>
            <span class="s2">debug(</span><span class="s4">&quot;Stop traversing because of 'root:true'.&quot;</span><span class="s2">);</span>
            <span class="s2">configArray.unshift(...baseConfigArray);</span>
            <span class="s3">return this</span><span class="s2">._cacheConfig(directoryPath, configArray);</span>
        <span class="s2">}</span>

        <span class="s0">// Load from the ancestors and merge it.</span>
        <span class="s3">const </span><span class="s2">parentPath = path.dirname(directoryPath);</span>
        <span class="s3">const </span><span class="s2">parentConfigArray = parentPath &amp;&amp; parentPath !== directoryPath</span>
            <span class="s2">? </span><span class="s3">this</span><span class="s2">._loadConfigInAncestors(</span>
                <span class="s2">parentPath,</span>
                <span class="s2">configsExistInSubdirs || configArray.length &gt; </span><span class="s5">0</span>
            <span class="s2">)</span>
            <span class="s2">: baseConfigArray;</span>

        <span class="s3">if </span><span class="s2">(configArray.length &gt; </span><span class="s5">0</span><span class="s2">) {</span>
            <span class="s2">configArray.unshift(...parentConfigArray);</span>
        <span class="s2">} </span><span class="s3">else </span><span class="s2">{</span>
            <span class="s2">configArray = parentConfigArray;</span>
        <span class="s2">}</span>

        <span class="s0">// Cache and return.</span>
        <span class="s3">return this</span><span class="s2">._cacheConfig(directoryPath, configArray);</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Freeze and cache a given config.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} directoryPath The path to a directory as a cache key.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{ConfigArray} configArray The config array as a cache value.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The `configArray` (frozen).</span>
     <span class="s0">*/</span>
    <span class="s2">_cacheConfig(directoryPath, configArray) {</span>
        <span class="s3">const </span><span class="s2">{ configCache } = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s2">Object.freeze(configArray);</span>
        <span class="s2">configCache.set(directoryPath, configArray);</span>

        <span class="s3">return </span><span class="s2">configArray;</span>
    <span class="s2">}</span>

    <span class="s0">/**</span>
     <span class="s0">* Finalize a given config array.</span>
     <span class="s0">* Concatenate `--config` and other CLI options.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{ConfigArray} configArray The parent config array.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{string} directoryPath The path to the leaf directory to find config files.</span>
     <span class="s0">* </span><span class="s1">@param </span><span class="s0">{boolean} ignoreNotFoundError If `true` then it doesn't throw `ConfigurationNotFoundError`.</span>
     <span class="s0">* </span><span class="s1">@returns </span><span class="s0">{ConfigArray} The loaded config.</span>
     <span class="s0">* </span><span class="s1">@throws </span><span class="s0">{Error} If a config file is invalid.</span>
     <span class="s0">* </span><span class="s1">@private</span>
     <span class="s0">*/</span>
    <span class="s2">_finalizeConfigArray(configArray, directoryPath, ignoreNotFoundError) {</span>
        <span class="s3">const </span><span class="s2">{</span>
            <span class="s2">cliConfigArray,</span>
            <span class="s2">configArrayFactory,</span>
            <span class="s2">finalizeCache,</span>
            <span class="s2">useEslintrc,</span>
            <span class="s2">builtInRules</span>
        <span class="s2">} = internalSlotsMap.get(</span><span class="s3">this</span><span class="s2">);</span>

        <span class="s3">let </span><span class="s2">finalConfigArray = finalizeCache.get(configArray);</span>

        <span class="s3">if </span><span class="s2">(!finalConfigArray) {</span>
            <span class="s2">finalConfigArray = configArray;</span>

            <span class="s0">// Load the personal config if there are no regular config files.</span>
            <span class="s3">if </span><span class="s2">(</span>
                <span class="s2">useEslintrc &amp;&amp;</span>
                <span class="s2">configArray.every(c =&gt; !c.filePath) &amp;&amp;</span>
                <span class="s2">cliConfigArray.every(c =&gt; !c.filePath) </span><span class="s0">// `--config` option can be a file.</span>
            <span class="s2">) {</span>
                <span class="s3">const </span><span class="s2">homePath = os.homedir();</span>

                <span class="s2">debug(</span><span class="s4">&quot;Loading the config file of the home directory:&quot;</span><span class="s2">, homePath);</span>

                <span class="s3">const </span><span class="s2">personalConfigArray = configArrayFactory.loadInDirectory(</span>
                    <span class="s2">homePath,</span>
                    <span class="s2">{ name: </span><span class="s4">&quot;PersonalConfig&quot; </span><span class="s2">}</span>
                <span class="s2">);</span>

                <span class="s3">if </span><span class="s2">(</span>
                    <span class="s2">personalConfigArray.length &gt; </span><span class="s5">0 </span><span class="s2">&amp;&amp;</span>
                    <span class="s2">!directoryPath.startsWith(homePath)</span>
                <span class="s2">) {</span>
                    <span class="s3">const </span><span class="s2">lastElement =</span>
                        <span class="s2">personalConfigArray.at(-</span><span class="s5">1</span><span class="s2">);</span>

                    <span class="s2">emitDeprecationWarning(</span>
                        <span class="s2">lastElement.filePath,</span>
                        <span class="s4">&quot;ESLINT_PERSONAL_CONFIG_LOAD&quot;</span>
                    <span class="s2">);</span>
                <span class="s2">}</span>

                <span class="s2">finalConfigArray = finalConfigArray.concat(personalConfigArray);</span>
            <span class="s2">}</span>

            <span class="s0">// Apply CLI options.</span>
            <span class="s3">if </span><span class="s2">(cliConfigArray.length &gt; </span><span class="s5">0</span><span class="s2">) {</span>
                <span class="s2">finalConfigArray = finalConfigArray.concat(cliConfigArray);</span>
            <span class="s2">}</span>

            <span class="s0">// Validate rule settings and environments.</span>
            <span class="s3">const </span><span class="s2">validator = </span><span class="s3">new </span><span class="s2">ConfigValidator({</span>
                <span class="s2">builtInRules</span>
            <span class="s2">});</span>

            <span class="s2">validator.validateConfigArray(finalConfigArray);</span>

            <span class="s0">// Cache it.</span>
            <span class="s2">Object.freeze(finalConfigArray);</span>
            <span class="s2">finalizeCache.set(configArray, finalConfigArray);</span>

            <span class="s2">debug(</span>
                <span class="s4">&quot;Configuration was determined: %o on %s&quot;</span><span class="s2">,</span>
                <span class="s2">finalConfigArray,</span>
                <span class="s2">directoryPath</span>
            <span class="s2">);</span>
        <span class="s2">}</span>

        <span class="s0">// At least one element (the default ignore patterns) exists.</span>
        <span class="s3">if </span><span class="s2">(!ignoreNotFoundError &amp;&amp; useEslintrc &amp;&amp; finalConfigArray.length &lt;= </span><span class="s5">1</span><span class="s2">) {</span>
            <span class="s3">throw new </span><span class="s2">ConfigurationNotFoundError(directoryPath);</span>
        <span class="s2">}</span>

        <span class="s3">return </span><span class="s2">finalConfigArray;</span>
    <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">//------------------------------------------------------------------------------</span>
<span class="s0">// Public Interface</span>
<span class="s0">//------------------------------------------------------------------------------</span>

<span class="s3">export </span><span class="s2">{ CascadingConfigArrayFactory };</span>
</pre>
</body>
</html>