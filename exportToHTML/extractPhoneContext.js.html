<html>
<head>
<title>extractPhoneContext.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #067d17;}
.s4 { color: #0037a6;}
.s5 { color: #8c8c8c; font-style: italic;}
.s6 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
extractPhoneContext.js</font>
</center></td></tr></table>
<pre><span class="s0">// When phone numbers are written in `RFC3966` format — `&quot;tel:+12133734253&quot;` —</span>
<span class="s0">// they can have their &quot;calling code&quot; part written separately in a `phone-context` parameter.</span>
<span class="s0">// Example: `&quot;tel:12133734253;phone-context=+1&quot;`.</span>
<span class="s0">// This function parses the full phone number from the local number and the `phone-context`</span>
<span class="s0">// when the `phone-context` contains a `+` sign.</span>

<span class="s2">import </span><span class="s1">{</span>
  <span class="s1">VALID_DIGITS,</span>
  <span class="s0">// PLUS_CHARS</span>
<span class="s1">} from </span><span class="s3">'../constants.js'</span>

<span class="s2">export const </span><span class="s1">PLUS_SIGN = </span><span class="s3">'+'</span>

<span class="s2">const </span><span class="s1">RFC3966_VISUAL_SEPARATOR_ = </span><span class="s3">'[</span><span class="s4">\\</span><span class="s3">-</span><span class="s4">\\</span><span class="s3">.</span><span class="s4">\\</span><span class="s3">(</span><span class="s4">\\</span><span class="s3">)]?'</span>

<span class="s2">const </span><span class="s1">RFC3966_PHONE_DIGIT_ = </span><span class="s3">'(' </span><span class="s1">+ </span><span class="s3">'[' </span><span class="s1">+ VALID_DIGITS + </span><span class="s3">']' </span><span class="s1">+ </span><span class="s3">'|' </span><span class="s1">+ RFC3966_VISUAL_SEPARATOR_ + </span><span class="s3">')'</span>

<span class="s2">const </span><span class="s1">RFC3966_GLOBAL_NUMBER_DIGITS_ =</span>
	<span class="s3">'^' </span><span class="s1">+</span>
	<span class="s3">'</span><span class="s4">\\</span><span class="s3">' </span><span class="s1">+</span>
	<span class="s1">PLUS_SIGN +</span>
	<span class="s1">RFC3966_PHONE_DIGIT_ +</span>
	<span class="s3">'*' </span><span class="s1">+</span>
	<span class="s3">'[' </span><span class="s1">+ VALID_DIGITS +  </span><span class="s3">']' </span><span class="s1">+</span>
	<span class="s1">RFC3966_PHONE_DIGIT_ +</span>
	<span class="s3">'*' </span><span class="s1">+</span>
	<span class="s3">'$'</span>

<span class="s0">/**</span>
 <span class="s0">* Regular expression of valid global-number-digits for the phone-context</span>
 <span class="s0">* parameter, following the syntax defined in RFC3966.</span>
 <span class="s0">*/</span>
<span class="s2">const </span><span class="s1">RFC3966_GLOBAL_NUMBER_DIGITS_PATTERN_ = </span><span class="s2">new </span><span class="s1">RegExp(RFC3966_GLOBAL_NUMBER_DIGITS_, </span><span class="s3">'g'</span><span class="s1">)</span>

<span class="s0">// In this port of Google's library, we don't accept alpha characters in phone numbers.</span>
<span class="s0">// const ALPHANUM_ = VALID_ALPHA_ + VALID_DIGITS</span>
<span class="s2">const </span><span class="s1">ALPHANUM_ = VALID_DIGITS</span>

<span class="s2">const </span><span class="s1">RFC3966_DOMAINLABEL_ = </span><span class="s3">'[' </span><span class="s1">+ ALPHANUM_ + </span><span class="s3">']+((</span><span class="s4">\\</span><span class="s3">-)*[' </span><span class="s1">+ ALPHANUM_ + </span><span class="s3">'])*'</span>

<span class="s2">const </span><span class="s1">VALID_ALPHA_ = </span><span class="s3">'a-zA-Z'</span>
<span class="s2">const </span><span class="s1">RFC3966_TOPLABEL_ = </span><span class="s3">'[' </span><span class="s1">+ VALID_ALPHA_ + </span><span class="s3">']+((</span><span class="s4">\\</span><span class="s3">-)*[' </span><span class="s1">+ ALPHANUM_ + </span><span class="s3">'])*'</span>

<span class="s2">const </span><span class="s1">RFC3966_DOMAINNAME_ = </span><span class="s3">'^(' </span><span class="s1">+ RFC3966_DOMAINLABEL_ + </span><span class="s3">'</span><span class="s4">\\</span><span class="s3">.)*' </span><span class="s1">+ RFC3966_TOPLABEL_ + </span><span class="s3">'</span><span class="s4">\\</span><span class="s3">.?$'</span>

<span class="s0">/**</span>
 <span class="s0">* Regular expression of valid domainname for the phone-context parameter,</span>
 <span class="s0">* following the syntax defined in RFC3966.</span>
 <span class="s0">*/</span>
<span class="s2">const </span><span class="s1">RFC3966_DOMAINNAME_PATTERN_ = </span><span class="s2">new </span><span class="s1">RegExp(RFC3966_DOMAINNAME_, </span><span class="s3">'g'</span><span class="s1">)</span>

<span class="s2">export const </span><span class="s1">RFC3966_PREFIX_ = </span><span class="s3">'tel:'</span>
<span class="s2">export const </span><span class="s1">RFC3966_PHONE_CONTEXT_ = </span><span class="s3">';phone-context='</span>
<span class="s2">export const </span><span class="s1">RFC3966_ISDN_SUBADDRESS_ = </span><span class="s3">';isub='</span>

<span class="s0">/**</span>
 <span class="s0">* Extracts the value of the phone-context parameter of `numberToExtractFrom`,</span>
 <span class="s0">* following the syntax defined in RFC3966.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s5">@param </span><span class="s0">{string} numberToExtractFrom</span>
 <span class="s0">* </span><span class="s5">@return </span><span class="s0">{string|null} the extracted string (possibly empty), or `null` if no phone-context parameter is found.</span>
 <span class="s0">*/</span>
<span class="s2">export default function </span><span class="s1">extractPhoneContext(numberToExtractFrom) {</span>
	<span class="s2">const </span><span class="s1">indexOfPhoneContext = numberToExtractFrom.indexOf(RFC3966_PHONE_CONTEXT_)</span>
	<span class="s0">// If no phone-context parameter is present</span>
	<span class="s2">if </span><span class="s1">(indexOfPhoneContext &lt; </span><span class="s6">0</span><span class="s1">) {</span>
		<span class="s2">return null</span>
	<span class="s1">}</span>

	<span class="s2">const </span><span class="s1">phoneContextStart = indexOfPhoneContext + RFC3966_PHONE_CONTEXT_.length</span>
	<span class="s0">// If phone-context parameter is empty</span>
	<span class="s2">if </span><span class="s1">(phoneContextStart &gt;= numberToExtractFrom.length) {</span>
		<span class="s2">return </span><span class="s3">''</span>
	<span class="s1">}</span>

	<span class="s2">const </span><span class="s1">phoneContextEnd = numberToExtractFrom.indexOf(</span><span class="s3">';'</span><span class="s1">, phoneContextStart)</span>
	<span class="s0">// If phone-context is not the last parameter</span>
	<span class="s2">if </span><span class="s1">(phoneContextEnd &gt;= </span><span class="s6">0</span><span class="s1">) {</span>
		<span class="s2">return </span><span class="s1">numberToExtractFrom.substring(phoneContextStart, phoneContextEnd)</span>
	<span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
		<span class="s2">return </span><span class="s1">numberToExtractFrom.substring(phoneContextStart)</span>
	<span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/**</span>
 <span class="s0">* Returns whether the value of phoneContext follows the syntax defined in RFC3966.</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s5">@param </span><span class="s0">{string|null} phoneContext</span>
 <span class="s0">* </span><span class="s5">@return </span><span class="s0">{boolean}</span>
 <span class="s0">*/</span>
<span class="s2">export function </span><span class="s1">isPhoneContextValid(phoneContext) {</span>
	<span class="s2">if </span><span class="s1">(phoneContext === </span><span class="s2">null</span><span class="s1">) {</span>
		<span class="s2">return true</span>
	<span class="s1">}</span>

	<span class="s2">if </span><span class="s1">(phoneContext.length === </span><span class="s6">0</span><span class="s1">) {</span>
		<span class="s2">return false</span>
	<span class="s1">}</span>

	<span class="s0">// Does phone-context value match pattern of global-number-digits or domainname.</span>
	<span class="s2">return </span><span class="s1">RFC3966_GLOBAL_NUMBER_DIGITS_PATTERN_.test(phoneContext) ||</span>
		<span class="s1">RFC3966_DOMAINNAME_PATTERN_.test(phoneContext)</span>
<span class="s1">}</span></pre>
</body>
</html>