<html>
<head>
<title>pick-font-file-for-fallback-generation.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #264eff;}
.s6 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pick-font-file-for-fallback-generation.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, { value: </span><span class="s2">true </span><span class="s1">});</span>
<span class="s1">exports.pickFontFileForFallbackGeneration = pickFontFileForFallbackGeneration;</span>
<span class="s2">const </span><span class="s1">next_font_error_1 = require(</span><span class="s0">&quot;../next-font-error&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">NORMAL_WEIGHT = </span><span class="s3">400</span><span class="s1">;</span>
<span class="s2">const </span><span class="s1">BOLD_WEIGHT = </span><span class="s3">700</span><span class="s1">;</span>
<span class="s4">/**</span>
 <span class="s4">* Convert the weight string to a number so it can be used for comparison.</span>
 <span class="s4">* Weights can be defined as a number, 'normal' or 'bold'. https://developer.mozilla.org/docs/Web/CSS/@font-face/font-weight</span>
 <span class="s4">*/</span>
<span class="s2">function </span><span class="s1">getWeightNumber(weight) {</span>
    <span class="s2">return </span><span class="s1">weight === </span><span class="s0">'normal'</span>
        <span class="s1">? NORMAL_WEIGHT</span>
        <span class="s1">: weight === </span><span class="s0">'bold'</span>
            <span class="s1">? BOLD_WEIGHT</span>
            <span class="s1">: Number(weight);</span>
<span class="s1">}</span>
<span class="s4">/**</span>
 <span class="s4">* Get the distance from normal (400) weight for the provided weight.</span>
 <span class="s4">* If it's not a variable font we can just return the distance.</span>
 <span class="s4">* If it's a variable font we need to compare its weight range to 400.</span>
 <span class="s4">*/</span>
<span class="s2">function </span><span class="s1">getDistanceFromNormalWeight(weight) {</span>
    <span class="s2">if </span><span class="s1">(!weight)</span>
        <span class="s2">return </span><span class="s3">0</span><span class="s1">;</span>
    <span class="s4">// If it's a variable font the weight is defined with two numbers &quot;100 900&quot;, rather than just one &quot;400&quot;</span>
    <span class="s2">const </span><span class="s1">[firstWeight, secondWeight] = weight</span>
        <span class="s1">.trim()</span>
        <span class="s1">.split(</span><span class="s5">/ +/</span><span class="s1">)</span>
        <span class="s1">.map(getWeightNumber);</span>
    <span class="s2">if </span><span class="s1">(Number.isNaN(firstWeight) || Number.isNaN(secondWeight)) {</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s1">, next_font_error_1.nextFontError)(</span><span class="s0">`Invalid weight value in src array: </span><span class="s6">\`</span><span class="s1">${weight}</span><span class="s6">\`</span><span class="s0">.</span><span class="s6">\n</span><span class="s0">Expected </span><span class="s6">\`</span><span class="s0">normal</span><span class="s6">\`</span><span class="s0">, </span><span class="s6">\`</span><span class="s0">bold</span><span class="s6">\` </span><span class="s0">or a number.`</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s4">// If the weight doesn't have have a second value, it's not a variable font</span>
    <span class="s4">// If that's the case, just return the distance from normal weight</span>
    <span class="s2">if </span><span class="s1">(!secondWeight) {</span>
        <span class="s2">return </span><span class="s1">firstWeight - NORMAL_WEIGHT;</span>
    <span class="s1">}</span>
    <span class="s4">// Normal weight is within variable font range</span>
    <span class="s2">if </span><span class="s1">(firstWeight &lt;= NORMAL_WEIGHT &amp;&amp; secondWeight &gt;= NORMAL_WEIGHT) {</span>
        <span class="s2">return </span><span class="s3">0</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">// Normal weight is outside variable font range</span>
    <span class="s4">// Return the distance of normal weight to the variable font range</span>
    <span class="s2">const </span><span class="s1">firstWeightDistance = firstWeight - NORMAL_WEIGHT;</span>
    <span class="s2">const </span><span class="s1">secondWeightDistance = secondWeight - NORMAL_WEIGHT;</span>
    <span class="s2">if </span><span class="s1">(Math.abs(firstWeightDistance) &lt; Math.abs(secondWeightDistance)) {</span>
        <span class="s2">return </span><span class="s1">firstWeightDistance;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">secondWeightDistance;</span>
<span class="s1">}</span>
<span class="s4">/**</span>
 <span class="s4">* If multiple font files are provided for a font family, we need to pick one to use for the automatic fallback generation.</span>
 <span class="s4">* This function returns the font file that is most likely to be used for the bulk of the text on a page.</span>
 <span class="s4">*</span>
 <span class="s4">* There are some assumptions here about the text on a page when picking the font file:</span>
 <span class="s4">* - Most of the text will have normal weight, use the one closest to 400</span>
 <span class="s4">* - Most of the text will have normal style, prefer normal over italic</span>
 <span class="s4">* - If two font files have the same distance from normal weight, the thinner one will most likely be the bulk of the text</span>
 <span class="s4">*/</span>
<span class="s2">function </span><span class="s1">pickFontFileForFallbackGeneration(fontFiles) {</span>
    <span class="s2">return </span><span class="s1">fontFiles.reduce((usedFontFile, currentFontFile) =&gt; {</span>
        <span class="s2">if </span><span class="s1">(!usedFontFile)</span>
            <span class="s2">return </span><span class="s1">currentFontFile;</span>
        <span class="s2">const </span><span class="s1">usedFontDistance = getDistanceFromNormalWeight(usedFontFile.weight);</span>
        <span class="s2">const </span><span class="s1">currentFontDistance = getDistanceFromNormalWeight(currentFontFile.weight);</span>
        <span class="s4">// Prefer normal style if they have the same weight</span>
        <span class="s2">if </span><span class="s1">(usedFontDistance === currentFontDistance &amp;&amp;</span>
            <span class="s1">(</span><span class="s2">typeof </span><span class="s1">currentFontFile.style === </span><span class="s0">'undefined' </span><span class="s1">||</span>
                <span class="s1">currentFontFile.style === </span><span class="s0">'normal'</span><span class="s1">)) {</span>
            <span class="s2">return </span><span class="s1">currentFontFile;</span>
        <span class="s1">}</span>
        <span class="s2">const </span><span class="s1">absUsedDistance = Math.abs(usedFontDistance);</span>
        <span class="s2">const </span><span class="s1">absCurrentDistance = Math.abs(currentFontDistance);</span>
        <span class="s4">// Use closest absolute distance to normal weight</span>
        <span class="s2">if </span><span class="s1">(absCurrentDistance &lt; absUsedDistance)</span>
            <span class="s2">return </span><span class="s1">currentFontFile;</span>
        <span class="s4">// Prefer the thinner font if both have the same absolute distance from normal weight</span>
        <span class="s2">if </span><span class="s1">(absUsedDistance === absCurrentDistance &amp;&amp;</span>
            <span class="s1">currentFontDistance &lt; usedFontDistance) {</span>
            <span class="s2">return </span><span class="s1">currentFontFile;</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s1">usedFontFile;</span>
    <span class="s1">});</span>
<span class="s1">}</span>
</pre>
</body>
</html>