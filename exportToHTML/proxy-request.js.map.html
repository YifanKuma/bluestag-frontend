<html>
<head>
<title>proxy-request.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
proxy-request.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../../src/server/lib/router-utils/proxy-request.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import type { IncomingMessage, ServerResponse } from 'http'</span><span class="s3">\n</span><span class="s1">import type { NextUrlWithParsedQuery } from '../../request-meta'</span><span class="s3">\n\n</span><span class="s1">import url from 'url'</span><span class="s3">\n</span><span class="s1">import { stringifyQuery } from '../../server-route-utils'</span><span class="s3">\n</span><span class="s1">import { Duplex } from 'stream'</span><span class="s3">\n</span><span class="s1">import { DetachedPromise } from '../../../lib/detached-promise'</span><span class="s3">\n\n</span><span class="s1">export async function proxyRequest(</span><span class="s3">\n  </span><span class="s1">req: IncomingMessage,</span><span class="s3">\n  </span><span class="s1">res: ServerResponse | Duplex,</span><span class="s3">\n  </span><span class="s1">parsedUrl: NextUrlWithParsedQuery,</span><span class="s3">\n  </span><span class="s1">upgradeHead?: Buffer,</span><span class="s3">\n  </span><span class="s1">reqBody?: any,</span><span class="s3">\n  </span><span class="s1">proxyTimeout?: number | null</span><span class="s3">\n</span><span class="s1">) {</span><span class="s3">\n  </span><span class="s1">const { query } = parsedUrl</span><span class="s3">\n  </span><span class="s1">delete (parsedUrl as any).query</span><span class="s3">\n  </span><span class="s1">parsedUrl.search = stringifyQuery(req as any, query)</span><span class="s3">\n\n  </span><span class="s1">const target = url.format(parsedUrl)</span><span class="s3">\n  </span><span class="s1">const HttpProxy =</span><span class="s3">\n    </span><span class="s1">require('next/dist/compiled/http-proxy') as typeof import('next/dist/compiled/http-proxy')</span><span class="s3">\n\n  </span><span class="s1">const proxy = new HttpProxy({</span><span class="s3">\n    </span><span class="s1">target,</span><span class="s3">\n    </span><span class="s1">changeOrigin: true,</span><span class="s3">\n    </span><span class="s1">ignorePath: true,</span><span class="s3">\n    </span><span class="s1">ws: true,</span><span class="s3">\n    </span><span class="s1">// we limit proxy requests to 30s by default, in development</span><span class="s3">\n    </span><span class="s1">// we don't time out WebSocket requests to allow proxying</span><span class="s3">\n    </span><span class="s1">proxyTimeout: proxyTimeout === null ? undefined : proxyTimeout || 30_000,</span><span class="s3">\n    </span><span class="s1">headers: {</span><span class="s3">\n      </span><span class="s1">'x-forwarded-host': req.headers.host || '',</span><span class="s3">\n    </span><span class="s1">},</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">let finished = false</span><span class="s3">\n\n  </span><span class="s1">// http-proxy does not properly detect a client disconnect in newer</span><span class="s3">\n  </span><span class="s1">// versions of Node.js. This is caused because it only listens for the</span><span class="s3">\n  </span><span class="s1">// `aborted` event on the our request object, but it also fully reads</span><span class="s3">\n  </span><span class="s1">// and closes the request object. Node **will not** fire `aborted` when</span><span class="s3">\n  </span><span class="s1">// the request is already closed. Listening for `close` on our response</span><span class="s3">\n  </span><span class="s1">// object will detect the disconnect, and we can abort the proxy's</span><span class="s3">\n  </span><span class="s1">// connection.</span><span class="s3">\n  </span><span class="s1">proxy.on('proxyReq', (proxyReq) =&gt; {</span><span class="s3">\n    </span><span class="s1">res.on('close', () =&gt; proxyReq.destroy())</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">proxy.on('proxyRes', (proxyRes) =&gt; {</span><span class="s3">\n    </span><span class="s1">if (res.destroyed) {</span><span class="s3">\n      </span><span class="s1">proxyRes.destroy()</span><span class="s3">\n    </span><span class="s1">} else {</span><span class="s3">\n      </span><span class="s1">res.on('close', () =&gt; proxyRes.destroy())</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">proxy.on('proxyRes', (proxyRes, innerReq, innerRes) =&gt; {</span><span class="s3">\n    </span><span class="s1">const cleanup = (err: any) =&gt; {</span><span class="s3">\n      </span><span class="s1">// cleanup event listeners to allow clean garbage collection</span><span class="s3">\n      </span><span class="s1">proxyRes.removeListener('error', cleanup)</span><span class="s3">\n      </span><span class="s1">proxyRes.removeListener('close', cleanup)</span><span class="s3">\n      </span><span class="s1">innerRes.removeListener('error', cleanup)</span><span class="s3">\n      </span><span class="s1">innerRes.removeListener('close', cleanup)</span><span class="s3">\n\n      </span><span class="s1">// destroy all source streams to propagate the caught event backward</span><span class="s3">\n      </span><span class="s1">innerReq.destroy(err)</span><span class="s3">\n      </span><span class="s1">proxyRes.destroy(err)</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n\n    </span><span class="s1">proxyRes.once('error', cleanup)</span><span class="s3">\n    </span><span class="s1">proxyRes.once('close', cleanup)</span><span class="s3">\n    </span><span class="s1">innerRes.once('error', cleanup)</span><span class="s3">\n    </span><span class="s1">innerRes.once('close', cleanup)</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">const detached = new DetachedPromise&lt;boolean&gt;()</span><span class="s3">\n\n  </span><span class="s1">proxy.on('error', (err) =&gt; {</span><span class="s3">\n    </span><span class="s1">console.error(`Failed to proxy ${target}`, err)</span><span class="s3">\n    </span><span class="s1">if (!finished) {</span><span class="s3">\n      </span><span class="s1">finished = true</span><span class="s3">\n      </span><span class="s1">detached.reject(err)</span><span class="s3">\n\n      </span><span class="s1">if (!res.destroyed) {</span><span class="s3">\n        </span><span class="s1">if (!(res instanceof Duplex)) {</span><span class="s3">\n          </span><span class="s1">res.statusCode = 500</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">res.end('Internal Server Error')</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">// If upgrade head is present or the response is a Duplex stream, treat as</span><span class="s3">\n  </span><span class="s1">// WebSocket request.</span><span class="s3">\n  </span><span class="s1">if (upgradeHead || res instanceof Duplex) {</span><span class="s3">\n    </span><span class="s1">proxy.on('proxyReqWs', (proxyReq) =&gt; {</span><span class="s3">\n      </span><span class="s1">proxyReq.on('close', () =&gt; {</span><span class="s3">\n        </span><span class="s1">if (!finished) {</span><span class="s3">\n          </span><span class="s1">finished = true</span><span class="s3">\n          </span><span class="s1">detached.resolve(true)</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n      </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">proxy.ws(req, res, upgradeHead)</span><span class="s3">\n    </span><span class="s1">detached.resolve(true)</span><span class="s3">\n  </span><span class="s1">} else {</span><span class="s3">\n    </span><span class="s1">proxy.on('proxyReq', (proxyReq) =&gt; {</span><span class="s3">\n      </span><span class="s1">proxyReq.on('close', () =&gt; {</span><span class="s3">\n        </span><span class="s1">if (!finished) {</span><span class="s3">\n          </span><span class="s1">finished = true</span><span class="s3">\n          </span><span class="s1">detached.resolve(true)</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n      </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n    </span><span class="s1">proxy.web(req, res, {</span><span class="s3">\n      </span><span class="s1">buffer: reqBody,</span><span class="s3">\n    </span><span class="s1">})</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">// When the proxy finishes proxying the request, shut down the proxy.</span><span class="s3">\n  </span><span class="s1">return detached.promise.finally(() =&gt; {</span><span class="s3">\n    </span><span class="s1">proxy.close()</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;proxyRequest&quot;</span><span class="s0">,</span><span class="s1">&quot;req&quot;</span><span class="s0">,</span><span class="s1">&quot;res&quot;</span><span class="s0">,</span><span class="s1">&quot;parsedUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;upgradeHead&quot;</span><span class="s0">,</span><span class="s1">&quot;reqBody&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyTimeout&quot;</span><span class="s0">,</span><span class="s1">&quot;query&quot;</span><span class="s0">,</span><span class="s1">&quot;search&quot;</span><span class="s0">,</span><span class="s1">&quot;stringifyQuery&quot;</span><span class="s0">,</span><span class="s1">&quot;target&quot;</span><span class="s0">,</span><span class="s1">&quot;url&quot;</span><span class="s0">,</span><span class="s1">&quot;format&quot;</span><span class="s0">,</span><span class="s1">&quot;HttpProxy&quot;</span><span class="s0">,</span><span class="s1">&quot;require&quot;</span><span class="s0">,</span><span class="s1">&quot;proxy&quot;</span><span class="s0">,</span><span class="s1">&quot;changeOrigin&quot;</span><span class="s0">,</span><span class="s1">&quot;ignorePath&quot;</span><span class="s0">,</span><span class="s1">&quot;ws&quot;</span><span class="s0">,</span><span class="s1">&quot;undefined&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;host&quot;</span><span class="s0">,</span><span class="s1">&quot;finished&quot;</span><span class="s0">,</span><span class="s1">&quot;on&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyReq&quot;</span><span class="s0">,</span><span class="s1">&quot;destroy&quot;</span><span class="s0">,</span><span class="s1">&quot;proxyRes&quot;</span><span class="s0">,</span><span class="s1">&quot;destroyed&quot;</span><span class="s0">,</span><span class="s1">&quot;innerReq&quot;</span><span class="s0">,</span><span class="s1">&quot;innerRes&quot;</span><span class="s0">,</span><span class="s1">&quot;cleanup&quot;</span><span class="s0">,</span><span class="s1">&quot;err&quot;</span><span class="s0">,</span><span class="s1">&quot;removeListener&quot;</span><span class="s0">,</span><span class="s1">&quot;once&quot;</span><span class="s0">,</span><span class="s1">&quot;detached&quot;</span><span class="s0">,</span><span class="s1">&quot;DetachedPromise&quot;</span><span class="s0">,</span><span class="s1">&quot;console&quot;</span><span class="s0">,</span><span class="s1">&quot;error&quot;</span><span class="s0">,</span><span class="s1">&quot;reject&quot;</span><span class="s0">,</span><span class="s1">&quot;Duplex&quot;</span><span class="s0">,</span><span class="s1">&quot;statusCode&quot;</span><span class="s0">,</span><span class="s1">&quot;end&quot;</span><span class="s0">,</span><span class="s1">&quot;resolve&quot;</span><span class="s0">,</span><span class="s1">&quot;web&quot;</span><span class="s0">,</span><span class="s1">&quot;buffer&quot;</span><span class="s0">,</span><span class="s1">&quot;promise&quot;</span><span class="s0">,</span><span class="s1">&quot;finally&quot;</span><span class="s0">,</span><span class="s1">&quot;close&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;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&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>