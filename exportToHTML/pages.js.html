<html>
<head>
<title>pages.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
.s5 { color: #0037a6;}
.s6 { color: #264eff;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pages.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;exportPagesPage&quot;</span><span class="s1">, {</span>
    <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
    <span class="s1">get: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">exportPagesPage;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_renderresult = </span><span class="s3">/*#__PURE__*/ </span><span class="s1">_interop_require_default(require(</span><span class="s0">&quot;../../server/render-result&quot;</span><span class="s1">));</span>
<span class="s2">const </span><span class="s1">_path = require(</span><span class="s0">&quot;path&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_ampmode = require(</span><span class="s0">&quot;../../shared/lib/amp-mode&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_constants = require(</span><span class="s0">&quot;../../lib/constants&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_bailouttocsr = require(</span><span class="s0">&quot;../../shared/lib/lazy-dynamic/bailout-to-csr&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_fileexists = require(</span><span class="s0">&quot;../../lib/file-exists&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_modulerender = require(</span><span class="s0">&quot;../../server/route-modules/pages/module.render&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_getamphtmlvalidator = require(</span><span class="s0">&quot;../helpers/get-amp-html-validator&quot;</span><span class="s1">);</span>
<span class="s2">function </span><span class="s1">_interop_require_default(obj) {</span>
    <span class="s2">return </span><span class="s1">obj &amp;&amp; obj.__esModule ? obj : {</span>
        <span class="s2">default</span><span class="s1">: obj</span>
    <span class="s1">};</span>
<span class="s1">}</span>
<span class="s1">async </span><span class="s2">function </span><span class="s1">exportPagesPage(req, res, path, page, query, params, htmlFilepath, htmlFilename, ampPath, subFolders, outDir, ampValidatorPath, pagesDataDir, buildExport, isDynamic, sharedContext, renderContext, hasOrigQueryValues, renderOpts, components, fileWriter) {</span>
    <span class="s2">var </span><span class="s1">_components_pageConfig, _components_pageConfig1;</span>
    <span class="s2">const </span><span class="s1">ampState = {</span>
        <span class="s1">ampFirst: ((_components_pageConfig = components.pageConfig) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _components_pageConfig.amp) === </span><span class="s2">true</span><span class="s1">,</span>
        <span class="s1">hasQuery: Boolean(query.amp),</span>
        <span class="s1">hybrid: ((_components_pageConfig1 = components.pageConfig) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: _components_pageConfig1.amp) === </span><span class="s0">'hybrid'</span>
    <span class="s1">};</span>
    <span class="s2">if </span><span class="s1">(!ampValidatorPath) {</span>
        <span class="s1">ampValidatorPath = (</span><span class="s4">0</span><span class="s1">, _getamphtmlvalidator.getBundledAmpValidatorFilepath)();</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">inAmpMode = (</span><span class="s4">0</span><span class="s1">, _ampmode.isInAmpMode)(ampState);</span>
    <span class="s2">const </span><span class="s1">hybridAmp = ampState.hybrid;</span>
    <span class="s2">if </span><span class="s1">(components.getServerSideProps) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">Error(</span><span class="s0">`Error for page </span><span class="s1">${page}</span><span class="s0">: </span><span class="s1">${_constants.SERVER_PROPS_EXPORT_ERROR}</span><span class="s0">`</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E15&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s3">// for non-dynamic SSG pages we should have already</span>
    <span class="s3">// prerendered the file</span>
    <span class="s2">if </span><span class="s1">(!buildExport &amp;&amp; components.getStaticProps &amp;&amp; !isDynamic) {</span>
        <span class="s2">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">// Pages router merges page params (e.g. [lang]) with query params</span>
    <span class="s3">// primarily to support them both being accessible on `useRouter().query`.</span>
    <span class="s3">// If we extracted dynamic params from the path, we need to merge them</span>
    <span class="s3">// back into the query object.</span>
    <span class="s2">const </span><span class="s1">searchAndDynamicParams = {</span>
        <span class="s1">...query,</span>
        <span class="s1">...params</span>
    <span class="s1">};</span>
    <span class="s2">if </span><span class="s1">(components.getStaticProps &amp;&amp; !htmlFilepath.endsWith(</span><span class="s0">'.html'</span><span class="s1">)) {</span>
        <span class="s3">// make sure it ends with .html if the name contains a dot</span>
        <span class="s1">htmlFilepath += </span><span class="s0">'.html'</span><span class="s1">;</span>
        <span class="s1">htmlFilename += </span><span class="s0">'.html'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">let </span><span class="s1">renderResult;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">components.Component === </span><span class="s0">'string'</span><span class="s1">) {</span>
        <span class="s1">renderResult = _renderresult.default.fromStatic(components.Component, _constants.HTML_CONTENT_TYPE_HEADER);</span>
        <span class="s2">if </span><span class="s1">(hasOrigQueryValues) {</span>
            <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">Error(</span><span class="s0">`</span><span class="s5">\n</span><span class="s0">Error: you provided query values for </span><span class="s1">${path} </span><span class="s0">which is an auto-exported page. These can not be applied since the page can no longer be re-rendered on the server. To disable auto-export for this page add </span><span class="s5">\`</span><span class="s0">getInitialProps</span><span class="s5">\`\n</span><span class="s0">`</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
                <span class="s1">value: </span><span class="s0">&quot;E505&quot;</span><span class="s1">,</span>
                <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
                <span class="s1">configurable: </span><span class="s2">true</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s3">/**</span>
     <span class="s3">* This sets environment variable to be used at the time of SSR by head.tsx.</span>
     <span class="s3">* Using this from process.env allows targeting SSR by calling</span>
     <span class="s3">* `process.env.__NEXT_OPTIMIZE_CSS`.</span>
     <span class="s3">*/ </span><span class="s2">if </span><span class="s1">(renderOpts.optimizeCss) {</span>
            <span class="s1">process.env.__NEXT_OPTIMIZE_CSS = JSON.stringify(</span><span class="s2">true</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">try </span><span class="s1">{</span>
            <span class="s1">renderResult = </span><span class="s2">await </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, _modulerender.lazyRenderPagesPage)(req, res, page, searchAndDynamicParams, renderOpts, sharedContext, renderContext);</span>
        <span class="s1">} </span><span class="s2">catch </span><span class="s1">(err) {</span>
            <span class="s2">if </span><span class="s1">(!(</span><span class="s4">0</span><span class="s1">, _bailouttocsr.isBailoutToCSRError)(err)) </span><span class="s2">throw </span><span class="s1">err;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">ssgNotFound = renderResult == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: renderResult.metadata.isNotFound;</span>
    <span class="s2">const </span><span class="s1">ampValidations = [];</span>
    <span class="s2">const </span><span class="s1">validateAmp = async (rawAmpHtml, ampPageName, validatorPath)=&gt;{</span>
        <span class="s2">const </span><span class="s1">validator = </span><span class="s2">await </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, _getamphtmlvalidator.getAmpValidatorInstance)(validatorPath);</span>
        <span class="s2">const </span><span class="s1">result = validator.validateString(rawAmpHtml);</span>
        <span class="s2">const </span><span class="s1">errors = result.errors.filter((error)=&gt;{</span>
            <span class="s2">if </span><span class="s1">(error.severity === </span><span class="s0">'ERROR'</span><span class="s1">) {</span>
                <span class="s3">// Unclear yet if these actually prevent the page from being indexed by the AMP cache.</span>
                <span class="s3">// These are coming from React so all we can do is ignore them for now.</span>
                <span class="s3">// &lt;link rel=&quot;expect&quot; blocking=&quot;render&quot; /&gt;</span>
                <span class="s3">// https://github.com/ampproject/amphtml/issues/40279</span>
                <span class="s2">if </span><span class="s1">(error.code === </span><span class="s0">'DISALLOWED_ATTR' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'blocking' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">1</span><span class="s1">] === </span><span class="s0">'link'</span><span class="s1">) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">// &lt;template&gt; without type</span>
                <span class="s3">// https://github.com/ampproject/amphtml/issues/40280</span>
                <span class="s2">if </span><span class="s1">(error.code === </span><span class="s0">'MANDATORY_ATTR_MISSING' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'type' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">1</span><span class="s1">] === </span><span class="s0">'template'</span><span class="s1">) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s3">// &lt;template&gt; without type</span>
                <span class="s3">// https://github.com/ampproject/amphtml/issues/40280</span>
                <span class="s2">if </span><span class="s1">(error.code === </span><span class="s0">'MISSING_REQUIRED_EXTENSION' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">0</span><span class="s1">] === </span><span class="s0">'template' </span><span class="s1">&amp;&amp; error.params[</span><span class="s4">1</span><span class="s1">] === </span><span class="s0">'amp-mustache'</span><span class="s1">) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">return true</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">return false</span><span class="s1">;</span>
        <span class="s1">});</span>
        <span class="s2">const </span><span class="s1">warnings = result.errors.filter((e)=&gt;e.severity !== </span><span class="s0">'ERROR'</span><span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(warnings.length || errors.length) {</span>
            <span class="s1">ampValidations.push({</span>
                <span class="s1">page: ampPageName,</span>
                <span class="s1">result: {</span>
                    <span class="s1">errors,</span>
                    <span class="s1">warnings</span>
                <span class="s1">}</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
    <span class="s1">};</span>
    <span class="s2">const </span><span class="s1">html = renderResult &amp;&amp; !renderResult.isNull ? renderResult.toUnchunkedString() : </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s2">let </span><span class="s1">ampRenderResult;</span>
    <span class="s2">if </span><span class="s1">(inAmpMode &amp;&amp; !renderOpts.ampSkipValidation) {</span>
        <span class="s2">if </span><span class="s1">(!ssgNotFound) {</span>
            <span class="s2">await </span><span class="s1">validateAmp(html, path, ampValidatorPath);</span>
        <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(hybridAmp) {</span>
        <span class="s2">const </span><span class="s1">ampHtmlFilename = subFolders ? (</span><span class="s4">0</span><span class="s1">, _path.join)(ampPath, </span><span class="s0">'index.html'</span><span class="s1">) : </span><span class="s0">`</span><span class="s1">${ampPath}</span><span class="s0">.html`</span><span class="s1">;</span>
        <span class="s2">const </span><span class="s1">ampHtmlFilepath = (</span><span class="s4">0</span><span class="s1">, _path.join)(outDir, ampHtmlFilename);</span>
        <span class="s2">const </span><span class="s1">exists = </span><span class="s2">await </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, _fileexists.fileExists)(ampHtmlFilepath, _fileexists.FileType.File);</span>
        <span class="s2">if </span><span class="s1">(!exists) {</span>
            <span class="s2">try </span><span class="s1">{</span>
                <span class="s1">ampRenderResult = </span><span class="s2">await </span><span class="s1">(</span><span class="s4">0</span><span class="s1">, _modulerender.lazyRenderPagesPage)(req, res, page, {</span>
                    <span class="s1">...searchAndDynamicParams,</span>
                    <span class="s1">amp: </span><span class="s0">'1'</span>
                <span class="s1">}, renderOpts, sharedContext, renderContext);</span>
            <span class="s1">} </span><span class="s2">catch </span><span class="s1">(err) {</span>
                <span class="s2">if </span><span class="s1">(!(</span><span class="s4">0</span><span class="s1">, _bailouttocsr.isBailoutToCSRError)(err)) </span><span class="s2">throw </span><span class="s1">err;</span>
            <span class="s1">}</span>
            <span class="s2">const </span><span class="s1">ampHtml = ampRenderResult &amp;&amp; !ampRenderResult.isNull ? ampRenderResult.toUnchunkedString() : </span><span class="s0">''</span><span class="s1">;</span>
            <span class="s2">if </span><span class="s1">(!renderOpts.ampSkipValidation) {</span>
                <span class="s2">await </span><span class="s1">validateAmp(ampHtml, page + </span><span class="s0">'?amp=1'</span><span class="s1">, ampValidatorPath);</span>
            <span class="s1">}</span>
            <span class="s1">fileWriter.append(ampHtmlFilepath, ampHtml);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">metadata = (renderResult == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: renderResult.metadata) || (ampRenderResult == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s4">0 </span><span class="s1">: ampRenderResult.metadata) || {};</span>
    <span class="s2">if </span><span class="s1">(metadata.pageData) {</span>
        <span class="s2">const </span><span class="s1">dataFile = (</span><span class="s4">0</span><span class="s1">, _path.join)(pagesDataDir, htmlFilename.replace(</span><span class="s6">/\.html$/</span><span class="s1">, _constants.NEXT_DATA_SUFFIX));</span>
        <span class="s1">fileWriter.append(dataFile, JSON.stringify(metadata.pageData));</span>
        <span class="s2">if </span><span class="s1">(hybridAmp) {</span>
            <span class="s1">fileWriter.append(dataFile.replace(</span><span class="s6">/\.json$/</span><span class="s1">, </span><span class="s0">'.amp.json'</span><span class="s1">), JSON.stringify(metadata.pageData));</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(!ssgNotFound) {</span>
        <span class="s3">// don't attempt writing to disk if getStaticProps returned not found</span>
        <span class="s1">fileWriter.append(htmlFilepath, html);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">{</span>
        <span class="s1">ampValidations,</span>
        <span class="s1">cacheControl: metadata.cacheControl ?? {</span>
            <span class="s1">revalidate: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">expire: undefined</span>
        <span class="s1">},</span>
        <span class="s1">ssgNotFound</span>
    <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">//# sourceMappingURL=pages.js.map</span></pre>
</body>
</html>