<html>
<head>
<title>ast_grep.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #0037a6;}
.s6 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ast_grep.js</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">{ parseFiles } from </span><span class="s2">&quot;@ast-grep/napi&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">MagicString from </span><span class="s2">&quot;magic-string&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ chalk, fs, path } from </span><span class="s2">&quot;zx&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ errors } from </span><span class="s2">&quot;./errors.js&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ root } from </span><span class="s2">&quot;./utils.js&quot;</span><span class="s1">;</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@typedef </span><span class="s3">{import(&quot;@ast-grep/napi&quot;).SgNode} SgNode</span>
 <span class="s3">*/</span>

<span class="s0">export function </span><span class="s1">ast_grep() {</span>
    <span class="s0">const </span><span class="s1">task_queue = [];</span>

    <span class="s0">const </span><span class="s1">task = parseFiles([root(</span><span class="s2">&quot;esm&quot;</span><span class="s1">)], (err, tree) =&gt; {</span>
        <span class="s0">const </span><span class="s1">filename = path.basename(tree.filename(), </span><span class="s2">&quot;.js&quot;</span><span class="s1">);</span>
        <span class="s0">if </span><span class="s1">(filename === </span><span class="s2">&quot;index&quot;</span><span class="s1">) {</span>
            <span class="s0">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s0">const </span><span class="s1">source = </span><span class="s0">new </span><span class="s1">MagicString(tree.root().text());</span>
        <span class="s1">source.prepend(</span><span class="s2">`&quot;use strict&quot;;</span><span class="s5">\n\n</span><span class="s2">`</span><span class="s1">);</span>

        <span class="s0">if </span><span class="s1">(filename.startsWith(</span><span class="s2">&quot;_ts&quot;</span><span class="s1">)) {</span>
            <span class="s0">const </span><span class="s1">match = tree.root().find(</span><span class="s2">`export { $NAME as _ } from &quot;tslib&quot;`</span><span class="s1">);</span>
            <span class="s0">if </span><span class="s1">(match) {</span>
                <span class="s0">const </span><span class="s1">name = match.getMatch(</span><span class="s2">&quot;NAME&quot;</span><span class="s1">).text();</span>

                <span class="s0">const </span><span class="s1">range = match.range();</span>

                <span class="s1">source.update(</span>
                    <span class="s1">range.start.index,</span>
                    <span class="s1">range.end.index,</span>
                    <span class="s2">`exports._ = require(&quot;tslib&quot;).</span><span class="s1">${name}</span><span class="s2">;`</span><span class="s1">,</span>
                <span class="s1">);</span>
                <span class="s1">task_queue.push(</span>
                    <span class="s1">fs.writeFile(root(</span><span class="s2">&quot;cjs&quot;</span><span class="s1">, </span><span class="s2">`</span><span class="s1">${filename}</span><span class="s2">.cjs`</span><span class="s1">), source.toString(), {</span>
                        <span class="s1">encoding: </span><span class="s2">&quot;utf-8&quot;</span><span class="s1">,</span>
                    <span class="s1">}),</span>
                <span class="s1">);</span>
            <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s1">report_noexport(tree.filename());</span>
            <span class="s1">}</span>
            <span class="s0">return</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s3">// rewrite export named function</span>
        <span class="s0">const </span><span class="s1">match = tree.root().find({</span>
            <span class="s1">rule: {</span>
                <span class="s1">kind: </span><span class="s2">&quot;export_statement&quot;</span><span class="s1">,</span>
                <span class="s1">pattern: </span><span class="s2">&quot;export { $FUNC as _ }&quot;</span><span class="s1">,</span>
            <span class="s1">},</span>
        <span class="s1">});</span>

        <span class="s0">if </span><span class="s1">(match) {</span>
            <span class="s0">const </span><span class="s1">func = match.getMatch(</span><span class="s2">&quot;FUNC&quot;</span><span class="s1">);</span>
            <span class="s0">const </span><span class="s1">func_name = func.text();</span>
            <span class="s0">if </span><span class="s1">(func_name !== filename) {</span>
                <span class="s1">report_export_mismatch(tree.filename(), match);</span>
            <span class="s1">}</span>

            <span class="s0">const </span><span class="s1">range = match.range();</span>
            <span class="s1">source.update(</span>
                <span class="s1">range.start.index,</span>
                <span class="s1">range.end.index,</span>
                <span class="s2">`exports._ = </span><span class="s1">${func_name}</span><span class="s2">;`</span><span class="s1">,</span>
            <span class="s1">);</span>

            <span class="s3">// since we match the { export x as _ } pattern,</span>
            <span class="s3">// we need to find the assignment expression from the root</span>
            <span class="s1">tree</span>
                <span class="s1">.root()</span>
                <span class="s1">.findAll({</span>
                    <span class="s1">rule: {</span>
                        <span class="s1">pattern: func_name,</span>
                        <span class="s1">kind: </span><span class="s2">&quot;identifier&quot;</span><span class="s1">,</span>
                        <span class="s1">inside: { kind: </span><span class="s2">&quot;assignment_expression&quot;</span><span class="s1">, field: </span><span class="s2">&quot;left&quot; </span><span class="s1">},</span>
                    <span class="s1">},</span>
                <span class="s1">})</span>
                <span class="s1">.forEach((match) =&gt; {</span>
                    <span class="s0">const </span><span class="s1">range = match.range();</span>

                    <span class="s1">source.prependLeft(range.start.index, </span><span class="s2">`exports._ = `</span><span class="s1">);</span>
                <span class="s1">});</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s1">report_noexport(tree.filename(tree.filename()));</span>
        <span class="s1">}</span>

        <span class="s3">// rewrite import</span>
        <span class="s1">tree</span>
            <span class="s1">.root()</span>
            <span class="s1">.findAll({ rule: { pattern: </span><span class="s2">`import { _ as $BINDING } from &quot;$SOURCE&quot;` </span><span class="s1">} })</span>
            <span class="s1">.forEach((match) =&gt; {</span>
                <span class="s0">const </span><span class="s1">import_binding = match.getMatch(</span><span class="s2">&quot;BINDING&quot;</span><span class="s1">).text();</span>
                <span class="s0">const </span><span class="s1">import_source = match.getMatch(</span><span class="s2">&quot;SOURCE&quot;</span><span class="s1">).text();</span>

                <span class="s0">const </span><span class="s1">import_basename = path.basename(import_source, </span><span class="s2">&quot;.js&quot;</span><span class="s1">);</span>

                <span class="s0">if </span><span class="s1">(import_binding !== import_basename) {</span>
                    <span class="s1">report_import_mismatch(tree.filename(), match);</span>
                <span class="s1">}</span>

                <span class="s0">const </span><span class="s1">range = match.range();</span>

                <span class="s1">source.update(</span>
                    <span class="s1">range.start.index,</span>
                    <span class="s1">range.end.index,</span>
                    <span class="s2">`var </span><span class="s1">${import_binding} </span><span class="s2">= require(&quot;./</span><span class="s1">${import_binding}</span><span class="s2">.cjs&quot;);`</span><span class="s1">,</span>
                <span class="s1">);</span>

                <span class="s1">tree</span>
                    <span class="s1">.root()</span>
                    <span class="s1">.findAll({</span>
                        <span class="s1">rule: {</span>
                            <span class="s1">pattern: import_binding,</span>
                            <span class="s1">kind: </span><span class="s2">&quot;identifier&quot;</span><span class="s1">,</span>
                            <span class="s1">inside: {</span>
                                <span class="s1">not: {</span>
                                    <span class="s1">kind: </span><span class="s2">&quot;import_specifier&quot;</span><span class="s1">,</span>
                                <span class="s1">},</span>
                            <span class="s1">},</span>
                        <span class="s1">},</span>
                    <span class="s1">})</span>
                    <span class="s1">.forEach((match) =&gt; {</span>
                        <span class="s0">const </span><span class="s1">range = match.range();</span>
                        <span class="s0">const </span><span class="s1">ref_name = match.text();</span>

                        <span class="s1">source.update(</span>
                            <span class="s1">range.start.index,</span>
                            <span class="s1">range.end.index,</span>
                            <span class="s2">`</span><span class="s1">${ref_name}</span><span class="s2">._`</span><span class="s1">,</span>
                        <span class="s1">);</span>
                    <span class="s1">});</span>
            <span class="s1">});</span>

        <span class="s1">task_queue.push(</span>
            <span class="s1">fs.writeFile(root(</span><span class="s2">&quot;cjs&quot;</span><span class="s1">, </span><span class="s2">`</span><span class="s1">${filename}</span><span class="s2">.cjs`</span><span class="s1">), source.toString(), {</span>
                <span class="s1">encoding: </span><span class="s2">&quot;utf-8&quot;</span><span class="s1">,</span>
            <span class="s1">}),</span>
        <span class="s1">);</span>
    <span class="s1">});</span>

    <span class="s1">task_queue.push(task);</span>

    <span class="s0">return </span><span class="s1">task_queue;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@param </span><span class="s3">{string} filename</span>
 <span class="s3">* </span><span class="s4">@param </span><span class="s3">{SgNode} match</span>
 <span class="s3">*/</span>
<span class="s0">function </span><span class="s1">report_export_mismatch(filename, match) {</span>
    <span class="s0">const </span><span class="s1">func = match.getMatch(</span><span class="s2">&quot;FUNC&quot;</span><span class="s1">);</span>
    <span class="s0">const </span><span class="s1">func_range = func.range();</span>

    <span class="s0">const </span><span class="s1">text = match.text().split(</span><span class="s2">&quot;</span><span class="s5">\n</span><span class="s2">&quot;</span><span class="s1">);</span>
    <span class="s0">const </span><span class="s1">offset = func_range.start.line - match.range().start.line;</span>

    <span class="s1">text.splice(</span>
        <span class="s1">offset + </span><span class="s6">1</span><span class="s1">,</span>
        <span class="s1">text.length,</span>
        <span class="s1">chalk.red(</span>
            <span class="s1">[</span>
                <span class="s2">&quot; &quot;</span><span class="s1">.repeat(func_range.start.column),</span>
                <span class="s2">&quot;^&quot;</span><span class="s1">.repeat(func_range.end.column - func_range.start.column),</span>
            <span class="s1">]</span>
                <span class="s1">.join(</span><span class="s2">&quot;&quot;</span><span class="s1">),</span>
        <span class="s1">),</span>
    <span class="s1">);</span>

    <span class="s1">errors.push(</span>
        <span class="s1">[</span>
            <span class="s2">`</span><span class="s1">${chalk.bold.red(</span><span class="s2">&quot;error&quot;</span><span class="s1">)}</span><span class="s2">: mismatch exported function name.`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
            <span class="s2">`</span><span class="s1">${chalk.blue(</span><span class="s2">&quot;--&gt;&quot;</span><span class="s1">)} ${filename}</span><span class="s2">:</span><span class="s1">${func_range.start.line + </span><span class="s6">1</span><span class="s1">}</span><span class="s2">:</span><span class="s1">${func_range.start.column + </span><span class="s6">1</span><span class="s1">}</span><span class="s2">`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
            <span class="s1">...text,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
            <span class="s2">`</span><span class="s1">${</span>
                <span class="s1">chalk.bold(</span>
                    <span class="s2">&quot;note:&quot;</span><span class="s1">,</span>
                <span class="s1">)</span>
            <span class="s1">} </span><span class="s2">The exported name should be the same as the filename.`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
        <span class="s1">]</span>
            <span class="s1">.join(</span><span class="s2">&quot;</span><span class="s5">\n</span><span class="s2">&quot;</span><span class="s1">),</span>
    <span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@param </span><span class="s3">{string} filename</span>
 <span class="s3">* </span><span class="s4">@param </span><span class="s3">{SgNode} match</span>
 <span class="s3">*/</span>
<span class="s0">function </span><span class="s1">report_import_mismatch(filename, match) {</span>
    <span class="s0">const </span><span class="s1">binding_range = match.getMatch(</span><span class="s2">&quot;BINDING&quot;</span><span class="s1">).range();</span>
    <span class="s0">const </span><span class="s1">source_range = match.getMatch(</span><span class="s2">&quot;SOURCE&quot;</span><span class="s1">).range();</span>

    <span class="s1">errors.push(</span>
        <span class="s1">[</span>
            <span class="s2">`</span><span class="s1">${chalk.bold.red(</span><span class="s2">&quot;error&quot;</span><span class="s1">)}</span><span class="s2">: mismatch imported binding name.`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
            <span class="s2">`</span><span class="s1">${chalk.blue(</span><span class="s2">&quot;--&gt;&quot;</span><span class="s1">)} ${filename}</span><span class="s2">:</span><span class="s1">${match.range().start.line + </span><span class="s6">1</span><span class="s1">}</span><span class="s2">`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
            <span class="s1">match.text(),</span>
            <span class="s1">[</span>
                <span class="s2">&quot; &quot;</span><span class="s1">.repeat(binding_range.start.column),</span>
                <span class="s1">chalk.red(</span><span class="s2">&quot;^&quot;</span><span class="s1">.repeat(binding_range.end.column - binding_range.start.column)),</span>
                <span class="s2">&quot; &quot;</span><span class="s1">.repeat(source_range.start.column - binding_range.end.column),</span>
                <span class="s1">chalk.blue(</span><span class="s2">&quot;-&quot;</span><span class="s1">.repeat(source_range.end.column - source_range.start.column)),</span>
            <span class="s1">]</span>
                <span class="s1">.join(</span><span class="s2">&quot;&quot;</span><span class="s1">),</span>
            <span class="s2">`</span><span class="s1">${</span>
                <span class="s1">chalk.bold(</span>
                    <span class="s2">&quot;note:&quot;</span><span class="s1">,</span>
                <span class="s1">)</span>
            <span class="s1">} </span><span class="s2">The imported binding name should be the same as the import source basename.`</span><span class="s1">,</span>
            <span class="s2">&quot;&quot;</span><span class="s1">,</span>
        <span class="s1">]</span>
            <span class="s1">.join(</span><span class="s2">&quot;</span><span class="s5">\n</span><span class="s2">&quot;</span><span class="s1">),</span>
    <span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* </span><span class="s4">@param </span><span class="s3">{string} filename</span>
 <span class="s3">*/</span>
<span class="s0">function </span><span class="s1">report_noexport(filename) {</span>
    <span class="s1">errors.push(</span>
        <span class="s1">[</span><span class="s2">`</span><span class="s1">${chalk.bold.red(</span><span class="s2">&quot;error&quot;</span><span class="s1">)}</span><span class="s2">: exported name not found`</span><span class="s1">, </span><span class="s2">`</span><span class="s1">${chalk.blue(</span><span class="s2">&quot;--&gt;&quot;</span><span class="s1">)} ${filename}</span><span class="s2">`</span><span class="s1">].join(</span><span class="s2">&quot;</span><span class="s5">\n</span><span class="s2">&quot;</span><span class="s1">),</span>
    <span class="s1">);</span>
<span class="s1">}</span>
</pre>
</body>
</html>