<html>
<head>
<title>trace.test.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
trace.test.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_promises = require(</span><span class="s0">&quot;fs/promises&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_path = require(</span><span class="s0">&quot;path&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_os = require(</span><span class="s0">&quot;os&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_shared = require(</span><span class="s0">&quot;./shared&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_trace = require(</span><span class="s0">&quot;./trace&quot;</span><span class="s1">);</span>
<span class="s1">describe(</span><span class="s0">'Trace'</span><span class="s1">, ()=&gt;{</span>
    <span class="s1">beforeEach(()=&gt;{</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.initializeTraceState)({</span>
            <span class="s1">lastId: </span><span class="s3">0</span><span class="s1">,</span>
            <span class="s1">shouldSaveTraceEvents: </span><span class="s2">true</span>
        <span class="s1">});</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.clearTraceEvents)();</span>
    <span class="s1">});</span>
    <span class="s1">describe(</span><span class="s0">'Tracer'</span><span class="s1">, ()=&gt;{</span>
        <span class="s1">it(</span><span class="s0">'traces a block of code'</span><span class="s1">, async ()=&gt;{</span>
            <span class="s2">const </span><span class="s1">tmpDir = </span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _promises.mkdtemp)((</span><span class="s3">0</span><span class="s1">, _path.join)((</span><span class="s3">0</span><span class="s1">, _os.tmpdir)(), </span><span class="s0">'json-reporter'</span><span class="s1">));</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _shared.setGlobal)(</span><span class="s0">'distDir'</span><span class="s1">, tmpDir);</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _shared.setGlobal)(</span><span class="s0">'phase'</span><span class="s1">, </span><span class="s0">'anything'</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">root = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'root-span'</span><span class="s1">, undefined, {</span>
                <span class="s0">'some-tag'</span><span class="s1">: </span><span class="s0">'some-value'</span>
            <span class="s1">});</span>
            <span class="s1">root.traceChild(</span><span class="s0">'child-span'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s2">await </span><span class="s1">root.traceChild(</span><span class="s0">'async-child-span'</span><span class="s1">).traceAsyncFn(async ()=&gt;{</span>
                <span class="s2">const </span><span class="s1">delayedPromise = </span><span class="s2">new </span><span class="s1">Promise((resolve)=&gt;{</span>
                    <span class="s1">setTimeout(resolve, </span><span class="s3">100</span><span class="s1">);</span>
                <span class="s1">});</span>
                <span class="s2">await </span><span class="s1">delayedPromise;</span>
            <span class="s1">});</span>
            <span class="s1">root.stop();</span>
            <span class="s2">const </span><span class="s1">traceEvents = (</span><span class="s3">0</span><span class="s1">, _trace.getTraceEvents)();</span>
            <span class="s1">expect(traceEvents.length).toEqual(</span><span class="s3">3</span><span class="s1">);</span>
            <span class="s1">expect(traceEvents[</span><span class="s3">0</span><span class="s1">].name).toEqual(</span><span class="s0">'child-span'</span><span class="s1">);</span>
            <span class="s1">expect(traceEvents[</span><span class="s3">1</span><span class="s1">].name).toEqual(</span><span class="s0">'async-child-span'</span><span class="s1">);</span>
            <span class="s1">expect(traceEvents[</span><span class="s3">2</span><span class="s1">].name).toEqual(</span><span class="s0">'root-span'</span><span class="s1">);</span>
            <span class="s4">// Check that the serialized .next/trace file looks correct.</span>
            <span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.flushAllTraces)();</span>
            <span class="s2">const </span><span class="s1">traceFilename = (</span><span class="s3">0</span><span class="s1">, _path.join)(tmpDir, </span><span class="s0">'trace'</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">serializedTraces = JSON.parse(</span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _promises.readFile)(traceFilename, </span><span class="s0">'utf-8'</span><span class="s1">));</span>
            <span class="s1">expect(serializedTraces).toMatchObject([</span>
                <span class="s1">{</span>
                    <span class="s1">id: </span><span class="s3">2</span><span class="s1">,</span>
                    <span class="s1">name: </span><span class="s0">'child-span'</span><span class="s1">,</span>
                    <span class="s1">parentId: </span><span class="s3">1</span><span class="s1">,</span>
                    <span class="s1">startTime: expect.any(Number),</span>
                    <span class="s1">timestamp: expect.any(Number),</span>
                    <span class="s1">duration: expect.any(Number),</span>
                    <span class="s1">tags: {}</span>
                <span class="s1">},</span>
                <span class="s1">{</span>
                    <span class="s1">id: </span><span class="s3">3</span><span class="s1">,</span>
                    <span class="s1">name: </span><span class="s0">'async-child-span'</span><span class="s1">,</span>
                    <span class="s1">parentId: </span><span class="s3">1</span><span class="s1">,</span>
                    <span class="s1">startTime: expect.any(Number),</span>
                    <span class="s1">timestamp: expect.any(Number),</span>
                    <span class="s1">duration: expect.any(Number),</span>
                    <span class="s1">tags: {}</span>
                <span class="s1">},</span>
                <span class="s1">{</span>
                    <span class="s1">id: </span><span class="s3">1</span><span class="s1">,</span>
                    <span class="s1">name: </span><span class="s0">'root-span'</span><span class="s1">,</span>
                    <span class="s1">startTime: expect.any(Number),</span>
                    <span class="s1">timestamp: expect.any(Number),</span>
                    <span class="s1">duration: expect.any(Number),</span>
                    <span class="s1">tags: {</span>
                        <span class="s0">'some-tag'</span><span class="s1">: </span><span class="s0">'some-value'</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">]);</span>
        <span class="s1">});</span>
    <span class="s1">});</span>
    <span class="s1">describe(</span><span class="s0">'Worker'</span><span class="s1">, ()=&gt;{</span>
        <span class="s1">it(</span><span class="s0">'exports and initializes trace state'</span><span class="s1">, ()=&gt;{</span>
            <span class="s2">const </span><span class="s1">root = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'root-span'</span><span class="s1">);</span>
            <span class="s1">expect(root.getId()).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">traceState = (</span><span class="s3">0</span><span class="s1">, _trace.exportTraceState)();</span>
            <span class="s1">expect(traceState.lastId).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.initializeTraceState)({</span>
                <span class="s1">lastId: </span><span class="s3">101</span>
            <span class="s1">});</span>
            <span class="s2">const </span><span class="s1">span = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'another-span'</span><span class="s1">);</span>
            <span class="s1">expect(span.getId()).toEqual(</span><span class="s3">102</span><span class="s1">);</span>
        <span class="s1">});</span>
        <span class="s1">it(</span><span class="s0">'trace data is serializable to a worker'</span><span class="s1">, async ()=&gt;{</span>
            <span class="s2">const </span><span class="s1">root = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'root-span'</span><span class="s1">);</span>
            <span class="s1">root.traceChild(</span><span class="s0">'child-span'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s1">root.stop();</span>
            <span class="s2">const </span><span class="s1">traceEvents = (</span><span class="s3">0</span><span class="s1">, _trace.getTraceEvents)();</span>
            <span class="s1">expect(traceEvents.length).toEqual(</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s4">// This is a proxy check to make sure the object would be serializable</span>
            <span class="s4">// to a worker. It will fail if the data contains some unserializable</span>
            <span class="s4">// objects like BigInt.</span>
            <span class="s2">const </span><span class="s1">clone = JSON.parse(JSON.stringify(traceEvents));</span>
            <span class="s1">expect(clone).toEqual(traceEvents);</span>
        <span class="s1">});</span>
        <span class="s1">it(</span><span class="s0">'correctly reports trace data from multiple workers'</span><span class="s1">, ()=&gt;{</span>
            <span class="s4">// This test simulates workers creating traces and propagating them</span>
            <span class="s4">// back to the main process for recording. It doesn't use</span>
            <span class="s4">// actual workers since they are more difficult to set up in tests.</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.initializeTraceState)({</span>
                <span class="s1">lastId: </span><span class="s3">5</span><span class="s1">,</span>
                <span class="s1">defaultParentSpanId: </span><span class="s3">1</span><span class="s1">,</span>
                <span class="s1">shouldSaveTraceEvents: </span><span class="s2">true</span>
            <span class="s1">});</span>
            <span class="s2">const </span><span class="s1">worker1Span = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'worker1'</span><span class="s1">);</span>
            <span class="s1">worker1Span.traceChild(</span><span class="s0">'webpack-compilation1'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s1">worker1Span.stop();</span>
            <span class="s2">const </span><span class="s1">worker1Traces = (</span><span class="s3">0</span><span class="s1">, _trace.getTraceEvents)();</span>
            <span class="s1">expect(worker1Traces.length).toEqual(</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s4">// Repeat for a second worker.</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.clearTraceEvents)();</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.initializeTraceState)({</span>
                <span class="s1">lastId: </span><span class="s3">10</span><span class="s1">,</span>
                <span class="s1">defaultParentSpanId: </span><span class="s3">1</span><span class="s1">,</span>
                <span class="s1">shouldSaveTraceEvents: </span><span class="s2">true</span>
            <span class="s1">});</span>
            <span class="s2">const </span><span class="s1">worker2Span = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'worker2'</span><span class="s1">);</span>
            <span class="s1">worker2Span.traceChild(</span><span class="s0">'webpack-compilation2'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s1">worker2Span.stop();</span>
            <span class="s2">const </span><span class="s1">worker2Traces = (</span><span class="s3">0</span><span class="s1">, _trace.getTraceEvents)();</span>
            <span class="s1">expect(worker2Traces.length).toEqual(</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s4">// Now simulate the traces in the main process and record the traces</span>
            <span class="s4">// from each worker.</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.clearTraceEvents)();</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.initializeTraceState)({</span>
                <span class="s1">lastId: </span><span class="s3">0</span><span class="s1">,</span>
                <span class="s1">shouldSaveTraceEvents: </span><span class="s2">true</span>
            <span class="s1">});</span>
            <span class="s2">const </span><span class="s1">root = (</span><span class="s3">0</span><span class="s1">, _trace.trace)(</span><span class="s0">'next-build'</span><span class="s1">);</span>
            <span class="s1">root.traceChild(</span><span class="s0">'some-child-span'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.recordTraceEvents)(worker1Traces);</span>
            <span class="s1">expect((</span><span class="s3">0</span><span class="s1">, _trace.exportTraceState)().lastId).toEqual(</span><span class="s3">8</span><span class="s1">);</span>
            <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.recordTraceEvents)(worker2Traces);</span>
            <span class="s1">expect((</span><span class="s3">0</span><span class="s1">, _trace.exportTraceState)().lastId).toEqual(</span><span class="s3">13</span><span class="s1">);</span>
            <span class="s1">root.traceChild(</span><span class="s0">'another-child-span'</span><span class="s1">).traceFn(()=&gt;</span><span class="s2">null</span><span class="s1">);</span>
            <span class="s1">root.stop();</span>
            <span class="s4">// Check that the final output looks correct.</span>
            <span class="s2">const </span><span class="s1">allTraces = (</span><span class="s3">0</span><span class="s1">, _trace.getTraceEvents)();</span>
            <span class="s1">expect(allTraces.length).toEqual(</span><span class="s3">7</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">firstSpan = allTraces[</span><span class="s3">0</span><span class="s1">];</span>
            <span class="s1">expect(firstSpan.name).toEqual(</span><span class="s0">'some-child-span'</span><span class="s1">);</span>
            <span class="s1">expect(firstSpan.id).toEqual(</span><span class="s3">2</span><span class="s1">);</span>
            <span class="s1">expect(firstSpan.parentId).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">worker1Child = allTraces[</span><span class="s3">1</span><span class="s1">];</span>
            <span class="s1">expect(worker1Child.name).toEqual(</span><span class="s0">'webpack-compilation1'</span><span class="s1">);</span>
            <span class="s1">expect(worker1Child.id).toEqual(</span><span class="s3">7</span><span class="s1">);</span>
            <span class="s1">expect(worker1Child.parentId).toEqual(</span><span class="s3">6</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">worker1Root = allTraces[</span><span class="s3">2</span><span class="s1">];</span>
            <span class="s1">expect(worker1Root.name).toEqual(</span><span class="s0">'worker1'</span><span class="s1">);</span>
            <span class="s1">expect(worker1Root.id).toEqual(</span><span class="s3">6</span><span class="s1">);</span>
            <span class="s1">expect(worker1Root.parentId).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">worker2Child = allTraces[</span><span class="s3">3</span><span class="s1">];</span>
            <span class="s1">expect(worker2Child.name).toEqual(</span><span class="s0">'webpack-compilation2'</span><span class="s1">);</span>
            <span class="s1">expect(worker2Child.id).toEqual(</span><span class="s3">12</span><span class="s1">);</span>
            <span class="s1">expect(worker2Child.parentId).toEqual(</span><span class="s3">11</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">worker2Root = allTraces[</span><span class="s3">4</span><span class="s1">];</span>
            <span class="s1">expect(worker2Root.name).toEqual(</span><span class="s0">'worker2'</span><span class="s1">);</span>
            <span class="s1">expect(worker2Root.id).toEqual(</span><span class="s3">11</span><span class="s1">);</span>
            <span class="s1">expect(worker2Root.parentId).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">lastChildSpan = allTraces[</span><span class="s3">5</span><span class="s1">];</span>
            <span class="s1">expect(lastChildSpan.name).toEqual(</span><span class="s0">'another-child-span'</span><span class="s1">);</span>
            <span class="s1">expect(lastChildSpan.id).toEqual(</span><span class="s3">14</span><span class="s1">);</span>
            <span class="s1">expect(lastChildSpan.parentId).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s2">const </span><span class="s1">rootSpan = allTraces[</span><span class="s3">6</span><span class="s1">];</span>
            <span class="s1">expect(rootSpan.name).toEqual(</span><span class="s0">'next-build'</span><span class="s1">);</span>
            <span class="s1">expect(rootSpan.id).toEqual(</span><span class="s3">1</span><span class="s1">);</span>
            <span class="s1">expect(rootSpan.parentId).toBeUndefined();</span>
        <span class="s1">});</span>
    <span class="s1">});</span>
<span class="s1">});</span>

<span class="s4">//# sourceMappingURL=trace.test.js.map</span></pre>
</body>
</html>