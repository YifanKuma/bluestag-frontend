<html>
<head>
<title>refresh-reducer.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
refresh-reducer.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../../../src/client/components/router-reducer/reducers/refresh-reducer.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import { fetchServerResponse } from '../fetch-server-response'</span><span class="s3">\n</span><span class="s1">import { createHrefFromUrl } from '../create-href-from-url'</span><span class="s3">\n</span><span class="s1">import { applyRouterStatePatchToTree } from '../apply-router-state-patch-to-tree'</span><span class="s3">\n</span><span class="s1">import { isNavigatingToNewRootLayout } from '../is-navigating-to-new-root-layout'</span><span class="s3">\n</span><span class="s1">import type {</span><span class="s3">\n  </span><span class="s1">Mutable,</span><span class="s3">\n  </span><span class="s1">ReadonlyReducerState,</span><span class="s3">\n  </span><span class="s1">ReducerState,</span><span class="s3">\n  </span><span class="s1">RefreshAction,</span><span class="s3">\n</span><span class="s1">} from '../router-reducer-types'</span><span class="s3">\n</span><span class="s1">import { handleExternalUrl } from './navigate-reducer'</span><span class="s3">\n</span><span class="s1">import { handleMutable } from '../handle-mutable'</span><span class="s3">\n</span><span class="s1">import type { CacheNode } from '../../../../shared/lib/app-router-context.shared-runtime'</span><span class="s3">\n</span><span class="s1">import { fillLazyItemsTillLeafWithHead } from '../fill-lazy-items-till-leaf-with-head'</span><span class="s3">\n</span><span class="s1">import { createEmptyCacheNode } from '../../app-router'</span><span class="s3">\n</span><span class="s1">import { handleSegmentMismatch } from '../handle-segment-mismatch'</span><span class="s3">\n</span><span class="s1">import { hasInterceptionRouteInCurrentTree } from './has-interception-route-in-current-tree'</span><span class="s3">\n</span><span class="s1">import { refreshInactiveParallelSegments } from '../refetch-inactive-parallel-segments'</span><span class="s3">\n</span><span class="s1">import { revalidateEntireCache } from '../../segment-cache'</span><span class="s3">\n\n</span><span class="s1">export function refreshReducer(</span><span class="s3">\n  </span><span class="s1">state: ReadonlyReducerState,</span><span class="s3">\n  </span><span class="s1">action: RefreshAction</span><span class="s3">\n</span><span class="s1">): ReducerState {</span><span class="s3">\n  </span><span class="s1">const { origin } = action</span><span class="s3">\n  </span><span class="s1">const mutable: Mutable = {}</span><span class="s3">\n  </span><span class="s1">const href = state.canonicalUrl</span><span class="s3">\n\n  </span><span class="s1">let currentTree = state.tree</span><span class="s3">\n\n  </span><span class="s1">mutable.preserveCustomHistoryState = false</span><span class="s3">\n\n  </span><span class="s1">const cache: CacheNode = createEmptyCacheNode()</span><span class="s3">\n\n  </span><span class="s1">// If the current tree was intercepted, the nextUrl should be included in the request.</span><span class="s3">\n  </span><span class="s1">// This is to ensure that the refresh request doesn't get intercepted, accidentally triggering the interception route.</span><span class="s3">\n  </span><span class="s1">const includeNextUrl = hasInterceptionRouteInCurrentTree(state.tree)</span><span class="s3">\n\n  </span><span class="s1">// TODO-APP: verify that `href` is not an external url.</span><span class="s3">\n  </span><span class="s1">// Fetch data from the root of the tree.</span><span class="s3">\n  </span><span class="s1">cache.lazyData = fetchServerResponse(new URL(href, origin), {</span><span class="s3">\n    </span><span class="s1">flightRouterState: [</span><span class="s3">\n      </span><span class="s1">currentTree[0],</span><span class="s3">\n      </span><span class="s1">currentTree[1],</span><span class="s3">\n      </span><span class="s1">currentTree[2],</span><span class="s3">\n      </span><span class="s1">'refetch',</span><span class="s3">\n    </span><span class="s1">],</span><span class="s3">\n    </span><span class="s1">nextUrl: includeNextUrl ? state.nextUrl : null,</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">const navigatedAt = Date.now()</span><span class="s3">\n  </span><span class="s1">return cache.lazyData.then(</span><span class="s3">\n    </span><span class="s1">async ({ flightData, canonicalUrl: canonicalUrlOverride }) =&gt; {</span><span class="s3">\n      </span><span class="s1">// Handle case when navigating to page in `pages` from `app`</span><span class="s3">\n      </span><span class="s1">if (typeof flightData === 'string') {</span><span class="s3">\n        </span><span class="s1">return handleExternalUrl(</span><span class="s3">\n          </span><span class="s1">state,</span><span class="s3">\n          </span><span class="s1">mutable,</span><span class="s3">\n          </span><span class="s1">flightData,</span><span class="s3">\n          </span><span class="s1">state.pushRef.pendingPush</span><span class="s3">\n        </span><span class="s1">)</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n\n      </span><span class="s1">// Remove cache.lazyData as it has been resolved at this point.</span><span class="s3">\n      </span><span class="s1">cache.lazyData = null</span><span class="s3">\n\n      </span><span class="s1">for (const normalizedFlightData of flightData) {</span><span class="s3">\n        </span><span class="s1">const {</span><span class="s3">\n          </span><span class="s1">tree: treePatch,</span><span class="s3">\n          </span><span class="s1">seedData: cacheNodeSeedData,</span><span class="s3">\n          </span><span class="s1">head,</span><span class="s3">\n          </span><span class="s1">isRootRender,</span><span class="s3">\n        </span><span class="s1">} = normalizedFlightData</span><span class="s3">\n\n        </span><span class="s1">if (!isRootRender) {</span><span class="s3">\n          </span><span class="s1">// TODO-APP: handle this case better</span><span class="s3">\n          </span><span class="s1">console.log('REFRESH FAILED')</span><span class="s3">\n          </span><span class="s1">return state</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">const newTree = applyRouterStatePatchToTree(</span><span class="s3">\n          </span><span class="s1">// TODO-APP: remove ''</span><span class="s3">\n          </span><span class="s1">[''],</span><span class="s3">\n          </span><span class="s1">currentTree,</span><span class="s3">\n          </span><span class="s1">treePatch,</span><span class="s3">\n          </span><span class="s1">state.canonicalUrl</span><span class="s3">\n        </span><span class="s1">)</span><span class="s3">\n\n        </span><span class="s1">if (newTree === null) {</span><span class="s3">\n          </span><span class="s1">return handleSegmentMismatch(state, action, treePatch)</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">if (isNavigatingToNewRootLayout(currentTree, newTree)) {</span><span class="s3">\n          </span><span class="s1">return handleExternalUrl(</span><span class="s3">\n            </span><span class="s1">state,</span><span class="s3">\n            </span><span class="s1">mutable,</span><span class="s3">\n            </span><span class="s1">href,</span><span class="s3">\n            </span><span class="s1">state.pushRef.pendingPush</span><span class="s3">\n          </span><span class="s1">)</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">const canonicalUrlOverrideHref = canonicalUrlOverride</span><span class="s3">\n          </span><span class="s1">? createHrefFromUrl(canonicalUrlOverride)</span><span class="s3">\n          </span><span class="s1">: undefined</span><span class="s3">\n\n        </span><span class="s1">if (canonicalUrlOverride) {</span><span class="s3">\n          </span><span class="s1">mutable.canonicalUrl = canonicalUrlOverrideHref</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">// Handles case where prefetch only returns the router tree patch without rendered components.</span><span class="s3">\n        </span><span class="s1">if (cacheNodeSeedData !== null) {</span><span class="s3">\n          </span><span class="s1">const rsc = cacheNodeSeedData[1]</span><span class="s3">\n          </span><span class="s1">const loading = cacheNodeSeedData[3]</span><span class="s3">\n          </span><span class="s1">cache.rsc = rsc</span><span class="s3">\n          </span><span class="s1">cache.prefetchRsc = null</span><span class="s3">\n          </span><span class="s1">cache.loading = loading</span><span class="s3">\n          </span><span class="s1">fillLazyItemsTillLeafWithHead(</span><span class="s3">\n            </span><span class="s1">navigatedAt,</span><span class="s3">\n            </span><span class="s1">cache,</span><span class="s3">\n            </span><span class="s1">// Existing cache is not passed in as `router.refresh()` has to invalidate the entire cache.</span><span class="s3">\n            </span><span class="s1">undefined,</span><span class="s3">\n            </span><span class="s1">treePatch,</span><span class="s3">\n            </span><span class="s1">cacheNodeSeedData,</span><span class="s3">\n            </span><span class="s1">head,</span><span class="s3">\n            </span><span class="s1">undefined</span><span class="s3">\n          </span><span class="s1">)</span><span class="s3">\n          </span><span class="s1">if (process.env.__NEXT_CLIENT_SEGMENT_CACHE) {</span><span class="s3">\n            </span><span class="s1">revalidateEntireCache(state.nextUrl, newTree)</span><span class="s3">\n          </span><span class="s1">} else {</span><span class="s3">\n            </span><span class="s1">mutable.prefetchCache = new Map()</span><span class="s3">\n          </span><span class="s1">}</span><span class="s3">\n        </span><span class="s1">}</span><span class="s3">\n\n        </span><span class="s1">await refreshInactiveParallelSegments({</span><span class="s3">\n          </span><span class="s1">navigatedAt,</span><span class="s3">\n          </span><span class="s1">state,</span><span class="s3">\n          </span><span class="s1">updatedTree: newTree,</span><span class="s3">\n          </span><span class="s1">updatedCache: cache,</span><span class="s3">\n          </span><span class="s1">includeNextUrl,</span><span class="s3">\n          </span><span class="s1">canonicalUrl: mutable.canonicalUrl || state.canonicalUrl,</span><span class="s3">\n        </span><span class="s1">})</span><span class="s3">\n\n        </span><span class="s1">mutable.cache = cache</span><span class="s3">\n        </span><span class="s1">mutable.patchedTree = newTree</span><span class="s3">\n\n        </span><span class="s1">currentTree = newTree</span><span class="s3">\n      </span><span class="s1">}</span><span class="s3">\n\n      </span><span class="s1">return handleMutable(state, mutable)</span><span class="s3">\n    </span><span class="s1">},</span><span class="s3">\n    </span><span class="s1">() =&gt; state</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;refreshReducer&quot;</span><span class="s0">,</span><span class="s1">&quot;state&quot;</span><span class="s0">,</span><span class="s1">&quot;action&quot;</span><span class="s0">,</span><span class="s1">&quot;origin&quot;</span><span class="s0">,</span><span class="s1">&quot;mutable&quot;</span><span class="s0">,</span><span class="s1">&quot;href&quot;</span><span class="s0">,</span><span class="s1">&quot;canonicalUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;currentTree&quot;</span><span class="s0">,</span><span class="s1">&quot;tree&quot;</span><span class="s0">,</span><span class="s1">&quot;preserveCustomHistoryState&quot;</span><span class="s0">,</span><span class="s1">&quot;cache&quot;</span><span class="s0">,</span><span class="s1">&quot;createEmptyCacheNode&quot;</span><span class="s0">,</span><span class="s1">&quot;includeNextUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;hasInterceptionRouteInCurrentTree&quot;</span><span class="s0">,</span><span class="s1">&quot;lazyData&quot;</span><span class="s0">,</span><span class="s1">&quot;fetchServerResponse&quot;</span><span class="s0">,</span><span class="s1">&quot;URL&quot;</span><span class="s0">,</span><span class="s1">&quot;flightRouterState&quot;</span><span class="s0">,</span><span class="s1">&quot;nextUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;navigatedAt&quot;</span><span class="s0">,</span><span class="s1">&quot;Date&quot;</span><span class="s0">,</span><span class="s1">&quot;now&quot;</span><span class="s0">,</span><span class="s1">&quot;then&quot;</span><span class="s0">,</span><span class="s1">&quot;flightData&quot;</span><span class="s0">,</span><span class="s1">&quot;canonicalUrlOverride&quot;</span><span class="s0">,</span><span class="s1">&quot;handleExternalUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;pushRef&quot;</span><span class="s0">,</span><span class="s1">&quot;pendingPush&quot;</span><span class="s0">,</span><span class="s1">&quot;normalizedFlightData&quot;</span><span class="s0">,</span><span class="s1">&quot;treePatch&quot;</span><span class="s0">,</span><span class="s1">&quot;seedData&quot;</span><span class="s0">,</span><span class="s1">&quot;cacheNodeSeedData&quot;</span><span class="s0">,</span><span class="s1">&quot;head&quot;</span><span class="s0">,</span><span class="s1">&quot;isRootRender&quot;</span><span class="s0">,</span><span class="s1">&quot;console&quot;</span><span class="s0">,</span><span class="s1">&quot;log&quot;</span><span class="s0">,</span><span class="s1">&quot;newTree&quot;</span><span class="s0">,</span><span class="s1">&quot;applyRouterStatePatchToTree&quot;</span><span class="s0">,</span><span class="s1">&quot;handleSegmentMismatch&quot;</span><span class="s0">,</span><span class="s1">&quot;isNavigatingToNewRootLayout&quot;</span><span class="s0">,</span><span class="s1">&quot;canonicalUrlOverrideHref&quot;</span><span class="s0">,</span><span class="s1">&quot;createHrefFromUrl&quot;</span><span class="s0">,</span><span class="s1">&quot;undefined&quot;</span><span class="s0">,</span><span class="s1">&quot;rsc&quot;</span><span class="s0">,</span><span class="s1">&quot;loading&quot;</span><span class="s0">,</span><span class="s1">&quot;prefetchRsc&quot;</span><span class="s0">,</span><span class="s1">&quot;fillLazyItemsTillLeafWithHead&quot;</span><span class="s0">,</span><span class="s1">&quot;process&quot;</span><span class="s0">,</span><span class="s1">&quot;env&quot;</span><span class="s0">,</span><span class="s1">&quot;__NEXT_CLIENT_SEGMENT_CACHE&quot;</span><span class="s0">,</span><span class="s1">&quot;revalidateEntireCache&quot;</span><span class="s0">,</span><span class="s1">&quot;prefetchCache&quot;</span><span class="s0">,</span><span class="s1">&quot;Map&quot;</span><span class="s0">,</span><span class="s1">&quot;refreshInactiveParallelSegments&quot;</span><span class="s0">,</span><span class="s1">&quot;updatedTree&quot;</span><span class="s0">,</span><span class="s1">&quot;updatedCache&quot;</span><span class="s0">,</span><span class="s1">&quot;patchedTree&quot;</span><span class="s0">,</span><span class="s1">&quot;handleMutable&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;+BAoBgBA;;;eAAAA;;;qCApBoB;mCACF;6CACU;6CACA;iCAOV;+BACJ;+CAEgB;2BACT;uCACC;mDACY;iDACF;8BACV;AAE/B,SAASA,eACdC,KAA2B,EAC3BC,MAAqB;IAErB,MAAM,EAAEC,MAAM,EAAE,GAAGD;IACnB,MAAME,UAAmB,CAAC;IAC1B,MAAMC,OAAOJ,MAAMK,YAAY;IAE/B,IAAIC,cAAcN,MAAMO,IAAI;IAE5BJ,QAAQK,0BAA0B,GAAG;IAErC,MAAMC,QAAmBC,IAAAA,+BAAoB;IAE7C,sFAAsF;IACtF,sHAAsH;IACtH,MAAMC,iBAAiBC,IAAAA,oEAAiC,EAACZ,MAAMO,IAAI;IAEnE,uDAAuD;IACvD,wCAAwC;IACxCE,MAAMI,QAAQ,GAAGC,IAAAA,wCAAmB,EAAC,IAAIC,IAAIX,MAAMF,SAAS;QAC1Dc,mBAAmB;YACjBV,WAAW,CAAC,EAAE;YACdA,WAAW,CAAC,EAAE;YACdA,WAAW,CAAC,EAAE;YACd;SACD;QACDW,SAASN,iBAAiBX,MAAMiB,OAAO,GAAG;IAC5C;IAEA,MAAMC,cAAcC,KAAKC,GAAG;IAC5B,OAAOX,MAAMI,QAAQ,CAACQ,IAAI,CACxB;YAAO,EAAEC,UAAU,EAAEjB,cAAckB,oBAAoB,EAAE;QACvD,4DAA4D;QAC5D,IAAI,OAAOD,eAAe,UAAU;YAClC,OAAOE,IAAAA,kCAAiB,EACtBxB,OACAG,SACAmB,YACAtB,MAAMyB,OAAO,CAACC,WAAW;QAE7B;QAEA,+DAA+D;QAC/DjB,MAAMI,QAAQ,GAAG;QAEjB,KAAK,MAAMc,wBAAwBL,WAAY;YAC7C,MAAM,EACJf,MAAMqB,SAAS,EACfC,UAAUC,iBAAiB,EAC3BC,IAAI,EACJC,YAAY,EACb,GAAGL;YAEJ,IAAI,CAACK,cAAc;gBACjB,oCAAoC;gBACpCC,QAAQC,GAAG,CAAC;gBACZ,OAAOlC;YACT;YAEA,MAAMmC,UAAUC,IAAAA,wDAA2B,EACzC,sBAAsB;YACtB;gBAAC;aAAG,EACJ9B,aACAsB,WACA5B,MAAMK,YAAY;YAGpB,IAAI8B,YAAY,MAAM;gBACpB,OAAOE,IAAAA,4CAAqB,EAACrC,OAAOC,QAAQ2B;YAC9C;YAEA,IAAIU,IAAAA,wDAA2B,EAAChC,aAAa6B,UAAU;gBACrD,OAAOX,IAAAA,kCAAiB,EACtBxB,OACAG,SACAC,MACAJ,MAAMyB,OAAO,CAACC,WAAW;YAE7B;YAEA,MAAMa,2BAA2BhB,uBAC7BiB,IAAAA,oCAAiB,EAACjB,wBAClBkB;YAEJ,IAAIlB,sBAAsB;gBACxBpB,QAAQE,YAAY,GAAGkC;YACzB;YAEA,8FAA8F;YAC9F,IAAIT,sBAAsB,MAAM;gBAC9B,MAAMY,MAAMZ,iBAAiB,CAAC,EAAE;gBAChC,MAAMa,UAAUb,iBAAiB,CAAC,EAAE;gBACpCrB,MAAMiC,GAAG,GAAGA;gBACZjC,MAAMmC,WAAW,GAAG;gBACpBnC,MAAMkC,OAAO,GAAGA;gBAChBE,IAAAA,4DAA6B,EAC3B3B,aACAT,OACA,4FAA4F;gBAC5FgC,WACAb,WACAE,mBACAC,MACAU;gBAEF,IAAIK,QAAQC,GAAG,CAACC,2BAA2B,EAAE;oBAC3CC,IAAAA,mCAAqB,EAACjD,MAAMiB,OAAO,EAAEkB;gBACvC,OAAO;oBACLhC,QAAQ+C,aAAa,GAAG,IAAIC;gBAC9B;YACF;YAEA,MAAMC,IAAAA,gEAA+B,EAAC;gBACpClC;gBACAlB;gBACAqD,aAAalB;gBACbmB,cAAc7C;gBACdE;gBACAN,cAAcF,QAAQE,YAAY,IAAIL,MAAMK,YAAY;YAC1D;YAEAF,QAAQM,KAAK,GAAGA;YAChBN,QAAQoD,WAAW,GAAGpB;YAEtB7B,cAAc6B;QAChB;QAEA,OAAOqB,IAAAA,4BAAa,EAACxD,OAAOG;IAC9B,GACA,IAAMH;AAEV&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>