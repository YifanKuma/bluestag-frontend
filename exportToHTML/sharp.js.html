<html>
<head>
<title>sharp.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #0033b3;}
.s4 { color: #264eff;}
.s5 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
sharp.js</font>
</center></td></tr></table>
<pre><span class="s0">// Copyright 2013 Lovell Fuller and others.</span>
<span class="s0">// SPDX-License-Identifier: Apache-2.0</span>

<span class="s2">'use strict'</span><span class="s1">;</span>

<span class="s0">// Inspects the runtime environment and exports the relevant sharp.node binary</span>

<span class="s3">const </span><span class="s1">{ familySync, versionSync } = require(</span><span class="s2">'detect-libc'</span><span class="s1">);</span>

<span class="s3">const </span><span class="s1">{ runtimePlatformArch, isUnsupportedNodeRuntime, prebuiltPlatforms, minimumLibvipsVersion } = require(</span><span class="s2">'./libvips'</span><span class="s1">);</span>
<span class="s3">const </span><span class="s1">runtimePlatform = runtimePlatformArch();</span>

<span class="s3">const </span><span class="s1">paths = [</span>
  <span class="s2">`../src/build/Release/sharp-</span><span class="s1">${runtimePlatform}</span><span class="s2">.node`</span><span class="s1">,</span>
  <span class="s2">'../src/build/Release/sharp-wasm32.node'</span><span class="s1">,</span>
  <span class="s2">`@img/sharp-</span><span class="s1">${runtimePlatform}</span><span class="s2">/sharp.node`</span><span class="s1">,</span>
  <span class="s2">'@img/sharp-wasm32/sharp.node'</span>
<span class="s1">];</span>

<span class="s3">let </span><span class="s1">path, sharp;</span>
<span class="s3">const </span><span class="s1">errors = [];</span>
<span class="s3">for </span><span class="s1">(path of paths) {</span>
  <span class="s3">try </span><span class="s1">{</span>
    <span class="s1">sharp = require(path);</span>
    <span class="s3">break</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">catch </span><span class="s1">(err) {</span>
    <span class="s0">/* istanbul ignore next */</span>
    <span class="s1">errors.push(err);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">if </span><span class="s1">(sharp &amp;&amp; path.startsWith(</span><span class="s2">'@img/sharp-linux-x64'</span><span class="s1">) &amp;&amp; !sharp._isUsingX64V2()) {</span>
  <span class="s3">const </span><span class="s1">err = </span><span class="s3">new </span><span class="s1">Error(</span><span class="s2">'Prebuilt binaries for linux-x64 require v2 microarchitecture'</span><span class="s1">);</span>
  <span class="s1">err.code = </span><span class="s2">'Unsupported CPU'</span><span class="s1">;</span>
  <span class="s1">errors.push(err);</span>
  <span class="s1">sharp = </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/* istanbul ignore next */</span>
<span class="s3">if </span><span class="s1">(sharp) {</span>
  <span class="s1">module.exports = sharp;</span>
<span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
  <span class="s3">const </span><span class="s1">[isLinux, isMacOs, isWindows] = [</span><span class="s2">'linux'</span><span class="s1">, </span><span class="s2">'darwin'</span><span class="s1">, </span><span class="s2">'win32'</span><span class="s1">].map(os =&gt; runtimePlatform.startsWith(os));</span>

  <span class="s3">const </span><span class="s1">help = [</span><span class="s2">`Could not load the &quot;sharp&quot; module using the </span><span class="s1">${runtimePlatform} </span><span class="s2">runtime`</span><span class="s1">];</span>
  <span class="s1">errors.forEach(err =&gt; {</span>
    <span class="s3">if </span><span class="s1">(err.code !== </span><span class="s2">'MODULE_NOT_FOUND'</span><span class="s1">) {</span>
      <span class="s1">help.push(</span><span class="s2">`</span><span class="s1">${err.code}</span><span class="s2">: </span><span class="s1">${err.message}</span><span class="s2">`</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>
  <span class="s3">const </span><span class="s1">messages = errors.map(err =&gt; err.message).join(</span><span class="s2">' '</span><span class="s1">);</span>
  <span class="s1">help.push(</span><span class="s2">'Possible solutions:'</span><span class="s1">);</span>
  <span class="s0">// Common error messages</span>
  <span class="s3">if </span><span class="s1">(isUnsupportedNodeRuntime()) {</span>
    <span class="s3">const </span><span class="s1">{ found, expected } = isUnsupportedNodeRuntime();</span>
    <span class="s1">help.push(</span>
      <span class="s2">'- Please upgrade Node.js:'</span><span class="s1">,</span>
      <span class="s2">`    Found </span><span class="s1">${found}</span><span class="s2">`</span><span class="s1">,</span>
      <span class="s2">`    Requires </span><span class="s1">${expected}</span><span class="s2">`</span>
    <span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(prebuiltPlatforms.includes(runtimePlatform)) {</span>
    <span class="s3">const </span><span class="s1">[os, cpu] = runtimePlatform.split(</span><span class="s2">'-'</span><span class="s1">);</span>
    <span class="s3">const </span><span class="s1">libc = os.endsWith(</span><span class="s2">'musl'</span><span class="s1">) ? </span><span class="s2">' --libc=musl' </span><span class="s1">: </span><span class="s2">''</span><span class="s1">;</span>
    <span class="s1">help.push(</span>
      <span class="s2">'- Ensure optional dependencies can be installed:'</span><span class="s1">,</span>
      <span class="s2">'    npm install --include=optional sharp'</span><span class="s1">,</span>
      <span class="s2">'- Ensure your package manager supports multi-platform installation:'</span><span class="s1">,</span>
      <span class="s2">'    See https://sharp.pixelplumbing.com/install#cross-platform'</span><span class="s1">,</span>
      <span class="s2">'- Add platform-specific dependencies:'</span><span class="s1">,</span>
      <span class="s2">`    npm install --os=</span><span class="s1">${os.replace(</span><span class="s2">'musl'</span><span class="s1">, </span><span class="s2">''</span><span class="s1">)}${libc} </span><span class="s2">--cpu=</span><span class="s1">${cpu} </span><span class="s2">sharp`</span>
    <span class="s1">);</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s1">help.push(</span>
      <span class="s2">`- Manually install libvips &gt;= </span><span class="s1">${minimumLibvipsVersion}</span><span class="s2">`</span><span class="s1">,</span>
      <span class="s2">'- Add experimental WebAssembly-based dependencies:'</span><span class="s1">,</span>
      <span class="s2">'    npm install --cpu=wasm32 sharp'</span><span class="s1">,</span>
      <span class="s2">'    npm install @img/sharp-wasm32'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(isLinux &amp;&amp; </span><span class="s4">/(symbol not found|CXXABI_)/i</span><span class="s1">.test(messages)) {</span>
    <span class="s3">try </span><span class="s1">{</span>
      <span class="s3">const </span><span class="s1">{ config } = require(</span><span class="s2">`@img/sharp-libvips-</span><span class="s1">${runtimePlatform}</span><span class="s2">/package`</span><span class="s1">);</span>
      <span class="s3">const </span><span class="s1">libcFound = </span><span class="s2">`</span><span class="s1">${familySync()} ${versionSync()}</span><span class="s2">`</span><span class="s1">;</span>
      <span class="s3">const </span><span class="s1">libcRequires = </span><span class="s2">`</span><span class="s1">${config.musl ? </span><span class="s2">'musl' </span><span class="s1">: </span><span class="s2">'glibc'</span><span class="s1">} ${config.musl || config.glibc}</span><span class="s2">`</span><span class="s1">;</span>
      <span class="s1">help.push(</span>
        <span class="s2">'- Update your OS:'</span><span class="s1">,</span>
        <span class="s2">`    Found </span><span class="s1">${libcFound}</span><span class="s2">`</span><span class="s1">,</span>
        <span class="s2">`    Requires </span><span class="s1">${libcRequires}</span><span class="s2">`</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s3">catch </span><span class="s1">(errEngines) {}</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(isLinux &amp;&amp; </span><span class="s4">/\/snap\/core[0-9]{2}/</span><span class="s1">.test(messages)) {</span>
    <span class="s1">help.push(</span>
      <span class="s2">'- Remove the Node.js Snap, which does not support native modules'</span><span class="s1">,</span>
      <span class="s2">'    snap remove node'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(isMacOs &amp;&amp; </span><span class="s4">/Incompatible library version/</span><span class="s1">.test(messages)) {</span>
    <span class="s1">help.push(</span>
      <span class="s2">'- Update Homebrew:'</span><span class="s1">,</span>
      <span class="s2">'    brew update &amp;&amp; brew upgrade vips'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(errors.some(err =&gt; err.code === </span><span class="s2">'ERR_DLOPEN_DISABLED'</span><span class="s1">)) {</span>
    <span class="s1">help.push(</span><span class="s2">'- Run Node.js without using the --no-addons flag'</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s0">// Link to installation docs</span>
  <span class="s3">if </span><span class="s1">(isWindows &amp;&amp; </span><span class="s4">/The specified procedure could not be found/</span><span class="s1">.test(messages)) {</span>
    <span class="s1">help.push(</span>
      <span class="s2">'- Using the canvas package on Windows?'</span><span class="s1">,</span>
      <span class="s2">'    See https://sharp.pixelplumbing.com/install#canvas-and-windows'</span><span class="s1">,</span>
      <span class="s2">'- Check for outdated versions of sharp in the dependency tree:'</span><span class="s1">,</span>
      <span class="s2">'    npm ls sharp'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">help.push(</span>
    <span class="s2">'- Consult the installation documentation:'</span><span class="s1">,</span>
    <span class="s2">'    See https://sharp.pixelplumbing.com/install'</span>
  <span class="s1">);</span>
  <span class="s3">throw new </span><span class="s1">Error(help.join(</span><span class="s2">'</span><span class="s5">\n</span><span class="s2">'</span><span class="s1">));</span>
<span class="s1">}</span>
</pre>
</body>
</html>