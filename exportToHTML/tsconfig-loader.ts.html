<html>
<head>
<title>tsconfig-loader.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
tsconfig-loader.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">* as path from </span><span class="s2">&quot;path&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">* as fs from </span><span class="s2">&quot;fs&quot;</span><span class="s1">;</span>
<span class="s3">// tslint:disable:no-require-imports</span>
<span class="s0">import </span><span class="s1">JSON5 = require(</span><span class="s2">&quot;json5&quot;</span><span class="s1">);</span>
<span class="s0">import </span><span class="s1">StripBom = require(</span><span class="s2">&quot;strip-bom&quot;</span><span class="s1">);</span>
<span class="s3">// tslint:enable:no-require-imports</span>

<span class="s3">/**</span>
 <span class="s3">* Typing for the parts of tsconfig that we care about</span>
 <span class="s3">*/</span>
<span class="s0">export interface </span><span class="s1">Tsconfig {</span>
  <span class="s0">extends</span><span class="s1">?: string | string[];</span>
  <span class="s1">compilerOptions?: {</span>
    <span class="s1">baseUrl?: string;</span>
    <span class="s1">paths?: { [key: string]: Array&lt;string&gt; };</span>
    <span class="s1">strict?: boolean;</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s0">export interface </span><span class="s1">TsConfigLoaderResult {</span>
  <span class="s1">tsConfigPath: string | undefined;</span>
  <span class="s1">baseUrl: string | undefined;</span>
  <span class="s1">paths: { [key: string]: Array&lt;string&gt; } | undefined;</span>
<span class="s1">}</span>

<span class="s0">export interface </span><span class="s1">TsConfigLoaderParams {</span>
  <span class="s1">getEnv: (key: string) =&gt; string | undefined;</span>
  <span class="s1">cwd: string;</span>
  <span class="s1">loadSync?(</span>
    <span class="s1">cwd: string,</span>
    <span class="s1">filename?: string,</span>
    <span class="s1">baseUrl?: string</span>
  <span class="s1">): TsConfigLoaderResult;</span>
<span class="s1">}</span>

<span class="s0">export function </span><span class="s1">tsConfigLoader({</span>
  <span class="s1">getEnv,</span>
  <span class="s1">cwd,</span>
  <span class="s1">loadSync = loadSyncDefault,</span>
<span class="s1">}: TsConfigLoaderParams): TsConfigLoaderResult {</span>
  <span class="s0">const </span><span class="s1">TS_NODE_PROJECT = getEnv(</span><span class="s2">&quot;TS_NODE_PROJECT&quot;</span><span class="s1">);</span>
  <span class="s0">const </span><span class="s1">TS_NODE_BASEURL = getEnv(</span><span class="s2">&quot;TS_NODE_BASEURL&quot;</span><span class="s1">);</span>

  <span class="s3">// tsconfig.loadSync handles if TS_NODE_PROJECT is a file or directory</span>
  <span class="s3">// and also overrides baseURL if TS_NODE_BASEURL is available.</span>
  <span class="s0">const </span><span class="s1">loadResult = loadSync(cwd, TS_NODE_PROJECT, TS_NODE_BASEURL);</span>
  <span class="s0">return </span><span class="s1">loadResult;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">loadSyncDefault(</span>
  <span class="s1">cwd: string,</span>
  <span class="s1">filename?: string,</span>
  <span class="s1">baseUrl?: string</span>
<span class="s1">): TsConfigLoaderResult {</span>
  <span class="s3">// Tsconfig.loadSync uses path.resolve. This is why we can use an absolute path as filename</span>

  <span class="s0">const </span><span class="s1">configPath = resolveConfigPath(cwd, filename);</span>

  <span class="s0">if </span><span class="s1">(!configPath) {</span>
    <span class="s0">return </span><span class="s1">{</span>
      <span class="s1">tsConfigPath: undefined,</span>
      <span class="s1">baseUrl: undefined,</span>
      <span class="s1">paths: undefined,</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
  <span class="s0">const </span><span class="s1">config = loadTsconfig(configPath);</span>

  <span class="s0">return </span><span class="s1">{</span>
    <span class="s1">tsConfigPath: configPath,</span>
    <span class="s1">baseUrl:</span>
      <span class="s1">baseUrl ||</span>
      <span class="s1">(config &amp;&amp; config.compilerOptions &amp;&amp; config.compilerOptions.baseUrl),</span>
    <span class="s1">paths: config &amp;&amp; config.compilerOptions &amp;&amp; config.compilerOptions.paths,</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">resolveConfigPath(cwd: string, filename?: string): string | undefined {</span>
  <span class="s0">if </span><span class="s1">(filename) {</span>
    <span class="s0">const </span><span class="s1">absolutePath = fs.lstatSync(filename).isDirectory()</span>
      <span class="s1">? path.resolve(filename, </span><span class="s2">&quot;./tsconfig.json&quot;</span><span class="s1">)</span>
      <span class="s1">: path.resolve(cwd, filename);</span>

    <span class="s0">return </span><span class="s1">absolutePath;</span>
  <span class="s1">}</span>

  <span class="s0">if </span><span class="s1">(fs.statSync(cwd).isFile()) {</span>
    <span class="s0">return </span><span class="s1">path.resolve(cwd);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">configAbsolutePath = walkForTsConfig(cwd);</span>
  <span class="s0">return </span><span class="s1">configAbsolutePath ? path.resolve(configAbsolutePath) : undefined;</span>
<span class="s1">}</span>

<span class="s0">export function </span><span class="s1">walkForTsConfig(</span>
  <span class="s1">directory: string,</span>
  <span class="s1">existsSync: (path: string) =&gt; boolean = fs.existsSync</span>
<span class="s1">): string | undefined {</span>
  <span class="s0">const </span><span class="s1">configPath = path.join(directory, </span><span class="s2">&quot;./tsconfig.json&quot;</span><span class="s1">);</span>
  <span class="s0">if </span><span class="s1">(existsSync(configPath)) {</span>
    <span class="s0">return </span><span class="s1">configPath;</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">parentDirectory = path.join(directory, </span><span class="s2">&quot;../&quot;</span><span class="s1">);</span>

  <span class="s3">// If we reached the top</span>
  <span class="s0">if </span><span class="s1">(directory === parentDirectory) {</span>
    <span class="s0">return </span><span class="s1">undefined;</span>
  <span class="s1">}</span>

  <span class="s0">return </span><span class="s1">walkForTsConfig(parentDirectory, existsSync);</span>
<span class="s1">}</span>

<span class="s0">export function </span><span class="s1">loadTsconfig(</span>
  <span class="s1">configFilePath: string,</span>
  <span class="s1">existsSync: (path: string) =&gt; boolean = fs.existsSync,</span>
  <span class="s1">readFileSync: (filename: string) =&gt; string = (filename: string) =&gt;</span>
    <span class="s1">fs.readFileSync(filename, </span><span class="s2">&quot;utf8&quot;</span><span class="s1">)</span>
<span class="s1">): Tsconfig | undefined {</span>
  <span class="s0">if </span><span class="s1">(!existsSync(configFilePath)) {</span>
    <span class="s0">return </span><span class="s1">undefined;</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">configString = readFileSync(configFilePath);</span>
  <span class="s0">const </span><span class="s1">cleanedJson = StripBom(configString);</span>
  <span class="s0">let </span><span class="s1">config: Tsconfig;</span>
  <span class="s0">try </span><span class="s1">{</span>
    <span class="s1">config = JSON5.parse(cleanedJson);</span>
  <span class="s1">} </span><span class="s0">catch </span><span class="s1">(e) {</span>
    <span class="s0">throw new </span><span class="s1">Error(</span><span class="s2">`</span><span class="s1">${configFilePath} </span><span class="s2">is malformed </span><span class="s1">${e.message}</span><span class="s2">`</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">let </span><span class="s1">extendedConfig = config.extends;</span>
  <span class="s0">if </span><span class="s1">(extendedConfig) {</span>
    <span class="s0">let </span><span class="s1">base: Tsconfig;</span>

    <span class="s0">if </span><span class="s1">(Array.isArray(extendedConfig)) {</span>
      <span class="s1">base = extendedConfig.reduce(</span>
        <span class="s1">(currBase, extendedConfigElement) =&gt;</span>
          <span class="s1">mergeTsconfigs(</span>
            <span class="s1">currBase,</span>
            <span class="s1">loadTsconfigFromExtends(</span>
              <span class="s1">configFilePath,</span>
              <span class="s1">extendedConfigElement,</span>
              <span class="s1">existsSync,</span>
              <span class="s1">readFileSync</span>
            <span class="s1">)</span>
          <span class="s1">),</span>
        <span class="s1">{}</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s1">base = loadTsconfigFromExtends(</span>
        <span class="s1">configFilePath,</span>
        <span class="s1">extendedConfig,</span>
        <span class="s1">existsSync,</span>
        <span class="s1">readFileSync</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s1">mergeTsconfigs(base, config);</span>
  <span class="s1">}</span>
  <span class="s0">return </span><span class="s1">config;</span>
<span class="s1">}</span>

<span class="s3">/**</span>
 <span class="s3">* Intended to be called only from loadTsconfig.</span>
 <span class="s3">* Parameters don't have defaults because they should use the same as loadTsconfig.</span>
 <span class="s3">*/</span>
<span class="s0">function </span><span class="s1">loadTsconfigFromExtends(</span>
  <span class="s1">configFilePath: string,</span>
  <span class="s1">extendedConfigValue: string,</span>
  <span class="s3">// eslint-disable-next-line no-shadow</span>
  <span class="s1">existsSync: (path: string) =&gt; boolean,</span>
  <span class="s1">readFileSync: (filename: string) =&gt; string</span>
<span class="s1">): Tsconfig {</span>
  <span class="s0">if </span><span class="s1">(</span>
    <span class="s0">typeof </span><span class="s1">extendedConfigValue === </span><span class="s2">&quot;string&quot; </span><span class="s1">&amp;&amp;</span>
    <span class="s1">extendedConfigValue.indexOf(</span><span class="s2">&quot;.json&quot;</span><span class="s1">) === -</span><span class="s4">1</span>
  <span class="s1">) {</span>
    <span class="s1">extendedConfigValue += </span><span class="s2">&quot;.json&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">const </span><span class="s1">currentDir = path.dirname(configFilePath);</span>
  <span class="s0">let </span><span class="s1">extendedConfigPath = path.join(currentDir, extendedConfigValue);</span>
  <span class="s0">if </span><span class="s1">(</span>
    <span class="s1">extendedConfigValue.indexOf(</span><span class="s2">&quot;/&quot;</span><span class="s1">) !== -</span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
    <span class="s1">extendedConfigValue.indexOf(</span><span class="s2">&quot;.&quot;</span><span class="s1">) !== -</span><span class="s4">1 </span><span class="s1">&amp;&amp;</span>
    <span class="s1">!existsSync(extendedConfigPath)</span>
  <span class="s1">) {</span>
    <span class="s1">extendedConfigPath = path.join(</span>
      <span class="s1">currentDir,</span>
      <span class="s2">&quot;node_modules&quot;</span><span class="s1">,</span>
      <span class="s1">extendedConfigValue</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">config =</span>
    <span class="s1">loadTsconfig(extendedConfigPath, existsSync, readFileSync) || {};</span>

  <span class="s3">// baseUrl should be interpreted as relative to extendedConfigPath,</span>
  <span class="s3">// but we need to update it so it is relative to the original tsconfig being loaded</span>
  <span class="s0">if </span><span class="s1">(config.compilerOptions?.baseUrl) {</span>
    <span class="s0">const </span><span class="s1">extendsDir = path.dirname(extendedConfigValue);</span>
    <span class="s1">config.compilerOptions.baseUrl = path.join(</span>
      <span class="s1">extendsDir,</span>
      <span class="s1">config.compilerOptions.baseUrl</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">return </span><span class="s1">config;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">mergeTsconfigs(</span>
  <span class="s1">base: Tsconfig | undefined,</span>
  <span class="s1">config: Tsconfig | undefined</span>
<span class="s1">): Tsconfig {</span>
  <span class="s1">base = base || {};</span>
  <span class="s1">config = config || {};</span>

  <span class="s0">return </span><span class="s1">{</span>
    <span class="s1">...base,</span>
    <span class="s1">...config,</span>
    <span class="s1">compilerOptions: {</span>
      <span class="s1">...base.compilerOptions,</span>
      <span class="s1">...config.compilerOptions,</span>
    <span class="s1">},</span>
  <span class="s1">};</span>
<span class="s1">}</span>
</pre>
</body>
</html>