<html>
<head>
<title>encryption-utils.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
encryption-utils.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s3">0 </span><span class="s1">&amp;&amp; (module.exports = {</span>
    <span class="s1">arrayBufferToString: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">decrypt: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">encrypt: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">getActionEncryptionKey: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">getClientReferenceManifestForRsc: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">getServerModuleMap: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">setReferenceManifestsSingleton: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">stringToUint8Array: </span><span class="s2">null</span>
<span class="s1">});</span>
<span class="s2">function </span><span class="s1">_export(target, all) {</span>
    <span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s1">name </span><span class="s2">in </span><span class="s1">all)Object.defineProperty(target, name, {</span>
        <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
        <span class="s1">get: all[name]</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s1">_export(exports, {</span>
    <span class="s1">arrayBufferToString: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">arrayBufferToString;</span>
    <span class="s1">},</span>
    <span class="s1">decrypt: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">decrypt;</span>
    <span class="s1">},</span>
    <span class="s1">encrypt: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">encrypt;</span>
    <span class="s1">},</span>
    <span class="s1">getActionEncryptionKey: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">getActionEncryptionKey;</span>
    <span class="s1">},</span>
    <span class="s1">getClientReferenceManifestForRsc: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">getClientReferenceManifestForRsc;</span>
    <span class="s1">},</span>
    <span class="s1">getServerModuleMap: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">getServerModuleMap;</span>
    <span class="s1">},</span>
    <span class="s1">setReferenceManifestsSingleton: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">setReferenceManifestsSingleton;</span>
    <span class="s1">},</span>
    <span class="s1">stringToUint8Array: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">stringToUint8Array;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_invarianterror = require(</span><span class="s0">&quot;../../shared/lib/invariant-error&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_apppaths = require(</span><span class="s0">&quot;../../shared/lib/router/utils/app-paths&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_workasyncstorageexternal = require(</span><span class="s0">&quot;./work-async-storage.external&quot;</span><span class="s1">);</span>
<span class="s2">let </span><span class="s1">__next_loaded_action_key;</span>
<span class="s2">function </span><span class="s1">arrayBufferToString(buffer) {</span>
    <span class="s2">const </span><span class="s1">bytes = </span><span class="s2">new </span><span class="s1">Uint8Array(buffer);</span>
    <span class="s2">const </span><span class="s1">len = bytes.byteLength;</span>
    <span class="s4">// @anonrig: V8 has a limit of 65535 arguments in a function.</span>
    <span class="s4">// For len &lt; 65535, this is faster.</span>
    <span class="s4">// https://github.com/vercel/next.js/pull/56377#pullrequestreview-1656181623</span>
    <span class="s2">if </span><span class="s1">(len &lt; </span><span class="s3">65535</span><span class="s1">) {</span>
        <span class="s2">return </span><span class="s1">String.fromCharCode.apply(</span><span class="s2">null</span><span class="s1">, bytes);</span>
    <span class="s1">}</span>
    <span class="s2">let </span><span class="s1">binary = </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s2">for</span><span class="s1">(</span><span class="s2">let </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; len; i++){</span>
        <span class="s1">binary += String.fromCharCode(bytes[i]);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">binary;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">stringToUint8Array(binary) {</span>
    <span class="s2">const </span><span class="s1">len = binary.length;</span>
    <span class="s2">const </span><span class="s1">arr = </span><span class="s2">new </span><span class="s1">Uint8Array(len);</span>
    <span class="s2">for</span><span class="s1">(</span><span class="s2">let </span><span class="s1">i = </span><span class="s3">0</span><span class="s1">; i &lt; len; i++){</span>
        <span class="s1">arr[i] = binary.charCodeAt(i);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">arr;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">encrypt(key, iv, data) {</span>
    <span class="s2">return </span><span class="s1">crypto.subtle.encrypt({</span>
        <span class="s1">name: </span><span class="s0">'AES-GCM'</span><span class="s1">,</span>
        <span class="s1">iv</span>
    <span class="s1">}, key, data);</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">decrypt(key, iv, data) {</span>
    <span class="s2">return </span><span class="s1">crypto.subtle.decrypt({</span>
        <span class="s1">name: </span><span class="s0">'AES-GCM'</span><span class="s1">,</span>
        <span class="s1">iv</span>
    <span class="s1">}, key, data);</span>
<span class="s1">}</span>
<span class="s4">// This is a global singleton that is used to encode/decode the action bound args from</span>
<span class="s4">// the closure. This can't be using a AsyncLocalStorage as it might happen on the module</span>
<span class="s4">// level. Since the client reference manifest won't be mutated, let's use a global singleton</span>
<span class="s4">// to keep it.</span>
<span class="s2">const </span><span class="s1">SERVER_ACTION_MANIFESTS_SINGLETON = Symbol.for(</span><span class="s0">'next.server.action-manifests'</span><span class="s1">);</span>
<span class="s2">function </span><span class="s1">setReferenceManifestsSingleton({ page, clientReferenceManifest, serverActionsManifest, serverModuleMap }) {</span>
    <span class="s2">var </span><span class="s1">_globalThis_SERVER_ACTION_MANIFESTS_SINGLETON;</span>
    <span class="s4">// @ts-expect-error</span>
    <span class="s2">const </span><span class="s1">clientReferenceManifestsPerPage = (_globalThis_SERVER_ACTION_MANIFESTS_SINGLETON = globalThis[SERVER_ACTION_MANIFESTS_SINGLETON]) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _globalThis_SERVER_ACTION_MANIFESTS_SINGLETON.clientReferenceManifestsPerPage;</span>
    <span class="s4">// @ts-expect-error</span>
    <span class="s1">globalThis[SERVER_ACTION_MANIFESTS_SINGLETON] = {</span>
        <span class="s1">clientReferenceManifestsPerPage: {</span>
            <span class="s1">...clientReferenceManifestsPerPage,</span>
            <span class="s1">[(</span><span class="s3">0</span><span class="s1">, _apppaths.normalizeAppPath)(page)]: clientReferenceManifest</span>
        <span class="s1">},</span>
        <span class="s1">serverActionsManifest,</span>
        <span class="s1">serverModuleMap</span>
    <span class="s1">};</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">getServerModuleMap() {</span>
    <span class="s2">const </span><span class="s1">serverActionsManifestSingleton = globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];</span>
    <span class="s2">if </span><span class="s1">(!serverActionsManifestSingleton) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Missing manifest for Server Actions.'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E606&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">serverActionsManifestSingleton.serverModuleMap;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">getClientReferenceManifestForRsc() {</span>
    <span class="s2">const </span><span class="s1">serverActionsManifestSingleton = globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];</span>
    <span class="s2">if </span><span class="s1">(!serverActionsManifestSingleton) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Missing manifest for Server Actions.'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E606&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">{ clientReferenceManifestsPerPage } = serverActionsManifestSingleton;</span>
    <span class="s2">const </span><span class="s1">workStore = _workasyncstorageexternal.workAsyncStorage.getStore();</span>
    <span class="s2">if </span><span class="s1">(!workStore) {</span>
        <span class="s4">// If there's no work store defined, we can assume that a client reference</span>
        <span class="s4">// manifest is needed during module evaluation, e.g. to create a server</span>
        <span class="s4">// action using a higher-order function. This might also use client</span>
        <span class="s4">// components which need to be serialized by Flight, and therefore client</span>
        <span class="s4">// references need to be resolvable. To make this work, we're returning a</span>
        <span class="s4">// merged manifest across all pages. This is fine as long as the module IDs</span>
        <span class="s4">// are not page specific, which they are not for Webpack. TODO: Fix this in</span>
        <span class="s4">// Turbopack.</span>
        <span class="s2">return </span><span class="s1">mergeClientReferenceManifests(clientReferenceManifestsPerPage);</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">clientReferenceManifest = clientReferenceManifestsPerPage[workStore.route];</span>
    <span class="s2">if </span><span class="s1">(!clientReferenceManifest) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">`Missing Client Reference Manifest for </span><span class="s1">${workStore.route}</span><span class="s0">.`</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E570&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">clientReferenceManifest;</span>
<span class="s1">}</span>
<span class="s1">async </span><span class="s2">function </span><span class="s1">getActionEncryptionKey() {</span>
    <span class="s2">if </span><span class="s1">(__next_loaded_action_key) {</span>
        <span class="s2">return </span><span class="s1">__next_loaded_action_key;</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">serverActionsManifestSingleton = globalThis[SERVER_ACTION_MANIFESTS_SINGLETON];</span>
    <span class="s2">if </span><span class="s1">(!serverActionsManifestSingleton) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Missing manifest for Server Actions.'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E606&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s2">const </span><span class="s1">rawKey = process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY || serverActionsManifestSingleton.serverActionsManifest.encryptionKey;</span>
    <span class="s2">if </span><span class="s1">(rawKey === undefined) {</span>
        <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">_invarianterror.InvariantError(</span><span class="s0">'Missing encryption key for Server Actions'</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
            <span class="s1">value: </span><span class="s0">&quot;E571&quot;</span><span class="s1">,</span>
            <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
            <span class="s1">configurable: </span><span class="s2">true</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s1">__next_loaded_action_key = </span><span class="s2">await </span><span class="s1">crypto.subtle.importKey(</span><span class="s0">'raw'</span><span class="s1">, stringToUint8Array(atob(rawKey)), </span><span class="s0">'AES-GCM'</span><span class="s1">, </span><span class="s2">true</span><span class="s1">, [</span>
        <span class="s0">'encrypt'</span><span class="s1">,</span>
        <span class="s0">'decrypt'</span>
    <span class="s1">]);</span>
    <span class="s2">return </span><span class="s1">__next_loaded_action_key;</span>
<span class="s1">}</span>
<span class="s2">function </span><span class="s1">mergeClientReferenceManifests(clientReferenceManifestsPerPage) {</span>
    <span class="s2">const </span><span class="s1">clientReferenceManifests = Object.values(clientReferenceManifestsPerPage);</span>
    <span class="s2">const </span><span class="s1">mergedClientReferenceManifest = {</span>
        <span class="s1">clientModules: {},</span>
        <span class="s1">edgeRscModuleMapping: {},</span>
        <span class="s1">rscModuleMapping: {}</span>
    <span class="s1">};</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">clientReferenceManifest of clientReferenceManifests){</span>
        <span class="s1">mergedClientReferenceManifest.clientModules = {</span>
            <span class="s1">...mergedClientReferenceManifest.clientModules,</span>
            <span class="s1">...clientReferenceManifest.clientModules</span>
        <span class="s1">};</span>
        <span class="s1">mergedClientReferenceManifest.edgeRscModuleMapping = {</span>
            <span class="s1">...mergedClientReferenceManifest.edgeRscModuleMapping,</span>
            <span class="s1">...clientReferenceManifest.edgeRscModuleMapping</span>
        <span class="s1">};</span>
        <span class="s1">mergedClientReferenceManifest.rscModuleMapping = {</span>
            <span class="s1">...mergedClientReferenceManifest.rscModuleMapping,</span>
            <span class="s1">...clientReferenceManifest.rscModuleMapping</span>
        <span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">mergedClientReferenceManifest;</span>
<span class="s1">}</span>

<span class="s4">//# sourceMappingURL=encryption-utils.js.map</span></pre>
</body>
</html>