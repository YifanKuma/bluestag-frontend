<html>
<head>
<title>asyncify.mjs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #0033b3;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
.s5 { color: #8c8c8c; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
asyncify.mjs</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">{ _WebAssembly } from </span><span class="s2">&quot;./webassembly.mjs&quot;</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ isPromiseLike, wrapInstanceExports } from </span><span class="s2">&quot;./wasi/util.mjs&quot;</span><span class="s1">;</span>
<span class="s0">const </span><span class="s1">ignoreNames = [</span>
    <span class="s2">'asyncify_get_state'</span><span class="s1">,</span>
    <span class="s2">'asyncify_start_rewind'</span><span class="s1">,</span>
    <span class="s2">'asyncify_start_unwind'</span><span class="s1">,</span>
    <span class="s2">'asyncify_stop_rewind'</span><span class="s1">,</span>
    <span class="s2">'asyncify_stop_unwind'</span>
<span class="s1">];</span>
<span class="s3">// const wrappedExports = new WeakMap&lt;WebAssembly.Exports, WebAssembly.Exports&gt;()</span>
<span class="s0">var </span><span class="s1">AsyncifyState;</span>
<span class="s1">(</span><span class="s0">function </span><span class="s1">(AsyncifyState) {</span>
    <span class="s1">AsyncifyState[AsyncifyState[</span><span class="s2">&quot;NONE&quot;</span><span class="s1">] = </span><span class="s4">0</span><span class="s1">] = </span><span class="s2">&quot;NONE&quot;</span><span class="s1">;</span>
    <span class="s1">AsyncifyState[AsyncifyState[</span><span class="s2">&quot;UNWINDING&quot;</span><span class="s1">] = </span><span class="s4">1</span><span class="s1">] = </span><span class="s2">&quot;UNWINDING&quot;</span><span class="s1">;</span>
    <span class="s1">AsyncifyState[AsyncifyState[</span><span class="s2">&quot;REWINDING&quot;</span><span class="s1">] = </span><span class="s4">2</span><span class="s1">] = </span><span class="s2">&quot;REWINDING&quot;</span><span class="s1">;</span>
<span class="s1">})(AsyncifyState || (AsyncifyState = {}));</span>
<span class="s0">function </span><span class="s1">tryAllocate(instance, wasm64, size, mallocName) {</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s1">instance.exports[mallocName] !== </span><span class="s2">'function' </span><span class="s1">|| size &lt;= </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s0">return </span><span class="s1">{</span>
            <span class="s1">wasm64,</span>
            <span class="s1">dataPtr: </span><span class="s4">16</span><span class="s1">,</span>
            <span class="s1">start: wasm64 ? </span><span class="s4">32 </span><span class="s1">: </span><span class="s4">24</span><span class="s1">,</span>
            <span class="s1">end: </span><span class="s4">1024</span>
        <span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s0">const </span><span class="s1">malloc = instance.exports[mallocName];</span>
    <span class="s0">const </span><span class="s1">dataPtr = wasm64 ? Number(malloc(BigInt(</span><span class="s4">16</span><span class="s1">) + BigInt(size))) : malloc(</span><span class="s4">8 </span><span class="s1">+ size);</span>
    <span class="s0">if </span><span class="s1">(dataPtr === </span><span class="s4">0</span><span class="s1">) {</span>
        <span class="s0">throw new </span><span class="s1">Error(</span><span class="s2">'Allocate asyncify data failed'</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">return </span><span class="s1">wasm64</span>
        <span class="s1">? { wasm64, dataPtr, start: dataPtr + </span><span class="s4">16</span><span class="s1">, end: dataPtr + </span><span class="s4">16 </span><span class="s1">+ size }</span>
        <span class="s1">: { wasm64, dataPtr, start: dataPtr + </span><span class="s4">8</span><span class="s1">, end: dataPtr + </span><span class="s4">8 </span><span class="s1">+ size };</span>
<span class="s1">}</span>
<span class="s3">/** </span><span class="s5">@public </span><span class="s3">*/</span>
<span class="s0">export class </span><span class="s1">Asyncify {</span>
    <span class="s1">constructor() {</span>
        <span class="s0">this</span><span class="s1">.value = undefined;</span>
        <span class="s0">this</span><span class="s1">.exports = undefined;</span>
        <span class="s0">this</span><span class="s1">.dataPtr = </span><span class="s4">0</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s1">init(memory, instance, options) {</span>
        <span class="s0">var </span><span class="s1">_a, _b;</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.exports) {</span>
            <span class="s0">throw new </span><span class="s1">Error(</span><span class="s2">'Asyncify has been initialized'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s0">if </span><span class="s1">(!(memory </span><span class="s0">instanceof </span><span class="s1">_WebAssembly.Memory)) {</span>
            <span class="s0">throw new </span><span class="s1">TypeError(</span><span class="s2">'Require WebAssembly.Memory object'</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s0">const </span><span class="s1">exports = instance.exports;</span>
        <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i = </span><span class="s4">0</span><span class="s1">; i &lt; ignoreNames.length; ++i) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s1">exports[ignoreNames[i]] !== </span><span class="s2">'function'</span><span class="s1">) {</span>
                <span class="s0">throw new </span><span class="s1">TypeError(</span><span class="s2">'Invalid asyncify wasm'</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">let </span><span class="s1">address;</span>
        <span class="s0">const </span><span class="s1">wasm64 = Boolean(options.wasm64);</span>
        <span class="s0">if </span><span class="s1">(!options.tryAllocate) {</span>
            <span class="s1">address = {</span>
                <span class="s1">wasm64,</span>
                <span class="s1">dataPtr: </span><span class="s4">16</span><span class="s1">,</span>
                <span class="s1">start: wasm64 ? </span><span class="s4">32 </span><span class="s1">: </span><span class="s4">24</span><span class="s1">,</span>
                <span class="s1">end: </span><span class="s4">1024</span>
            <span class="s1">};</span>
        <span class="s1">}</span>
        <span class="s0">else </span><span class="s1">{</span>
            <span class="s0">if </span><span class="s1">(options.tryAllocate === </span><span class="s0">true</span><span class="s1">) {</span>
                <span class="s1">address = tryAllocate(instance, wasm64, </span><span class="s4">4096</span><span class="s1">, </span><span class="s2">'malloc'</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s0">else </span><span class="s1">{</span>
                <span class="s1">address = tryAllocate(instance, wasm64, (_a = options.tryAllocate.size) !== </span><span class="s0">null </span><span class="s1">&amp;&amp; _a !== </span><span class="s0">void </span><span class="s4">0 </span><span class="s1">? _a : </span><span class="s4">4096</span><span class="s1">, (_b = options.tryAllocate.name) !== </span><span class="s0">null </span><span class="s1">&amp;&amp; _b !== </span><span class="s0">void </span><span class="s4">0 </span><span class="s1">? _b : </span><span class="s2">'malloc'</span><span class="s1">);</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s0">this</span><span class="s1">.dataPtr = address.dataPtr;</span>
        <span class="s0">if </span><span class="s1">(wasm64) {</span>
            <span class="s0">new </span><span class="s1">BigInt64Array(memory.buffer, </span><span class="s0">this</span><span class="s1">.dataPtr).set([BigInt(address.start), BigInt(address.end)]);</span>
        <span class="s1">}</span>
        <span class="s0">else </span><span class="s1">{</span>
            <span class="s0">new </span><span class="s1">Int32Array(memory.buffer, </span><span class="s0">this</span><span class="s1">.dataPtr).set([address.start, address.end]);</span>
        <span class="s1">}</span>
        <span class="s0">this</span><span class="s1">.exports = </span><span class="s0">this</span><span class="s1">.wrapExports(exports, options.wrapExports);</span>
        <span class="s0">const </span><span class="s1">asyncifiedInstance = Object.create(_WebAssembly.Instance.prototype);</span>
        <span class="s1">Object.defineProperty(asyncifiedInstance, </span><span class="s2">'exports'</span><span class="s1">, { value: </span><span class="s0">this</span><span class="s1">.exports });</span>
        <span class="s3">// Object.setPrototypeOf(instance, Instance.prototype)</span>
        <span class="s0">return </span><span class="s1">asyncifiedInstance;</span>
    <span class="s1">}</span>
    <span class="s1">assertState() {</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.exports.asyncify_get_state() !== AsyncifyState.NONE) {</span>
            <span class="s0">throw new </span><span class="s1">Error(</span><span class="s2">'Asyncify state error'</span><span class="s1">);</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s1">wrapImportFunction(f) {</span>
        <span class="s3">// eslint-disable-next-line @typescript-eslint/no-this-alias</span>
        <span class="s0">const </span><span class="s1">_this = </span><span class="s0">this</span><span class="s1">;</span>
        <span class="s0">return </span><span class="s1">(</span><span class="s0">function </span><span class="s1">() {</span>
            <span class="s3">// eslint-disable-next-line no-unreachable-loop</span>
            <span class="s0">while </span><span class="s1">(_this.exports.asyncify_get_state() === AsyncifyState.REWINDING) {</span>
                <span class="s1">_this.exports.asyncify_stop_rewind();</span>
                <span class="s0">return </span><span class="s1">_this.value;</span>
            <span class="s1">}</span>
            <span class="s1">_this.assertState();</span>
            <span class="s0">const </span><span class="s1">v = f.apply(</span><span class="s0">this</span><span class="s1">, arguments);</span>
            <span class="s0">if </span><span class="s1">(!isPromiseLike(v))</span>
                <span class="s0">return </span><span class="s1">v;</span>
            <span class="s1">_this.exports.asyncify_start_unwind(_this.dataPtr);</span>
            <span class="s1">_this.value = v;</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s1">wrapImports(imports) {</span>
        <span class="s0">const </span><span class="s1">importObject = {};</span>
        <span class="s1">Object.keys(imports).forEach(k =&gt; {</span>
            <span class="s0">const </span><span class="s1">mod = imports[k];</span>
            <span class="s0">const </span><span class="s1">newModule = {};</span>
            <span class="s1">Object.keys(mod).forEach(name =&gt; {</span>
                <span class="s0">const </span><span class="s1">importValue = mod[name];</span>
                <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s1">importValue === </span><span class="s2">'function'</span><span class="s1">) {</span>
                    <span class="s1">newModule[name] = </span><span class="s0">this</span><span class="s1">.wrapImportFunction(importValue);</span>
                <span class="s1">}</span>
                <span class="s0">else </span><span class="s1">{</span>
                    <span class="s1">newModule[name] = importValue;</span>
                <span class="s1">}</span>
            <span class="s1">});</span>
            <span class="s1">importObject[k] = newModule;</span>
        <span class="s1">});</span>
        <span class="s0">return </span><span class="s1">importObject;</span>
    <span class="s1">}</span>
    <span class="s1">wrapExportFunction(f) {</span>
        <span class="s3">// eslint-disable-next-line @typescript-eslint/no-this-alias</span>
        <span class="s0">const </span><span class="s1">_this = </span><span class="s0">this</span><span class="s1">;</span>
        <span class="s0">return </span><span class="s1">(async </span><span class="s0">function </span><span class="s1">() {</span>
            <span class="s1">_this.assertState();</span>
            <span class="s0">let </span><span class="s1">ret = f.apply(</span><span class="s0">this</span><span class="s1">, arguments);</span>
            <span class="s0">while </span><span class="s1">(_this.exports.asyncify_get_state() === AsyncifyState.UNWINDING) {</span>
                <span class="s1">_this.exports.asyncify_stop_unwind();</span>
                <span class="s1">_this.value = </span><span class="s0">await </span><span class="s1">_this.value;</span>
                <span class="s1">_this.assertState();</span>
                <span class="s1">_this.exports.asyncify_start_rewind(_this.dataPtr);</span>
                <span class="s1">ret = f.call(</span><span class="s0">this</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s1">_this.assertState();</span>
            <span class="s0">return </span><span class="s1">ret;</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
    <span class="s1">wrapExports(exports, needWrap) {</span>
        <span class="s0">return </span><span class="s1">wrapInstanceExports(exports, (exportValue, name) =&gt; {</span>
            <span class="s0">let </span><span class="s1">ignore = ignoreNames.indexOf(name) !== -</span><span class="s4">1 </span><span class="s1">|| </span><span class="s0">typeof </span><span class="s1">exportValue !== </span><span class="s2">'function'</span><span class="s1">;</span>
            <span class="s0">if </span><span class="s1">(Array.isArray(needWrap)) {</span>
                <span class="s1">ignore = ignore || (needWrap.indexOf(name) === -</span><span class="s4">1</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s0">return </span><span class="s1">ignore ? exportValue : </span><span class="s0">this</span><span class="s1">.wrapExportFunction(exportValue);</span>
        <span class="s1">});</span>
    <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>