<html>
<head>
<title>revalidation-utils.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
revalidation-utils.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../src/server/revalidation-utils.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;import type { WorkStore } from './app-render/work-async-storage.external'</span><span class="s3">\n</span><span class="s1">import type { IncrementalCache } from './lib/incremental-cache'</span><span class="s3">\n</span><span class="s1">import { getCacheHandlers } from './use-cache/handlers'</span><span class="s3">\n\n</span><span class="s1">/** Run a callback, and execute any *new* revalidations added during its runtime. */</span><span class="s3">\n</span><span class="s1">export async function withExecuteRevalidates&lt;T&gt;(</span><span class="s3">\n  </span><span class="s1">store: WorkStore | undefined,</span><span class="s3">\n  </span><span class="s1">callback: () =&gt; Promise&lt;T&gt;</span><span class="s3">\n</span><span class="s1">): Promise&lt;T&gt; {</span><span class="s3">\n  </span><span class="s1">if (!store) {</span><span class="s3">\n    </span><span class="s1">return callback()</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">// If we executed any revalidates during the request, then we don't want to execute them again.</span><span class="s3">\n  </span><span class="s1">// save the state so we can check if anything changed after we're done running callbacks.</span><span class="s3">\n  </span><span class="s1">const savedRevalidationState = cloneRevalidationState(store)</span><span class="s3">\n  </span><span class="s1">try {</span><span class="s3">\n    </span><span class="s1">return await callback()</span><span class="s3">\n  </span><span class="s1">} finally {</span><span class="s3">\n    </span><span class="s1">// Check if we have any new revalidates, and if so, wait until they are all resolved.</span><span class="s3">\n    </span><span class="s1">const newRevalidates = diffRevalidationState(</span><span class="s3">\n      </span><span class="s1">savedRevalidationState,</span><span class="s3">\n      </span><span class="s1">cloneRevalidationState(store)</span><span class="s3">\n    </span><span class="s1">)</span><span class="s3">\n    </span><span class="s1">await executeRevalidates(store, newRevalidates)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">type RevalidationState = Required&lt;</span><span class="s3">\n  </span><span class="s1">Pick&lt;</span><span class="s3">\n    </span><span class="s1">WorkStore,</span><span class="s3">\n    </span><span class="s1">'pendingRevalidatedTags' | 'pendingRevalidates' | 'pendingRevalidateWrites'</span><span class="s3">\n  </span><span class="s1">&gt;</span><span class="s3">\n</span><span class="s1">&gt;</span><span class="s3">\n\n</span><span class="s1">function cloneRevalidationState(store: WorkStore): RevalidationState {</span><span class="s3">\n  </span><span class="s1">return {</span><span class="s3">\n    </span><span class="s1">pendingRevalidatedTags: store.pendingRevalidatedTags</span><span class="s3">\n      </span><span class="s1">? [...store.pendingRevalidatedTags]</span><span class="s3">\n      </span><span class="s1">: [],</span><span class="s3">\n    </span><span class="s1">pendingRevalidates: { ...store.pendingRevalidates },</span><span class="s3">\n    </span><span class="s1">pendingRevalidateWrites: store.pendingRevalidateWrites</span><span class="s3">\n      </span><span class="s1">? [...store.pendingRevalidateWrites]</span><span class="s3">\n      </span><span class="s1">: [],</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">function diffRevalidationState(</span><span class="s3">\n  </span><span class="s1">prev: RevalidationState,</span><span class="s3">\n  </span><span class="s1">curr: RevalidationState</span><span class="s3">\n</span><span class="s1">): RevalidationState {</span><span class="s3">\n  </span><span class="s1">const prevTags = new Set(prev.pendingRevalidatedTags)</span><span class="s3">\n  </span><span class="s1">const prevRevalidateWrites = new Set(prev.pendingRevalidateWrites)</span><span class="s3">\n  </span><span class="s1">return {</span><span class="s3">\n    </span><span class="s1">pendingRevalidatedTags: curr.pendingRevalidatedTags.filter(</span><span class="s3">\n      </span><span class="s1">(tag) =&gt; !prevTags.has(tag)</span><span class="s3">\n    </span><span class="s1">),</span><span class="s3">\n    </span><span class="s1">pendingRevalidates: Object.fromEntries(</span><span class="s3">\n      </span><span class="s1">Object.entries(curr.pendingRevalidates).filter(</span><span class="s3">\n        </span><span class="s1">([key]) =&gt; !(key in prev.pendingRevalidates)</span><span class="s3">\n      </span><span class="s1">)</span><span class="s3">\n    </span><span class="s1">),</span><span class="s3">\n    </span><span class="s1">pendingRevalidateWrites: curr.pendingRevalidateWrites.filter(</span><span class="s3">\n      </span><span class="s1">(promise) =&gt; !prevRevalidateWrites.has(promise)</span><span class="s3">\n    </span><span class="s1">),</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">async function revalidateTags(</span><span class="s3">\n  </span><span class="s1">tags: string[],</span><span class="s3">\n  </span><span class="s1">incrementalCache: IncrementalCache | undefined</span><span class="s3">\n</span><span class="s1">): Promise&lt;void&gt; {</span><span class="s3">\n  </span><span class="s1">if (tags.length === 0) {</span><span class="s3">\n    </span><span class="s1">return</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const promises: Promise&lt;void&gt;[] = []</span><span class="s3">\n\n  </span><span class="s1">if (incrementalCache) {</span><span class="s3">\n    </span><span class="s1">promises.push(incrementalCache.revalidateTag(tags))</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const handlers = getCacheHandlers()</span><span class="s3">\n  </span><span class="s1">if (handlers) {</span><span class="s3">\n    </span><span class="s1">for (const handler of handlers) {</span><span class="s3">\n      </span><span class="s1">promises.push(handler.expireTags(...tags))</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">await Promise.all(promises)</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">export async function executeRevalidates(</span><span class="s3">\n  </span><span class="s1">workStore: WorkStore,</span><span class="s3">\n  </span><span class="s1">state?: RevalidationState</span><span class="s3">\n</span><span class="s1">) {</span><span class="s3">\n  </span><span class="s1">const pendingRevalidatedTags =</span><span class="s3">\n    </span><span class="s1">state?.pendingRevalidatedTags ?? workStore.pendingRevalidatedTags ?? []</span><span class="s3">\n\n  </span><span class="s1">const pendingRevalidates =</span><span class="s3">\n    </span><span class="s1">state?.pendingRevalidates ?? workStore.pendingRevalidates ?? {}</span><span class="s3">\n\n  </span><span class="s1">const pendingRevalidateWrites =</span><span class="s3">\n    </span><span class="s1">state?.pendingRevalidateWrites ?? workStore.pendingRevalidateWrites ?? []</span><span class="s3">\n\n  </span><span class="s1">return Promise.all([</span><span class="s3">\n    </span><span class="s1">revalidateTags(pendingRevalidatedTags, workStore.incrementalCache),</span><span class="s3">\n    </span><span class="s1">...Object.values(pendingRevalidates),</span><span class="s3">\n    </span><span class="s1">...pendingRevalidateWrites,</span><span class="s3">\n  </span><span class="s1">])</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;executeRevalidates&quot;</span><span class="s0">,</span><span class="s1">&quot;withExecuteRevalidates&quot;</span><span class="s0">,</span><span class="s1">&quot;store&quot;</span><span class="s0">,</span><span class="s1">&quot;callback&quot;</span><span class="s0">,</span><span class="s1">&quot;savedRevalidationState&quot;</span><span class="s0">,</span><span class="s1">&quot;cloneRevalidationState&quot;</span><span class="s0">,</span><span class="s1">&quot;newRevalidates&quot;</span><span class="s0">,</span><span class="s1">&quot;diffRevalidationState&quot;</span><span class="s0">,</span><span class="s1">&quot;pendingRevalidatedTags&quot;</span><span class="s0">,</span><span class="s1">&quot;pendingRevalidates&quot;</span><span class="s0">,</span><span class="s1">&quot;pendingRevalidateWrites&quot;</span><span class="s0">,</span><span class="s1">&quot;prev&quot;</span><span class="s0">,</span><span class="s1">&quot;curr&quot;</span><span class="s0">,</span><span class="s1">&quot;prevTags&quot;</span><span class="s0">,</span><span class="s1">&quot;Set&quot;</span><span class="s0">,</span><span class="s1">&quot;prevRevalidateWrites&quot;</span><span class="s0">,</span><span class="s1">&quot;filter&quot;</span><span class="s0">,</span><span class="s1">&quot;tag&quot;</span><span class="s0">,</span><span class="s1">&quot;has&quot;</span><span class="s0">,</span><span class="s1">&quot;Object&quot;</span><span class="s0">,</span><span class="s1">&quot;fromEntries&quot;</span><span class="s0">,</span><span class="s1">&quot;entries&quot;</span><span class="s0">,</span><span class="s1">&quot;key&quot;</span><span class="s0">,</span><span class="s1">&quot;promise&quot;</span><span class="s0">,</span><span class="s1">&quot;revalidateTags&quot;</span><span class="s0">,</span><span class="s1">&quot;tags&quot;</span><span class="s0">,</span><span class="s1">&quot;incrementalCache&quot;</span><span class="s0">,</span><span class="s1">&quot;length&quot;</span><span class="s0">,</span><span class="s1">&quot;promises&quot;</span><span class="s0">,</span><span class="s1">&quot;push&quot;</span><span class="s0">,</span><span class="s1">&quot;revalidateTag&quot;</span><span class="s0">,</span><span class="s1">&quot;handlers&quot;</span><span class="s0">,</span><span class="s1">&quot;getCacheHandlers&quot;</span><span class="s0">,</span><span class="s1">&quot;handler&quot;</span><span class="s0">,</span><span class="s1">&quot;expireTags&quot;</span><span class="s0">,</span><span class="s1">&quot;Promise&quot;</span><span class="s0">,</span><span class="s1">&quot;all&quot;</span><span class="s0">,</span><span class="s1">&quot;workStore&quot;</span><span class="s0">,</span><span class="s1">&quot;state&quot;</span><span class="s0">,</span><span class="s1">&quot;values&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;;;;;;;;;;;;IA2FsBA,kBAAkB;eAAlBA;;IAtFAC,sBAAsB;eAAtBA;;;0BAHW;AAG1B,eAAeA,uBACpBC,KAA4B,EAC5BC,QAA0B;IAE1B,IAAI,CAACD,OAAO;QACV,OAAOC;IACT;IACA,+FAA+F;IAC/F,yFAAyF;IACzF,MAAMC,yBAAyBC,uBAAuBH;IACtD,IAAI;QACF,OAAO,MAAMC;IACf,SAAU;QACR,qFAAqF;QACrF,MAAMG,iBAAiBC,sBACrBH,wBACAC,uBAAuBH;QAEzB,MAAMF,mBAAmBE,OAAOI;IAClC;AACF;AASA,SAASD,uBAAuBH,KAAgB;IAC9C,OAAO;QACLM,wBAAwBN,MAAMM,sBAAsB,GAChD;eAAIN,MAAMM,sBAAsB;SAAC,GACjC,EAAE;QACNC,oBAAoB;YAAE,GAAGP,MAAMO,kBAAkB;QAAC;QAClDC,yBAAyBR,MAAMQ,uBAAuB,GAClD;eAAIR,MAAMQ,uBAAuB;SAAC,GAClC,EAAE;IACR;AACF;AAEA,SAASH,sBACPI,IAAuB,EACvBC,IAAuB;IAEvB,MAAMC,WAAW,IAAIC,IAAIH,KAAKH,sBAAsB;IACpD,MAAMO,uBAAuB,IAAID,IAAIH,KAAKD,uBAAuB;IACjE,OAAO;QACLF,wBAAwBI,KAAKJ,sBAAsB,CAACQ,MAAM,CACxD,CAACC,MAAQ,CAACJ,SAASK,GAAG,CAACD;QAEzBR,oBAAoBU,OAAOC,WAAW,CACpCD,OAAOE,OAAO,CAACT,KAAKH,kBAAkB,EAAEO,MAAM,CAC5C,CAAC,CAACM,IAAI,GAAK,CAAEA,CAAAA,OAAOX,KAAKF,kBAAkB,AAAD;QAG9CC,yBAAyBE,KAAKF,uBAAuB,CAACM,MAAM,CAC1D,CAACO,UAAY,CAACR,qBAAqBG,GAAG,CAACK;IAE3C;AACF;AAEA,eAAeC,eACbC,IAAc,EACdC,gBAA8C;IAE9C,IAAID,KAAKE,MAAM,KAAK,GAAG;QACrB;IACF;IAEA,MAAMC,WAA4B,EAAE;IAEpC,IAAIF,kBAAkB;QACpBE,SAASC,IAAI,CAACH,iBAAiBI,aAAa,CAACL;IAC/C;IAEA,MAAMM,WAAWC,IAAAA,0BAAgB;IACjC,IAAID,UAAU;QACZ,KAAK,MAAME,WAAWF,SAAU;YAC9BH,SAASC,IAAI,CAACI,QAAQC,UAAU,IAAIT;QACtC;IACF;IAEA,MAAMU,QAAQC,GAAG,CAACR;AACpB;AAEO,eAAe5B,mBACpBqC,SAAoB,EACpBC,KAAyB;IAEzB,MAAM9B,yBACJ8B,CAAAA,yBAAAA,MAAO9B,sBAAsB,KAAI6B,UAAU7B,sBAAsB,IAAI,EAAE;IAEzE,MAAMC,qBACJ6B,CAAAA,yBAAAA,MAAO7B,kBAAkB,KAAI4B,UAAU5B,kBAAkB,IAAI,CAAC;IAEhE,MAAMC,0BACJ4B,CAAAA,yBAAAA,MAAO5B,uBAAuB,KAAI2B,UAAU3B,uBAAuB,IAAI,EAAE;IAE3E,OAAOyB,QAAQC,GAAG,CAAC;QACjBZ,eAAehB,wBAAwB6B,UAAUX,gBAAgB;WAC9DP,OAAOoB,MAAM,CAAC9B;WACdC;KACJ;AACH&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>