<html>
<head>
<title>clone-response.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
clone-response.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../src/server/lib/clone-response.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;const noop = () =&gt; {}</span><span class="s3">\n\n</span><span class="s1">let registry: FinalizationRegistry&lt;WeakRef&lt;ReadableStream&gt;&gt; | undefined</span><span class="s3">\n\n</span><span class="s1">if (globalThis.FinalizationRegistry) {</span><span class="s3">\n  </span><span class="s1">registry = new FinalizationRegistry((weakRef: WeakRef&lt;ReadableStream&gt;) =&gt; {</span><span class="s3">\n    </span><span class="s1">const stream = weakRef.deref()</span><span class="s3">\n    </span><span class="s1">if (stream &amp;&amp; !stream.locked) {</span><span class="s3">\n      </span><span class="s1">stream.cancel('Response object has been garbage collected').then(noop)</span><span class="s3">\n    </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">/**</span><span class="s3">\n </span><span class="s1">* Clones a response by teeing the body so we can return two independent</span><span class="s3">\n </span><span class="s1">* ReadableStreams from it. This avoids the bug in the undici library around</span><span class="s3">\n </span><span class="s1">* response cloning.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* After cloning, the original response's body will be consumed and closed.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* @see https://github.com/vercel/next.js/pull/73274</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* @param original - The original response to clone.</span><span class="s3">\n </span><span class="s1">* @returns A tuple containing two independent clones of the original response.</span><span class="s3">\n </span><span class="s1">*/</span><span class="s3">\n</span><span class="s1">export function cloneResponse(original: Response): [Response, Response] {</span><span class="s3">\n  </span><span class="s1">// If the response has no body, then we can just return the original response</span><span class="s3">\n  </span><span class="s1">// twice because it's immutable.</span><span class="s3">\n  </span><span class="s1">if (!original.body) {</span><span class="s3">\n    </span><span class="s1">return [original, original]</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const [body1, body2] = original.body.tee()</span><span class="s3">\n\n  </span><span class="s1">const cloned1 = new Response(body1, {</span><span class="s3">\n    </span><span class="s1">status: original.status,</span><span class="s3">\n    </span><span class="s1">statusText: original.statusText,</span><span class="s3">\n    </span><span class="s1">headers: original.headers,</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">Object.defineProperty(cloned1, 'url', {</span><span class="s3">\n    </span><span class="s1">value: original.url,</span><span class="s3">\n    </span><span class="s1">// How the original response.url behaves</span><span class="s3">\n    </span><span class="s1">configurable: true,</span><span class="s3">\n    </span><span class="s1">enumerable: true,</span><span class="s3">\n    </span><span class="s1">writable: false,</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">// The Fetch Standard allows users to skip consuming the response body by</span><span class="s3">\n  </span><span class="s1">// relying on garbage collection to release connection resources.</span><span class="s3">\n  </span><span class="s1">// https://github.com/nodejs/undici?tab=readme-ov-file#garbage-collection</span><span class="s3">\n  </span><span class="s1">//</span><span class="s3">\n  </span><span class="s1">// To cancel the stream you then need to cancel both resulting branches.</span><span class="s3">\n  </span><span class="s1">// Teeing a stream will generally lock it for the duration, preventing other</span><span class="s3">\n  </span><span class="s1">// readers from locking it.</span><span class="s3">\n  </span><span class="s1">// https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream/tee</span><span class="s3">\n\n  </span><span class="s1">// cloned2 is stored in a react cache and cloned for subsequent requests.</span><span class="s3">\n  </span><span class="s1">// It is the original request, and is is garbage collected by a</span><span class="s3">\n  </span><span class="s1">// FinalizationRegistry in Undici, but since we're tee-ing the stream</span><span class="s3">\n  </span><span class="s1">// ourselves, we need to cancel clone1's stream (the response returned from</span><span class="s3">\n  </span><span class="s1">// our dedupe fetch) when clone1 is reclaimed, otherwise we leak memory.</span><span class="s3">\n  </span><span class="s1">if (registry &amp;&amp; cloned1.body) {</span><span class="s3">\n    </span><span class="s1">registry.register(cloned1, new WeakRef(cloned1.body))</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n\n  </span><span class="s1">const cloned2 = new Response(body2, {</span><span class="s3">\n    </span><span class="s1">status: original.status,</span><span class="s3">\n    </span><span class="s1">statusText: original.statusText,</span><span class="s3">\n    </span><span class="s1">headers: original.headers,</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">Object.defineProperty(cloned2, 'url', {</span><span class="s3">\n    </span><span class="s1">value: original.url,</span><span class="s3">\n    </span><span class="s1">// How the original response.url behaves</span><span class="s3">\n    </span><span class="s1">configurable: true,</span><span class="s3">\n    </span><span class="s1">enumerable: true,</span><span class="s3">\n    </span><span class="s1">writable: false,</span><span class="s3">\n  </span><span class="s1">})</span><span class="s3">\n\n  </span><span class="s1">return [cloned1, cloned2]</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;cloneResponse&quot;</span><span class="s0">,</span><span class="s1">&quot;noop&quot;</span><span class="s0">,</span><span class="s1">&quot;registry&quot;</span><span class="s0">,</span><span class="s1">&quot;globalThis&quot;</span><span class="s0">,</span><span class="s1">&quot;FinalizationRegistry&quot;</span><span class="s0">,</span><span class="s1">&quot;weakRef&quot;</span><span class="s0">,</span><span class="s1">&quot;stream&quot;</span><span class="s0">,</span><span class="s1">&quot;deref&quot;</span><span class="s0">,</span><span class="s1">&quot;locked&quot;</span><span class="s0">,</span><span class="s1">&quot;cancel&quot;</span><span class="s0">,</span><span class="s1">&quot;then&quot;</span><span class="s0">,</span><span class="s1">&quot;original&quot;</span><span class="s0">,</span><span class="s1">&quot;body&quot;</span><span class="s0">,</span><span class="s1">&quot;body1&quot;</span><span class="s0">,</span><span class="s1">&quot;body2&quot;</span><span class="s0">,</span><span class="s1">&quot;tee&quot;</span><span class="s0">,</span><span class="s1">&quot;cloned1&quot;</span><span class="s0">,</span><span class="s1">&quot;Response&quot;</span><span class="s0">,</span><span class="s1">&quot;status&quot;</span><span class="s0">,</span><span class="s1">&quot;statusText&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;Object&quot;</span><span class="s0">,</span><span class="s1">&quot;defineProperty&quot;</span><span class="s0">,</span><span class="s1">&quot;value&quot;</span><span class="s0">,</span><span class="s1">&quot;url&quot;</span><span class="s0">,</span><span class="s1">&quot;configurable&quot;</span><span class="s0">,</span><span class="s1">&quot;enumerable&quot;</span><span class="s0">,</span><span class="s1">&quot;writable&quot;</span><span class="s0">,</span><span class="s1">&quot;register&quot;</span><span class="s0">,</span><span class="s1">&quot;WeakRef&quot;</span><span class="s0">,</span><span class="s1">&quot;cloned2&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;;;;;+BAyBgBA;;;eAAAA;;;AAzBhB,MAAMC,OAAO,KAAO;AAEpB,IAAIC;AAEJ,IAAIC,WAAWC,oBAAoB,EAAE;IACnCF,WAAW,IAAIE,qBAAqB,CAACC;QACnC,MAAMC,SAASD,QAAQE,KAAK;QAC5B,IAAID,UAAU,CAACA,OAAOE,MAAM,EAAE;YAC5BF,OAAOG,MAAM,CAAC,8CAA8CC,IAAI,CAACT;QACnE;IACF;AACF;AAcO,SAASD,cAAcW,QAAkB;IAC9C,6EAA6E;IAC7E,gCAAgC;IAChC,IAAI,CAACA,SAASC,IAAI,EAAE;QAClB,OAAO;YAACD;YAAUA;SAAS;IAC7B;IAEA,MAAM,CAACE,OAAOC,MAAM,GAAGH,SAASC,IAAI,CAACG,GAAG;IAExC,MAAMC,UAAU,IAAIC,SAASJ,OAAO;QAClCK,QAAQP,SAASO,MAAM;QACvBC,YAAYR,SAASQ,UAAU;QAC/BC,SAAST,SAASS,OAAO;IAC3B;IAEAC,OAAOC,cAAc,CAACN,SAAS,OAAO;QACpCO,OAAOZ,SAASa,GAAG;QACnB,wCAAwC;QACxCC,cAAc;QACdC,YAAY;QACZC,UAAU;IACZ;IAEA,yEAAyE;IACzE,iEAAiE;IACjE,yEAAyE;IACzE,EAAE;IACF,wEAAwE;IACxE,4EAA4E;IAC5E,2BAA2B;IAC3B,sEAAsE;IAEtE,yEAAyE;IACzE,+DAA+D;IAC/D,qEAAqE;IACrE,2EAA2E;IAC3E,wEAAwE;IACxE,IAAIzB,YAAYc,QAAQJ,IAAI,EAAE;QAC5BV,SAAS0B,QAAQ,CAACZ,SAAS,IAAIa,QAAQb,QAAQJ,IAAI;IACrD;IAEA,MAAMkB,UAAU,IAAIb,SAASH,OAAO;QAClCI,QAAQP,SAASO,MAAM;QACvBC,YAAYR,SAASQ,UAAU;QAC/BC,SAAST,SAASS,OAAO;IAC3B;IAEAC,OAAOC,cAAc,CAACQ,SAAS,OAAO;QACpCP,OAAOZ,SAASa,GAAG;QACnB,wCAAwC;QACxCC,cAAc;QACdC,YAAY;QACZC,UAAU;IACZ;IAEA,OAAO;QAACX;QAASc;KAAQ;AAC3B&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>