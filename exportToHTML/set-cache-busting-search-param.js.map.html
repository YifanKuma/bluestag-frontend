<html>
<head>
<title>set-cache-busting-search-param.js.map</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #080808;}
.s1 { color: #067d17;}
.s2 { color: #1750eb;}
.s3 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
set-cache-busting-search-param.js.map</font>
</center></td></tr></table>
<pre><span class="s0">{</span><span class="s1">&quot;version&quot;</span><span class="s0">:</span><span class="s2">3</span><span class="s0">,</span><span class="s1">&quot;sources&quot;</span><span class="s0">:[</span><span class="s1">&quot;../../../../src/client/components/router-reducer/set-cache-busting-search-param.ts&quot;</span><span class="s0">],</span><span class="s1">&quot;sourcesContent&quot;</span><span class="s0">:[</span><span class="s1">&quot;'use client'</span><span class="s3">\n\n</span><span class="s1">import { computeCacheBustingSearchParam } from '../../../shared/lib/router/utils/cache-busting-search-param'</span><span class="s3">\n</span><span class="s1">import {</span><span class="s3">\n  </span><span class="s1">NEXT_ROUTER_PREFETCH_HEADER,</span><span class="s3">\n  </span><span class="s1">NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,</span><span class="s3">\n  </span><span class="s1">NEXT_ROUTER_STATE_TREE_HEADER,</span><span class="s3">\n  </span><span class="s1">NEXT_URL,</span><span class="s3">\n  </span><span class="s1">NEXT_RSC_UNION_QUERY,</span><span class="s3">\n</span><span class="s1">} from '../app-router-headers'</span><span class="s3">\n</span><span class="s1">import type { RequestHeaders } from './fetch-server-response'</span><span class="s3">\n\n</span><span class="s1">/**</span><span class="s3">\n </span><span class="s1">* Mutates the provided URL by adding a cache-busting search parameter for CDNs that don't</span><span class="s3">\n </span><span class="s1">* support custom headers. This helps avoid caching conflicts by making each request unique.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* Rather than relying on the Vary header which some CDNs ignore, we append a search param</span><span class="s3">\n </span><span class="s1">* to create a unique URL that forces a fresh request.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* Example:</span><span class="s3">\n </span><span class="s1">* URL before: https://example.com/path?query=1</span><span class="s3">\n </span><span class="s1">* URL after: https://example.com/path?query=1&amp;_rsc=abc123</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* Note: This function mutates the input URL directly and does not return anything.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* TODO: Since we need to use a search param anyway, we could simplify by removing the custom</span><span class="s3">\n </span><span class="s1">* headers approach entirely and just use search params.</span><span class="s3">\n </span><span class="s1">*/</span><span class="s3">\n</span><span class="s1">export const setCacheBustingSearchParam = (</span><span class="s3">\n  </span><span class="s1">url: URL,</span><span class="s3">\n  </span><span class="s1">headers: RequestHeaders</span><span class="s3">\n</span><span class="s1">): void =&gt; {</span><span class="s3">\n  </span><span class="s1">const uniqueCacheKey = computeCacheBustingSearchParam(</span><span class="s3">\n    </span><span class="s1">headers[NEXT_ROUTER_PREFETCH_HEADER],</span><span class="s3">\n    </span><span class="s1">headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER],</span><span class="s3">\n    </span><span class="s1">headers[NEXT_ROUTER_STATE_TREE_HEADER],</span><span class="s3">\n    </span><span class="s1">headers[NEXT_URL]</span><span class="s3">\n  </span><span class="s1">)</span><span class="s3">\n  </span><span class="s1">setCacheBustingSearchParamWithHash(url, uniqueCacheKey)</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n\n</span><span class="s1">/**</span><span class="s3">\n </span><span class="s1">* Sets a cache-busting search parameter on a URL using a provided hash value.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* This function performs the same logic as `setCacheBustingSearchParam` but accepts</span><span class="s3">\n </span><span class="s1">* a pre-computed hash instead of computing it from headers.</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* Example:</span><span class="s3">\n </span><span class="s1">* URL before: https://example.com/path?query=1</span><span class="s3">\n </span><span class="s1">* hash: </span><span class="s3">\&quot;</span><span class="s1">abc123</span><span class="s3">\&quot;\n </span><span class="s1">* URL after: https://example.com/path?query=1&amp;_rsc=abc123</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* If the hash is null, we will set `_rsc` search param without a value.</span><span class="s3">\n </span><span class="s1">* Like this: https://example.com/path?query=1&amp;_rsc</span><span class="s3">\n </span><span class="s1">*</span><span class="s3">\n </span><span class="s1">* Note: This function mutates the input URL directly and does not return anything.</span><span class="s3">\n </span><span class="s1">*/</span><span class="s3">\n</span><span class="s1">export const setCacheBustingSearchParamWithHash = (</span><span class="s3">\n  </span><span class="s1">url: URL,</span><span class="s3">\n  </span><span class="s1">hash: string</span><span class="s3">\n</span><span class="s1">): void =&gt; {</span><span class="s3">\n  </span><span class="s1">/**</span><span class="s3">\n   </span><span class="s1">* Note that we intentionally do not use `url.searchParams.set` here:</span><span class="s3">\n   </span><span class="s1">*</span><span class="s3">\n   </span><span class="s1">* const url = new URL('https://example.com/search?q=custom%20spacing');</span><span class="s3">\n   </span><span class="s1">* url.searchParams.set('_rsc', 'abc123');</span><span class="s3">\n   </span><span class="s1">* console.log(url.toString()); // Outputs: https://example.com/search?q=custom+spacing&amp;_rsc=abc123</span><span class="s3">\n   </span><span class="s1">*                                                                             ^ &lt;--- this is causing confusion</span><span class="s3">\n   </span><span class="s1">* This is in fact intended based on https://url.spec.whatwg.org/#interface-urlsearchparams, but</span><span class="s3">\n   </span><span class="s1">* we want to preserve the %20 as %20 if that's what the user passed in, hence the custom</span><span class="s3">\n   </span><span class="s1">* logic below.</span><span class="s3">\n   </span><span class="s1">*/</span><span class="s3">\n  </span><span class="s1">const existingSearch = url.search</span><span class="s3">\n  </span><span class="s1">const rawQuery = existingSearch.startsWith('?')</span><span class="s3">\n    </span><span class="s1">? existingSearch.slice(1)</span><span class="s3">\n    </span><span class="s1">: existingSearch</span><span class="s3">\n\n  </span><span class="s1">// Always remove any existing cache busting param and add a fresh one to ensure</span><span class="s3">\n  </span><span class="s1">// we have the correct value based on current request headers</span><span class="s3">\n  </span><span class="s1">const pairs = rawQuery</span><span class="s3">\n    </span><span class="s1">.split('&amp;')</span><span class="s3">\n    </span><span class="s1">.filter((pair) =&gt; pair &amp;&amp; !pair.startsWith(`${NEXT_RSC_UNION_QUERY}=`))</span><span class="s3">\n\n  </span><span class="s1">if (hash.length &gt; 0) {</span><span class="s3">\n    </span><span class="s1">pairs.push(`${NEXT_RSC_UNION_QUERY}=${hash}`)</span><span class="s3">\n  </span><span class="s1">} else {</span><span class="s3">\n    </span><span class="s1">pairs.push(`${NEXT_RSC_UNION_QUERY}`)</span><span class="s3">\n  </span><span class="s1">}</span><span class="s3">\n  </span><span class="s1">url.search = pairs.length ? `?${pairs.join('&amp;')}` : ''</span><span class="s3">\n</span><span class="s1">}</span><span class="s3">\n</span><span class="s1">&quot;</span><span class="s0">],</span><span class="s1">&quot;names&quot;</span><span class="s0">:[</span><span class="s1">&quot;setCacheBustingSearchParam&quot;</span><span class="s0">,</span><span class="s1">&quot;setCacheBustingSearchParamWithHash&quot;</span><span class="s0">,</span><span class="s1">&quot;url&quot;</span><span class="s0">,</span><span class="s1">&quot;headers&quot;</span><span class="s0">,</span><span class="s1">&quot;uniqueCacheKey&quot;</span><span class="s0">,</span><span class="s1">&quot;computeCacheBustingSearchParam&quot;</span><span class="s0">,</span><span class="s1">&quot;NEXT_ROUTER_PREFETCH_HEADER&quot;</span><span class="s0">,</span><span class="s1">&quot;NEXT_ROUTER_SEGMENT_PREFETCH_HEADER&quot;</span><span class="s0">,</span><span class="s1">&quot;NEXT_ROUTER_STATE_TREE_HEADER&quot;</span><span class="s0">,</span><span class="s1">&quot;NEXT_URL&quot;</span><span class="s0">,</span><span class="s1">&quot;hash&quot;</span><span class="s0">,</span><span class="s1">&quot;existingSearch&quot;</span><span class="s0">,</span><span class="s1">&quot;search&quot;</span><span class="s0">,</span><span class="s1">&quot;rawQuery&quot;</span><span class="s0">,</span><span class="s1">&quot;startsWith&quot;</span><span class="s0">,</span><span class="s1">&quot;slice&quot;</span><span class="s0">,</span><span class="s1">&quot;pairs&quot;</span><span class="s0">,</span><span class="s1">&quot;split&quot;</span><span class="s0">,</span><span class="s1">&quot;filter&quot;</span><span class="s0">,</span><span class="s1">&quot;pair&quot;</span><span class="s0">,</span><span class="s1">&quot;NEXT_RSC_UNION_QUERY&quot;</span><span class="s0">,</span><span class="s1">&quot;length&quot;</span><span class="s0">,</span><span class="s1">&quot;push&quot;</span><span class="s0">,</span><span class="s1">&quot;join&quot;</span><span class="s0">],</span><span class="s1">&quot;mappings&quot;</span><span class="s0">:</span><span class="s1">&quot;AAAA;;;;;;;;;;;;;;;;IA4BaA,0BAA0B;eAA1BA;;IA6BAC,kCAAkC;eAAlCA;;;yCAvDkC;kCAOxC;AAmBA,MAAMD,6BAA6B,CACxCE,KACAC;IAEA,MAAMC,iBAAiBC,IAAAA,uDAA8B,EACnDF,OAAO,CAACG,6CAA2B,CAAC,EACpCH,OAAO,CAACI,qDAAmC,CAAC,EAC5CJ,OAAO,CAACK,+CAA6B,CAAC,EACtCL,OAAO,CAACM,0BAAQ,CAAC;IAEnBR,mCAAmCC,KAAKE;AAC1C;AAkBO,MAAMH,qCAAqC,CAChDC,KACAQ;IAEA;;;;;;;;;;GAUC,GACD,MAAMC,iBAAiBT,IAAIU,MAAM;IACjC,MAAMC,WAAWF,eAAeG,UAAU,CAAC,OACvCH,eAAeI,KAAK,CAAC,KACrBJ;IAEJ,+EAA+E;IAC/E,6DAA6D;IAC7D,MAAMK,QAAQH,SACXI,KAAK,CAAC,KACNC,MAAM,CAAC,CAACC,OAASA,QAAQ,CAACA,KAAKL,UAAU,CAAC,AAAC,KAAEM,sCAAoB,GAAC;IAErE,IAAIV,KAAKW,MAAM,GAAG,GAAG;QACnBL,MAAMM,IAAI,CAAC,AAAGF,sCAAoB,GAAC,MAAGV;IACxC,OAAO;QACLM,MAAMM,IAAI,CAAC,AAAC,KAAEF,sCAAoB;IACpC;IACAlB,IAAIU,MAAM,GAAGI,MAAMK,MAAM,GAAG,AAAC,MAAGL,MAAMO,IAAI,CAAC,OAAS;AACtD&quot;</span><span class="s0">,</span><span class="s1">&quot;ignoreList&quot;</span><span class="s0">:[</span><span class="s2">0</span><span class="s0">]}</span></pre>
</body>
</html>