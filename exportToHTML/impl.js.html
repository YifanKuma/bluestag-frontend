<html>
<head>
<title>impl.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #1750eb;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #0037a6;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
impl.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">Object.defineProperty(exports, </span><span class="s0">&quot;__esModule&quot;</span><span class="s1">, {</span>
    <span class="s1">value: </span><span class="s2">true</span>
<span class="s1">});</span>
<span class="s3">0 </span><span class="s1">&amp;&amp; (module.exports = {</span>
    <span class="s1">turbopackBuild: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">waitForShutdown: </span><span class="s2">null</span><span class="s1">,</span>
    <span class="s1">workerMain: </span><span class="s2">null</span>
<span class="s1">});</span>
<span class="s2">function </span><span class="s1">_export(target, all) {</span>
    <span class="s2">for</span><span class="s1">(</span><span class="s2">var </span><span class="s1">name </span><span class="s2">in </span><span class="s1">all)Object.defineProperty(target, name, {</span>
        <span class="s1">enumerable: </span><span class="s2">true</span><span class="s1">,</span>
        <span class="s1">get: all[name]</span>
    <span class="s1">});</span>
<span class="s1">}</span>
<span class="s1">_export(exports, {</span>
    <span class="s1">turbopackBuild: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">turbopackBuild;</span>
    <span class="s1">},</span>
    <span class="s1">waitForShutdown: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">waitForShutdown;</span>
    <span class="s1">},</span>
    <span class="s1">workerMain: </span><span class="s2">function</span><span class="s1">() {</span>
        <span class="s2">return </span><span class="s1">workerMain;</span>
    <span class="s1">}</span>
<span class="s1">});</span>
<span class="s2">const </span><span class="s1">_path = </span><span class="s4">/*#__PURE__*/ </span><span class="s1">_interop_require_default(require(</span><span class="s0">&quot;path&quot;</span><span class="s1">));</span>
<span class="s2">const </span><span class="s1">_turbopackwarning = require(</span><span class="s0">&quot;../../lib/turbopack-warning&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_utils = require(</span><span class="s0">&quot;../../shared/lib/turbopack/utils&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_buildcontext = require(</span><span class="s0">&quot;../build-context&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_swc = require(</span><span class="s0">&quot;../swc&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_handleentrypoints = require(</span><span class="s0">&quot;../handle-entrypoints&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_manifestloader = require(</span><span class="s0">&quot;../../shared/lib/turbopack/manifest-loader&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_fs = require(</span><span class="s0">&quot;fs&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_constants = require(</span><span class="s0">&quot;../../shared/lib/constants&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_config = </span><span class="s4">/*#__PURE__*/ </span><span class="s1">_interop_require_default(require(</span><span class="s0">&quot;../../server/config&quot;</span><span class="s1">));</span>
<span class="s2">const </span><span class="s1">_utils1 = require(</span><span class="s0">&quot;../../export/utils&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_storage = require(</span><span class="s0">&quot;../../telemetry/storage&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_trace = require(</span><span class="s0">&quot;../../trace&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_ciinfo = require(</span><span class="s0">&quot;../../server/ci-info&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_compilationevents = require(</span><span class="s0">&quot;../../shared/lib/turbopack/compilation-events&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_utils2 = require(</span><span class="s0">&quot;../utils&quot;</span><span class="s1">);</span>
<span class="s2">const </span><span class="s1">_normalizepath = require(</span><span class="s0">&quot;../../lib/normalize-path&quot;</span><span class="s1">);</span>
<span class="s2">function </span><span class="s1">_interop_require_default(obj) {</span>
    <span class="s2">return </span><span class="s1">obj &amp;&amp; obj.__esModule ? obj : {</span>
        <span class="s2">default</span><span class="s1">: obj</span>
    <span class="s1">};</span>
<span class="s1">}</span>
<span class="s1">async </span><span class="s2">function </span><span class="s1">turbopackBuild() {</span>
    <span class="s2">var </span><span class="s1">_config_experimental, _config_turbopack, _config_turbopack1, _config_experimental1;</span>
    <span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _turbopackwarning.validateTurboNextConfig)({</span>
        <span class="s1">dir: _buildcontext.NextBuildContext.dir,</span>
        <span class="s1">isDev: </span><span class="s2">false</span>
    <span class="s1">});</span>
    <span class="s2">const </span><span class="s1">config = _buildcontext.NextBuildContext.config;</span>
    <span class="s2">const </span><span class="s1">dir = _buildcontext.NextBuildContext.dir;</span>
    <span class="s2">const </span><span class="s1">distDir = _buildcontext.NextBuildContext.distDir;</span>
    <span class="s2">const </span><span class="s1">buildId = _buildcontext.NextBuildContext.buildId;</span>
    <span class="s2">const </span><span class="s1">encryptionKey = _buildcontext.NextBuildContext.encryptionKey;</span>
    <span class="s2">const </span><span class="s1">previewProps = _buildcontext.NextBuildContext.previewProps;</span>
    <span class="s2">const </span><span class="s1">hasRewrites = _buildcontext.NextBuildContext.hasRewrites;</span>
    <span class="s2">const </span><span class="s1">rewrites = _buildcontext.NextBuildContext.rewrites;</span>
    <span class="s2">const </span><span class="s1">appDirOnly = _buildcontext.NextBuildContext.appDirOnly;</span>
    <span class="s2">const </span><span class="s1">noMangling = _buildcontext.NextBuildContext.noMangling;</span>
    <span class="s2">const </span><span class="s1">currentNodeJsVersion = process.versions.node;</span>
    <span class="s2">const </span><span class="s1">startTime = process.hrtime();</span>
    <span class="s2">const </span><span class="s1">bindings = </span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _swc.loadBindings)(config == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: (_config_experimental = config.experimental) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _config_experimental.useWasmBinary);</span>
    <span class="s2">const </span><span class="s1">dev = </span><span class="s2">false</span><span class="s1">;</span>
    <span class="s2">const </span><span class="s1">supportedBrowsers = (</span><span class="s3">0</span><span class="s1">, _utils2.getSupportedBrowsers)(dir, dev);</span>
    <span class="s2">const </span><span class="s1">persistentCaching = (</span><span class="s3">0</span><span class="s1">, _utils.isPersistentCachingEnabled)(config);</span>
    <span class="s2">const </span><span class="s1">rootPath = ((_config_turbopack = config.turbopack) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _config_turbopack.root) || config.outputFileTracingRoot || dir;</span>
    <span class="s2">const </span><span class="s1">project = </span><span class="s2">await </span><span class="s1">bindings.turbo.createProject({</span>
        <span class="s1">rootPath: ((_config_turbopack1 = config.turbopack) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _config_turbopack1.root) || config.outputFileTracingRoot || dir,</span>
        <span class="s1">projectPath: (</span><span class="s3">0</span><span class="s1">, _normalizepath.normalizePath)(_path.default.relative(rootPath, dir) || </span><span class="s0">'.'</span><span class="s1">),</span>
        <span class="s1">distDir,</span>
        <span class="s1">nextConfig: config,</span>
        <span class="s1">jsConfig: </span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _utils.getTurbopackJsConfig)(dir, config),</span>
        <span class="s1">watch: {</span>
            <span class="s1">enable: </span><span class="s2">false</span>
        <span class="s1">},</span>
        <span class="s1">dev,</span>
        <span class="s1">env: process.env,</span>
        <span class="s1">defineEnv: (</span><span class="s3">0</span><span class="s1">, _swc.createDefineEnv)({</span>
            <span class="s1">isTurbopack: </span><span class="s2">true</span><span class="s1">,</span>
            <span class="s1">clientRouterFilters: _buildcontext.NextBuildContext.clientRouterFilters,</span>
            <span class="s1">config,</span>
            <span class="s1">dev,</span>
            <span class="s1">distDir,</span>
            <span class="s1">projectPath: dir,</span>
            <span class="s1">fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,</span>
            <span class="s1">hasRewrites,</span>
            <span class="s4">// Implemented separately in Turbopack, doesn't have to be passed here.</span>
            <span class="s1">middlewareMatchers: undefined,</span>
            <span class="s1">rewrites</span>
        <span class="s1">}),</span>
        <span class="s1">buildId,</span>
        <span class="s1">encryptionKey,</span>
        <span class="s1">previewProps,</span>
        <span class="s1">browserslistQuery: supportedBrowsers.join(</span><span class="s0">', '</span><span class="s1">),</span>
        <span class="s1">noMangling,</span>
        <span class="s1">currentNodeJsVersion</span>
    <span class="s1">}, {</span>
        <span class="s1">persistentCaching,</span>
        <span class="s1">memoryLimit: (_config_experimental1 = config.experimental) == </span><span class="s2">null </span><span class="s1">? </span><span class="s2">void </span><span class="s3">0 </span><span class="s1">: _config_experimental1.turbopackMemoryLimit,</span>
        <span class="s1">dependencyTracking: persistentCaching,</span>
        <span class="s1">isCi: _ciinfo.isCI,</span>
        <span class="s1">isShortSession: </span><span class="s2">true</span>
    <span class="s1">});</span>
    <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s1">, _compilationevents.backgroundLogCompilationEvents)(project);</span>
        <span class="s4">// Write an empty file in a known location to signal this was built with Turbopack</span>
        <span class="s2">await </span><span class="s1">_fs.promises.writeFile(_path.default.join(distDir, </span><span class="s0">'turbopack'</span><span class="s1">), </span><span class="s0">''</span><span class="s1">);</span>
        <span class="s2">await </span><span class="s1">_fs.promises.mkdir(_path.default.join(distDir, </span><span class="s0">'server'</span><span class="s1">), {</span>
            <span class="s1">recursive: </span><span class="s2">true</span>
        <span class="s1">});</span>
        <span class="s2">await </span><span class="s1">_fs.promises.mkdir(_path.default.join(distDir, </span><span class="s0">'static'</span><span class="s1">, buildId), {</span>
            <span class="s1">recursive: </span><span class="s2">true</span>
        <span class="s1">});</span>
        <span class="s2">await </span><span class="s1">_fs.promises.writeFile(_path.default.join(distDir, </span><span class="s0">'package.json'</span><span class="s1">), JSON.stringify({</span>
            <span class="s1">type: </span><span class="s0">'commonjs'</span>
        <span class="s1">}, </span><span class="s2">null</span><span class="s1">, </span><span class="s3">2</span><span class="s1">));</span>
        <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unused-vars</span>
        <span class="s2">const </span><span class="s1">entrypoints = </span><span class="s2">await </span><span class="s1">project.writeAllEntrypointsToDisk(appDirOnly);</span>
        <span class="s2">const </span><span class="s1">manifestLoader = </span><span class="s2">new </span><span class="s1">_manifestloader.TurbopackManifestLoader({</span>
            <span class="s1">buildId,</span>
            <span class="s1">distDir,</span>
            <span class="s1">encryptionKey</span>
        <span class="s1">});</span>
        <span class="s2">const </span><span class="s1">topLevelErrors = [];</span>
        <span class="s2">const </span><span class="s1">topLevelWarnings = [];</span>
        <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">issue of entrypoints.issues){</span>
            <span class="s2">if </span><span class="s1">(issue.severity === </span><span class="s0">'error' </span><span class="s1">|| issue.severity === </span><span class="s0">'fatal'</span><span class="s1">) {</span>
                <span class="s1">topLevelErrors.push((</span><span class="s3">0</span><span class="s1">, _utils.formatIssue)(issue));</span>
            <span class="s1">} </span><span class="s2">else if </span><span class="s1">((</span><span class="s3">0</span><span class="s1">, _utils.isRelevantWarning)(issue)) {</span>
                <span class="s1">topLevelWarnings.push((</span><span class="s3">0</span><span class="s1">, _utils.formatIssue)(issue));</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(topLevelWarnings.length &gt; </span><span class="s3">0</span><span class="s1">) {</span>
            <span class="s1">console.warn(</span><span class="s0">`Turbopack build encountered </span><span class="s1">${topLevelWarnings.length} </span><span class="s0">warnings:</span><span class="s5">\n</span><span class="s1">${topLevelWarnings.join(</span><span class="s0">'</span><span class="s5">\n</span><span class="s0">'</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(topLevelErrors.length &gt; </span><span class="s3">0</span><span class="s1">) {</span>
            <span class="s2">throw </span><span class="s1">Object.defineProperty(</span><span class="s2">new </span><span class="s1">Error(</span><span class="s0">`Turbopack build failed with </span><span class="s1">${topLevelErrors.length} </span><span class="s0">errors:</span><span class="s5">\n</span><span class="s1">${topLevelErrors.join(</span><span class="s0">'</span><span class="s5">\n</span><span class="s0">'</span><span class="s1">)}</span><span class="s0">`</span><span class="s1">), </span><span class="s0">&quot;__NEXT_ERROR_CODE&quot;</span><span class="s1">, {</span>
                <span class="s1">value: </span><span class="s0">&quot;E425&quot;</span><span class="s1">,</span>
                <span class="s1">enumerable: </span><span class="s2">false</span><span class="s1">,</span>
                <span class="s1">configurable: </span><span class="s2">true</span>
            <span class="s1">});</span>
        <span class="s1">}</span>
        <span class="s2">const </span><span class="s1">currentEntrypoints = </span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _handleentrypoints.rawEntrypointsToEntrypoints)(entrypoints);</span>
        <span class="s2">const </span><span class="s1">promises = [];</span>
        <span class="s2">if </span><span class="s1">(!appDirOnly) {</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">[page, route] of currentEntrypoints.page){</span>
                <span class="s1">promises.push((</span><span class="s3">0</span><span class="s1">, _handleentrypoints.handleRouteType)({</span>
                    <span class="s1">page,</span>
                    <span class="s1">route,</span>
                    <span class="s1">manifestLoader</span>
                <span class="s1">}));</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">[page, route] of currentEntrypoints.app){</span>
            <span class="s1">promises.push((</span><span class="s3">0</span><span class="s1">, _handleentrypoints.handleRouteType)({</span>
                <span class="s1">page,</span>
                <span class="s1">route,</span>
                <span class="s1">manifestLoader</span>
            <span class="s1">}));</span>
        <span class="s1">}</span>
        <span class="s2">await </span><span class="s1">Promise.all(promises);</span>
        <span class="s2">await </span><span class="s1">Promise.all([</span>
            <span class="s1">manifestLoader.loadBuildManifest(</span><span class="s0">'_app'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadPagesManifest(</span><span class="s0">'_app'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadFontManifest(</span><span class="s0">'_app'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadPagesManifest(</span><span class="s0">'_document'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadClientBuildManifest(</span><span class="s0">'_error'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadBuildManifest(</span><span class="s0">'_error'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadPagesManifest(</span><span class="s0">'_error'</span><span class="s1">),</span>
            <span class="s1">manifestLoader.loadFontManifest(</span><span class="s0">'_error'</span><span class="s1">),</span>
            <span class="s1">entrypoints.instrumentation &amp;&amp; manifestLoader.loadMiddlewareManifest(</span><span class="s0">'instrumentation'</span><span class="s1">, </span><span class="s0">'instrumentation'</span><span class="s1">),</span>
            <span class="s1">entrypoints.middleware &amp;&amp; </span><span class="s2">await </span><span class="s1">manifestLoader.loadMiddlewareManifest(</span><span class="s0">'middleware'</span><span class="s1">, </span><span class="s0">'middleware'</span><span class="s1">)</span>
        <span class="s1">]);</span>
        <span class="s2">await </span><span class="s1">manifestLoader.writeManifests({</span>
            <span class="s1">devRewrites: undefined,</span>
            <span class="s1">productionRewrites: rewrites,</span>
            <span class="s1">entrypoints: currentEntrypoints</span>
        <span class="s1">});</span>
        <span class="s2">const </span><span class="s1">shutdownPromise = project.shutdown();</span>
        <span class="s2">const </span><span class="s1">time = process.hrtime(startTime);</span>
        <span class="s2">return </span><span class="s1">{</span>
            <span class="s1">duration: time[</span><span class="s3">0</span><span class="s1">] + time[</span><span class="s3">1</span><span class="s1">] / </span><span class="s3">1e9</span><span class="s1">,</span>
            <span class="s1">buildTraceContext: undefined,</span>
            <span class="s1">shutdownPromise</span>
        <span class="s1">};</span>
    <span class="s1">} </span><span class="s2">catch </span><span class="s1">(err) {</span>
        <span class="s2">await </span><span class="s1">project.shutdown();</span>
        <span class="s2">throw </span><span class="s1">err;</span>
    <span class="s1">}</span>
<span class="s1">}</span>
<span class="s2">let </span><span class="s1">shutdownPromise;</span>
<span class="s1">async </span><span class="s2">function </span><span class="s1">workerMain(workerData) {</span>
    <span class="s4">// setup new build context from the serialized data passed from the parent</span>
    <span class="s1">Object.assign(_buildcontext.NextBuildContext, workerData.buildContext);</span>
    <span class="s4">/// load the config because it's not serializable</span>
    <span class="s1">_buildcontext.NextBuildContext.config = </span><span class="s2">await </span><span class="s1">(</span><span class="s3">0</span><span class="s1">, _config.default)(_constants.PHASE_PRODUCTION_BUILD, _buildcontext.NextBuildContext.dir, {</span>
        <span class="s1">debugPrerender: _buildcontext.NextBuildContext.debugPrerender</span>
    <span class="s1">});</span>
    <span class="s4">// Matches handling in build/index.ts</span>
    <span class="s4">// https://github.com/vercel/next.js/blob/84f347fc86f4efc4ec9f13615c215e4b9fb6f8f0/packages/next/src/build/index.ts#L815-L818</span>
    <span class="s4">// Ensures the `config.distDir` option is matched.</span>
    <span class="s2">if </span><span class="s1">((</span><span class="s3">0</span><span class="s1">, _utils1.hasCustomExportOutput)(_buildcontext.NextBuildContext.config)) {</span>
        <span class="s1">_buildcontext.NextBuildContext.config.distDir = </span><span class="s0">'.next'</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">// Clone the telemetry for worker</span>
    <span class="s2">const </span><span class="s1">telemetry = </span><span class="s2">new </span><span class="s1">_storage.Telemetry({</span>
        <span class="s1">distDir: _buildcontext.NextBuildContext.config.distDir</span>
    <span class="s1">});</span>
    <span class="s1">(</span><span class="s3">0</span><span class="s1">, _trace.setGlobal)(</span><span class="s0">'telemetry'</span><span class="s1">, telemetry);</span>
    <span class="s2">const </span><span class="s1">result = </span><span class="s2">await </span><span class="s1">turbopackBuild();</span>
    <span class="s1">shutdownPromise = result.shutdownPromise;</span>
    <span class="s2">return </span><span class="s1">result;</span>
<span class="s1">}</span>
<span class="s1">async </span><span class="s2">function </span><span class="s1">waitForShutdown() {</span>
    <span class="s2">if </span><span class="s1">(shutdownPromise) {</span>
        <span class="s2">await </span><span class="s1">shutdownPromise;</span>
    <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">//# sourceMappingURL=impl.js.map</span></pre>
</body>
</html>