<html>
<head>
<title>common.cc</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #067d17;}
.s4 { color: #000000;}
.s5 { color: #00627a;}
.s6 { color: #1750eb; font-style: italic;}
.s7 { color: #871094; font-style: italic;}
.s8 { color: #0037a6; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
common.cc</font>
</center></td></tr></table>
<pre><span class="s0">// Copyright 2013 Lovell Fuller and others.</span>
<span class="s0">// SPDX-License-Identifier: Apache-2.0</span>

<span class="s2">#include </span><span class="s3">&lt;cstdlib&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;string&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;string.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;vector&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;queue&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;map&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;mutex&gt;  </span><span class="s0">// NOLINT(build/c++11)</span>

<span class="s2">#include </span><span class="s3">&lt;napi.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;vips/vips8&gt;</span>

<span class="s2">#include </span><span class="s3">&quot;common.h&quot;</span>

<span class="s2">using </span>vips<span class="s1">::VImage;</span>

<span class="s2">namespace </span>sharp <span class="s1">{</span>

  <span class="s0">// Convenience methods to access the attributes of a Napi::Object</span>
  <span class="s1">bool </span><span class="s5">HasAttr</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Has</span><span class="s1">(attr);</span>
  <span class="s1">}</span>
  std<span class="s1">::string </span><span class="s5">AttrAsStr</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::String</span><span class="s2">&gt;</span><span class="s1">();</span>
  <span class="s1">}</span>
  std<span class="s1">::string </span><span class="s5">AttrAsStr</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span><span class="s2">unsigned int const </span>attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::String</span><span class="s2">&gt;</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">uint32_t </span><span class="s5">AttrAsUint32</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">Uint32Value</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">int32_t </span><span class="s5">AttrAsInt32</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">Int32Value</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">int32_t </span><span class="s5">AttrAsInt32</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span><span class="s2">unsigned int const </span>attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">Int32Value</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">int64_t </span><span class="s5">AttrAsInt64</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">Int64Value</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">double </span><span class="s5">AttrAsDouble</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">DoubleValue</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">double </span><span class="s5">AttrAsDouble</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span><span class="s2">unsigned int const </span>attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Number</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">DoubleValue</span><span class="s1">();</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">AttrAsBool</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    <span class="s2">return </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Boolean</span><span class="s2">&gt;</span><span class="s1">().</span><span class="s5">Value</span><span class="s1">();</span>
  <span class="s1">}</span>
  std<span class="s1">::vector&lt;double&gt; </span><span class="s5">AttrAsVectorOfDouble</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    Napi<span class="s1">::Array napiArray </span><span class="s2">= </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Array</span><span class="s2">&gt;</span><span class="s1">();</span>
    std<span class="s1">::vector</span><span class="s2">&lt;double&gt; </span><span class="s5">vectorOfDouble</span><span class="s1">(</span>napiArray<span class="s1">.</span><span class="s5">Length</span><span class="s1">());</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">unsigned int </span><span class="s1">i </span><span class="s2">= </span><span class="s6">0</span><span class="s1">; i </span><span class="s2">&lt; </span>napiArray<span class="s1">.</span><span class="s5">Length</span><span class="s1">(); i</span><span class="s2">++</span><span class="s1">) {</span>
      vectorOfDouble<span class="s1">[i] </span><span class="s2">= </span><span class="s5">AttrAsDouble</span><span class="s1">(napiArray, i);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">vectorOfDouble;</span>
  <span class="s1">}</span>
  std<span class="s1">::vector&lt;int32_t&gt; </span><span class="s5">AttrAsInt32Vector</span><span class="s1">(</span>Napi<span class="s1">::</span>Object obj<span class="s1">, </span>std<span class="s1">::</span>string attr<span class="s1">) {</span>
    Napi<span class="s1">::Array array </span><span class="s2">= </span>obj<span class="s1">.</span><span class="s5">Get</span><span class="s1">(attr).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Array</span><span class="s2">&gt;</span><span class="s1">();</span>
    std<span class="s1">::vector</span><span class="s2">&lt;int32_t&gt; </span><span class="s5">vector</span><span class="s1">(</span>array<span class="s1">.</span><span class="s5">Length</span><span class="s1">());</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">unsigned int </span><span class="s1">i </span><span class="s2">= </span><span class="s6">0</span><span class="s1">; i </span><span class="s2">&lt; </span>array<span class="s1">.</span><span class="s5">Length</span><span class="s1">(); i</span><span class="s2">++</span><span class="s1">) {</span>
      vector<span class="s1">[i] </span><span class="s2">= </span><span class="s5">AttrAsInt32</span><span class="s1">(array, i);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">vector;</span>
  <span class="s1">}</span>

  <span class="s0">// Create an InputDescriptor instance from a Napi::Object describing an input image</span>
  <span class="s1">InputDescriptor</span><span class="s2">* </span><span class="s5">CreateInputDescriptor</span><span class="s1">(</span>Napi<span class="s1">::</span>Object input<span class="s1">) {</span>
    <span class="s1">InputDescriptor </span><span class="s2">*</span><span class="s1">descriptor </span><span class="s2">= new </span><span class="s1">InputDescriptor;</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;file&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>file <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;file&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;buffer&quot;</span><span class="s1">)) {</span>
      Napi<span class="s1">::Buffer</span><span class="s2">&lt;char&gt; </span><span class="s1">buffer </span><span class="s2">= </span>input<span class="s1">.</span><span class="s5">Get</span><span class="s1">(</span><span class="s3">&quot;buffer&quot;</span><span class="s1">).</span>As<span class="s2">&lt;</span>Napi<span class="s1">::Buffer</span><span class="s2">&lt;char&gt;&gt;</span><span class="s1">();</span>
      descriptor<span class="s1">-&gt;</span>bufferLength <span class="s2">= </span>buffer<span class="s1">.</span><span class="s5">Length</span><span class="s1">();</span>
      descriptor<span class="s1">-&gt;</span>buffer <span class="s2">= </span>buffer<span class="s1">.</span><span class="s5">Data</span><span class="s1">();</span>
      descriptor<span class="s1">-&gt;</span>isBuffer <span class="s2">= </span><span class="s7">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    descriptor<span class="s1">-&gt;</span>failOn <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsFailOn&gt;(input, </span><span class="s3">&quot;failOn&quot;</span><span class="s1">, VIPS_TYPE_FAIL_ON);</span>
    <span class="s0">// Density for vector-based input</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;density&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>density <span class="s2">= </span><span class="s5">AttrAsDouble</span><span class="s1">(input, </span><span class="s3">&quot;density&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Should we ignore any embedded ICC profile</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;ignoreIcc&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>ignoreIcc <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;ignoreIcc&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Raw pixel input</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;rawChannels&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>rawDepth <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsBandFormat&gt;(input, </span><span class="s3">&quot;rawDepth&quot;</span><span class="s1">, VIPS_TYPE_BAND_FORMAT);</span>
      descriptor<span class="s1">-&gt;</span>rawChannels <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;rawChannels&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>rawWidth <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;rawWidth&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>rawHeight <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;rawHeight&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>rawPremultiplied <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;rawPremultiplied&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>rawPageHeight <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;rawPageHeight&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Multi-page input (GIF, TIFF, PDF)</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;pages&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>pages <span class="s2">= </span><span class="s5">AttrAsInt32</span><span class="s1">(input, </span><span class="s3">&quot;pages&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;page&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>page <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;page&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// SVG</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;svgStylesheet&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>svgStylesheet <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;svgStylesheet&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;svgHighBitdepth&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>svgHighBitdepth <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;svgHighBitdepth&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Multi-level input (OpenSlide)</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;openSlideLevel&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>openSlideLevel <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;openSlideLevel&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// subIFD (OME-TIFF)</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;subifd&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>tiffSubifd <span class="s2">= </span><span class="s5">AttrAsInt32</span><span class="s1">(input, </span><span class="s3">&quot;tiffSubifd&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// // PDF background color</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;pdfBackground&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>pdfBackground <span class="s2">= </span><span class="s5">AttrAsVectorOfDouble</span><span class="s1">(input, </span><span class="s3">&quot;pdfBackground&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Use JPEG 2000 oneshot mode?</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;jp2Oneshot&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>jp2Oneshot <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;jp2Oneshot&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">// Create new image</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;createChannels&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>createChannels <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;createChannels&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>createWidth <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;createWidth&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>createHeight <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;createHeight&quot;</span><span class="s1">);</span>
      descriptor<span class="s1">-&gt;</span>createPageHeight <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;createPageHeight&quot;</span><span class="s1">);</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;createNoiseType&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>createNoiseType <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;createNoiseType&quot;</span><span class="s1">);</span>
        descriptor<span class="s1">-&gt;</span>createNoiseMean <span class="s2">= </span><span class="s5">AttrAsDouble</span><span class="s1">(input, </span><span class="s3">&quot;createNoiseMean&quot;</span><span class="s1">);</span>
        descriptor<span class="s1">-&gt;</span>createNoiseSigma <span class="s2">= </span><span class="s5">AttrAsDouble</span><span class="s1">(input, </span><span class="s3">&quot;createNoiseSigma&quot;</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        descriptor<span class="s1">-&gt;</span>createBackground <span class="s2">= </span><span class="s5">AttrAsVectorOfDouble</span><span class="s1">(input, </span><span class="s3">&quot;createBackground&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">// Create new image with text</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textValue&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>textValue <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;textValue&quot;</span><span class="s1">);</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textFont&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textFont <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;textFont&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textFontfile&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textFontfile <span class="s2">= </span><span class="s5">AttrAsStr</span><span class="s1">(input, </span><span class="s3">&quot;textFontfile&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textWidth&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textWidth <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;textWidth&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textHeight&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textHeight <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;textHeight&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textAlign&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textAlign <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsAlign&gt;(input, </span><span class="s3">&quot;textAlign&quot;</span><span class="s1">, VIPS_TYPE_ALIGN);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textJustify&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textJustify <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;textJustify&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textDpi&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textDpi <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;textDpi&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textRgba&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textRgba <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;textRgba&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textSpacing&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textSpacing <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;textSpacing&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;textWrap&quot;</span><span class="s1">)) {</span>
        descriptor<span class="s1">-&gt;</span>textWrap <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsTextWrap&gt;(input, </span><span class="s3">&quot;textWrap&quot;</span><span class="s1">, VIPS_TYPE_TEXT_WRAP);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s0">// Join images together</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinAnimated&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinAnimated <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;joinAnimated&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinAcross&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinAcross <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;joinAcross&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinShim&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinShim <span class="s2">= </span><span class="s5">AttrAsUint32</span><span class="s1">(input, </span><span class="s3">&quot;joinShim&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinBackground&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinBackground <span class="s2">= </span><span class="s5">AttrAsVectorOfDouble</span><span class="s1">(input, </span><span class="s3">&quot;joinBackground&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinHalign&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinHalign <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsAlign&gt;(input, </span><span class="s3">&quot;joinHalign&quot;</span><span class="s1">, VIPS_TYPE_ALIGN);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;joinValign&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>joinValign <span class="s2">= </span><span class="s5">AttrAsEnum</span><span class="s1">&lt;VipsAlign&gt;(input, </span><span class="s3">&quot;joinValign&quot;</span><span class="s1">, VIPS_TYPE_ALIGN);</span>
    <span class="s1">}</span>
    <span class="s0">// Limit input images to a given number of pixels, where pixels = width * height</span>
    descriptor<span class="s1">-&gt;</span>limitInputPixels <span class="s2">= static_cast&lt;uint64_t&gt;</span><span class="s1">(</span><span class="s5">AttrAsInt64</span><span class="s1">(input, </span><span class="s3">&quot;limitInputPixels&quot;</span><span class="s1">));</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasAttr</span><span class="s1">(input, </span><span class="s3">&quot;access&quot;</span><span class="s1">)) {</span>
      descriptor<span class="s1">-&gt;</span>access <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;sequentialRead&quot;</span><span class="s1">) </span><span class="s2">? </span><span class="s1">VIPS_ACCESS_SEQUENTIAL </span><span class="s2">: </span><span class="s1">VIPS_ACCESS_RANDOM;</span>
    <span class="s1">}</span>
    <span class="s0">// Remove safety features and allow unlimited input</span>
    descriptor<span class="s1">-&gt;</span>unlimited <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;unlimited&quot;</span><span class="s1">);</span>
    <span class="s0">// Use the EXIF orientation to auto orient the image</span>
    descriptor<span class="s1">-&gt;</span>autoOrient <span class="s2">= </span><span class="s5">AttrAsBool</span><span class="s1">(input, </span><span class="s3">&quot;autoOrient&quot;</span><span class="s1">);</span>
    <span class="s2">return </span><span class="s1">descriptor;</span>
  <span class="s1">}</span>

  <span class="s0">// How many tasks are in the queue?</span>
  std<span class="s1">::atomic</span><span class="s2">&lt;int&gt; </span><span class="s1">counterQueue{</span><span class="s6">0</span><span class="s1">};</span>

  <span class="s0">// How many tasks are being processed?</span>
  std<span class="s1">::atomic</span><span class="s2">&lt;int&gt; </span><span class="s1">counterProcess{</span><span class="s6">0</span><span class="s1">};</span>

  <span class="s0">// Filename extension checkers</span>
  <span class="s2">static </span><span class="s1">bool </span><span class="s5">EndsWith</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">, </span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>end<span class="s1">) {</span>
    <span class="s2">return </span>str<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">&gt;= </span>end<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">&amp;&amp; </span><span class="s6">0 </span><span class="s2">== </span>str<span class="s1">.</span><span class="s5">compare</span><span class="s1">(</span>str<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">- </span>end<span class="s1">.</span><span class="s5">length</span><span class="s1">(), </span>end<span class="s1">.</span><span class="s5">length</span><span class="s1">(), end);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsJpeg</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.jpg&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.jpeg&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.JPG&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.JPEG&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsPng</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.png&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.PNG&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsWebp</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.webp&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.WEBP&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsGif</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.gif&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.GIF&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsJp2</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.jp2&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.jpx&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.j2k&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.j2c&quot;</span><span class="s1">)</span>
      <span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.JP2&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.JPX&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.J2K&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.J2C&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsTiff</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.tif&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.tiff&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.TIF&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.TIFF&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsHeic</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.heic&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.HEIC&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsHeif</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.heif&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.HEIF&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">IsHeic</span><span class="s1">(str) </span><span class="s2">|| </span><span class="s5">IsAvif</span><span class="s1">(str);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsAvif</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.avif&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.AVIF&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsJxl</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.jxl&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.JXL&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsDz</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.dzi&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.DZI&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsDzZip</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.zip&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.ZIP&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.szi&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.SZI&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">bool </span><span class="s5">IsV</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.v&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.V&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.vips&quot;</span><span class="s1">) </span><span class="s2">|| </span><span class="s5">EndsWith</span><span class="s1">(str, </span><span class="s3">&quot;.VIPS&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Trim space from end of string. 
  */</span>
  std<span class="s1">::string </span><span class="s5">TrimEnd</span><span class="s1">(</span>std<span class="s1">::</span>string <span class="s2">const &amp;</span>str<span class="s1">) {</span>
    <span class="s2">return </span>str<span class="s1">.</span><span class="s5">substr</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span>str<span class="s1">.</span><span class="s5">find_last_not_of</span><span class="s1">(</span><span class="s3">&quot; </span><span class="s8">\n\r\f</span><span class="s3">&quot;</span><span class="s1">) </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Provide a string identifier for the given image type. 
  */</span>
  std<span class="s1">::string </span><span class="s5">ImageTypeId</span><span class="s1">(</span>ImageType <span class="s2">const </span>imageType<span class="s1">) {</span>
    std<span class="s1">::string id;</span>
    <span class="s2">switch </span><span class="s1">(imageType) {</span>
      <span class="s2">case </span>ImageType<span class="s1">::JPEG: id </span><span class="s2">= </span><span class="s3">&quot;jpeg&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::PNG: id </span><span class="s2">= </span><span class="s3">&quot;png&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::WEBP: id </span><span class="s2">= </span><span class="s3">&quot;webp&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::TIFF: id </span><span class="s2">= </span><span class="s3">&quot;tiff&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::GIF: id </span><span class="s2">= </span><span class="s3">&quot;gif&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::JP2: id </span><span class="s2">= </span><span class="s3">&quot;jp2&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::SVG: id </span><span class="s2">= </span><span class="s3">&quot;svg&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::HEIF: id </span><span class="s2">= </span><span class="s3">&quot;heif&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::PDF: id </span><span class="s2">= </span><span class="s3">&quot;pdf&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::MAGICK: id </span><span class="s2">= </span><span class="s3">&quot;magick&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::OPENSLIDE: id </span><span class="s2">= </span><span class="s3">&quot;openslide&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::PPM: id </span><span class="s2">= </span><span class="s3">&quot;ppm&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::FITS: id </span><span class="s2">= </span><span class="s3">&quot;fits&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::EXR: id </span><span class="s2">= </span><span class="s3">&quot;exr&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::JXL: id </span><span class="s2">= </span><span class="s3">&quot;jxl&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::RAD: id </span><span class="s2">= </span><span class="s3">&quot;rad&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::DCRAW: id </span><span class="s2">= </span><span class="s3">&quot;dcraw&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::VIPS: id </span><span class="s2">= </span><span class="s3">&quot;vips&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::RAW: id </span><span class="s2">= </span><span class="s3">&quot;raw&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::UNKNOWN: id </span><span class="s2">= </span><span class="s3">&quot;unknown&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::MISSING: id </span><span class="s2">= </span><span class="s3">&quot;missing&quot;</span><span class="s1">; </span><span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">id;</span>
  <span class="s1">}</span>

  <span class="s0">/** 
   * Regenerate this table with something like: 
   * 
   * $ vips -l foreign | grep -i load | awk '{ print $2, $1; }' 
   * 
   * Plus a bit of editing. 
   */</span>
  std<span class="s1">::map</span><span class="s2">&lt;</span>std<span class="s1">::string, ImageType</span><span class="s2">&gt; </span><span class="s1">loaderToType </span><span class="s2">= </span><span class="s1">{</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJpegFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JPEG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJpegBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JPEG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadPngFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::PNG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadPngBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::PNG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadWebpFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::WEBP },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadWebpBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::WEBP },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadTiffFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::TIFF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadTiffBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::TIFF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadGifFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::GIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadGifBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::GIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadNsgifFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::GIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadNsgifBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::GIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJp2kBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JP2 },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJp2kFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JP2 },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadSvgFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::SVG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadSvgBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::SVG },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadHeifFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::HEIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadHeifBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::HEIF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadPdfFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::PDF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadPdfBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::PDF },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadMagickFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::MAGICK },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadMagickBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::MAGICK },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadMagick7File&quot;</span><span class="s1">, </span>ImageType<span class="s1">::MAGICK },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadMagick7Buffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::MAGICK },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadOpenslideFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::OPENSLIDE },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadPpmFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::PPM },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadFitsFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::FITS },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadOpenexr&quot;</span><span class="s1">, </span>ImageType<span class="s1">::EXR },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJxlFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JXL },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadJxlBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::JXL },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadRadFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::RAD },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadRadBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::RAD },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadDcRawFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::DCRAW },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadDcRawBuffer&quot;</span><span class="s1">, </span>ImageType<span class="s1">::DCRAW },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadVips&quot;</span><span class="s1">, </span>ImageType<span class="s1">::VIPS },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadVipsFile&quot;</span><span class="s1">, </span>ImageType<span class="s1">::VIPS },</span>
    <span class="s1">{ </span><span class="s3">&quot;VipsForeignLoadRaw&quot;</span><span class="s1">, </span>ImageType<span class="s1">::RAW }</span>
  <span class="s1">};</span>

  <span class="s0">/*</span>
    <span class="s0">Determine image format of a buffer. 
  */</span>
  <span class="s1">ImageType </span><span class="s5">DetermineImageType</span><span class="s1">(</span><span class="s2">void *</span>buffer<span class="s1">, </span><span class="s2">size_t const </span>length<span class="s1">) {</span>
    <span class="s1">ImageType imageType </span><span class="s2">= </span>ImageType<span class="s1">::UNKNOWN;</span>
    <span class="s2">char const *</span><span class="s1">load </span><span class="s2">= </span><span class="s5">vips_foreign_find_load_buffer</span><span class="s1">(buffer, length);</span>
    <span class="s2">if </span><span class="s1">(load </span><span class="s2">!= </span><span class="s7">nullptr</span><span class="s1">) {</span>
      <span class="s2">auto </span><span class="s1">it </span><span class="s2">= </span>loaderToType<span class="s1">.</span><span class="s5">find</span><span class="s1">(load);</span>
      <span class="s2">if </span><span class="s1">(it </span><span class="s2">!= </span>loaderToType<span class="s1">.</span><span class="s5">end</span><span class="s1">()) {</span>
        <span class="s1">imageType </span><span class="s2">= </span>it<span class="s1">-&gt;</span>second<span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">imageType;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Determine image format, reads the first few bytes of the file 
  */</span>
  <span class="s1">ImageType </span><span class="s5">DetermineImageType</span><span class="s1">(</span><span class="s2">char const *</span>file<span class="s1">) {</span>
    <span class="s1">ImageType imageType </span><span class="s2">= </span>ImageType<span class="s1">::UNKNOWN;</span>
    <span class="s2">char const *</span><span class="s1">load </span><span class="s2">= </span><span class="s5">vips_foreign_find_load</span><span class="s1">(file);</span>
    <span class="s2">if </span><span class="s1">(load </span><span class="s2">!= </span><span class="s7">nullptr</span><span class="s1">) {</span>
      <span class="s2">auto </span><span class="s1">it </span><span class="s2">= </span>loaderToType<span class="s1">.</span><span class="s5">find</span><span class="s1">(load);</span>
      <span class="s2">if </span><span class="s1">(it </span><span class="s2">!= </span>loaderToType<span class="s1">.</span><span class="s5">end</span><span class="s1">()) {</span>
        <span class="s1">imageType </span><span class="s2">= </span>it<span class="s1">-&gt;</span>second<span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s5">EndsWith</span><span class="s1">(</span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">().</span><span class="s5">what</span><span class="s1">(), </span><span class="s3">&quot; does not exist</span><span class="s8">\n</span><span class="s3">&quot;</span><span class="s1">)) {</span>
        <span class="s1">imageType </span><span class="s2">= </span>ImageType<span class="s1">::MISSING;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">imageType;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Does this image type support multiple pages? 
  */</span>
  <span class="s1">bool </span><span class="s5">ImageTypeSupportsPage</span><span class="s1">(</span>ImageType imageType<span class="s1">) {</span>
    <span class="s2">return</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::WEBP </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::MAGICK </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::GIF </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::JP2 </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::TIFF </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::HEIF </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::PDF;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Does this image type support removal of safety limits? 
  */</span>
  <span class="s1">bool </span><span class="s5">ImageTypeSupportsUnlimited</span><span class="s1">(</span>ImageType imageType<span class="s1">) {</span>
    <span class="s2">return</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::JPEG </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::PNG </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::SVG </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::TIFF </span><span class="s2">||</span>
      <span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::HEIF;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Format-specific options builder 
  */</span>
  vips<span class="s1">::VOption</span><span class="s2">* </span><span class="s5">GetOptionsForImageType</span><span class="s1">(</span>ImageType imageType<span class="s1">, </span>InputDescriptor <span class="s2">*</span>descriptor<span class="s1">) {</span>
    vips<span class="s1">::VOption </span><span class="s2">*</span><span class="s1">option </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()</span>
      <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;access&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>access<span class="s1">)</span>
      <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;fail_on&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>failOn<span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>unlimited <span class="s2">&amp;&amp; </span><span class="s5">ImageTypeSupportsUnlimited</span><span class="s1">(imageType)) {</span>
      option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;unlimited&quot;</span><span class="s1">, </span><span class="s7">true</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">ImageTypeSupportsPage</span><span class="s1">(imageType)) {</span>
      option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;n&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>pages<span class="s1">);</span>
      option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;page&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>page<span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">switch </span><span class="s1">(imageType) {</span>
      <span class="s2">case </span>ImageType<span class="s1">::SVG:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;dpi&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>density<span class="s1">)</span>
              <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;stylesheet&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>svgStylesheet<span class="s1">.</span><span class="s5">data</span><span class="s1">())</span>
              <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;high_bitdepth&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>svgHighBitdepth<span class="s1">);</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::TIFF:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;subifd&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>tiffSubifd<span class="s1">);</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::PDF:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;dpi&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>density<span class="s1">)</span>
              <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;background&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>pdfBackground<span class="s1">);</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::OPENSLIDE:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;level&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>openSlideLevel<span class="s1">);</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::JP2:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;oneshot&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>jp2Oneshot<span class="s1">);</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span>ImageType<span class="s1">::MAGICK:</span>
        option<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;density&quot;</span><span class="s1">, </span>std<span class="s1">::</span><span class="s5">to_string</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>density<span class="s1">).</span><span class="s5">data</span><span class="s1">());</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">default</span><span class="s1">:</span>
        <span class="s2">break</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">option;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Open an image from the given InputDescriptor (filesystem, compressed buffer, raw pixel data) 
  */</span>
  std<span class="s1">::tuple&lt;VImage, ImageType&gt; </span><span class="s5">OpenInput</span><span class="s1">(</span>InputDescriptor <span class="s2">*</span>descriptor<span class="s1">) {</span>
    <span class="s1">VImage image;</span>
    <span class="s1">ImageType imageType;</span>
    <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>isBuffer<span class="s1">) {</span>
      <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawChannels <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
        <span class="s0">// Raw, uncompressed pixel data</span>
        <span class="s2">bool const </span><span class="s1">is8bit </span><span class="s2">= </span><span class="s5">vips_band_format_is8bit</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawDepth<span class="s1">);</span>
        <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">new_from_memory</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>buffer<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>bufferLength<span class="s1">,</span>
          descriptor<span class="s1">-&gt;</span>rawWidth<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>rawHeight<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>rawChannels<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>rawDepth<span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawChannels <span class="s2">&lt; </span><span class="s6">3</span><span class="s1">) {</span>
          image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">()-&gt;</span>Type <span class="s2">= </span><span class="s1">is8bit </span><span class="s2">? </span><span class="s1">VIPS_INTERPRETATION_B_W </span><span class="s2">: </span><span class="s1">VIPS_INTERPRETATION_GREY16;</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">()-&gt;</span>Type <span class="s2">= </span><span class="s1">is8bit </span><span class="s2">? </span><span class="s1">VIPS_INTERPRETATION_sRGB </span><span class="s2">: </span><span class="s1">VIPS_INTERPRETATION_RGB16;</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawPageHeight <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          image<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_PAGE_HEIGHT, </span>descriptor<span class="s1">-&gt;</span>rawPageHeight<span class="s1">);</span>
          image<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_N_PAGES, </span><span class="s2">static_cast&lt;int&gt;</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawHeight <span class="s2">/ </span>descriptor<span class="s1">-&gt;</span>rawPageHeight<span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>rawPremultiplied<span class="s1">) {</span>
          <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">unpremultiply</span><span class="s1">();</span>
        <span class="s1">}</span>
        <span class="s1">imageType </span><span class="s2">= </span>ImageType<span class="s1">::RAW;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s0">// Compressed data</span>
        <span class="s1">imageType </span><span class="s2">= </span><span class="s5">DetermineImageType</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>buffer<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>bufferLength<span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">!= </span>ImageType<span class="s1">::UNKNOWN) {</span>
          <span class="s2">try </span><span class="s1">{</span>
            vips<span class="s1">::VOption </span><span class="s2">*</span><span class="s1">option </span><span class="s2">= </span><span class="s5">GetOptionsForImageType</span><span class="s1">(imageType, descriptor);</span>
            <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">new_from_buffer</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>buffer<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>bufferLength<span class="s1">, </span><span class="s7">nullptr</span><span class="s1">, option);</span>
            <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::SVG </span><span class="s2">|| </span><span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::PDF </span><span class="s2">|| </span><span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::MAGICK) {</span>
              <span class="s1">image </span><span class="s2">= </span><span class="s5">SetDensity</span><span class="s1">(image, </span>descriptor<span class="s1">-&gt;</span>density<span class="s1">);</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s2">catch </span><span class="s1">(</span>vips<span class="s1">::VError </span><span class="s2">const &amp;</span><span class="s1">err) {</span>
            <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span>std<span class="s1">::</span><span class="s5">string</span><span class="s1">(</span><span class="s3">&quot;Input buffer has corrupt header: &quot;</span><span class="s1">) </span><span class="s2">+ </span>err<span class="s1">.</span><span class="s5">what</span><span class="s1">());</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Input buffer contains unsupported image format&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">int const </span><span class="s1">channels </span><span class="s2">= </span>descriptor<span class="s1">-&gt;</span>createChannels<span class="s1">;</span>
      <span class="s2">if </span><span class="s1">(channels </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
        <span class="s0">// Create new image</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createNoiseType <span class="s2">== </span><span class="s3">&quot;gaussian&quot;</span><span class="s1">) {</span>
          std<span class="s1">::vector</span><span class="s2">&lt;</span><span class="s1">VImage</span><span class="s2">&gt; </span><span class="s1">bands </span><span class="s2">= </span><span class="s1">{};</span>
          bands<span class="s1">.</span><span class="s5">reserve</span><span class="s1">(channels);</span>
          <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">_band </span><span class="s2">= </span><span class="s6">0</span><span class="s1">; _band </span><span class="s2">&lt; </span><span class="s1">channels; _band</span><span class="s2">++</span><span class="s1">) {</span>
            bands<span class="s1">.</span><span class="s5">push_back</span><span class="s1">(</span>VImage<span class="s1">::</span><span class="s5">gaussnoise</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createWidth<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>createHeight<span class="s1">, </span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()</span>
              <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;mean&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>createNoiseMean<span class="s1">)</span>
              <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;sigma&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>createNoiseSigma<span class="s1">)));</span>
          <span class="s1">}</span>
          <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">bandjoin</span><span class="s1">(bands).</span><span class="s5">copy</span><span class="s1">(</span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;interpretation&quot;</span><span class="s1">,</span>
            <span class="s1">channels </span><span class="s2">&lt; </span><span class="s6">3 </span><span class="s2">? </span><span class="s1">VIPS_INTERPRETATION_B_W</span><span class="s2">: </span><span class="s1">VIPS_INTERPRETATION_sRGB));</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          std<span class="s1">::vector</span><span class="s2">&lt;double&gt; </span><span class="s1">background </span><span class="s2">= </span><span class="s1">{</span>
            descriptor<span class="s1">-&gt;</span>createBackground<span class="s1">[</span><span class="s6">0</span><span class="s1">],</span>
            descriptor<span class="s1">-&gt;</span>createBackground<span class="s1">[</span><span class="s6">1</span><span class="s1">],</span>
            descriptor<span class="s1">-&gt;</span>createBackground<span class="s1">[</span><span class="s6">2</span><span class="s1">]</span>
          <span class="s1">};</span>
          <span class="s2">if </span><span class="s1">(channels </span><span class="s2">== </span><span class="s6">4</span><span class="s1">) {</span>
            background<span class="s1">.</span><span class="s5">push_back</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createBackground<span class="s1">[</span><span class="s6">3</span><span class="s1">]);</span>
          <span class="s1">}</span>
          <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">new_matrix</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createWidth<span class="s1">, </span>descriptor<span class="s1">-&gt;</span>createHeight<span class="s1">)</span>
            <span class="s1">.</span><span class="s5">copy</span><span class="s1">(</span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;interpretation&quot;</span><span class="s1">,</span>
              <span class="s1">channels </span><span class="s2">&lt; </span><span class="s6">3 </span><span class="s2">? </span><span class="s1">VIPS_INTERPRETATION_B_W </span><span class="s2">: </span><span class="s1">VIPS_INTERPRETATION_sRGB))</span>
            <span class="s1">.</span><span class="s5">new_from_image</span><span class="s1">(background);</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createPageHeight <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          image<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_PAGE_HEIGHT, </span>descriptor<span class="s1">-&gt;</span>createPageHeight<span class="s1">);</span>
          image<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_N_PAGES, </span><span class="s2">static_cast&lt;int&gt;</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>createHeight <span class="s2">/ </span>descriptor<span class="s1">-&gt;</span>createPageHeight<span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">cast</span><span class="s1">(VIPS_FORMAT_UCHAR);</span>
        <span class="s1">imageType </span><span class="s2">= </span>ImageType<span class="s1">::RAW;</span>
      <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textValue<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
        <span class="s0">// Create a new image with text</span>
        vips<span class="s1">::VOption </span><span class="s2">*</span><span class="s1">textOptions </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;align&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textAlign<span class="s1">)</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;justify&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textJustify<span class="s1">)</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;rgba&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textRgba<span class="s1">)</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;spacing&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textSpacing<span class="s1">)</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;wrap&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textWrap<span class="s1">)</span>
          <span class="s2">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;autofit_dpi&quot;</span><span class="s1">, </span><span class="s2">&amp;</span>descriptor<span class="s1">-&gt;</span>textAutofitDpi<span class="s1">);</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textWidth <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          textOptions<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;width&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textWidth<span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s0">// Ignore dpi if height is set</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textWidth <span class="s2">&gt; </span><span class="s6">0 </span><span class="s2">&amp;&amp; </span>descriptor<span class="s1">-&gt;</span>textHeight <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          textOptions<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;height&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textHeight<span class="s1">);</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textDpi <span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          textOptions<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;dpi&quot;</span><span class="s1">, </span>descriptor<span class="s1">-&gt;</span>textDpi<span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textFont<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          textOptions<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;font&quot;</span><span class="s1">, </span><span class="s2">const_cast&lt;char*&gt;</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textFont<span class="s1">.</span><span class="s5">data</span><span class="s1">()));</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textFontfile<span class="s1">.</span><span class="s5">length</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
          textOptions<span class="s1">-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;fontfile&quot;</span><span class="s1">, </span><span class="s2">const_cast&lt;char*&gt;</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textFontfile<span class="s1">.</span><span class="s5">data</span><span class="s1">()));</span>
        <span class="s1">}</span>
        <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">text</span><span class="s1">(</span><span class="s2">const_cast&lt;char *&gt;</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>textValue<span class="s1">.</span><span class="s5">data</span><span class="s1">()), textOptions);</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span>descriptor<span class="s1">-&gt;</span>textRgba<span class="s1">) {</span>
          <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">(</span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;interpretation&quot;</span><span class="s1">, VIPS_INTERPRETATION_B_W));</span>
        <span class="s1">}</span>
        <span class="s1">imageType </span><span class="s2">= </span>ImageType<span class="s1">::RAW;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s0">// From filesystem</span>
        <span class="s1">imageType </span><span class="s2">= </span><span class="s5">DetermineImageType</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>file<span class="s1">.</span><span class="s5">data</span><span class="s1">());</span>
        <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::MISSING) {</span>
          <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>file<span class="s1">.</span><span class="s5">find</span><span class="s1">(</span><span class="s3">&quot;&lt;svg&quot;</span><span class="s1">) </span><span class="s2">!= </span>std<span class="s1">::</span>string<span class="s1">::npos) {</span>
            <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Input file is missing, did you mean &quot;</span>
              <span class="s3">&quot;sharp(Buffer.from('&quot; </span><span class="s2">+ </span>descriptor<span class="s1">-&gt;</span>file<span class="s1">.</span><span class="s5">substr</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s6">8</span><span class="s1">) </span><span class="s2">+ </span><span class="s3">&quot;...')?&quot;</span><span class="s1">);</span>
          <span class="s1">}</span>
          <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Input file is missing: &quot; </span><span class="s2">+ </span>descriptor<span class="s1">-&gt;</span>file<span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">!= </span>ImageType<span class="s1">::UNKNOWN) {</span>
          <span class="s2">try </span><span class="s1">{</span>
            vips<span class="s1">::VOption </span><span class="s2">*</span><span class="s1">option </span><span class="s2">= </span><span class="s5">GetOptionsForImageType</span><span class="s1">(imageType, descriptor);</span>
            <span class="s1">image </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">new_from_file</span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>file<span class="s1">.</span><span class="s5">data</span><span class="s1">(), option);</span>
            <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::SVG </span><span class="s2">|| </span><span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::PDF </span><span class="s2">|| </span><span class="s1">imageType </span><span class="s2">== </span>ImageType<span class="s1">::MAGICK) {</span>
              <span class="s1">image </span><span class="s2">= </span><span class="s5">SetDensity</span><span class="s1">(image, </span>descriptor<span class="s1">-&gt;</span>density<span class="s1">);</span>
            <span class="s1">}</span>
          <span class="s1">} </span><span class="s2">catch </span><span class="s1">(</span>vips<span class="s1">::VError </span><span class="s2">const &amp;</span><span class="s1">err) {</span>
            <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span>std<span class="s1">::</span><span class="s5">string</span><span class="s1">(</span><span class="s3">&quot;Input file has corrupt header: &quot;</span><span class="s1">) </span><span class="s2">+ </span>err<span class="s1">.</span><span class="s5">what</span><span class="s1">());</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
          <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Input file contains unsupported image format&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// Limit input images to a given number of pixels, where pixels = width * height</span>
    <span class="s2">if </span><span class="s1">(</span>descriptor<span class="s1">-&gt;</span>limitInputPixels <span class="s2">&gt; </span><span class="s6">0 </span><span class="s2">&amp;&amp;</span>
      <span class="s2">static_cast&lt;uint64_t&gt;</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">width</span><span class="s1">()) </span><span class="s2">* </span>image<span class="s1">.</span><span class="s5">height</span><span class="s1">() </span><span class="s2">&gt; </span>descriptor<span class="s1">-&gt;</span>limitInputPixels<span class="s1">) {</span>
      <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Input image exceeds pixel limit&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_tuple</span><span class="s1">(image, imageType);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Does this image have an embedded profile? 
  */</span>
  <span class="s1">bool </span><span class="s5">HasProfile</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">return </span>image<span class="s1">.</span><span class="s5">get_typeof</span><span class="s1">(VIPS_META_ICC_NAME) </span><span class="s2">== </span><span class="s1">VIPS_TYPE_BLOB;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Get copy of embedded profile. 
  */</span>
  std<span class="s1">::pair&lt;char*, size_t&gt; </span><span class="s5">GetProfile</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    std<span class="s1">::pair</span><span class="s2">&lt;char*</span><span class="s1">, </span><span class="s2">size_t&gt; </span><span class="s5">icc</span><span class="s1">(</span><span class="s7">nullptr</span><span class="s1">, </span><span class="s6">0</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">HasProfile</span><span class="s1">(image)) {</span>
      <span class="s2">size_t </span><span class="s1">length;</span>
      <span class="s2">const void *</span><span class="s1">data </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">get_blob</span><span class="s1">(VIPS_META_ICC_NAME, </span><span class="s2">&amp;</span><span class="s1">length);</span>
      icc<span class="s1">.</span>first <span class="s2">= static_cast&lt;char*&gt;</span><span class="s1">(</span><span class="s5">g_malloc</span><span class="s1">(length));</span>
      icc<span class="s1">.</span>second <span class="s2">= </span><span class="s1">length;</span>
      <span class="s5">memcpy</span><span class="s1">(</span>icc<span class="s1">.</span>first<span class="s1">, data, length);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">icc;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Set embedded profile. 
  */</span>
  <span class="s1">VImage </span><span class="s5">SetProfile</span><span class="s1">(</span>VImage image<span class="s1">, </span>std<span class="s1">::</span>pair<span class="s1">&lt;</span><span class="s2">char*</span><span class="s1">, </span><span class="s2">size_t</span><span class="s1">&gt; </span>icc<span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span>icc<span class="s1">.</span>first <span class="s2">!= </span><span class="s7">nullptr</span><span class="s1">) {</span>
      <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
      image<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_ICC_NAME, </span><span class="s2">reinterpret_cast&lt;</span><span class="s1">VipsCallbackFn</span><span class="s2">&gt;</span><span class="s1">(vips_area_free_cb), </span>icc<span class="s1">.</span>first<span class="s1">, </span>icc<span class="s1">.</span>second<span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">image;</span>
  <span class="s1">}</span>

  <span class="s2">static </span><span class="s1">void</span><span class="s2">* </span><span class="s5">RemoveExifCallback</span><span class="s1">(</span>VipsImage <span class="s2">*</span>image<span class="s1">, </span><span class="s2">char const *</span>field<span class="s1">, </span>GValue <span class="s2">*</span>value<span class="s1">, </span><span class="s2">void *</span>data<span class="s1">) {</span>
    std<span class="s1">::vector</span><span class="s2">&lt;</span>std<span class="s1">::string</span><span class="s2">&gt; *</span><span class="s1">fieldNames </span><span class="s2">= static_cast&lt;</span>std<span class="s1">::vector</span><span class="s2">&lt;</span>std<span class="s1">::string</span><span class="s2">&gt; *&gt;</span><span class="s1">(data);</span>
    std<span class="s1">::string </span><span class="s5">fieldName</span><span class="s1">(field);</span>
    <span class="s2">if </span><span class="s1">(</span>fieldName<span class="s1">.</span><span class="s5">substr</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s6">8</span><span class="s1">) </span><span class="s2">== </span><span class="s1">(</span><span class="s3">&quot;exif-ifd&quot;</span><span class="s1">)) {</span>
      fieldNames<span class="s1">-&gt;</span><span class="s5">push_back</span><span class="s1">(fieldName);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s7">nullptr</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Remove all EXIF-related image fields. 
  */</span>
  <span class="s1">VImage </span><span class="s5">RemoveExif</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    std<span class="s1">::vector</span><span class="s2">&lt;</span>std<span class="s1">::string</span><span class="s2">&gt; </span><span class="s1">fieldNames;</span>
    <span class="s5">vips_image_map</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">(), </span><span class="s2">static_cast&lt;</span><span class="s1">VipsImageMapFn</span><span class="s2">&gt;</span><span class="s1">(RemoveExifCallback), </span><span class="s2">&amp;</span><span class="s1">fieldNames);</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">const auto&amp; </span><span class="s1">f : fieldNames) {</span>
      image<span class="s1">.</span><span class="s5">remove</span><span class="s1">(</span>f<span class="s1">.</span><span class="s5">data</span><span class="s1">());</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">image;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Get EXIF Orientation of image, if any. 
  */</span>
  <span class="s1">int </span><span class="s5">ExifOrientation</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">int </span><span class="s1">orientation </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">get_typeof</span><span class="s1">(VIPS_META_ORIENTATION) </span><span class="s2">!= </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s1">orientation </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">get_int</span><span class="s1">(VIPS_META_ORIENTATION);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">orientation;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Set EXIF Orientation of image. 
  */</span>
  <span class="s1">VImage </span><span class="s5">SetExifOrientation</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">int const </span>orientation<span class="s1">) {</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
    copy<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_ORIENTATION, orientation);</span>
    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Remove EXIF Orientation from image. 
  */</span>
  <span class="s1">VImage </span><span class="s5">RemoveExifOrientation</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(VIPS_META_ORIENTATION);</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(</span><span class="s3">&quot;exif-ifd0-Orientation&quot;</span><span class="s1">);</span>
    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Set animation properties if necessary. 
  */</span>
  <span class="s1">VImage </span><span class="s5">SetAnimationProperties</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">int </span>nPages<span class="s1">, </span><span class="s2">int </span>pageHeight<span class="s1">, </span>std<span class="s1">::</span>vector<span class="s1">&lt;</span><span class="s2">int</span><span class="s1">&gt; </span>delay<span class="s1">, </span><span class="s2">int </span>loop<span class="s1">) {</span>
    <span class="s2">bool </span><span class="s1">hasDelay </span><span class="s2">= !</span>delay<span class="s1">.</span><span class="s5">empty</span><span class="s1">();</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>

    <span class="s0">// Only set page-height if we have more than one page, or this could</span>
    <span class="s0">// accidentally turn into an animated image later.</span>
    <span class="s2">if </span><span class="s1">(nPages </span><span class="s2">&gt; </span><span class="s6">1</span><span class="s1">) </span>copy<span class="s1">.</span><span class="s5">set</span><span class="s1">(VIPS_META_PAGE_HEIGHT, pageHeight);</span>
    <span class="s2">if </span><span class="s1">(hasDelay) {</span>
      <span class="s2">if </span><span class="s1">(</span>delay<span class="s1">.</span><span class="s5">size</span><span class="s1">() </span><span class="s2">== </span><span class="s6">1</span><span class="s1">) {</span>
        <span class="s0">// We have just one delay, repeat that value for all frames.</span>
        delay<span class="s1">.</span><span class="s5">insert</span><span class="s1">(</span>delay<span class="s1">.</span><span class="s5">end</span><span class="s1">(), nPages </span><span class="s2">- </span><span class="s6">1</span><span class="s1">, </span>delay<span class="s1">[</span><span class="s6">0</span><span class="s1">]);</span>
      <span class="s1">}</span>
      copy<span class="s1">.</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;delay&quot;</span><span class="s1">, delay);</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(nPages </span><span class="s2">== </span><span class="s6">1 </span><span class="s2">&amp;&amp; !</span><span class="s1">hasDelay </span><span class="s2">&amp;&amp; </span><span class="s1">loop </span><span class="s2">== -</span><span class="s6">1</span><span class="s1">) {</span>
      <span class="s1">loop </span><span class="s2">= </span><span class="s6">1</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(loop </span><span class="s2">!= -</span><span class="s6">1</span><span class="s1">) </span>copy<span class="s1">.</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;loop&quot;</span><span class="s1">, loop);</span>

    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Remove animation properties from image. 
  */</span>
  <span class="s1">VImage </span><span class="s5">RemoveAnimationProperties</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(VIPS_META_PAGE_HEIGHT);</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(</span><span class="s3">&quot;delay&quot;</span><span class="s1">);</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(</span><span class="s3">&quot;loop&quot;</span><span class="s1">);</span>
    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Remove GIF palette from image. 
  */</span>
  <span class="s1">VImage </span><span class="s5">RemoveGifPalette</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
    copy<span class="s1">.</span><span class="s5">remove</span><span class="s1">(</span><span class="s3">&quot;gif-palette&quot;</span><span class="s1">);</span>
    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Does this image have a non-default density? 
  */</span>
  <span class="s1">bool </span><span class="s5">HasDensity</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">return </span>image<span class="s1">.</span><span class="s5">xres</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">1.0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Get pixels/mm resolution as pixels/inch density. 
  */</span>
  <span class="s1">int </span><span class="s5">GetDensity</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">return static_cast&lt;int&gt;</span><span class="s1">(</span><span class="s5">round</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">xres</span><span class="s1">() </span><span class="s2">* </span><span class="s6">25.4</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Set pixels/mm resolution based on a pixels/inch density. 
  */</span>
  <span class="s1">VImage </span><span class="s5">SetDensity</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">const double </span>density<span class="s1">) {</span>
    <span class="s2">const double </span><span class="s1">pixelsPerMm </span><span class="s2">= </span><span class="s1">density </span><span class="s2">/ </span><span class="s6">25.4</span><span class="s1">;</span>
    <span class="s1">VImage copy </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy</span><span class="s1">();</span>
    copy<span class="s1">.</span><span class="s5">get_image</span><span class="s1">()-&gt;</span>Xres <span class="s2">= </span><span class="s1">pixelsPerMm;</span>
    copy<span class="s1">.</span><span class="s5">get_image</span><span class="s1">()-&gt;</span>Yres <span class="s2">= </span><span class="s1">pixelsPerMm;</span>
    <span class="s2">return </span><span class="s1">copy;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Multi-page images can have a page height. Fetch it, and sanity check it. 
    If page-height is not set, it defaults to the image height 
  */</span>
  <span class="s1">int </span><span class="s5">GetPageHeight</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">vips_image_get_page_height</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">());</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Check the proposed format supports the current dimensions. 
  */</span>
  <span class="s1">void </span><span class="s5">AssertImageTypeDimensions</span><span class="s1">(</span>VImage image<span class="s1">, </span>ImageType <span class="s2">const </span>imageType<span class="s1">) {</span>
    <span class="s2">const int </span><span class="s1">height </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">get_typeof</span><span class="s1">(VIPS_META_PAGE_HEIGHT) </span><span class="s2">== </span><span class="s1">G_TYPE_INT 
      </span><span class="s2">? </span>image<span class="s1">.</span><span class="s5">get_int</span><span class="s1">(VIPS_META_PAGE_HEIGHT)</span>
      <span class="s2">: </span>image<span class="s1">.</span><span class="s5">height</span><span class="s1">();</span>
    <span class="s2">if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::JPEG) {</span>
      <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">width</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">65535 </span><span class="s2">|| </span><span class="s1">height </span><span class="s2">&gt; </span><span class="s6">65535</span><span class="s1">) {</span>
        <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Processed image is too large for the JPEG format&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::WEBP) {</span>
      <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">width</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">16383 </span><span class="s2">|| </span><span class="s1">height </span><span class="s2">&gt; </span><span class="s6">16383</span><span class="s1">) {</span>
        <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Processed image is too large for the WebP format&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::GIF) {</span>
      <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">width</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">65535 </span><span class="s2">|| </span><span class="s1">height </span><span class="s2">&gt; </span><span class="s6">65535</span><span class="s1">) {</span>
        <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Processed image is too large for the GIF format&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(imageType </span><span class="s2">== </span>ImageType<span class="s1">::HEIF) {</span>
      <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">width</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">16384 </span><span class="s2">|| </span><span class="s1">height </span><span class="s2">&gt; </span><span class="s6">16384</span><span class="s1">) {</span>
        <span class="s2">throw </span>vips<span class="s1">::</span><span class="s5">VError</span><span class="s1">(</span><span class="s3">&quot;Processed image is too large for the HEIF format&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Called when a Buffer undergoes GC, required to support mixed runtime libraries in Windows 
  */</span>
  std<span class="s1">::function</span><span class="s2">&lt;void</span><span class="s1">(</span><span class="s2">void*</span><span class="s1">, </span><span class="s2">char*</span><span class="s1">)</span><span class="s2">&gt; </span><span class="s1">FreeCallback </span><span class="s2">= </span><span class="s1">[](</span><span class="s2">void*</span><span class="s1">, </span><span class="s2">char* </span>data<span class="s1">) {</span>
    <span class="s5">g_free</span><span class="s1">(data);</span>
  <span class="s1">};</span>

  <span class="s0">/*</span>
    <span class="s0">Temporary buffer of warnings 
  */</span>
  std<span class="s1">::queue</span><span class="s2">&lt;</span>std<span class="s1">::string</span><span class="s2">&gt; </span><span class="s1">vipsWarnings;</span>
  std<span class="s1">::mutex vipsWarningsMutex;</span>

  <span class="s0">/*</span>
    <span class="s0">Called with warnings from the glib-registered &quot;VIPS&quot; domain 
  */</span>
  <span class="s1">void </span><span class="s5">VipsWarningCallback</span><span class="s1">(</span><span class="s2">char const* </span>log_domain<span class="s1">, </span>GLogLevelFlags log_level<span class="s1">, </span><span class="s2">char const* </span>message<span class="s1">, </span><span class="s2">void* </span>ignore<span class="s1">) {</span>
    std<span class="s1">::lock_guard</span><span class="s2">&lt;</span>std<span class="s1">::mutex</span><span class="s2">&gt; </span><span class="s5">lock</span><span class="s1">(vipsWarningsMutex);</span>
    vipsWarnings<span class="s1">.</span><span class="s5">emplace</span><span class="s1">(message);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Pop the oldest warning message from the queue 
  */</span>
  std<span class="s1">::string </span><span class="s5">VipsWarningPop</span><span class="s1">() {</span>
    std<span class="s1">::string warning;</span>
    std<span class="s1">::lock_guard</span><span class="s2">&lt;</span>std<span class="s1">::mutex</span><span class="s2">&gt; </span><span class="s5">lock</span><span class="s1">(vipsWarningsMutex);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span>vipsWarnings<span class="s1">.</span><span class="s5">empty</span><span class="s1">()) {</span>
      <span class="s1">warning </span><span class="s2">= </span>vipsWarnings<span class="s1">.</span><span class="s5">front</span><span class="s1">();</span>
      vipsWarnings<span class="s1">.</span><span class="s5">pop</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">warning;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Attach an event listener for progress updates, used to detect timeout 
  */</span>
  <span class="s1">void </span><span class="s5">SetTimeout</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">int const </span>seconds<span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(seconds </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s1">VipsImage </span><span class="s2">*</span><span class="s1">im </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">();</span>
      <span class="s2">if </span><span class="s1">(</span>im<span class="s1">-&gt;</span>progress_signal <span class="s2">== </span><span class="s7">NULL</span><span class="s1">) {</span>
        <span class="s2">int *</span><span class="s1">timeout </span><span class="s2">= </span><span class="s5">VIPS_NEW</span><span class="s1">(im, </span><span class="s2">int</span><span class="s1">);</span>
        <span class="s2">*</span><span class="s1">timeout </span><span class="s2">= </span><span class="s1">seconds;</span>
        <span class="s5">g_signal_connect</span><span class="s1">(im, </span><span class="s3">&quot;eval&quot;</span><span class="s1">, </span><span class="s5">G_CALLBACK</span><span class="s1">(VipsProgressCallBack), timeout);</span>
        <span class="s5">vips_image_set_progress</span><span class="s1">(im, </span><span class="s7">true</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Event listener for progress updates, used to detect timeout 
  */</span>
  <span class="s1">void </span><span class="s5">VipsProgressCallBack</span><span class="s1">(</span>VipsImage <span class="s2">*</span>im<span class="s1">, </span>VipsProgress <span class="s2">*</span>progress<span class="s1">, </span><span class="s2">int *</span>timeout<span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">*</span><span class="s1">timeout </span><span class="s2">&gt; </span><span class="s6">0 </span><span class="s2">&amp;&amp; </span>progress<span class="s1">-&gt;</span>run <span class="s2">&gt;= *</span><span class="s1">timeout) {</span>
      <span class="s5">vips_image_set_kill</span><span class="s1">(im, </span><span class="s7">true</span><span class="s1">);</span>
      <span class="s5">vips_error</span><span class="s1">(</span><span class="s3">&quot;timeout&quot;</span><span class="s1">, </span><span class="s3">&quot;</span><span class="s7">%d%% </span><span class="s3">complete&quot;</span><span class="s1">, </span>progress<span class="s1">-&gt;</span>percent<span class="s1">);</span>
      <span class="s2">*</span><span class="s1">timeout </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Calculate the (left, top) coordinates of the output image 
    within the input image, applying the given gravity during an embed. 
</span>
    <span class="s0">@Azurebyte: We are basically swapping the inWidth and outWidth, inHeight and outHeight from the CalculateCrop function. 
  */</span>
  std<span class="s1">::tuple&lt;int, int&gt; </span><span class="s5">CalculateEmbedPosition</span><span class="s1">(</span><span class="s2">int const </span>inWidth<span class="s1">, </span><span class="s2">int const </span>inHeight<span class="s1">,</span>
    <span class="s2">int const </span>outWidth<span class="s1">, </span><span class="s2">int const </span>outHeight<span class="s1">, </span><span class="s2">int const </span>gravity<span class="s1">) {</span>

    <span class="s2">int </span><span class="s1">left </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">top </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">switch </span><span class="s1">(gravity) {</span>
      <span class="s2">case </span><span class="s6">1</span><span class="s1">:</span>
        <span class="s0">// North</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(outWidth </span><span class="s2">- </span><span class="s1">inWidth) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">2</span><span class="s1">:</span>
        <span class="s0">// East</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">outWidth </span><span class="s2">- </span><span class="s1">inWidth;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(outHeight </span><span class="s2">- </span><span class="s1">inHeight) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">3</span><span class="s1">:</span>
        <span class="s0">// South</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(outWidth </span><span class="s2">- </span><span class="s1">inWidth) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">outHeight </span><span class="s2">- </span><span class="s1">inHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">4</span><span class="s1">:</span>
        <span class="s0">// West</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(outHeight </span><span class="s2">- </span><span class="s1">inHeight) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">5</span><span class="s1">:</span>
        <span class="s0">// Northeast</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">outWidth </span><span class="s2">- </span><span class="s1">inWidth;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">6</span><span class="s1">:</span>
        <span class="s0">// Southeast</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">outWidth </span><span class="s2">- </span><span class="s1">inWidth;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">outHeight </span><span class="s2">- </span><span class="s1">inHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">7</span><span class="s1">:</span>
        <span class="s0">// Southwest</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">outHeight </span><span class="s2">- </span><span class="s1">inHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">8</span><span class="s1">:</span>
        <span class="s0">// Northwest</span>
        <span class="s0">// Which is the default is 0,0 so we do not assign anything here.</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">default</span><span class="s1">:</span>
        <span class="s0">// Centre</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(outWidth </span><span class="s2">- </span><span class="s1">inWidth) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(outHeight </span><span class="s2">- </span><span class="s1">inHeight) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_tuple</span><span class="s1">(left, top);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Calculate the (left, top) coordinates of the output image 
    within the input image, applying the given gravity during a crop. 
  */</span>
  std<span class="s1">::tuple&lt;int, int&gt; </span><span class="s5">CalculateCrop</span><span class="s1">(</span><span class="s2">int const </span>inWidth<span class="s1">, </span><span class="s2">int const </span>inHeight<span class="s1">,</span>
    <span class="s2">int const </span>outWidth<span class="s1">, </span><span class="s2">int const </span>outHeight<span class="s1">, </span><span class="s2">int const </span>gravity<span class="s1">) {</span>

    <span class="s2">int </span><span class="s1">left </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">top </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">switch </span><span class="s1">(gravity) {</span>
      <span class="s2">case </span><span class="s6">1</span><span class="s1">:</span>
        <span class="s0">// North</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(inWidth </span><span class="s2">- </span><span class="s1">outWidth </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">2</span><span class="s1">:</span>
        <span class="s0">// East</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">inWidth </span><span class="s2">- </span><span class="s1">outWidth;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(inHeight </span><span class="s2">- </span><span class="s1">outHeight </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">3</span><span class="s1">:</span>
        <span class="s0">// South</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(inWidth </span><span class="s2">- </span><span class="s1">outWidth </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">inHeight </span><span class="s2">- </span><span class="s1">outHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">4</span><span class="s1">:</span>
        <span class="s0">// West</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(inHeight </span><span class="s2">- </span><span class="s1">outHeight </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">5</span><span class="s1">:</span>
        <span class="s0">// Northeast</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">inWidth </span><span class="s2">- </span><span class="s1">outWidth;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">6</span><span class="s1">:</span>
        <span class="s0">// Southeast</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">inWidth </span><span class="s2">- </span><span class="s1">outWidth;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">inHeight </span><span class="s2">- </span><span class="s1">outHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">7</span><span class="s1">:</span>
        <span class="s0">// Southwest</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">inHeight </span><span class="s2">- </span><span class="s1">outHeight;</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">case </span><span class="s6">8</span><span class="s1">:</span>
        <span class="s0">// Northwest</span>
        <span class="s2">break</span><span class="s1">;</span>
      <span class="s2">default</span><span class="s1">:</span>
        <span class="s0">// Centre</span>
        <span class="s1">left </span><span class="s2">= </span><span class="s1">(inWidth </span><span class="s2">- </span><span class="s1">outWidth </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
        <span class="s1">top </span><span class="s2">= </span><span class="s1">(inHeight </span><span class="s2">- </span><span class="s1">outHeight </span><span class="s2">+ </span><span class="s6">1</span><span class="s1">) </span><span class="s2">/ </span><span class="s6">2</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_tuple</span><span class="s1">(left, top);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Calculate the (left, top) coordinates of the output image 
    within the input image, applying the given x and y offsets. 
  */</span>
  std<span class="s1">::tuple&lt;int, int&gt; </span><span class="s5">CalculateCrop</span><span class="s1">(</span><span class="s2">int const </span>inWidth<span class="s1">, </span><span class="s2">int const </span>inHeight<span class="s1">,</span>
    <span class="s2">int const </span>outWidth<span class="s1">, </span><span class="s2">int const </span>outHeight<span class="s1">, </span><span class="s2">int const </span>x<span class="s1">, </span><span class="s2">int const </span>y<span class="s1">) {</span>

    <span class="s0">// default values</span>
    <span class="s2">int </span><span class="s1">left </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">int </span><span class="s1">top </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>

    <span class="s0">// assign only if valid</span>
    <span class="s2">if </span><span class="s1">(x </span><span class="s2">&lt; </span><span class="s1">(inWidth </span><span class="s2">- </span><span class="s1">outWidth)) {</span>
      <span class="s1">left </span><span class="s2">= </span><span class="s1">x;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(x </span><span class="s2">&gt;= </span><span class="s1">(inWidth </span><span class="s2">- </span><span class="s1">outWidth)) {</span>
      <span class="s1">left </span><span class="s2">= </span><span class="s1">inWidth </span><span class="s2">- </span><span class="s1">outWidth;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(y </span><span class="s2">&lt; </span><span class="s1">(inHeight </span><span class="s2">- </span><span class="s1">outHeight)) {</span>
      <span class="s1">top </span><span class="s2">= </span><span class="s1">y;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(y </span><span class="s2">&gt;= </span><span class="s1">(inHeight </span><span class="s2">- </span><span class="s1">outHeight)) {</span>
      <span class="s1">top </span><span class="s2">= </span><span class="s1">inHeight </span><span class="s2">- </span><span class="s1">outHeight;</span>
    <span class="s1">}</span>

    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_tuple</span><span class="s1">(left, top);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Are pixel values in this image 16-bit integer? 
  */</span>
  <span class="s1">bool </span><span class="s5">Is16Bit</span><span class="s1">(</span>VipsInterpretation <span class="s2">const </span>interpretation<span class="s1">) {</span>
    <span class="s2">return </span><span class="s1">interpretation </span><span class="s2">== </span><span class="s1">VIPS_INTERPRETATION_RGB16 </span><span class="s2">|| </span><span class="s1">interpretation </span><span class="s2">== </span><span class="s1">VIPS_INTERPRETATION_GREY16;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Convert RGBA value to another colourspace 
  */</span>
  std<span class="s1">::vector&lt;double&gt; </span><span class="s5">GetRgbaAsColourspace</span><span class="s1">(</span>std<span class="s1">::</span>vector<span class="s1">&lt;</span><span class="s2">double</span><span class="s1">&gt; </span><span class="s2">const </span>rgba<span class="s1">,</span>
    VipsInterpretation <span class="s2">const </span>interpretation<span class="s1">, </span><span class="s2">bool </span>premultiply<span class="s1">) {</span>
    <span class="s2">int const </span><span class="s1">bands </span><span class="s2">= static_cast&lt;int&gt;</span><span class="s1">(</span>rgba<span class="s1">.</span><span class="s5">size</span><span class="s1">());</span>
    <span class="s2">if </span><span class="s1">(bands </span><span class="s2">&lt; </span><span class="s6">3</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s1">rgba;</span>
    <span class="s1">}</span>
    <span class="s1">VImage pixel </span><span class="s2">= </span>VImage<span class="s1">::</span><span class="s5">new_matrix</span><span class="s1">(</span><span class="s6">1</span><span class="s1">, </span><span class="s6">1</span><span class="s1">);</span>
    pixel<span class="s1">.</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;bands&quot;</span><span class="s1">, bands);</span>
    <span class="s1">pixel </span><span class="s2">= </span><span class="s1">pixel 
      .</span><span class="s5">new_from_image</span><span class="s1">(rgba)</span>
      <span class="s1">.</span><span class="s5">colourspace</span><span class="s1">(interpretation, </span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;source_space&quot;</span><span class="s1">, VIPS_INTERPRETATION_sRGB));</span>
    <span class="s2">if </span><span class="s1">(premultiply) {</span>
      <span class="s1">pixel </span><span class="s2">= </span>pixel<span class="s1">.</span><span class="s5">premultiply</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s5">pixel</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span><span class="s6">0</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Apply the alpha channel to a given colour 
  */</span>
  std<span class="s1">::tuple&lt;VImage, std::vector&lt;double&gt;&gt; </span><span class="s5">ApplyAlpha</span><span class="s1">(</span>VImage image<span class="s1">, </span>std<span class="s1">::</span>vector<span class="s1">&lt;</span><span class="s2">double</span><span class="s1">&gt; </span>colour<span class="s1">, </span><span class="s2">bool </span>premultiply<span class="s1">) {</span>
    <span class="s0">// Scale up 8-bit values to match 16-bit input image</span>
    <span class="s2">double const </span><span class="s1">multiplier </span><span class="s2">= </span>sharp<span class="s1">::</span><span class="s5">Is16Bit</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">interpretation</span><span class="s1">()) </span><span class="s2">? </span><span class="s6">256.0 </span><span class="s2">: </span><span class="s6">1.0</span><span class="s1">;</span>
    <span class="s0">// Create alphaColour colour</span>
    std<span class="s1">::vector</span><span class="s2">&lt;double&gt; </span><span class="s1">alphaColour;</span>
    <span class="s2">if </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">bands</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">2</span><span class="s1">) {</span>
      <span class="s1">alphaColour </span><span class="s2">= </span><span class="s1">{</span>
        <span class="s1">multiplier </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">0</span><span class="s1">],</span>
        <span class="s1">multiplier </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">1</span><span class="s1">],</span>
        <span class="s1">multiplier </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">2</span><span class="s1">]</span>
      <span class="s1">};</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s0">// Convert sRGB to greyscale</span>
      <span class="s1">alphaColour </span><span class="s2">= </span><span class="s1">{ multiplier </span><span class="s2">* </span><span class="s1">(</span>
        <span class="s6">0.2126 </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">0</span><span class="s1">] </span><span class="s2">+</span>
        <span class="s6">0.7152 </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">1</span><span class="s1">] </span><span class="s2">+</span>
        <span class="s6">0.0722 </span><span class="s2">* </span>colour<span class="s1">[</span><span class="s6">2</span><span class="s1">])</span>
      <span class="s1">};</span>
    <span class="s1">}</span>
    <span class="s0">// Add alpha channel(s) to alphaColour colour</span>
    <span class="s2">if </span><span class="s1">(</span>colour<span class="s1">[</span><span class="s6">3</span><span class="s1">] </span><span class="s2">&lt; </span><span class="s6">255.0 </span><span class="s2">|| </span>image<span class="s1">.</span><span class="s5">has_alpha</span><span class="s1">()) {</span>
      <span class="s2">int </span><span class="s1">extraBands </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">bands</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">4 </span><span class="s2">? </span>image<span class="s1">.</span><span class="s5">bands</span><span class="s1">() </span><span class="s2">- </span><span class="s6">3 </span><span class="s2">: </span><span class="s6">1</span><span class="s1">;</span>
      alphaColour<span class="s1">.</span><span class="s5">insert</span><span class="s1">(</span>alphaColour<span class="s1">.</span><span class="s5">end</span><span class="s1">(), extraBands, </span>colour<span class="s1">[</span><span class="s6">3</span><span class="s1">] </span><span class="s2">* </span><span class="s1">multiplier);</span>
    <span class="s1">}</span>
    <span class="s0">// Ensure alphaColour colour uses correct colourspace</span>
    <span class="s1">alphaColour </span><span class="s2">= </span>sharp<span class="s1">::</span><span class="s5">GetRgbaAsColourspace</span><span class="s1">(alphaColour, </span>image<span class="s1">.</span><span class="s5">interpretation</span><span class="s1">(), premultiply);</span>
    <span class="s0">// Add non-transparent alpha channel, if required</span>
    <span class="s2">if </span><span class="s1">(</span>colour<span class="s1">[</span><span class="s6">3</span><span class="s1">] </span><span class="s2">&lt; </span><span class="s6">255.0 </span><span class="s2">&amp;&amp; !</span>image<span class="s1">.</span><span class="s5">has_alpha</span><span class="s1">()) {</span>
      <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">bandjoin_const</span><span class="s1">({ </span><span class="s6">255 </span><span class="s2">* </span><span class="s1">multiplier });</span>
    <span class="s1">}</span>
    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_tuple</span><span class="s1">(image, alphaColour);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Removes alpha channels, if any. 
  */</span>
  <span class="s1">VImage </span><span class="s5">RemoveAlpha</span><span class="s1">(</span>VImage image<span class="s1">) {</span>
    <span class="s2">while </span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">bands</span><span class="s1">() </span><span class="s2">&gt; </span><span class="s6">1 </span><span class="s2">&amp;&amp; </span>image<span class="s1">.</span><span class="s5">has_alpha</span><span class="s1">()) {</span>
      <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">extract_band</span><span class="s1">(</span><span class="s6">0</span><span class="s1">, </span>VImage<span class="s1">::</span><span class="s5">option</span><span class="s1">()-&gt;</span><span class="s5">set</span><span class="s1">(</span><span class="s3">&quot;n&quot;</span><span class="s1">, </span>image<span class="s1">.</span><span class="s5">bands</span><span class="s1">() </span><span class="s2">- </span><span class="s6">1</span><span class="s1">));</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">image;</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Ensures alpha channel, if missing. 
  */</span>
  <span class="s1">VImage </span><span class="s5">EnsureAlpha</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">double const </span>value<span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span>image<span class="s1">.</span><span class="s5">has_alpha</span><span class="s1">()) {</span>
      <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">bandjoin_const</span><span class="s1">({ value </span><span class="s2">* </span><span class="s5">vips_interpretation_max_alpha</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">interpretation</span><span class="s1">()) });</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">image;</span>
  <span class="s1">}</span>

  std<span class="s1">::pair&lt;double, double&gt; </span><span class="s5">ResolveShrink</span><span class="s1">(</span><span class="s2">int </span>width<span class="s1">, </span><span class="s2">int </span>height<span class="s1">, </span><span class="s2">int </span>targetWidth<span class="s1">, </span><span class="s2">int </span>targetHeight<span class="s1">,</span>
    Canvas canvas<span class="s1">, </span><span class="s2">bool </span>withoutEnlargement<span class="s1">, </span><span class="s2">bool </span>withoutReduction<span class="s1">) {</span>
    <span class="s2">double </span><span class="s1">hshrink </span><span class="s2">= </span><span class="s6">1.0</span><span class="s1">;</span>
    <span class="s2">double </span><span class="s1">vshrink </span><span class="s2">= </span><span class="s6">1.0</span><span class="s1">;</span>

    <span class="s2">if </span><span class="s1">(targetWidth </span><span class="s2">&gt; </span><span class="s6">0 </span><span class="s2">&amp;&amp; </span><span class="s1">targetHeight </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s0">// Fixed width and height</span>
      <span class="s1">hshrink </span><span class="s2">= static_cast&lt;double&gt;</span><span class="s1">(width) </span><span class="s2">/ </span><span class="s1">targetWidth;</span>
      <span class="s1">vshrink </span><span class="s2">= static_cast&lt;double&gt;</span><span class="s1">(height) </span><span class="s2">/ </span><span class="s1">targetHeight;</span>

      <span class="s2">switch </span><span class="s1">(canvas) {</span>
        <span class="s2">case </span>Canvas<span class="s1">::CROP:</span>
        <span class="s2">case </span>Canvas<span class="s1">::MIN:</span>
          <span class="s2">if </span><span class="s1">(hshrink </span><span class="s2">&lt; </span><span class="s1">vshrink) {</span>
            <span class="s1">vshrink </span><span class="s2">= </span><span class="s1">hshrink;</span>
          <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">hshrink </span><span class="s2">= </span><span class="s1">vshrink;</span>
          <span class="s1">}</span>
          <span class="s2">break</span><span class="s1">;</span>
        <span class="s2">case </span>Canvas<span class="s1">::EMBED:</span>
        <span class="s2">case </span>Canvas<span class="s1">::MAX:</span>
          <span class="s2">if </span><span class="s1">(hshrink </span><span class="s2">&gt; </span><span class="s1">vshrink) {</span>
            <span class="s1">vshrink </span><span class="s2">= </span><span class="s1">hshrink;</span>
          <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s1">hshrink </span><span class="s2">= </span><span class="s1">vshrink;</span>
          <span class="s1">}</span>
          <span class="s2">break</span><span class="s1">;</span>
        <span class="s2">case </span>Canvas<span class="s1">::IGNORE_ASPECT:</span>
          <span class="s2">break</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(targetWidth </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s0">// Fixed width</span>
      <span class="s1">hshrink </span><span class="s2">= static_cast&lt;double&gt;</span><span class="s1">(width) </span><span class="s2">/ </span><span class="s1">targetWidth;</span>

      <span class="s2">if </span><span class="s1">(canvas </span><span class="s2">!= </span>Canvas<span class="s1">::IGNORE_ASPECT) {</span>
        <span class="s0">// Auto height</span>
        <span class="s1">vshrink </span><span class="s2">= </span><span class="s1">hshrink;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(targetHeight </span><span class="s2">&gt; </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s0">// Fixed height</span>
      <span class="s1">vshrink </span><span class="s2">= static_cast&lt;double&gt;</span><span class="s1">(height) </span><span class="s2">/ </span><span class="s1">targetHeight;</span>

      <span class="s2">if </span><span class="s1">(canvas </span><span class="s2">!= </span>Canvas<span class="s1">::IGNORE_ASPECT) {</span>
        <span class="s0">// Auto width</span>
        <span class="s1">hshrink </span><span class="s2">= </span><span class="s1">vshrink;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// We should not reduce or enlarge the output image, if</span>
    <span class="s0">// withoutReduction or withoutEnlargement is specified.</span>
    <span class="s2">if </span><span class="s1">(withoutReduction) {</span>
      <span class="s0">// Equivalent of VIPS_SIZE_UP</span>
      <span class="s1">hshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">min</span><span class="s1">(</span><span class="s6">1.0</span><span class="s1">, hshrink);</span>
      <span class="s1">vshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">min</span><span class="s1">(</span><span class="s6">1.0</span><span class="s1">, vshrink);</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(withoutEnlargement) {</span>
      <span class="s0">// Equivalent of VIPS_SIZE_DOWN</span>
      <span class="s1">hshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">max</span><span class="s1">(</span><span class="s6">1.0</span><span class="s1">, hshrink);</span>
      <span class="s1">vshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">max</span><span class="s1">(</span><span class="s6">1.0</span><span class="s1">, vshrink);</span>
    <span class="s1">}</span>

    <span class="s0">// We don't want to shrink so much that we send an axis to 0</span>
    <span class="s1">hshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">min</span><span class="s1">(hshrink, </span><span class="s2">static_cast&lt;double&gt;</span><span class="s1">(width));</span>
    <span class="s1">vshrink </span><span class="s2">= </span>std<span class="s1">::</span><span class="s5">min</span><span class="s1">(vshrink, </span><span class="s2">static_cast&lt;double&gt;</span><span class="s1">(height));</span>

    <span class="s2">return </span>std<span class="s1">::</span><span class="s5">make_pair</span><span class="s1">(hshrink, vshrink);</span>
  <span class="s1">}</span>

  <span class="s0">/*</span>
    <span class="s0">Ensure decoding remains sequential. 
  */</span>
  <span class="s1">VImage </span><span class="s5">StaySequential</span><span class="s1">(</span>VImage image<span class="s1">, </span><span class="s2">bool </span>condition<span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s5">vips_image_is_sequential</span><span class="s1">(</span>image<span class="s1">.</span><span class="s5">get_image</span><span class="s1">()) </span><span class="s2">&amp;&amp; </span><span class="s1">condition) {</span>
      <span class="s1">image </span><span class="s2">= </span>image<span class="s1">.</span><span class="s5">copy_memory</span><span class="s1">().</span><span class="s5">copy</span><span class="s1">();</span>
      image<span class="s1">.</span><span class="s5">remove</span><span class="s1">(VIPS_META_SEQUENTIAL);</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">image;</span>
  <span class="s1">}</span>
<span class="s1">}  </span><span class="s0">// namespace sharp</span>
</pre>
</body>
</html>