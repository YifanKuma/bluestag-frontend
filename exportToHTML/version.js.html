<html>
<head>
<title>version.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #8c8c8c; font-style: italic;}
.s2 { color: #080808;}
.s3 { color: #067d17;}
.s4 { color: #0033b3;}
.s5 { color: #264eff;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
version.js</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* </span><span class="s1">@fileoverview </span><span class="s0">Utility functions for React and Flow version configuration</span>
 <span class="s0">* </span><span class="s1">@author </span><span class="s0">Yannick Croissant</span>
 <span class="s0">*/</span>

<span class="s3">'use strict'</span><span class="s2">;</span>

<span class="s4">const </span><span class="s2">fs = require(</span><span class="s3">'fs'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">path = require(</span><span class="s3">'path'</span><span class="s2">);</span>

<span class="s4">const </span><span class="s2">resolve = require(</span><span class="s3">'resolve'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">semver = require(</span><span class="s3">'semver'</span><span class="s2">);</span>
<span class="s4">const </span><span class="s2">error = require(</span><span class="s3">'./error'</span><span class="s2">);</span>

<span class="s4">const </span><span class="s2">ULTIMATE_LATEST_SEMVER = </span><span class="s3">'999.999.999'</span><span class="s2">;</span>

<span class="s4">let </span><span class="s2">warnedForMissingVersion = </span><span class="s4">false</span><span class="s2">;</span>

<span class="s4">function </span><span class="s2">resetWarningFlag() {</span>
  <span class="s2">warnedForMissingVersion = </span><span class="s4">false</span><span class="s2">;</span>
<span class="s2">}</span>

<span class="s4">let </span><span class="s2">cachedDetectedReactVersion;</span>

<span class="s4">function </span><span class="s2">resetDetectedVersion() {</span>
  <span class="s2">cachedDetectedReactVersion = undefined;</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">resolveBasedir(contextOrFilename) {</span>
  <span class="s4">if </span><span class="s2">(contextOrFilename) {</span>
    <span class="s4">const </span><span class="s2">filename = </span><span class="s4">typeof </span><span class="s2">contextOrFilename === </span><span class="s3">'string' </span><span class="s2">? contextOrFilename : contextOrFilename.getFilename();</span>
    <span class="s4">const </span><span class="s2">dirname = path.dirname(filename);</span>
    <span class="s4">try </span><span class="s2">{</span>
      <span class="s4">if </span><span class="s2">(fs.statSync(filename).isFile()) {</span>
        <span class="s0">// dirname must be dir here</span>
        <span class="s4">return </span><span class="s2">dirname;</span>
      <span class="s2">}</span>
    <span class="s2">} </span><span class="s4">catch </span><span class="s2">(err) {</span>
      <span class="s0">// https://github.com/eslint/eslint/issues/11989</span>
      <span class="s4">if </span><span class="s2">(err.code === </span><span class="s3">'ENOTDIR'</span><span class="s2">) {</span>
        <span class="s0">// virtual filename could be recursive</span>
        <span class="s4">return </span><span class="s2">resolveBasedir(dirname);</span>
      <span class="s2">}</span>
    <span class="s2">}</span>
  <span class="s2">}</span>
  <span class="s4">return </span><span class="s2">process.cwd();</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">convertConfVerToSemver(confVer) {</span>
  <span class="s4">const </span><span class="s2">fullSemverString = </span><span class="s5">/^[0-9]+\.[0-9]+$/</span><span class="s2">.test(confVer) ? </span><span class="s3">`</span><span class="s2">${confVer}</span><span class="s3">.0` </span><span class="s2">: confVer;</span>
  <span class="s4">return </span><span class="s2">semver.coerce(fullSemverString.split(</span><span class="s3">'.'</span><span class="s2">).map((part) =&gt; Number(part)).join(</span><span class="s3">'.'</span><span class="s2">));</span>
<span class="s2">}</span>

<span class="s4">let </span><span class="s2">defaultVersion = ULTIMATE_LATEST_SEMVER;</span>

<span class="s4">function </span><span class="s2">resetDefaultVersion() {</span>
  <span class="s2">defaultVersion = ULTIMATE_LATEST_SEMVER;</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">readDefaultReactVersionFromContext(context) {</span>
  <span class="s0">// .eslintrc shared settings (https://eslint.org/docs/user-guide/configuring#adding-shared-settings)</span>
  <span class="s4">if </span><span class="s2">(context.settings &amp;&amp; context.settings.react &amp;&amp; context.settings.react.defaultVersion) {</span>
    <span class="s4">let </span><span class="s2">settingsDefaultVersion = context.settings.react.defaultVersion;</span>
    <span class="s4">if </span><span class="s2">(</span><span class="s4">typeof </span><span class="s2">settingsDefaultVersion !== </span><span class="s3">'string'</span><span class="s2">) {</span>
      <span class="s2">error(</span><span class="s3">`Warning: default React version specified in eslint-pluigin-react-settings must be a string; got &quot;</span><span class="s2">${</span><span class="s4">typeof </span><span class="s2">settingsDefaultVersion}</span><span class="s3">&quot;`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s2">settingsDefaultVersion = String(settingsDefaultVersion);</span>
    <span class="s4">const </span><span class="s2">result = convertConfVerToSemver(settingsDefaultVersion);</span>
    <span class="s4">if </span><span class="s2">(result) {</span>
      <span class="s2">defaultVersion = result.version;</span>
    <span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
      <span class="s2">error(</span><span class="s3">`Warning: React version specified in eslint-plugin-react-settings must be a valid semver version, or &quot;detect&quot;; got “</span><span class="s2">${settingsDefaultVersion}</span><span class="s3">”. Falling back to latest version as default.`</span><span class="s2">);</span>
    <span class="s2">}</span>
  <span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
    <span class="s2">defaultVersion = ULTIMATE_LATEST_SEMVER;</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s0">// TODO, semver-major: remove context fallback</span>
<span class="s4">function </span><span class="s2">detectReactVersion(context) {</span>
  <span class="s4">if </span><span class="s2">(cachedDetectedReactVersion) {</span>
    <span class="s4">return </span><span class="s2">cachedDetectedReactVersion;</span>
  <span class="s2">}</span>

  <span class="s4">const </span><span class="s2">basedir = resolveBasedir(context);</span>

  <span class="s4">try </span><span class="s2">{</span>
    <span class="s4">const </span><span class="s2">reactPath = resolve.sync(</span><span class="s3">'react'</span><span class="s2">, { basedir });</span>
    <span class="s4">const </span><span class="s2">react = require(reactPath); </span><span class="s0">// eslint-disable-line global-require, import/no-dynamic-require</span>
    <span class="s2">cachedDetectedReactVersion = react.version;</span>
    <span class="s4">return </span><span class="s2">cachedDetectedReactVersion;</span>
  <span class="s2">} </span><span class="s4">catch </span><span class="s2">(e) {</span>
    <span class="s4">if </span><span class="s2">(e.code === </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">) {</span>
      <span class="s4">if </span><span class="s2">(!warnedForMissingVersion) {</span>
        <span class="s4">let </span><span class="s2">sentence2 = </span><span class="s3">'Assuming latest React version for linting.'</span><span class="s2">;</span>
        <span class="s4">if </span><span class="s2">(defaultVersion !== ULTIMATE_LATEST_SEMVER) {</span>
          <span class="s2">sentence2 = </span><span class="s3">`Assuming default React version for linting: &quot;</span><span class="s2">${defaultVersion}</span><span class="s3">&quot;.`</span><span class="s2">;</span>
        <span class="s2">}</span>
        <span class="s2">error(</span><span class="s3">`Warning: React version was set to &quot;detect&quot; in eslint-plugin-react settings, but the &quot;react&quot; package is not installed. </span><span class="s2">${sentence2}</span><span class="s3">`</span><span class="s2">);</span>
        <span class="s2">warnedForMissingVersion = </span><span class="s4">true</span><span class="s2">;</span>
      <span class="s2">}</span>
      <span class="s2">cachedDetectedReactVersion = defaultVersion;</span>
      <span class="s4">return </span><span class="s2">cachedDetectedReactVersion;</span>
    <span class="s2">}</span>
    <span class="s4">throw </span><span class="s2">e;</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">getReactVersionFromContext(context) {</span>
  <span class="s2">readDefaultReactVersionFromContext(context);</span>
  <span class="s4">let </span><span class="s2">confVer = defaultVersion;</span>
  <span class="s0">// .eslintrc shared settings (https://eslint.org/docs/user-guide/configuring#adding-shared-settings)</span>
  <span class="s4">if </span><span class="s2">(context.settings &amp;&amp; context.settings.react &amp;&amp; context.settings.react.version) {</span>
    <span class="s4">let </span><span class="s2">settingsVersion = context.settings.react.version;</span>
    <span class="s4">if </span><span class="s2">(settingsVersion === </span><span class="s3">'detect'</span><span class="s2">) {</span>
      <span class="s2">settingsVersion = detectReactVersion(context);</span>
    <span class="s2">}</span>
    <span class="s4">if </span><span class="s2">(</span><span class="s4">typeof </span><span class="s2">settingsVersion !== </span><span class="s3">'string'</span><span class="s2">) {</span>
      <span class="s2">error(</span><span class="s3">`Warning: React version specified in eslint-plugin-react-settings must be a string; got “</span><span class="s2">${</span><span class="s4">typeof </span><span class="s2">settingsVersion}</span><span class="s3">”`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s2">confVer = String(settingsVersion);</span>
  <span class="s2">} </span><span class="s4">else if </span><span class="s2">(!warnedForMissingVersion) {</span>
    <span class="s2">error(</span><span class="s3">'Warning: React version not specified in eslint-plugin-react settings. See https://github.com/jsx-eslint/eslint-plugin-react#configuration .'</span><span class="s2">);</span>
    <span class="s2">warnedForMissingVersion = </span><span class="s4">true</span><span class="s2">;</span>
  <span class="s2">}</span>

  <span class="s4">const </span><span class="s2">result = convertConfVerToSemver(confVer);</span>
  <span class="s4">if </span><span class="s2">(!result) {</span>
    <span class="s2">error(</span><span class="s3">`Warning: React version specified in eslint-plugin-react-settings must be a valid semver version, or &quot;detect&quot;; got “</span><span class="s2">${confVer}</span><span class="s3">”`</span><span class="s2">);</span>
  <span class="s2">}</span>
  <span class="s4">return </span><span class="s2">result ? result.version : defaultVersion;</span>
<span class="s2">}</span>

<span class="s0">// TODO, semver-major: remove context fallback</span>
<span class="s4">function </span><span class="s2">detectFlowVersion(context) {</span>
  <span class="s4">const </span><span class="s2">basedir = resolveBasedir(context);</span>

  <span class="s4">try </span><span class="s2">{</span>
    <span class="s4">const </span><span class="s2">flowPackageJsonPath = resolve.sync(</span><span class="s3">'flow-bin/package.json'</span><span class="s2">, { basedir });</span>
    <span class="s4">const </span><span class="s2">flowPackageJson = require(flowPackageJsonPath); </span><span class="s0">// eslint-disable-line global-require, import/no-dynamic-require</span>
    <span class="s4">return </span><span class="s2">flowPackageJson.version;</span>
  <span class="s2">} </span><span class="s4">catch </span><span class="s2">(e) {</span>
    <span class="s4">if </span><span class="s2">(e.code === </span><span class="s3">'MODULE_NOT_FOUND'</span><span class="s2">) {</span>
      <span class="s2">error(</span><span class="s3">'Warning: Flow version was set to &quot;detect&quot; in eslint-plugin-react settings, '</span>
        <span class="s2">+ </span><span class="s3">'but the &quot;flow-bin&quot; package is not installed. Assuming latest Flow version for linting.'</span><span class="s2">);</span>
      <span class="s4">return </span><span class="s2">ULTIMATE_LATEST_SEMVER;</span>
    <span class="s2">}</span>
    <span class="s4">throw </span><span class="s2">e;</span>
  <span class="s2">}</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">getFlowVersionFromContext(context) {</span>
  <span class="s4">let </span><span class="s2">confVer = defaultVersion;</span>
  <span class="s0">// .eslintrc shared settings (https://eslint.org/docs/user-guide/configuring#adding-shared-settings)</span>
  <span class="s4">if </span><span class="s2">(context.settings.react &amp;&amp; context.settings.react.flowVersion) {</span>
    <span class="s4">let </span><span class="s2">flowVersion = context.settings.react.flowVersion;</span>
    <span class="s4">if </span><span class="s2">(flowVersion === </span><span class="s3">'detect'</span><span class="s2">) {</span>
      <span class="s2">flowVersion = detectFlowVersion(context);</span>
    <span class="s2">}</span>
    <span class="s4">if </span><span class="s2">(</span><span class="s4">typeof </span><span class="s2">flowVersion !== </span><span class="s3">'string'</span><span class="s2">) {</span>
      <span class="s2">error(</span><span class="s3">'Warning: Flow version specified in eslint-plugin-react-settings must be a string; '</span>
        <span class="s2">+ </span><span class="s3">`got “</span><span class="s2">${</span><span class="s4">typeof </span><span class="s2">flowVersion}</span><span class="s3">”`</span><span class="s2">);</span>
    <span class="s2">}</span>
    <span class="s2">confVer = String(flowVersion);</span>
  <span class="s2">} </span><span class="s4">else </span><span class="s2">{</span>
    <span class="s4">throw </span><span class="s3">'Could not retrieve flowVersion from settings'</span><span class="s2">; </span><span class="s0">// eslint-disable-line no-throw-literal</span>
  <span class="s2">}</span>

  <span class="s4">const </span><span class="s2">result = convertConfVerToSemver(confVer);</span>
  <span class="s4">if </span><span class="s2">(!result) {</span>
    <span class="s2">error(</span><span class="s3">`Warning: Flow version specified in eslint-plugin-react-settings must be a valid semver version, or &quot;detect&quot;; got “</span><span class="s2">${confVer}</span><span class="s3">”`</span><span class="s2">);</span>
  <span class="s2">}</span>
  <span class="s4">return </span><span class="s2">result ? result.version : defaultVersion;</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">test(semverRange, confVer) {</span>
  <span class="s4">return </span><span class="s2">semver.satisfies(confVer, semverRange);</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">testReactVersion(context, semverRange) {</span>
  <span class="s4">return </span><span class="s2">test(semverRange, getReactVersionFromContext(context));</span>
<span class="s2">}</span>

<span class="s4">function </span><span class="s2">testFlowVersion(context, semverRange) {</span>
  <span class="s4">return </span><span class="s2">test(semverRange, getFlowVersionFromContext(context));</span>
<span class="s2">}</span>

<span class="s2">module.exports = {</span>
  <span class="s2">testReactVersion,</span>
  <span class="s2">testFlowVersion,</span>
  <span class="s2">resetWarningFlag,</span>
  <span class="s2">resetDetectedVersion,</span>
  <span class="s2">resetDefaultVersion,</span>
<span class="s2">};</span>
</pre>
</body>
</html>