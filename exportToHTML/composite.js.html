<html>
<head>
<title>composite.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #067d17;}
.s3 { color: #0033b3;}
.s4 { color: #8c8c8c; font-style: italic;}
.s5 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
composite.js</font>
</center></td></tr></table>
<pre><span class="s0">// Copyright 2013 Lovell Fuller and others.</span>
<span class="s0">// SPDX-License-Identifier: Apache-2.0</span>

<span class="s2">'use strict'</span><span class="s1">;</span>

<span class="s3">const </span><span class="s1">is = require(</span><span class="s2">'./is'</span><span class="s1">);</span>

<span class="s0">/**</span>
 <span class="s0">* Blend modes.</span>
 <span class="s0">* </span><span class="s4">@member</span>
 <span class="s0">* </span><span class="s4">@private</span>
 <span class="s0">*/</span>
<span class="s3">const </span><span class="s1">blend = {</span>
  <span class="s1">clear: </span><span class="s2">'clear'</span><span class="s1">,</span>
  <span class="s1">source: </span><span class="s2">'source'</span><span class="s1">,</span>
  <span class="s1">over: </span><span class="s2">'over'</span><span class="s1">,</span>
  <span class="s3">in</span><span class="s1">: </span><span class="s2">'in'</span><span class="s1">,</span>
  <span class="s1">out: </span><span class="s2">'out'</span><span class="s1">,</span>
  <span class="s1">atop: </span><span class="s2">'atop'</span><span class="s1">,</span>
  <span class="s1">dest: </span><span class="s2">'dest'</span><span class="s1">,</span>
  <span class="s2">'dest-over'</span><span class="s1">: </span><span class="s2">'dest-over'</span><span class="s1">,</span>
  <span class="s2">'dest-in'</span><span class="s1">: </span><span class="s2">'dest-in'</span><span class="s1">,</span>
  <span class="s2">'dest-out'</span><span class="s1">: </span><span class="s2">'dest-out'</span><span class="s1">,</span>
  <span class="s2">'dest-atop'</span><span class="s1">: </span><span class="s2">'dest-atop'</span><span class="s1">,</span>
  <span class="s1">xor: </span><span class="s2">'xor'</span><span class="s1">,</span>
  <span class="s1">add: </span><span class="s2">'add'</span><span class="s1">,</span>
  <span class="s1">saturate: </span><span class="s2">'saturate'</span><span class="s1">,</span>
  <span class="s1">multiply: </span><span class="s2">'multiply'</span><span class="s1">,</span>
  <span class="s1">screen: </span><span class="s2">'screen'</span><span class="s1">,</span>
  <span class="s1">overlay: </span><span class="s2">'overlay'</span><span class="s1">,</span>
  <span class="s1">darken: </span><span class="s2">'darken'</span><span class="s1">,</span>
  <span class="s1">lighten: </span><span class="s2">'lighten'</span><span class="s1">,</span>
  <span class="s2">'colour-dodge'</span><span class="s1">: </span><span class="s2">'colour-dodge'</span><span class="s1">,</span>
  <span class="s2">'color-dodge'</span><span class="s1">: </span><span class="s2">'colour-dodge'</span><span class="s1">,</span>
  <span class="s2">'colour-burn'</span><span class="s1">: </span><span class="s2">'colour-burn'</span><span class="s1">,</span>
  <span class="s2">'color-burn'</span><span class="s1">: </span><span class="s2">'colour-burn'</span><span class="s1">,</span>
  <span class="s2">'hard-light'</span><span class="s1">: </span><span class="s2">'hard-light'</span><span class="s1">,</span>
  <span class="s2">'soft-light'</span><span class="s1">: </span><span class="s2">'soft-light'</span><span class="s1">,</span>
  <span class="s1">difference: </span><span class="s2">'difference'</span><span class="s1">,</span>
  <span class="s1">exclusion: </span><span class="s2">'exclusion'</span>
<span class="s1">};</span>

<span class="s0">/**</span>
 <span class="s0">* Composite image(s) over the processed (resized, extracted etc.) image.</span>
 <span class="s0">*</span>
 <span class="s0">* The images to composite must be the same size or smaller than the processed image.</span>
 <span class="s0">* If both `top` and `left` options are provided, they take precedence over `gravity`.</span>
 <span class="s0">*</span>
 <span class="s0">* Other operations in the same processing pipeline (e.g. resize, rotate, flip,</span>
 <span class="s0">* flop, extract) will always be applied to the input image before composition.</span>
 <span class="s0">*</span>
 <span class="s0">* The `blend` option can be one of `clear`, `source`, `over`, `in`, `out`, `atop`,</span>
 <span class="s0">* `dest`, `dest-over`, `dest-in`, `dest-out`, `dest-atop`,</span>
 <span class="s0">* `xor`, `add`, `saturate`, `multiply`, `screen`, `overlay`, `darken`, `lighten`,</span>
 <span class="s0">* `colour-dodge`, `color-dodge`, `colour-burn`,`color-burn`,</span>
 <span class="s0">* `hard-light`, `soft-light`, `difference`, `exclusion`.</span>
 <span class="s0">*</span>
 <span class="s0">* More information about blend modes can be found at</span>
 <span class="s0">* https://www.libvips.org/API/current/libvips-conversion.html#VipsBlendMode</span>
 <span class="s0">* and https://www.cairographics.org/operators/</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s4">@since </span><span class="s0">0.22.0</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s4">@example</span>
 <span class="s0">* await sharp(background)</span>
 <span class="s0">*   .composite([</span>
 <span class="s0">*     { input: layer1, gravity: 'northwest' },</span>
 <span class="s0">*     { input: layer2, gravity: 'southeast' },</span>
 <span class="s0">*   ])</span>
 <span class="s0">*   .toFile('combined.png');</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s4">@example</span>
 <span class="s0">* const output = await sharp('input.gif', { animated: true })</span>
 <span class="s0">*   .composite([</span>
 <span class="s0">*     { input: 'overlay.png', tile: true, blend: 'saturate' }</span>
 <span class="s0">*   ])</span>
 <span class="s0">*   .toBuffer();</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s4">@example</span>
 <span class="s0">* sharp('input.png')</span>
 <span class="s0">*   .rotate(180)</span>
 <span class="s0">*   .resize(300)</span>
 <span class="s0">*   .flatten( { background: '#ff6600' } )</span>
 <span class="s0">*   .composite([{ input: 'overlay.png', gravity: 'southeast' }])</span>
 <span class="s0">*   .sharpen()</span>
 <span class="s0">*   .withMetadata()</span>
 <span class="s0">*   .webp( { quality: 90 } )</span>
 <span class="s0">*   .toBuffer()</span>
 <span class="s0">*   .then(function(outputBuffer) {</span>
 <span class="s0">*     // outputBuffer contains upside down, 300px wide, alpha channel flattened</span>
 <span class="s0">*     // onto orange background, composited with overlay.png with SE gravity,</span>
 <span class="s0">*     // sharpened, with metadata, 90% quality WebP image data. Phew!</span>
 <span class="s0">*   });</span>
 <span class="s0">*</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Object[]} images - Ordered list of images to composite</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Buffer|String} [images[].input] - Buffer containing image data, String containing the path to an image file, or Create object (see below)</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Object} [images[].input.create] - describes a blank overlay to be created.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].input.create.width]</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].input.create.height]</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].input.create.channels] - 3-4</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{String|Object} [images[].input.create.background] - parsed by the [color](https://www.npmjs.org/package/color) module to extract values for red, green, blue and alpha.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Object} [images[].input.text] - describes a new text image to be created.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{string} [images[].input.text.text] - text to render as a UTF-8 string. It can contain Pango markup, for example `&lt;i&gt;Le&lt;/i&gt;Monde`.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{string} [images[].input.text.font] - font name to render with.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{string} [images[].input.text.fontfile] - absolute filesystem path to a font file that can be used by `font`.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{number} [images[].input.text.width=0] - integral number of pixels to word-wrap at. Lines of text wider than this will be broken at word boundaries.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{number} [images[].input.text.height=0] - integral number of pixels high. When defined, `dpi` will be ignored and the text will automatically fit the pixel resolution defined by `width` and `height`. Will be ignored if `width` is not specified or set to 0.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{string} [images[].input.text.align='left'] - text alignment (`'left'`, `'centre'`, `'center'`, `'right'`).</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{boolean} [images[].input.text.justify=false] - set this to true to apply justification to the text.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{number} [images[].input.text.dpi=72] - the resolution (size) at which to render the text. Does not take effect if `height` is specified.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{boolean} [images[].input.text.rgba=false] - set this to true to enable RGBA output. This is useful for colour emoji rendering, or support for Pango markup features like `&lt;span foreground=&quot;red&quot;&gt;Red!&lt;/span&gt;`.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{number} [images[].input.text.spacing=0] - text line height in points. Will use the font line height if none is specified.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Boolean} [images[].autoOrient=false] - set to true to use EXIF orientation data, if present, to orient the image.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{String} [images[].blend='over'] - how to blend this image with the image below.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{String} [images[].gravity='centre'] - gravity at which to place the overlay.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].top] - the pixel offset from the top edge.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].left] - the pixel offset from the left edge.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Boolean} [images[].tile=false] - set to true to repeat the overlay image across the entire image with the given `gravity`.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Boolean} [images[].premultiplied=false] - set to true to avoid premultiplying the image below. Equivalent to the `--premultiplied` vips option.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].density=72] - number representing the DPI for vector overlay image.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Object} [images[].raw] - describes overlay when using raw pixel data.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].raw.width]</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].raw.height]</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{Number} [images[].raw.channels]</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{boolean} [images[].animated=false] - Set to `true` to read all frames/pages of an animated image.</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{string} [images[].failOn='warning'] - @see {</span><span class="s4">@link </span><span class="s0">/api-constructor#parameters|constructor parameters}</span>
 <span class="s0">* </span><span class="s4">@param </span><span class="s0">{number|boolean} [images[].limitInputPixels=268402689] - @see {</span><span class="s4">@link </span><span class="s0">/api-constructor#parameters|constructor parameters}</span>
 <span class="s0">* </span><span class="s4">@returns </span><span class="s0">{Sharp}</span>
 <span class="s0">* </span><span class="s4">@throws </span><span class="s0">{Error} Invalid parameters</span>
 <span class="s0">*/</span>
<span class="s3">function </span><span class="s1">composite (images) {</span>
  <span class="s3">if </span><span class="s1">(!Array.isArray(images)) {</span>
    <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'images to composite'</span><span class="s1">, </span><span class="s2">'array'</span><span class="s1">, images);</span>
  <span class="s1">}</span>
  <span class="s3">this</span><span class="s1">.options.composite = images.map(image =&gt; {</span>
    <span class="s3">if </span><span class="s1">(!is.object(image)) {</span>
      <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'image to composite'</span><span class="s1">, </span><span class="s2">'object'</span><span class="s1">, image);</span>
    <span class="s1">}</span>
    <span class="s3">const </span><span class="s1">inputOptions = </span><span class="s3">this</span><span class="s1">._inputOptionsFromObject(image);</span>
    <span class="s3">const </span><span class="s1">composite = {</span>
      <span class="s1">input: </span><span class="s3">this</span><span class="s1">._createInputDescriptor(image.input, inputOptions, { allowStream: </span><span class="s3">false </span><span class="s1">}),</span>
      <span class="s1">blend: </span><span class="s2">'over'</span><span class="s1">,</span>
      <span class="s1">tile: </span><span class="s3">false</span><span class="s1">,</span>
      <span class="s1">left: </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s1">top: </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s1">hasOffset: </span><span class="s3">false</span><span class="s1">,</span>
      <span class="s1">gravity: </span><span class="s5">0</span><span class="s1">,</span>
      <span class="s1">premultiplied: </span><span class="s3">false</span>
    <span class="s1">};</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.blend)) {</span>
      <span class="s3">if </span><span class="s1">(is.string(blend[image.blend])) {</span>
        <span class="s1">composite.blend = blend[image.blend];</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'blend'</span><span class="s1">, </span><span class="s2">'valid blend name'</span><span class="s1">, image.blend);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.tile)) {</span>
      <span class="s3">if </span><span class="s1">(is.bool(image.tile)) {</span>
        <span class="s1">composite.tile = image.tile;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'tile'</span><span class="s1">, </span><span class="s2">'boolean'</span><span class="s1">, image.tile);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.left)) {</span>
      <span class="s3">if </span><span class="s1">(is.integer(image.left)) {</span>
        <span class="s1">composite.left = image.left;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'left'</span><span class="s1">, </span><span class="s2">'integer'</span><span class="s1">, image.left);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.top)) {</span>
      <span class="s3">if </span><span class="s1">(is.integer(image.top)) {</span>
        <span class="s1">composite.top = image.top;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'top'</span><span class="s1">, </span><span class="s2">'integer'</span><span class="s1">, image.top);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.top) !== is.defined(image.left)) {</span>
      <span class="s3">throw new </span><span class="s1">Error(</span><span class="s2">'Expected both left and top to be set'</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s1">composite.hasOffset = is.integer(image.top) &amp;&amp; is.integer(image.left);</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.gravity)) {</span>
      <span class="s3">if </span><span class="s1">(is.integer(image.gravity) &amp;&amp; is.inRange(image.gravity, </span><span class="s5">0</span><span class="s1">, </span><span class="s5">8</span><span class="s1">)) {</span>
        <span class="s1">composite.gravity = image.gravity;</span>
      <span class="s1">} </span><span class="s3">else if </span><span class="s1">(is.string(image.gravity) &amp;&amp; is.integer(</span><span class="s3">this</span><span class="s1">.constructor.gravity[image.gravity])) {</span>
        <span class="s1">composite.gravity = </span><span class="s3">this</span><span class="s1">.constructor.gravity[image.gravity];</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'gravity'</span><span class="s1">, </span><span class="s2">'valid gravity'</span><span class="s1">, image.gravity);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(is.defined(image.premultiplied)) {</span>
      <span class="s3">if </span><span class="s1">(is.bool(image.premultiplied)) {</span>
        <span class="s1">composite.premultiplied = image.premultiplied;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">throw </span><span class="s1">is.invalidParameterError(</span><span class="s2">'premultiplied'</span><span class="s1">, </span><span class="s2">'boolean'</span><span class="s1">, image.premultiplied);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">return </span><span class="s1">composite;</span>
  <span class="s1">});</span>
  <span class="s3">return this</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">/**</span>
 <span class="s0">* Decorate the Sharp prototype with composite-related functions.</span>
 <span class="s0">* </span><span class="s4">@module </span><span class="s0">Sharp</span>
 <span class="s0">* </span><span class="s4">@private</span>
 <span class="s0">*/</span>
<span class="s1">module.exports = </span><span class="s3">function </span><span class="s1">(Sharp) {</span>
  <span class="s1">Sharp.prototype.composite = composite;</span>
  <span class="s1">Sharp.blend = blend;</span>
<span class="s1">};</span>
</pre>
</body>
</html>