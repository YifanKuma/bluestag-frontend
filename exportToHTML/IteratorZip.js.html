<html>
<head>
<title>IteratorZip.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #067d17;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #8c8c8c; font-style: italic;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
IteratorZip.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>

<span class="s2">var </span><span class="s1">$TypeError = require(</span><span class="s0">'es-errors/type'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">CreateIteratorFromClosure = require(</span><span class="s0">'./CreateIteratorFromClosure'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">IteratorCloseAll = require(</span><span class="s0">'./IteratorCloseAll'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">IteratorStep = require(</span><span class="s0">'es-abstract/2024/IteratorStep'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">IteratorStepValue = require(</span><span class="s0">'es-abstract/2024/IteratorStepValue'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">NormalCompletion = require(</span><span class="s0">'es-abstract/2024/NormalCompletion'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">ThrowCompletion = require(</span><span class="s0">'es-abstract/2024/ThrowCompletion'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">isAbstractClosure = require(</span><span class="s0">'es-abstract/helpers/isAbstractClosure'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">IsArray = require(</span><span class="s0">'es-abstract/helpers/IsArray'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">isIteratorRecord = require(</span><span class="s0">'es-abstract/helpers/records/iterator-record'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">every = require(</span><span class="s0">'es-abstract/helpers/every'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">callBound = require(</span><span class="s0">'call-bound'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">$indexOf = callBound(</span><span class="s0">'Array.prototype.indexOf'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">$slice = callBound(</span><span class="s0">'Array.prototype.slice'</span><span class="s1">);</span>
<span class="s2">var </span><span class="s1">$splice = callBound(</span><span class="s0">'Array.prototype.splice'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">iterHelperProto = require(</span><span class="s0">'../IteratorHelperPrototype'</span><span class="s1">);</span>

<span class="s2">var </span><span class="s1">SLOT = require(</span><span class="s0">'internal-slot'</span><span class="s1">);</span>

<span class="s3">// https://tc39.es/proposal-joint-iteration/#sec-IteratorZip</span>

<span class="s1">module.exports = </span><span class="s2">function </span><span class="s1">IteratorZip(iters, mode, padding, finishResults) {</span>
	<span class="s2">if </span><span class="s1">(!IsArray(iters) || !every(iters, isIteratorRecord)) {</span>
		<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'`iters` must be a List of IteratorRecords'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s2">if </span><span class="s1">(mode !== </span><span class="s0">'shortest' </span><span class="s1">&amp;&amp; mode !== </span><span class="s0">'longest' </span><span class="s1">&amp;&amp; mode !== </span><span class="s0">'strict'</span><span class="s1">) {</span>
		<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'`mode` must be one of &quot;shortest&quot;, &quot;longest&quot;, or &quot;strict&quot;'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s2">if </span><span class="s1">(!IsArray(padding)) {</span>
		<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'`padding` must be a List'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s2">if </span><span class="s1">(!isAbstractClosure(finishResults)) {</span>
		<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'`finishResults` must be an Abstract Closure'</span><span class="s1">);</span>
	<span class="s1">}</span>

	<span class="s2">var </span><span class="s1">iterCount = iters.length; </span><span class="s3">// step 1</span>

	<span class="s2">var </span><span class="s1">openIters = $slice(iters); </span><span class="s3">// step 2</span>

	<span class="s2">var </span><span class="s1">sentinel = {};</span>
	<span class="s2">var </span><span class="s1">closure = </span><span class="s2">function </span><span class="s1">() {</span>
		<span class="s2">if </span><span class="s1">(iterCount === </span><span class="s4">0</span><span class="s1">) {</span>
			<span class="s3">// 1. If iterCount = 0, return ReturnCompletion(undefined).</span>
			<span class="s2">return </span><span class="s1">sentinel; </span><span class="s3">// step 1</span>
		<span class="s1">}</span>
		<span class="s3">// while (true) {</span>
		<span class="s1">{ </span><span class="s3">// eslint-disable-line no-lone-blocks</span>
			<span class="s2">var </span><span class="s1">results = []; </span><span class="s3">// step 3.b.i</span>
			<span class="s2">if </span><span class="s1">(openIters.length === </span><span class="s4">0</span><span class="s1">) {</span>
				<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `openIters` is empty'</span><span class="s1">); </span><span class="s3">// step 3.b.ii</span>
			<span class="s1">}</span>
			<span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">i = </span><span class="s4">0</span><span class="s1">; i &lt; iterCount; ++i) { </span><span class="s3">// step 3.b.iii</span>
				<span class="s3">// for (var i = 0; i &lt; iterCount; i += 1) { // step 3.b.iii</span>
				<span class="s2">var </span><span class="s1">result;</span>

				<span class="s2">var </span><span class="s1">iter = iters[i];</span>
				<span class="s2">if </span><span class="s1">(iter === </span><span class="s2">null</span><span class="s1">) { </span><span class="s3">// step 3.b.iii.1</span>
					<span class="s2">if </span><span class="s1">(mode !== </span><span class="s0">'longest'</span><span class="s1">) {</span>
						<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `mode` is not &quot;longest&quot;'</span><span class="s1">); </span><span class="s3">// step 3.b.iii.1.a</span>
					<span class="s1">}</span>
					<span class="s1">result = padding[i]; </span><span class="s3">// step 3.b.iii.1.b</span>
				<span class="s1">} </span><span class="s2">else </span><span class="s1">{ </span><span class="s3">// step 2</span>
					<span class="s2">try </span><span class="s1">{</span>
						<span class="s1">result = IteratorStepValue(iter); </span><span class="s3">// step 3.b.iii.2.a, 3.b.iii.2.c</span>
					<span class="s1">} </span><span class="s2">catch </span><span class="s1">(e) { </span><span class="s3">// step 3.b.iii.2.b</span>
						<span class="s1">$splice(openIters, $indexOf(openIters, iter), </span><span class="s4">1</span><span class="s1">); </span><span class="s3">// step 3.b.iii.2.b.i</span>
						<span class="s2">return </span><span class="s1">IteratorCloseAll(openIters, ThrowCompletion(e)); </span><span class="s3">// step 3.b.iii.2.b.ii</span>
					<span class="s1">}</span>
					<span class="s2">if </span><span class="s1">(iter[</span><span class="s0">'[[Done]]'</span><span class="s1">]) { </span><span class="s3">// step 3.b.iii.2.d</span>
						<span class="s1">$splice(openIters, $indexOf(openIters, iter), </span><span class="s4">1</span><span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.i</span>
						<span class="s2">if </span><span class="s1">(mode === </span><span class="s0">'shortest'</span><span class="s1">) { </span><span class="s3">// step 3.b.iii.2.d.ii</span>
							<span class="s1">IteratorCloseAll(openIters, NormalCompletion(undefined)); </span><span class="s3">// step 3.b.iii.2.d.ii.i</span>
							<span class="s2">return </span><span class="s1">sentinel;</span>
						<span class="s1">} </span><span class="s2">else if </span><span class="s1">(mode === </span><span class="s0">'strict'</span><span class="s1">) { </span><span class="s3">// step 3.b.iii.2.d.iii</span>
							<span class="s2">if </span><span class="s1">(i !== </span><span class="s4">0</span><span class="s1">) { </span><span class="s3">// step 3.b.iii.2.d.iii.i</span>
								<span class="s2">return </span><span class="s1">IteratorCloseAll(</span>
									<span class="s1">openIters,</span>
									<span class="s1">ThrowCompletion(</span><span class="s2">new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `i` is not 0'</span><span class="s1">))</span>
								<span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.iii.i.i</span>
							<span class="s1">}</span>
							<span class="s2">for </span><span class="s1">(</span><span class="s2">var </span><span class="s1">k = </span><span class="s4">1</span><span class="s1">; k &lt; iterCount; k += </span><span class="s4">1</span><span class="s1">) { </span><span class="s3">// step 3.b.iii.2.d.iii.ii</span>
								<span class="s2">if </span><span class="s1">(iters[k] === </span><span class="s2">null</span><span class="s1">) {</span>
									<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `iters[k]` is `null`'</span><span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.iii.ii.i</span>
								<span class="s1">}</span>
								<span class="s2">try </span><span class="s1">{</span>
									<span class="s1">result = IteratorStep(iters[k]); </span><span class="s3">// step 3.b.iii.2.d.iii.ii.ii, 3.b.iii.2.d.iii.ii.iii.ii.iv</span>
								<span class="s1">} </span><span class="s2">catch </span><span class="s1">(e) { </span><span class="s3">// step 3.b.iii.2.d.iii.ii.iii</span>
									<span class="s2">return </span><span class="s1">IteratorCloseAll(openIters, ThrowCompletion(e)); </span><span class="s3">// step 3.b.iii.2.d.iii.ii.iii.ii</span>
								<span class="s1">}</span>

								<span class="s3">// if (open === false) { // step 3.b.iii.2.d.iii.ii.v</span>
								<span class="s2">if </span><span class="s1">(iters[k][</span><span class="s0">'[[Done]]'</span><span class="s1">]) { </span><span class="s3">// step 3.b.iii.2.d.iii.ii.v</span>
									<span class="s1">$splice(openIters, $indexOf(openIters, iters[k]), </span><span class="s4">1</span><span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.iii.ii.v.i</span>
								<span class="s1">} </span><span class="s2">else </span><span class="s1">{ </span><span class="s3">// step 3.b.iii.2.d.iii.ii.vi</span>
									<span class="s2">return </span><span class="s1">IteratorCloseAll(</span>
										<span class="s1">openIters,</span>
										<span class="s1">ThrowCompletion(</span><span class="s2">new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `open` is not `false`'</span><span class="s1">))</span>
									<span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.iii.ii.vi.i</span>
								<span class="s1">}</span>
							<span class="s1">}</span>
						<span class="s1">} </span><span class="s2">else </span><span class="s1">{ </span><span class="s3">// step 3.b.iii.2.d.iv</span>
							<span class="s2">if </span><span class="s1">(mode !== </span><span class="s0">'longest'</span><span class="s1">) {</span>
								<span class="s2">throw new </span><span class="s1">$TypeError(</span><span class="s0">'Assertion failed: `mode` is not &quot;longest&quot;'</span><span class="s1">); </span><span class="s3">// step 3.b.iii.2.d.iv.i</span>
							<span class="s1">}</span>

							<span class="s2">if </span><span class="s1">(openIters.length === </span><span class="s4">0</span><span class="s1">) {</span>
								<span class="s2">return </span><span class="s1">sentinel; </span><span class="s3">// ReturnCompletion(undefined); // step 3.b.iii.2.d.iv.ii</span>
							<span class="s1">}</span>

							<span class="s3">// eslint-disable-next-line no-param-reassign</span>
							<span class="s1">iters[i] = </span><span class="s2">null</span><span class="s1">; </span><span class="s3">// step 3.b.iii.2.d.iv.iii</span>
							<span class="s3">// i += 1;</span>

							<span class="s1">result = padding[i]; </span><span class="s3">// step 3.b.iii.2.d.iv.iv</span>
						<span class="s1">}</span>
					<span class="s1">}</span>
				<span class="s1">}</span>

				<span class="s1">results[results.length] = result; </span><span class="s3">// step 3.b.iii.3</span>

				<span class="s3">//    5. Let completion be Completion(Yield(results)).</span>
				<span class="s3">//    6. If completion is an abrupt completion, then</span>
				<span class="s3">//   1. Return ? IteratorCloseAll(openIters, completion).</span>
			<span class="s1">}</span>
		<span class="s1">}</span>

		<span class="s2">return </span><span class="s1">finishResults(results); </span><span class="s3">// step 3.b.iv</span>
	<span class="s1">};</span>
	<span class="s1">SLOT.set(closure, </span><span class="s0">'[[Sentinel]]'</span><span class="s1">, sentinel); </span><span class="s3">// for the userland implementation</span>
	<span class="s1">SLOT.set(closure, </span><span class="s0">'[[CloseIfAbrupt]]'</span><span class="s1">, finishResults); </span><span class="s3">// for the userland implementation</span>

	<span class="s2">var </span><span class="s1">gen = CreateIteratorFromClosure(closure, </span><span class="s0">'Iterator Helper'</span><span class="s1">, iterHelperProto, [</span><span class="s0">'[[UnderlyingIterators]]'</span><span class="s1">]); </span><span class="s3">// step 4</span>

	<span class="s1">SLOT.set(gen, </span><span class="s0">'[[UnderlyingIterators]]'</span><span class="s1">, openIters); </span><span class="s3">// step 5</span>

	<span class="s2">return </span><span class="s1">gen; </span><span class="s3">// step 6</span>
<span class="s1">};</span>
</pre>
</body>
</html>